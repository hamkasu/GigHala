{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; margin: 100px auto; padding: 20px;">
    <div style="background: var(--bg-white); border-radius: var(--radius-lg); padding: 48px; border: 1px solid var(--border);">
        {% if error %}
        <!-- Error State -->
        <div style="text-align: center;">
            <div style="font-size: 64px; margin-bottom: 24px;">‚ö†Ô∏è</div>
            <h1 style="color: var(--text-dark); margin-bottom: 16px; font-size: 24px;">Password Reset Error</h1>
            <p style="color: var(--text-gray); margin-bottom: 32px;">{{ error }}</p>
            <a href="/" class="btn btn-primary" style="display: inline-block; padding: 12px 24px; background: var(--primary); color: white; border-radius: 8px; text-decoration: none;">
                Kembali ke Halaman Utama
            </a>
        </div>
        {% else %}
        <!-- Password Reset Form -->
        <div style="text-align: center; margin-bottom: 32px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîê</div>
            <h1 style="color: var(--text-dark); margin-bottom: 8px; font-size: 24px;">Reset Your Password</h1>
            <p style="color: var(--text-gray); font-size: 14px;">Enter your new password below</p>
            {% if email %}
            <p style="color: var(--text-gray); font-size: 12px; margin-top: 8px;">For account: <strong>{{ email }}</strong></p>
            {% endif %}
        </div>

        <form id="resetPasswordForm" style="margin-top: 24px;">
            <input type="hidden" id="resetToken" value="{{ token }}">

            <div style="margin-bottom: 20px;">
                <label for="password" style="display: block; margin-bottom: 8px; color: var(--text-dark); font-weight: 500;">
                    New Password
                </label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    placeholder="Enter your new password"
                >
                <small style="display: block; margin-top: 8px; color: var(--text-gray); font-size: 12px;">
                    Password must be at least 8 characters with uppercase, lowercase, number, and special character.
                </small>
            </div>

            <div style="margin-bottom: 24px;">
                <label for="confirmPassword" style="display: block; margin-bottom: 8px; color: var(--text-dark); font-weight: 500;">
                    Confirm Password
                </label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;"
                    placeholder="Confirm your new password"
                >
            </div>

            <div id="errorMessage" style="display: none; padding: 12px; background: #fee; border: 1px solid #fcc; border-radius: 8px; color: #c33; margin-bottom: 16px; font-size: 14px;"></div>

            <div id="successMessage" style="display: none; padding: 12px; background: #efe; border: 1px solid #cfc; border-radius: 8px; color: #3c3; margin-bottom: 16px; font-size: 14px;"></div>

            <button
                type="submit"
                id="submitBtn"
                style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;"
                onmouseover="this.style.opacity='0.9'"
                onmouseout="this.style.opacity='1'"
            >
                Reset Password
            </button>
        </form>

        <div style="text-align: center; margin-top: 24px;">
            <a href="/" style="color: var(--primary); text-decoration: none; font-size: 14px;">
                Back to Home
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const token = document.getElementById('resetToken').value;
    const errorDiv = document.getElementById('errorMessage');
    const successDiv = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');

    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    // Validate passwords match
    if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }

    // Disable button during submission
    submitBtn.disabled = true;
    submitBtn.textContent = 'Resetting...';

    try {
        const response = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: token,
                password: password
            })
        });

        const data = await response.json();

        if (response.ok) {
            successDiv.textContent = data.message;
            successDiv.style.display = 'block';

            // Redirect to home page after 2 seconds
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            errorDiv.textContent = data.error || 'Failed to reset password';
            errorDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Reset Password';
        }
    } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
    }
});
</script>
{% endblock %}
