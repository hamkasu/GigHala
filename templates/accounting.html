{% extends "base.html" %}

{% block title %}Accounting Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
    }

    .admin-header h1 {
        margin: 0 0 6px 0;
        font-size: 28px;
    }

    .admin-header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: #6366f1;
    }

    .tab-btn.active {
        color: #6366f1;
        border-bottom-color: #6366f1;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-white);
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        border-left: 4px solid #6366f1;
    }

    .stat-card h3 {
        margin: 0 0 6px 0;
        color: var(--text-gray);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: #6366f1;
        margin-bottom: 4px;
    }

    .stat-card .label {
        color: var(--text-light);
        font-size: 12px;
    }

    .data-table {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .data-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: var(--bg-gray);
        padding: 14px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--text-gray);
        letter-spacing: 0.5px;
    }

    .data-table td {
        padding: 14px 16px;
        border-top: 1px solid var(--border);
    }

    .data-table tr:hover {
        background: var(--bg-gray);
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .filter-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-bar select,
    .filter-bar button {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .filter-bar button {
        background: #6366f1;
        color: white;
        border: none;
        cursor: pointer;
    }

    .filter-bar button:hover {
        background: #4f46e5;
    }

    .role-form {
        background: var(--bg-white);
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }

    .role-form label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-gray);
    }

    .role-form select,
    .role-form input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
    }

    .role-form button {
        padding: 10px 20px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
    }

    .role-form button:hover {
        background: #4f46e5;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-gray);
    }

    .period-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
    }

    .period-btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .period-btn.active {
        background: #6366f1;
        color: white;
        border-color: #6366f1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 24px;">
    <div class="admin-header">
        <h1>ðŸ’° Accounting & Billing Dashboard</h1>
        <p>Manage invoices, payouts, and financial reports</p>
    </div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn" onclick="switchTab('invoices')">Invoices</button>
        <button class="tab-btn" onclick="switchTab('payouts')">Payouts</button>
        <button class="tab-btn" onclick="switchTab('revenue')">Revenue</button>
        <button class="tab-btn" onclick="switchTab('reports')">Financial Reports</button>
        <button class="tab-btn" onclick="switchTab('roles')">User Roles</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
        <h2 style="margin-bottom: 16px;">Financial Overview</h2>
        <div class="stats-grid" id="overview-stats">
            <div class="loading">Loading overview...</div>
        </div>
    </div>

    <!-- Invoices Tab -->
    <div id="invoices-tab" class="tab-content">
        <h2 style="margin-bottom: 16px;">Invoice Management</h2>
        <div class="filter-bar">
            <select id="invoice-status-filter" onchange="loadInvoices()">
                <option value="all">All Statuses</option>
                <option value="draft">Draft</option>
                <option value="issued">Issued</option>
                <option value="paid">Paid</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <button onclick="loadInvoices()">Refresh</button>
        </div>
        <div class="data-table" id="invoices-table">
            <div class="loading">Loading invoices...</div>
        </div>
    </div>

    <!-- Payouts Tab -->
    <div id="payouts-tab" class="tab-content">
        <h2 style="margin-bottom: 16px;">Payout Management</h2>
        <div class="filter-bar">
            <select id="payout-status-filter" onchange="loadPayouts()">
                <option value="all">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
            </select>
            <button onclick="loadPayouts()">Refresh</button>
        </div>
        <div class="data-table" id="payouts-table">
            <div class="loading">Loading payouts...</div>
        </div>
    </div>

    <!-- Revenue Tab -->
    <div id="revenue-tab" class="tab-content">
        <h2 style="margin-bottom: 16px;">Revenue Summary</h2>
        <div class="period-selector">
            <button class="period-btn active" onclick="selectPeriod('day')">Today</button>
            <button class="period-btn" onclick="selectPeriod('week')">This Week</button>
            <button class="period-btn" onclick="selectPeriod('month')">This Month</button>
            <button class="period-btn" onclick="selectPeriod('year')">This Year</button>
        </div>
        <div class="stats-grid" id="revenue-stats">
            <div class="loading">Loading revenue data...</div>
        </div>
    </div>

    <!-- Financial Reports Tab -->
    <div id="reports-tab" class="tab-content">
        <div class="data-table">
            <div style="padding: 24px;">
                <h2 style="margin-bottom: 20px;">Financial Reports</h2>

                <!-- Report Type Selection -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-gray);">Report Type</label>
                    <select id="report-type" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;" onchange="handleReportTypeChange()">
                        <option value="">Select Report Type</option>
                        <option value="platform">Platform-Wide Financial Report</option>
                        <option value="worker">Worker Financial Report</option>
                        <option value="client">Client Spending Report</option>
                        <option value="socso">SOCSO Payout Report</option>
                    </select>
                </div>

                <!-- User Selection (for worker/client reports) -->
                <div id="user-selection-section" style="display: none; margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-gray);" id="user-selection-label">Select User</label>
                    <select id="user-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                        <option value="">Select...</option>
                    </select>
                </div>

                <!-- Date Range Selection -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-gray);">Start Date</label>
                        <input type="date" id="report-start-date" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-gray);">End Date</label>
                        <input type="date" id="report-end-date" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                    </div>
                </div>

                <!-- Quick Date Range Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;">
                    <button onclick="setDateRange('thisMonth')" class="filter-bar button" style="padding: 8px 16px; font-size: 13px; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px;">This Month</button>
                    <button onclick="setDateRange('lastMonth')" class="filter-bar button" style="padding: 8px 16px; font-size: 13px; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px;">Last Month</button>
                    <button onclick="setDateRange('last3Months')" class="filter-bar button" style="padding: 8px 16px; font-size: 13px; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px;">Last 3 Months</button>
                    <button onclick="setDateRange('last6Months')" class="filter-bar button" style="padding: 8px 16px; font-size: 13px; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px;">Last 6 Months</button>
                    <button onclick="setDateRange('thisYear')" class="filter-bar button" style="padding: 8px 16px; font-size: 13px; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px;">This Year</button>
                </div>

                <!-- Generate Button -->
                <button onclick="generateReport()" style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600; background: #6366f1; color: white; border: none; cursor: pointer; border-radius: 8px; margin-bottom: 24px;">
                    Generate Report
                </button>

                <!-- Report Loading -->
                <div id="report-loading" style="display: none; text-align: center; padding: 40px; color: var(--text-gray);">
                    <div class="loading">Generating report...</div>
                </div>

                <!-- Report Results -->
                <div id="report-results" style="display: none; margin-top: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-gray);" id="report-title">Report</h3>
                        <button onclick="exportReportToCSV()" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">Export to CSV</button>
                    </div>

                    <!-- Platform Report -->
                    <div id="platform-report" style="display: none;">
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #1e40af;">
                                <strong>Period:</strong> <span id="platform-period"></span>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Overview</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Revenue</h3>
                                <div class="value" id="platform-total-revenue">RM 0</div>
                                <div class="label">Commission + Fees</div>
                            </div>
                            <div class="stat-card">
                                <h3>New Users</h3>
                                <div class="value" id="platform-new-users">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Completed Gigs</h3>
                                <div class="value" id="platform-gigs-completed">0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Transactions</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Transactions</h3>
                                <div class="value" id="platform-tx-count">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Transaction Amount</h3>
                                <div class="value" id="platform-tx-amount">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Commission Earned</h3>
                                <div class="value" id="platform-tx-commission">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Net to Workers</h3>
                                <div class="value" id="platform-tx-net">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Escrow</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Funded</h3>
                                <div class="value" id="platform-escrow-funded">RM 0</div>
                                <div class="label" id="platform-escrow-funded-count">0 escrows</div>
                            </div>
                            <div class="stat-card">
                                <h3>Released</h3>
                                <div class="value" id="platform-escrow-released">RM 0</div>
                                <div class="label" id="platform-escrow-released-count">0 escrows</div>
                            </div>
                            <div class="stat-card">
                                <h3>Platform Fees</h3>
                                <div class="value" id="platform-escrow-fees">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Payouts</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Completed Payouts</h3>
                                <div class="value" id="platform-payout-count">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Payout Amount</h3>
                                <div class="value" id="platform-payout-amount">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Payout Fees</h3>
                                <div class="value" id="platform-payout-fees">RM 0</div>
                            </div>
                        </div>

                        <div id="platform-payment-methods" style="margin-top: 24px;"></div>
                        <div id="platform-commission-tiers" style="margin-top: 24px;"></div>
                    </div>

                    <!-- Worker Report -->
                    <div id="worker-report" style="display: none;">
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #1e40af; margin-bottom: 8px;">
                                <strong>Worker:</strong> <span id="worker-name"></span> (<span id="worker-email"></span>)
                            </div>
                            <div style="font-size: 13px; color: #1e40af;">
                                <strong>Period:</strong> <span id="worker-period"></span>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Wallet Status</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Current Balance</h3>
                                <div class="value" id="worker-balance">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Held Balance</h3>
                                <div class="value" id="worker-held">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Lifetime Earnings</h3>
                                <div class="value" id="worker-total-earned">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Period Earnings</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Earned</h3>
                                <div class="value" id="worker-earned">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Commission Paid</h3>
                                <div class="value" id="worker-commission">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Transactions</h3>
                                <div class="value" id="worker-tx-count">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Escrow Released</h3>
                                <div class="value" id="worker-escrow">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Gigs</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Completed</h3>
                                <div class="value" id="worker-gigs-completed">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>In Progress</h3>
                                <div class="value" id="worker-gigs-progress">0</div>
                            </div>
                        </div>

                        <div id="worker-gig-details" style="margin-top: 24px;"></div>
                        <div id="worker-payout-details" style="margin-top: 24px;"></div>
                    </div>

                    <!-- Client Report -->
                    <div id="client-report" style="display: none;">
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #1e40af; margin-bottom: 8px;">
                                <strong>Client:</strong> <span id="client-name"></span> (<span id="client-email"></span>)
                            </div>
                            <div style="font-size: 13px; color: #1e40af;">
                                <strong>Period:</strong> <span id="client-period"></span>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Wallet Status</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Current Balance</h3>
                                <div class="value" id="client-balance">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Lifetime Spent</h3>
                                <div class="value" id="client-total-spent">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Period Spending</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Spent</h3>
                                <div class="value" id="client-spent">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Commission Paid</h3>
                                <div class="value" id="client-commission">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Transactions</h3>
                                <div class="value" id="client-tx-count">0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Gigs</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Gigs</h3>
                                <div class="value" id="client-gigs-total">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Completed</h3>
                                <div class="value" id="client-gigs-completed">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Active</h3>
                                <div class="value" id="client-gigs-active">0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Escrow</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Funded</h3>
                                <div class="value" id="client-escrow-funded">RM 0</div>
                                <div class="label" id="client-escrow-funded-count">0 escrows</div>
                            </div>
                            <div class="stat-card">
                                <h3>Pending</h3>
                                <div class="value" id="client-escrow-pending">RM 0</div>
                            </div>
                        </div>

                        <div id="client-payment-methods" style="margin-top: 24px;"></div>
                        <div id="client-gig-details" style="margin-top: 24px;"></div>
                    </div>

                    <!-- SOCSO Payout Report -->
                    <div id="socso-report" style="display: none;">
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #1e40af;">
                                <strong>Period:</strong> <span id="socso-period"></span>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">SOCSO Summary</h4>
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <h3>Total Freelancers</h3>
                                <div class="value" id="socso-total-freelancers">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Transactions</h3>
                                <div class="value" id="socso-total-transactions">0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total SOCSO Collected</h3>
                                <div class="value" id="socso-total-amount">RM 0</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Net Earnings</h3>
                                <div class="value" id="socso-total-earnings">RM 0</div>
                            </div>
                        </div>

                        <h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Freelancer Breakdown</h4>
                        <div id="socso-details-table" style="overflow-x: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roles Tab -->
    <div id="roles-tab" class="tab-content">
        <h2 style="margin-bottom: 16px;">Admin Role Management</h2>
        <p style="margin-bottom: 20px; color: var(--text-gray);">
            Manage admin user roles and permissions. Only super admins can modify roles.
        </p>
        <div class="data-table" id="roles-table">
            <div class="loading">Loading user roles...</div>
        </div>
    </div>
</div>

<script>
let currentPeriod = 'month';

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');

    // Load data for the tab
    if (tabName === 'overview') loadOverview();
    else if (tabName === 'invoices') loadInvoices();
    else if (tabName === 'payouts') loadPayouts();
    else if (tabName === 'revenue') loadRevenue();
    else if (tabName === 'reports') { /* Reports tab doesn't auto-load */ }
    else if (tabName === 'roles') loadRoles();
}

async function loadOverview() {
    try {
        const response = await fetch('/api/accounting/revenue-summary?period=month');
        const data = await response.json();

        const html = `
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value">RM ${data.revenue.total.toFixed(2)}</div>
                <div class="label">This Month</div>
            </div>
            <div class="stat-card">
                <h3>Transactions</h3>
                <div class="value">${data.revenue.transaction_count}</div>
                <div class="label">Completed</div>
            </div>
            <div class="stat-card">
                <h3>Invoices</h3>
                <div class="value">${data.invoices.count}</div>
                <div class="label">RM ${data.invoices.total.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <h3>Payouts</h3>
                <div class="value">${data.payouts.count}</div>
                <div class="label">RM ${data.payouts.total.toFixed(2)}</div>
            </div>
        `;

        document.getElementById('overview-stats').innerHTML = html;
    } catch (error) {
        console.error('Error loading overview:', error);
        document.getElementById('overview-stats').innerHTML = '<div class="loading">Error loading overview</div>';
    }
}

async function loadInvoices() {
    const status = document.getElementById('invoice-status-filter').value;
    try {
        const response = await fetch(`/api/accounting/invoices?status=${status}&limit=50`);
        const data = await response.json();

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Client</th>
                        <th>Freelancer</th>
                        <th>Amount</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (data.invoices.length === 0) {
            html += '<tr><td colspan="7" style="text-align: center;">No invoices found</td></tr>';
        } else {
            data.invoices.forEach(inv => {
                const statusClass = inv.status === 'paid' ? 'success' :
                                   inv.status === 'issued' ? 'info' :
                                   inv.status === 'cancelled' ? 'danger' : 'warning';
                html += `
                    <tr>
                        <td><strong>${inv.invoice_number}</strong></td>
                        <td>${inv.client_name}</td>
                        <td>${inv.freelancer_name}</td>
                        <td>RM ${inv.amount.toFixed(2)}</td>
                        <td>RM ${inv.total_amount.toFixed(2)}</td>
                        <td><span class="badge badge-${statusClass}">${inv.status}</span></td>
                        <td>${new Date(inv.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        }

        html += '</tbody></table>';
        document.getElementById('invoices-table').innerHTML = html;
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('invoices-table').innerHTML = '<div class="loading">Error loading invoices</div>';
    }
}

async function loadPayouts() {
    const status = document.getElementById('payout-status-filter').value;
    try {
        const response = await fetch(`/api/accounting/payouts?status=${status}&limit=50`);
        const data = await response.json();

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Freelancer</th>
                        <th>Amount</th>
                        <th>Net Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Requested</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (data.payouts.length === 0) {
            html += '<tr><td colspan="7" style="text-align: center;">No payouts found</td></tr>';
        } else {
            data.payouts.forEach(payout => {
                const statusClass = payout.status === 'completed' ? 'success' :
                                   payout.status === 'processing' ? 'info' :
                                   payout.status === 'failed' ? 'danger' : 'warning';
                html += `
                    <tr>
                        <td><strong>${payout.payout_number}</strong></td>
                        <td>${payout.freelancer_name}</td>
                        <td>RM ${payout.amount.toFixed(2)}</td>
                        <td>RM ${payout.net_amount.toFixed(2)}</td>
                        <td>${payout.payment_method || 'N/A'}</td>
                        <td><span class="badge badge-${statusClass}">${payout.status}</span></td>
                        <td>${new Date(payout.requested_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        }

        html += '</tbody></table>';
        document.getElementById('payouts-table').innerHTML = html;
    } catch (error) {
        console.error('Error loading payouts:', error);
        document.getElementById('payouts-table').innerHTML = '<div class="loading">Error loading payouts</div>';
    }
}

function selectPeriod(period) {
    currentPeriod = period;
    document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadRevenue();
}

async function loadRevenue() {
    try {
        const response = await fetch(`/api/accounting/revenue-summary?period=${currentPeriod}`);
        const data = await response.json();

        const html = `
            <div class="stat-card">
                <h3>Platform Revenue</h3>
                <div class="value">RM ${data.revenue.total.toFixed(2)}</div>
                <div class="label">${data.revenue.transaction_count} transactions</div>
            </div>
            <div class="stat-card">
                <h3>Total Transaction Volume</h3>
                <div class="value">RM ${data.revenue.total_transaction_amount.toFixed(2)}</div>
                <div class="label">Gross Amount</div>
            </div>
            <div class="stat-card">
                <h3>Invoices Paid</h3>
                <div class="value">RM ${data.invoices.total.toFixed(2)}</div>
                <div class="label">${data.invoices.count} invoices</div>
            </div>
            <div class="stat-card">
                <h3>Payouts Completed</h3>
                <div class="value">RM ${data.payouts.total.toFixed(2)}</div>
                <div class="label">${data.payouts.count} payouts</div>
            </div>
        `;

        document.getElementById('revenue-stats').innerHTML = html;
    } catch (error) {
        console.error('Error loading revenue:', error);
        document.getElementById('revenue-stats').innerHTML = '<div class="loading">Error loading revenue</div>';
    }
}

async function loadRoles() {
    try {
        const response = await fetch('/api/accounting/user-roles');
        const data = await response.json();

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Permissions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (data.users.length === 0) {
            html += '<tr><td colspan="5" style="text-align: center;">No admin users found</td></tr>';
        } else {
            data.users.forEach(user => {
                const role = user.admin_role || 'none';
                const isSuperAdmin = role === 'super_admin';
                html += `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.email}</td>
                        <td>${role}</td>
                        <td>${user.admin_permissions || 'N/A'}</td>
                        <td>
                            <button onclick="editRole(${user.id}, '${user.username}', '${role}')"
                                    style="padding: 6px 12px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                Edit
                            </button>
                            ${isSuperAdmin ? '' : `
                            <button onclick="removeUser(${user.id}, '${user.username}')"
                                    style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Remove
                            </button>
                            `}
                        </td>
                    </tr>
                `;
            });
        }

        html += '</tbody></table>';
        document.getElementById('roles-table').innerHTML = html;
    } catch (error) {
        console.error('Error loading roles:', error);
        document.getElementById('roles-table').innerHTML = '<div class="loading">Error loading roles</div>';
    }
}

function editRole(userId, username, currentRole) {
    const newRole = prompt(`Change role for ${username}.\n\nAvailable roles:\n- super_admin\n- billing\n- moderator\n- (leave empty to remove role)\n\nCurrent role: ${currentRole}`, currentRole);

    if (newRole === null) return; // User cancelled

    updateUserRole(userId, newRole || null);
}

async function updateUserRole(userId, role) {
    try {
        const response = await fetch(`/api/accounting/user-roles/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                admin_role: role,
                admin_permissions: role === 'super_admin' ? '["*"]' : null
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('Role updated successfully!');
            loadRoles();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error updating role:', error);
        alert('Failed to update role');
    }
}

async function removeUser(userId, username) {
    if (!confirm(`Are you sure you want to remove user "${username}" from the billing page?\n\nThis will remove their admin role and permissions. The user account will remain active.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/accounting/user-roles/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (response.ok) {
            alert('User removed from billing page successfully!');
            loadRoles();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error removing user:', error);
        alert('Failed to remove user from billing page');
    }
}

// ==================== FINANCIAL REPORTS FUNCTIONS ====================

let currentReportData = null;
let currentReportType = null;

async function handleReportTypeChange() {
    const reportType = document.getElementById('report-type').value;
    const userSelectionSection = document.getElementById('user-selection-section');
    const userSelectionLabel = document.getElementById('user-selection-label');
    const userSelect = document.getElementById('user-select');

    // Hide results when changing report type
    document.getElementById('report-results').style.display = 'none';

    if (reportType === 'worker') {
        userSelectionSection.style.display = 'block';
        userSelectionLabel.textContent = 'Select Worker';
        userSelect.innerHTML = '<option value="">Loading workers...</option>';

        try {
            const response = await fetch('/api/admin/reports/workers');
            const data = await response.json();

            userSelect.innerHTML = '<option value="">Select a worker...</option>';
            data.workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.username} (${worker.email}) - ${worker.completed_gigs} gigs, RM ${worker.total_earnings.toFixed(2)}`;
                userSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading workers:', error);
            userSelect.innerHTML = '<option value="">Error loading workers</option>';
        }
    } else if (reportType === 'client') {
        userSelectionSection.style.display = 'block';
        userSelectionLabel.textContent = 'Select Client';
        userSelect.innerHTML = '<option value="">Loading clients...</option>';

        try {
            const response = await fetch('/api/admin/reports/clients');
            const data = await response.json();

            userSelect.innerHTML = '<option value="">Select a client...</option>';
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.username} (${client.email}) - RM ${client.total_spent.toFixed(2)} spent`;
                userSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading clients:', error);
            userSelect.innerHTML = '<option value="">Error loading clients</option>';
        }
    } else {
        userSelectionSection.style.display = 'none';
    }
}

function setDateRange(range) {
    const now = new Date();
    const startDate = new Date();
    const endDate = new Date();

    switch (range) {
        case 'thisMonth':
            startDate.setDate(1);
            break;
        case 'lastMonth':
            startDate.setMonth(now.getMonth() - 1);
            startDate.setDate(1);
            endDate.setMonth(now.getMonth());
            endDate.setDate(0);
            break;
        case 'last3Months':
            startDate.setMonth(now.getMonth() - 3);
            break;
        case 'last6Months':
            startDate.setMonth(now.getMonth() - 6);
            break;
        case 'thisYear':
            startDate.setMonth(0);
            startDate.setDate(1);
            break;
    }

    document.getElementById('report-start-date').value = formatDate(startDate);
    document.getElementById('report-end-date').value = formatDate(endDate);
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

async function generateReport() {
    const reportType = document.getElementById('report-type').value;
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;
    const userId = document.getElementById('user-select').value;

    if (!reportType) {
        alert('Please select a report type');
        return;
    }

    if (!startDate || !endDate) {
        alert('Please select start and end dates');
        return;
    }

    if ((reportType === 'worker' || reportType === 'client') && !userId) {
        alert(`Please select a ${reportType}`);
        return;
    }

    // Show loading
    document.getElementById('report-loading').style.display = 'block';
    document.getElementById('report-results').style.display = 'none';

    try {
        let url = '';
        if (reportType === 'platform') {
            url = `/api/admin/reports/platform?start_date=${startDate}&end_date=${endDate}`;
        } else if (reportType === 'worker') {
            url = `/api/admin/reports/worker/${userId}?start_date=${startDate}&end_date=${endDate}`;
        } else if (reportType === 'client') {
            url = `/api/admin/reports/client/${userId}?start_date=${startDate}&end_date=${endDate}`;
        } else if (reportType === 'socso') {
            const start = new Date(startDate);
            const year = start.getFullYear();
            url = `/api/admin/socso/monthly-report?year=${year}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate report');
        }

        currentReportData = data;
        currentReportType = reportType;

        // Hide loading
        document.getElementById('report-loading').style.display = 'none';
        document.getElementById('report-results').style.display = 'block';

        // Hide all report sections
        document.getElementById('platform-report').style.display = 'none';
        document.getElementById('worker-report').style.display = 'none';
        document.getElementById('client-report').style.display = 'none';
        document.getElementById('socso-report').style.display = 'none';

        // Display the appropriate report
        if (reportType === 'platform') {
            displayPlatformReport(data);
        } else if (reportType === 'worker') {
            displayWorkerReport(data);
        } else if (reportType === 'client') {
            displayClientReport(data);
        } else if (reportType === 'socso') {
            displaySOSCOReport(data);
        }
    } catch (error) {
        console.error('Error generating report:', error);
        alert(error.message || 'Failed to generate report');
        document.getElementById('report-loading').style.display = 'none';
    }
}

function displayPlatformReport(data) {
    document.getElementById('report-title').textContent = 'Platform Financial Report';
    document.getElementById('platform-report').style.display = 'block';

    document.getElementById('platform-period').textContent =
        `${data.period.start_date} to ${data.period.end_date}`;

    document.getElementById('platform-total-revenue').textContent =
        `RM ${data.overview.total_revenue.toFixed(2)}`;
    document.getElementById('platform-new-users').textContent = data.overview.new_users;
    document.getElementById('platform-gigs-completed').textContent = data.overview.gigs_completed;

    document.getElementById('platform-tx-count').textContent = data.transactions.total_count;
    document.getElementById('platform-tx-amount').textContent =
        `RM ${data.transactions.total_amount.toFixed(2)}`;
    document.getElementById('platform-tx-commission').textContent =
        `RM ${data.transactions.total_commission.toFixed(2)}`;
    document.getElementById('platform-tx-net').textContent =
        `RM ${data.transactions.total_net_amount.toFixed(2)}`;

    document.getElementById('platform-escrow-funded').textContent =
        `RM ${data.escrow.funded_amount.toFixed(2)}`;
    document.getElementById('platform-escrow-funded-count').textContent =
        `${data.escrow.funded_count} escrows`;
    document.getElementById('platform-escrow-released').textContent =
        `RM ${data.escrow.released_amount.toFixed(2)}`;
    document.getElementById('platform-escrow-released-count').textContent =
        `${data.escrow.released_count} escrows`;
    document.getElementById('platform-escrow-fees').textContent =
        `RM ${data.escrow.platform_fees.toFixed(2)}`;

    document.getElementById('platform-payout-count').textContent = data.payouts.total_count;
    document.getElementById('platform-payout-amount').textContent =
        `RM ${data.payouts.total_amount.toFixed(2)}`;
    document.getElementById('platform-payout-fees').textContent =
        `RM ${data.payouts.total_fees.toFixed(2)}`;

    const pmContainer = document.getElementById('platform-payment-methods');
    pmContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Payment Methods</h4>';

    if (Object.keys(data.transactions.payment_methods).length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Payment Method</th>
                    <th>Transactions</th>
                    <th>Amount</th>
                    <th>Commission</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(data.transactions.payment_methods).map(([method, stats]) => `
                    <tr>
                        <td style="text-transform: capitalize;">${method}</td>
                        <td>${stats.count}</td>
                        <td>RM ${stats.amount.toFixed(2)}</td>
                        <td>RM ${stats.commission.toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        pmContainer.appendChild(table);
    } else {
        pmContainer.innerHTML += '<p style="color: var(--text-gray);">No payment data available</p>';
    }

    const ctContainer = document.getElementById('platform-commission-tiers');
    ctContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Commission Breakdown by Tier</h4>';

    const tiersGrid = document.createElement('div');
    tiersGrid.className = 'stats-grid';
    tiersGrid.innerHTML = `
        <div class="stat-card">
            <h3>15% Tier (â‰¤RM 500)</h3>
            <div class="value">${data.transactions.commission_breakdown.tier_15_percent.count}</div>
            <div class="label">RM ${data.transactions.commission_breakdown.tier_15_percent.commission.toFixed(2)} commission</div>
        </div>
        <div class="stat-card">
            <h3>10% Tier (RM 501-2000)</h3>
            <div class="value">${data.transactions.commission_breakdown.tier_10_percent.count}</div>
            <div class="label">RM ${data.transactions.commission_breakdown.tier_10_percent.commission.toFixed(2)} commission</div>
        </div>
        <div class="stat-card">
            <h3>5% Tier (>RM 2000)</h3>
            <div class="value">${data.transactions.commission_breakdown.tier_5_percent.count}</div>
            <div class="label">RM ${data.transactions.commission_breakdown.tier_5_percent.commission.toFixed(2)} commission</div>
        </div>
    `;
    ctContainer.appendChild(tiersGrid);
}

function displayWorkerReport(data) {
    document.getElementById('report-title').textContent = 'Worker Financial Report';
    document.getElementById('worker-report').style.display = 'block';

    document.getElementById('worker-name').textContent = data.worker.username;
    document.getElementById('worker-email').textContent = data.worker.email;
    document.getElementById('worker-period').textContent =
        `${data.period.start_date} to ${data.period.end_date}`;

    document.getElementById('worker-balance').textContent =
        `RM ${data.wallet.current_balance.toFixed(2)}`;
    document.getElementById('worker-held').textContent =
        `RM ${data.wallet.held_balance.toFixed(2)}`;
    document.getElementById('worker-total-earned').textContent =
        `RM ${data.wallet.total_earned.toFixed(2)}`;

    document.getElementById('worker-earned').textContent =
        `RM ${data.earnings.total_earned.toFixed(2)}`;
    document.getElementById('worker-commission').textContent =
        `RM ${data.earnings.total_commission_paid.toFixed(2)}`;
    document.getElementById('worker-tx-count').textContent = data.earnings.transaction_count;
    document.getElementById('worker-escrow').textContent =
        `RM ${data.earnings.escrow_released.toFixed(2)}`;

    document.getElementById('worker-gigs-completed').textContent = data.gigs.completed_count;
    document.getElementById('worker-gigs-progress').textContent = data.gigs.in_progress_count;

    const gigContainer = document.getElementById('worker-gig-details');
    gigContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Completed Gigs</h4>';

    if (data.gigs.gig_details.length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Gig ID</th>
                    <th>Title</th>
                    <th>Budget</th>
                    <th>Earned</th>
                    <th>Commission</th>
                    <th>Completed</th>
                </tr>
            </thead>
            <tbody>
                ${data.gigs.gig_details.map(gig => `
                    <tr>
                        <td>${gig.gig_id}</td>
                        <td>${gig.title}</td>
                        <td>RM ${gig.budget.toFixed(2)}</td>
                        <td>RM ${gig.earned.toFixed(2)}</td>
                        <td>RM ${gig.commission.toFixed(2)}</td>
                        <td>${gig.completed_at || 'N/A'}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        gigContainer.appendChild(table);
    } else {
        gigContainer.innerHTML += '<p style="color: var(--text-gray);">No completed gigs in this period</p>';
    }

    const payoutContainer = document.getElementById('worker-payout-details');
    payoutContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Payouts</h4>';

    if (data.payouts.payout_details.length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Payout #</th>
                    <th>Amount</th>
                    <th>Fee</th>
                    <th>Net Amount</th>
                    <th>Method</th>
                    <th>Completed</th>
                </tr>
            </thead>
            <tbody>
                ${data.payouts.payout_details.map(payout => `
                    <tr>
                        <td>${payout.payout_number}</td>
                        <td>RM ${payout.amount.toFixed(2)}</td>
                        <td>RM ${payout.fee.toFixed(2)}</td>
                        <td>RM ${payout.net_amount.toFixed(2)}</td>
                        <td style="text-transform: capitalize;">${payout.payment_method}</td>
                        <td>${payout.completed_at || 'N/A'}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        payoutContainer.appendChild(table);
    } else {
        payoutContainer.innerHTML += '<p style="color: var(--text-gray);">No payouts in this period</p>';
    }
}

function displayClientReport(data) {
    document.getElementById('report-title').textContent = 'Client Spending Report';
    document.getElementById('client-report').style.display = 'block';

    document.getElementById('client-name').textContent = data.client.username;
    document.getElementById('client-email').textContent = data.client.email;
    document.getElementById('client-period').textContent =
        `${data.period.start_date} to ${data.period.end_date}`;

    document.getElementById('client-balance').textContent =
        `RM ${data.wallet.current_balance.toFixed(2)}`;
    document.getElementById('client-total-spent').textContent =
        `RM ${data.wallet.total_spent.toFixed(2)}`;

    document.getElementById('client-spent').textContent =
        `RM ${data.spending.total_spent.toFixed(2)}`;
    document.getElementById('client-commission').textContent =
        `RM ${data.spending.total_commission.toFixed(2)}`;
    document.getElementById('client-tx-count').textContent = data.spending.transaction_count;

    document.getElementById('client-gigs-total').textContent = data.gigs.total_count;
    document.getElementById('client-gigs-completed').textContent = data.gigs.completed_count;
    document.getElementById('client-gigs-active').textContent = data.gigs.active_count;

    document.getElementById('client-escrow-funded').textContent =
        `RM ${data.escrow.total_funded.toFixed(2)}`;
    document.getElementById('client-escrow-funded-count').textContent =
        `${data.escrow.funded_count} escrows`;
    document.getElementById('client-escrow-pending').textContent =
        `RM ${data.escrow.pending_amount.toFixed(2)}`;

    const pmContainer = document.getElementById('client-payment-methods');
    pmContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Payment Methods Used</h4>';

    if (Object.keys(data.spending.payment_methods).length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Payment Method</th>
                    <th>Transactions</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(data.spending.payment_methods).map(([method, stats]) => `
                    <tr>
                        <td style="text-transform: capitalize;">${method}</td>
                        <td>${stats.count}</td>
                        <td>RM ${stats.amount.toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        pmContainer.appendChild(table);
    } else {
        pmContainer.innerHTML += '<p style="color: var(--text-gray);">No payment data available</p>';
    }

    const gigContainer = document.getElementById('client-gig-details');
    gigContainer.innerHTML = '<h4 style="color: var(--text-gray); margin: 20px 0 12px 0;">Gigs</h4>';

    if (data.gigs.gig_details.length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Gig ID</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Budget</th>
                    <th>Spent</th>
                    <th>Commission</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody>
                ${data.gigs.gig_details.map(gig => `
                    <tr>
                        <td>${gig.gig_id}</td>
                        <td>${gig.title}</td>
                        <td><span class="badge badge-${gig.status}">${gig.status}</span></td>
                        <td>RM ${gig.budget.toFixed(2)}</td>
                        <td>RM ${gig.spent.toFixed(2)}</td>
                        <td>RM ${gig.commission.toFixed(2)}</td>
                        <td>${gig.created_at || 'N/A'}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        gigContainer.appendChild(table);
    } else {
        gigContainer.innerHTML += '<p style="color: var(--text-gray);">No gigs in this period</p>';
    }
}

function displaySOSCOReport(data) {
    document.getElementById('report-title').textContent = 'SOCSO Payout Report';
    document.getElementById('socso-report').style.display = 'block';

    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;
    document.getElementById('socso-period').textContent = `${startDate} to ${endDate}`;

    document.getElementById('socso-total-freelancers').textContent = data.totals.total_freelancers;
    document.getElementById('socso-total-transactions').textContent = data.totals.total_transactions;
    document.getElementById('socso-total-amount').textContent =
        `RM ${data.totals.total_socso_amount.toFixed(2)}`;
    document.getElementById('socso-total-earnings').textContent =
        `RM ${data.totals.total_net_earnings.toFixed(2)}`;

    const tableContainer = document.getElementById('socso-details-table');
    tableContainer.innerHTML = '';

    if (data.report.length > 0) {
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Freelancer</th>
                    <th>IC Number</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Transactions</th>
                    <th>Net Earnings</th>
                    <th>SOCSO Amount</th>
                    <th>Final Payout</th>
                    <th>Remitted</th>
                </tr>
            </thead>
            <tbody>
                ${data.report.map(record => `
                    <tr>
                        <td>${record.contribution_month}</td>
                        <td>${record.full_name}</td>
                        <td>${record.ic_number || 'N/A'}</td>
                        <td>${record.email}</td>
                        <td>${record.phone || 'N/A'}</td>
                        <td>${record.transaction_count}</td>
                        <td>RM ${record.total_net_earnings.toFixed(2)}</td>
                        <td>RM ${record.total_socso_amount.toFixed(2)}</td>
                        <td>RM ${record.total_final_payout.toFixed(2)}</td>
                        <td>${record.all_remitted ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        tableContainer.appendChild(table);
    } else {
        tableContainer.innerHTML = '<p style="color: var(--text-gray); padding: 20px; text-align: center;">No SOCSO contributions in this period</p>';
    }
}

function exportReportToCSV() {
    if (!currentReportData || !currentReportType) {
        alert('No report data to export');
        return;
    }

    let csvContent = '';
    let filename = '';

    if (currentReportType === 'platform') {
        filename = `platform_report_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
        csvContent = 'Platform Financial Report\n\n';
        csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

        csvContent += 'Overview\n';
        csvContent += `Total Revenue,${currentReportData.overview.total_revenue}\n`;
        csvContent += `New Users,${currentReportData.overview.new_users}\n`;
        csvContent += `Completed Gigs,${currentReportData.overview.gigs_completed}\n\n`;

        csvContent += 'Transactions\n';
        csvContent += `Total Count,${currentReportData.transactions.total_count}\n`;
        csvContent += `Total Amount,${currentReportData.transactions.total_amount}\n`;
        csvContent += `Total Commission,${currentReportData.transactions.total_commission}\n`;
        csvContent += `Net to Workers,${currentReportData.transactions.total_net_amount}\n\n`;

        csvContent += 'Payment Methods\n';
        csvContent += 'Method,Count,Amount,Commission\n';
        Object.entries(currentReportData.transactions.payment_methods).forEach(([method, stats]) => {
            csvContent += `${method},${stats.count},${stats.amount},${stats.commission}\n`;
        });
    } else if (currentReportType === 'worker') {
        filename = `worker_report_${currentReportData.worker.username}_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
        csvContent = 'Worker Financial Report\n\n';
        csvContent += `Worker,${currentReportData.worker.username}\n`;
        csvContent += `Email,${currentReportData.worker.email}\n`;
        csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

        csvContent += 'Wallet Status\n';
        csvContent += `Current Balance,${currentReportData.wallet.current_balance}\n`;
        csvContent += `Held Balance,${currentReportData.wallet.held_balance}\n`;
        csvContent += `Lifetime Earnings,${currentReportData.wallet.total_earned}\n\n`;

        csvContent += 'Period Earnings\n';
        csvContent += `Total Earned,${currentReportData.earnings.total_earned}\n`;
        csvContent += `Commission Paid,${currentReportData.earnings.total_commission_paid}\n`;
        csvContent += `Transaction Count,${currentReportData.earnings.transaction_count}\n\n`;

        csvContent += 'Completed Gigs\n';
        csvContent += 'Gig ID,Title,Budget,Earned,Commission,Completed\n';
        currentReportData.gigs.gig_details.forEach(gig => {
            csvContent += `${gig.gig_id},"${gig.title}",${gig.budget},${gig.earned},${gig.commission},${gig.completed_at || 'N/A'}\n`;
        });
    } else if (currentReportType === 'client') {
        filename = `client_report_${currentReportData.client.username}_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
        csvContent = 'Client Spending Report\n\n';
        csvContent += `Client,${currentReportData.client.username}\n`;
        csvContent += `Email,${currentReportData.client.email}\n`;
        csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

        csvContent += 'Wallet Status\n';
        csvContent += `Current Balance,${currentReportData.wallet.current_balance}\n`;
        csvContent += `Lifetime Spent,${currentReportData.wallet.total_spent}\n\n`;

        csvContent += 'Period Spending\n';
        csvContent += `Total Spent,${currentReportData.spending.total_spent}\n`;
        csvContent += `Commission Paid,${currentReportData.spending.total_commission}\n`;
        csvContent += `Transaction Count,${currentReportData.spending.transaction_count}\n\n`;

        csvContent += 'Gigs\n';
        csvContent += 'Gig ID,Title,Status,Budget,Spent,Commission,Created\n';
        currentReportData.gigs.gig_details.forEach(gig => {
            csvContent += `${gig.gig_id},"${gig.title}",${gig.status},${gig.budget},${gig.spent},${gig.commission},${gig.created_at || 'N/A'}\n`;
        });
    } else if (currentReportType === 'socso') {
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        filename = `socso_report_${startDate}_to_${endDate}.csv`;
        csvContent = 'SOCSO Payout Report\n\n';
        csvContent += `Period,${startDate} to ${endDate}\n\n`;

        csvContent += 'Summary\n';
        csvContent += `Total Freelancers,${currentReportData.totals.total_freelancers}\n`;
        csvContent += `Total Transactions,${currentReportData.totals.total_transactions}\n`;
        csvContent += `Total Net Earnings,${currentReportData.totals.total_net_earnings}\n`;
        csvContent += `Total SOCSO Amount,${currentReportData.totals.total_socso_amount}\n`;
        csvContent += `Total Final Payout,${currentReportData.totals.total_final_payout}\n\n`;

        csvContent += 'Freelancer Breakdown\n';
        csvContent += 'Month,Freelancer,IC Number,Email,Phone,Transactions,Net Earnings,SOCSO Amount,Final Payout,Remitted\n';
        currentReportData.report.forEach(record => {
            csvContent += `${record.contribution_month},"${record.full_name}",${record.ic_number || 'N/A'},${record.email},${record.phone || 'N/A'},${record.transaction_count},${record.total_net_earnings.toFixed(2)},${record.total_socso_amount.toFixed(2)},${record.total_final_payout.toFixed(2)},${record.all_remitted ? 'Yes' : 'No'}\n`;
        });
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Load overview on page load
document.addEventListener('DOMContentLoaded', () => {
    loadOverview();
});
</script>
{% endblock %}
