{% extends "base.html" %}

{% block title %}Browse Workers{% endblock %}

{% block extra_styles %}
<style>
    .workers-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    .filters-bar {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
    }

    .filters-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 180px;
    }

    .filter-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .filter-input, .filter-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        background: white;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .rate-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .rate-inputs input {
        flex: 1;
    }

    .search-btn {
        padding: 10px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: opacity 0.2s;
    }

    .search-btn:hover {
        opacity: 0.9;
    }

    .search-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .advanced-filters {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        display: none;
    }

    .advanced-filters.show {
        display: block;
    }

    .toggle-filters-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 12px;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .results-count {
        font-size: 16px;
        color: var(--text-gray);
    }

    .sort-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .workers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .worker-card {
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .worker-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .worker-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .worker-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--text-gray);
        flex-shrink: 0;
    }

    .worker-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .worker-info {
        flex: 1;
        min-width: 0;
    }

    .worker-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .verified-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: #2e7d32;
        color: white;
        border-radius: 50%;
        font-size: 10px;
    }

    .worker-location {
        font-size: 14px;
        color: var(--text-gray);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .worker-rating {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: var(--text-gray);
        margin-top: 4px;
    }

    .rating-stars {
        color: #f59e0b;
    }

    .worker-bio {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        margin-bottom: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .worker-specializations {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
        flex-grow: 1;
    }

    .specialization-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--text-dark);
    }

    .specialization-tag .rate {
        color: var(--primary);
        font-weight: 600;
    }

    .worker-stats {
        display: flex;
        gap: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        margin-top: auto;
    }

    .stat-item {
        text-align: center;
        flex: 1;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .stat-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
    }

    .rate-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #e8f5e9;
        color: #2e7d32;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
    }

    .rate-badge.hourly {
        background: #e3f2fd;
        color: #1565c0;
    }

    .rate-badge.fixed {
        background: #fff3e0;
        color: #e65100;
    }

    .load-more-section {
        text-align: center;
        margin-top: 32px;
    }

    .load-more-btn {
        padding: 12px 32px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .load-more-btn:hover {
        opacity: 0.9;
    }

    .load-more-info {
        margin-top: 12px;
        font-size: 14px;
        color: var(--text-gray);
    }

    .error-message, .empty-state {
        grid-column: 1/-1;
        text-align: center;
        padding: 60px 20px;
    }

    .error-message {
        background: #fee;
        color: #c33;
        border-radius: var(--radius-md);
        border: 1px solid #fcc;
    }

    .empty-state {
        color: var(--text-gray);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .checkbox-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--text-dark);
        cursor: pointer;
    }

    .checkbox-filter input {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    /* ============ WORKER DETAIL MODAL ============ */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .modal-overlay.open {
        display: flex;
    }

    .worker-modal {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 640px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 24px 24px 20px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--bg-white);
        z-index: 1;
    }

    .modal-close-btn {
        margin-left: auto;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-gray);
        padding: 4px;
        border-radius: 4px;
        flex-shrink: 0;
        line-height: 1;
        font-size: 22px;
    }

    .modal-close-btn:hover {
        background: var(--bg-light);
        color: var(--text-dark);
    }

    .modal-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        font-weight: 700;
        color: var(--primary);
        flex-shrink: 0;
        overflow: hidden;
    }

    .modal-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .modal-worker-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .modal-meta {
        font-size: 14px;
        color: var(--text-gray);
        margin-top: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .modal-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .modal-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .modal-section-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .modal-bio {
        font-size: 15px;
        color: var(--text-gray);
        line-height: 1.7;
    }

    .modal-skills-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .skill-card {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        background: var(--bg-light);
    }

    .skill-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
    }

    .skill-card-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .skill-card-category {
        font-size: 12px;
        color: var(--text-gray);
        background: white;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 2px 10px;
        white-space: nowrap;
    }

    .skill-rates {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 8px;
    }

    .skill-rate-pill {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .skill-rate-pill.hourly {
        background: #e3f2fd;
        color: #1565c0;
    }

    .skill-rate-pill.fixed {
        background: #fff3e0;
        color: #e65100;
    }

    .skill-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .skill-tag {
        font-size: 12px;
        background: white;
        border: 1px solid var(--border);
        color: var(--text-dark);
        padding: 3px 10px;
        border-radius: 20px;
    }

    .modal-stats-row {
        display: flex;
        gap: 0;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .modal-stat {
        flex: 1;
        text-align: center;
        padding: 14px 8px;
        border-right: 1px solid var(--border);
    }

    .modal-stat:last-child {
        border-right: none;
    }

    .modal-stat-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .modal-stat-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
        margin-top: 2px;
    }

    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--border);
        background: var(--bg-white);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message-compose {
        display: none;
        flex-direction: column;
        gap: 10px;
    }

    .message-compose.open {
        display: flex;
    }

    .message-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 90px;
        box-sizing: border-box;
    }

    .message-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-message {
        flex: 1;
        padding: 12px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .btn-message:hover {
        opacity: 0.9;
    }

    .btn-message:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-profile {
        flex: 1;
        padding: 12px 20px;
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }

    .btn-profile:hover {
        background: var(--bg-light);
    }

    .btn-send-msg {
        padding: 10px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .btn-send-msg:hover { opacity: 0.9; }
    .btn-send-msg:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-cancel-msg {
        padding: 10px 16px;
        background: none;
        color: var(--text-gray);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
    }

    .message-compose-row {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .halal-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #e8f5e9;
        color: #2e7d32;
        border-radius: 20px;
        padding: 2px 10px;
        font-size: 12px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="workers-container">
    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Cari Pekerja</label>
                <input type="text" class="filter-input" placeholder="Nama, kemahiran, kepakaran..." id="searchInput">
            </div>

            <div class="filter-group">
                <label class="filter-label">Kategori</label>
                <select class="filter-select" id="categorySelect">
                    <option value="">Semua Kategori</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Kadar Sejam (RM)</label>
                <div class="rate-inputs">
                    <input type="number" class="filter-input" placeholder="Min" id="rateMin">
                    <span>-</span>
                    <input type="number" class="filter-input" placeholder="Maks" id="rateMax">
                </div>
            </div>

            <div class="filter-group" style="flex: 0;">
                <button class="search-btn" id="searchBtn" onclick="loadWorkers()">Cari Pekerja</button>
            </div>
        </div>

        <button class="toggle-filters-btn" onclick="toggleAdvancedFilters()">
            <i data-feather="sliders"></i>
            <span id="toggleFiltersText">Tunjuk Lebih Penapis</span>
        </button>

        <div class="advanced-filters" id="advancedFilters">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Kadar Tetap (RM)</label>
                    <div class="rate-inputs">
                        <input type="number" class="filter-input" placeholder="Min" id="fixedRateMin">
                        <span>-</span>
                        <input type="number" class="filter-input" placeholder="Maks" id="fixedRateMax">
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Penilaian Min</label>
                    <select class="filter-select" id="minRating">
                        <option value="">Semua Penilaian</option>
                        <option value="4.5">4.5+ Bintang</option>
                        <option value="4">4+ Bintang</option>
                        <option value="3.5">3.5+ Bintang</option>
                        <option value="3">3+ Bintang</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Location</label>
                    <input type="text" class="filter-input" placeholder="City or area..." id="locationInput">
                </div>

                <div class="filter-group" style="min-width: 140px;">
                    <label class="filter-label">&nbsp;</label>
                    <label class="checkbox-filter">
                        <input type="checkbox" id="verifiedOnly">
                        Verified Only
                    </label>
                </div>

                <div class="filter-group" style="min-width: 140px;">
                    <label class="filter-label">&nbsp;</label>
                    <label class="checkbox-filter">
                        <input type="checkbox" id="hasRatesOnly">
                        With Rates Only
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Header -->
    <div class="results-header">
        <div class="results-count">
            <strong id="resultCount">0</strong> pekerja dijumpai
        </div>
        <div>
            <label style="margin-right: 8px; font-size: 14px; color: var(--text-gray);">Susun:</label>
            <select class="sort-select" id="sortSelect" onchange="loadWorkers()">
                <option value="rating" selected>Penilaian Tertinggi</option>
                <option value="jobs">Pekerjaan Terbanyak</option>
                <option value="rate_low">Kadar: Rendah ke Tinggi</option>
                <option value="rate_high">Kadar: Tinggi ke Rendah</option>
                <option value="newest">Terbaru</option>
            </select>
        </div>
    </div>

    <!-- Workers Grid -->
    <div class="workers-grid" id="workersGrid">
        <div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>
    </div>

    <!-- Load More -->
    <div class="load-more-section" id="loadMoreSection" style="display: none;">
        <button class="load-more-btn" onclick="loadMore()">Load More</button>
        <div class="load-more-info">
            Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> workers
        </div>
    </div>
</div>

<!-- Worker Detail Modal -->
<div class="modal-overlay" id="workerModalOverlay" onclick="handleOverlayClick(event)">
    <div class="worker-modal" id="workerModal">
        <div class="modal-header">
            <div class="modal-avatar" id="modalAvatar"></div>
            <div style="flex:1; min-width:0;">
                <div class="modal-worker-name" id="modalName"></div>
                <div class="modal-meta" id="modalMeta"></div>
            </div>
            <button class="modal-close-btn" onclick="closeWorkerModal()" aria-label="Close">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Stats row -->
            <div class="modal-stats-row">
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalJobs">0</div>
                    <div class="modal-stat-label">Jobs Done</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalReviews">0</div>
                    <div class="modal-stat-label">Reviews</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" id="modalRating">-</div>
                    <div class="modal-stat-label">Rating</div>
                </div>
            </div>

            <!-- Bio section -->
            <div id="modalBioSection">
                <div class="modal-section-title">About</div>
                <div class="modal-bio" id="modalBio"></div>
            </div>

            <!-- Skills & Rates section -->
            <div id="modalSkillsSection">
                <div class="modal-section-title">Skills &amp; Going Rates</div>
                <div class="modal-skills-grid" id="modalSkillsGrid"></div>
            </div>
        </div>

        <div class="modal-footer">
            <!-- Message compose area (hidden until button clicked) -->
            <div class="message-compose" id="messageCompose">
                <textarea class="message-textarea" id="messageText" placeholder="Write your message..."></textarea>
                <div class="message-compose-row">
                    <button class="btn-cancel-msg" onclick="cancelMessage()">Cancel</button>
                    <button class="btn-send-msg" id="sendMsgBtn" onclick="sendMessage()">Send Message</button>
                </div>
            </div>
            <!-- Action buttons -->
            <div class="modal-actions" id="modalActions">
                <button class="btn-message" id="openMessageBtn" onclick="openMessageCompose()">
                    &#9993; Message Worker
                </button>
                <a class="btn-profile" id="viewProfileBtn" href="#">View Full Profile</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============ STATE MANAGEMENT ============
    let allWorkers = [];
    let allCategories = [];
    let currentPage = 1;
    let totalWorkers = 0;
    const pageSize = 12;

    // ============ INITIALIZATION ============
    async function init() {
        try {
            await loadCategories();
            loadURLParams();
            await loadWorkers();
            feather.replace();
        } catch (error) {
            console.error('Initialization error:', error);
            showError('Failed to initialize page. Please refresh.');
        }
    }

    // ============ TOGGLE ADVANCED FILTERS ============
    function toggleAdvancedFilters() {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleText = document.getElementById('toggleFiltersText');
        advancedFilters.classList.toggle('show');
        toggleText.textContent = advancedFilters.classList.contains('show') ? 'Sembunyikan Penapis' : 'Tunjuk Lebih Penapis';
    }

    // ============ LOAD CATEGORIES FROM API ============
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) throw new Error('Failed to fetch categories');

            allCategories = await response.json();

            const categorySelect = document.getElementById('categorySelect');
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // ============ LOAD URL PARAMETERS ============
    function loadURLParams() {
        const urlParams = new URLSearchParams(window.location.search);

        const category = urlParams.get('category');
        if (category) {
            document.getElementById('categorySelect').value = category;
        }

        const search = urlParams.get('q');
        if (search) {
            document.getElementById('searchInput').value = search;
        }

        const skill = urlParams.get('skill');
        if (skill) {
            document.getElementById('searchInput').value = skill;
        }
    }

    // ============ LOAD WORKERS FROM API ============
    async function loadWorkers(append = false) {
        const searchBtn = document.getElementById('searchBtn');
        const workersGrid = document.getElementById('workersGrid');

        try {
            searchBtn.disabled = true;
            searchBtn.textContent = 'Mencari...';

            if (!append) {
                workersGrid.innerHTML = '<div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>';
                currentPage = 1;
            }

            // Build API URL with parameters
            const params = new URLSearchParams();

            const search = document.getElementById('searchInput').value.trim();
            if (search) params.append('q', search);

            const category = document.getElementById('categorySelect').value;
            if (category) params.append('category_id', category);

            const rateMin = document.getElementById('rateMin').value;
            if (rateMin) params.append('min_rate', rateMin);

            const rateMax = document.getElementById('rateMax').value;
            if (rateMax) params.append('max_rate', rateMax);

            const fixedRateMin = document.getElementById('fixedRateMin').value;
            if (fixedRateMin) params.append('min_fixed_rate', fixedRateMin);

            const fixedRateMax = document.getElementById('fixedRateMax').value;
            if (fixedRateMax) params.append('max_fixed_rate', fixedRateMax);

            const minRating = document.getElementById('minRating').value;
            if (minRating) params.append('min_rating', minRating);

            const location = document.getElementById('locationInput').value.trim();
            if (location) params.append('location', location);

            const verifiedOnly = document.getElementById('verifiedOnly').checked;
            if (verifiedOnly) params.append('verified_only', 'true');

            const hasRatesOnly = document.getElementById('hasRatesOnly').checked;
            if (hasRatesOnly) params.append('has_rates', 'true');

            params.append('page', currentPage);
            params.append('limit', pageSize);

            const apiUrl = `/api/workers/search?${params.toString()}`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Failed to fetch workers');

            const data = await response.json();

            if (append) {
                allWorkers = [...allWorkers, ...data.workers];
            } else {
                allWorkers = data.workers;
            }
            totalWorkers = data.total;

            displayWorkers();

        } catch (error) {
            console.error('Error loading workers:', error);
            showError('Failed to load workers. Please try again.');
        } finally {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Cari Pekerja';
        }
    }

    // ============ DISPLAY WORKERS ============
    function displayWorkers() {
        const workersGrid = document.getElementById('workersGrid');
        const resultCount = document.getElementById('resultCount');

        resultCount.textContent = totalWorkers;

        if (allWorkers.length === 0) {
            workersGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë∑</div>
                    <h3>Tiada pekerja dijumpai</h3>
                    <p>Cuba laraskan penapis carian anda</p>
                </div>
            `;
            document.getElementById('loadMoreSection').style.display = 'none';
            return;
        }

        workersGrid.innerHTML = allWorkers.map(worker => renderWorkerCard(worker)).join('');

        // Update load more section
        document.getElementById('showingCount').textContent = allWorkers.length;
        document.getElementById('totalCount').textContent = totalWorkers;

        if (allWorkers.length < totalWorkers) {
            document.getElementById('loadMoreSection').style.display = 'block';
        } else {
            document.getElementById('loadMoreSection').style.display = 'none';
        }
    }

    // ============ RENDER WORKER CARD ============
    function renderWorkerCard(worker) {
        const displayName = worker.name || worker.full_name || worker.username || 'Worker';
        const avatarContent = worker.profile_picture
            ? `<img src="${worker.profile_picture}" alt="${escapeHtml(displayName)}">`
            : displayName.charAt(0).toUpperCase();

        // Format rating
        const rating = worker.rating || 0;
        const ratingStars = '‚òÖ'.repeat(Math.floor(rating)) + '‚òÜ'.repeat(5 - Math.floor(rating));

        // Format specializations with rates
        let specializationsHtml = '';
        if (worker.specializations && worker.specializations.length > 0) {
            specializationsHtml = worker.specializations.slice(0, 3).map(spec => {
                let rateHtml = '';
                if (spec.base_hourly_rate) {
                    rateHtml = `<span class="rate">RM${parseFloat(spec.base_hourly_rate).toFixed(0)}/jam</span>`;
                } else if (spec.base_fixed_rate) {
                    rateHtml = `<span class="rate">RM${parseFloat(spec.base_fixed_rate).toFixed(0)}</span>`;
                }
                return `<span class="specialization-tag">${escapeHtml(spec.skill_name || spec.category_name)}${rateHtml ? ' ¬∑ ' + rateHtml : ''}</span>`;
            }).join('');

            if (worker.specializations.length > 3) {
                specializationsHtml += `<span class="specialization-tag">+${worker.specializations.length - 3} more</span>`;
            }
        }

        // Format min rates for display
        let rateDisplay = '';
        if (worker.min_hourly_rate) {
            rateDisplay += `<span class="rate-badge hourly">From RM${parseFloat(worker.min_hourly_rate).toFixed(0)}/jam</span>`;
        }
        if (worker.min_fixed_rate) {
            rateDisplay += `<span class="rate-badge fixed">From RM${parseFloat(worker.min_fixed_rate).toFixed(0)}/gig</span>`;
        }

        const wid = worker.id || worker.worker_id;
        return `
            <div class="worker-card" onclick="openWorkerModalById(${wid})" style="cursor:pointer;">
                <div class="worker-header">
                    <div class="worker-avatar">
                        ${avatarContent}
                    </div>
                    <div class="worker-info">
                        <div class="worker-name">
                            ${escapeHtml(displayName)}
                            ${worker.is_verified ? '<span class="verified-badge">‚úì</span>' : ''}
                        </div>
                        ${worker.location ? `<div class="worker-location"><i data-feather="map-pin" style="width:14px;height:14px;"></i> ${escapeHtml(worker.location)}</div>` : ''}
                        <div class="worker-rating">
                            <span class="rating-stars">${ratingStars}</span>
                            <span>${rating.toFixed(1)} (${worker.total_reviews || 0} reviews)</span>
                        </div>
                    </div>
                </div>

                ${worker.bio ? `<div class="worker-bio">${escapeHtml(worker.bio)}</div>` : ''}

                <div class="worker-specializations">
                    ${specializationsHtml || '<span class="specialization-tag" style="color: var(--text-gray);">No specializations listed</span>'}
                </div>

                ${rateDisplay ? `<div style="margin-bottom: 16px;">${rateDisplay}</div>` : ''}

                <div class="worker-stats">
                    <div class="stat-item">
                        <div class="stat-value">${worker.completed_gigs || 0}</div>
                        <div class="stat-label">Jobs Done</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${worker.specializations ? worker.specializations.length : 0}</div>
                        <div class="stat-label">Skills</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${worker.response_rate ? worker.response_rate + '%' : '-'}</div>
                        <div class="stat-label">Response</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ============ LOAD MORE ============
    function loadMore() {
        currentPage++;
        loadWorkers(true);
    }

    // ============ SHOW ERROR ============
    function showError(message) {
        const workersGrid = document.getElementById('workersGrid');
        workersGrid.innerHTML = `
            <div class="error-message">
                <h3>Error</h3>
                <p>${escapeHtml(message)}</p>
                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #c33; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button>
            </div>
        `;
    }

    // ============ UTILITY FUNCTIONS ============
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============ WORKER DETAIL MODAL ============
    let activeWorkerId = null;

    function openWorkerModalById(workerId) {
        const worker = allWorkers.find(w => (w.id || w.worker_id) === workerId);
        if (worker) openWorkerModal(worker);
    }

    function openWorkerModal(worker) {
        activeWorkerId = worker.id || worker.worker_id;

        // Avatar
        const avatarEl = document.getElementById('modalAvatar');
        if (worker.profile_picture) {
            avatarEl.innerHTML = `<img src="${escapeHtml(worker.profile_picture)}" alt="${escapeHtml(worker.name || worker.full_name)}">`;
        } else {
            const initial = (worker.name || worker.full_name || '?').charAt(0).toUpperCase();
            avatarEl.textContent = initial;
        }

        // Name & badges
        const name = escapeHtml(worker.name || worker.full_name || worker.username || 'Worker');
        const verifiedBadge = worker.is_verified ? '<span class="verified-badge" title="Verified">‚úì</span>' : '';
        const halalBadge = worker.halal_verified ? '<span class="halal-badge">&#9670; Halal Verified</span>' : '';
        document.getElementById('modalName').innerHTML = `${name} ${verifiedBadge} ${halalBadge}`;

        // Meta row
        const rating = parseFloat(worker.rating || 0);
        const stars = '‚òÖ'.repeat(Math.floor(rating)) + '‚òÜ'.repeat(5 - Math.floor(rating));
        let metaHtml = `<span><span style="color:#f59e0b">${stars}</span> ${rating.toFixed(1)}</span>`;
        if (worker.location) metaHtml += `<span>üìç ${escapeHtml(worker.location)}</span>`;
        document.getElementById('modalMeta').innerHTML = metaHtml;

        // Stats
        document.getElementById('modalJobs').textContent = worker.completed_gigs || 0;
        document.getElementById('modalReviews').textContent = worker.total_reviews || worker.review_count || 0;
        document.getElementById('modalRating').textContent = rating.toFixed(1);

        // Bio
        const bioSection = document.getElementById('modalBioSection');
        const bio = worker.full_bio || worker.bio || '';
        if (bio) {
            document.getElementById('modalBio').textContent = bio;
            bioSection.style.display = '';
        } else {
            bioSection.style.display = 'none';
        }

        // Skills & Rates
        const skillsGrid = document.getElementById('modalSkillsGrid');
        const specs = worker.specializations || [];
        if (specs.length > 0) {
            skillsGrid.innerHTML = specs.map(spec => {
                const title = spec.specialization_title || spec.category_name || 'Skill';
                const category = spec.category_name || '';

                let ratesHtml = '';
                if (spec.base_hourly_rate) {
                    ratesHtml += `<span class="skill-rate-pill hourly">‚è± RM${parseFloat(spec.base_hourly_rate).toFixed(2)}/hr</span>`;
                }
                if (spec.base_fixed_rate) {
                    ratesHtml += `<span class="skill-rate-pill fixed">üìã RM${parseFloat(spec.base_fixed_rate).toFixed(2)}/gig</span>`;
                }
                if (!ratesHtml) {
                    ratesHtml = '<span style="font-size:13px;color:var(--text-gray);">Rate on request</span>';
                }

                const skillsList = Array.isArray(spec.skills) ? spec.skills : [];
                const tagsHtml = skillsList.length > 0
                    ? `<div class="skill-tags">${skillsList.map(s => `<span class="skill-tag">${escapeHtml(s)}</span>`).join('')}</div>`
                    : '';

                const premiumNote = spec.has_premium ? '<span style="font-size:12px;color:#7b1fa2;margin-left:6px;">‚òÖ Premium</span>' : '';

                return `
                    <div class="skill-card">
                        <div class="skill-card-header">
                            <span class="skill-card-title">${escapeHtml(title)}${premiumNote}</span>
                            ${category ? `<span class="skill-card-category">${escapeHtml(category)}</span>` : ''}
                        </div>
                        <div class="skill-rates">${ratesHtml}</div>
                        ${tagsHtml}
                    </div>`;
            }).join('');
            document.getElementById('modalSkillsSection').style.display = '';
        } else {
            document.getElementById('modalSkillsSection').style.display = 'none';
        }

        // Profile link
        document.getElementById('viewProfileBtn').href = `/profile/${worker.username || activeWorkerId}`;

        // Reset message compose
        cancelMessage();

        // Show modal
        document.getElementById('workerModalOverlay').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeWorkerModal() {
        document.getElementById('workerModalOverlay').classList.remove('open');
        document.body.style.overflow = '';
        activeWorkerId = null;
        cancelMessage();
    }

    function handleOverlayClick(event) {
        if (event.target === document.getElementById('workerModalOverlay')) {
            closeWorkerModal();
        }
    }

    function openMessageCompose() {
        document.getElementById('messageCompose').classList.add('open');
        document.getElementById('modalActions').style.display = 'none';
        document.getElementById('messageText').focus();
    }

    function cancelMessage() {
        document.getElementById('messageCompose').classList.remove('open');
        document.getElementById('modalActions').style.display = '';
        const ta = document.getElementById('messageText');
        if (ta) ta.value = '';
    }

    async function sendMessage() {
        const text = document.getElementById('messageText').value.trim();
        if (!text) {
            document.getElementById('messageText').focus();
            return;
        }
        if (!activeWorkerId) return;

        const sendBtn = document.getElementById('sendMsgBtn');
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';

        try {
            const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';
            const resp = await fetch('/api/messages/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ user_id: activeWorkerId, message: text })
            });

            const data = await resp.json();

            if (resp.ok && data.conversation_id) {
                window.location.href = `/messages/${data.conversation_id}`;
            } else if (resp.status === 401 || resp.status === 403) {
                window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
            } else {
                alert(data.error || 'Failed to send message. Please try again.');
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
            }
        } catch (err) {
            console.error('Send message error:', err);
            alert('Network error. Please try again.');
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send Message';
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeWorkerModal();
    });

    // ============ EVENT LISTENERS ============
    document.addEventListener('DOMContentLoaded', init);

    // Allow Enter key to trigger search
    ['searchInput', 'rateMin', 'rateMax', 'fixedRateMin', 'fixedRateMax', 'locationInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadWorkers();
            });
        }
    });

    // Reset pagination and reload when filters change
    ['categorySelect', 'minRating'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            currentPage = 1;
            loadWorkers();
        });
    });

    // Checkboxes
    ['verifiedOnly', 'hasRatesOnly'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            currentPage = 1;
            loadWorkers();
        });
    });
</script>
{% endblock %}
