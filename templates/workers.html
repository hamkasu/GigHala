{% extends "base.html" %}

{% block title %}Browse Workers{% endblock %}

{% block extra_styles %}
<style>
    .workers-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    .filters-bar {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
    }

    .filters-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 180px;
    }

    .filter-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .filter-input, .filter-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        background: white;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .rate-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .rate-inputs input {
        flex: 1;
    }

    .search-btn {
        padding: 10px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: opacity 0.2s;
    }

    .search-btn:hover {
        opacity: 0.9;
    }

    .search-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .advanced-filters {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        display: none;
    }

    .advanced-filters.show {
        display: block;
    }

    .toggle-filters-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 12px;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .results-count {
        font-size: 16px;
        color: var(--text-gray);
    }

    .sort-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .workers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .worker-card {
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .worker-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .worker-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .worker-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--text-gray);
        flex-shrink: 0;
    }

    .worker-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .worker-info {
        flex: 1;
        min-width: 0;
    }

    .worker-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .verified-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: #2e7d32;
        color: white;
        border-radius: 50%;
        font-size: 10px;
    }

    .worker-location {
        font-size: 14px;
        color: var(--text-gray);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .worker-rating {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: var(--text-gray);
        margin-top: 4px;
    }

    .rating-stars {
        color: #f59e0b;
    }

    .worker-bio {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        margin-bottom: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .worker-specializations {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
        flex-grow: 1;
    }

    .specialization-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--text-dark);
    }

    .specialization-tag .rate {
        color: var(--primary);
        font-weight: 600;
    }

    .worker-stats {
        display: flex;
        gap: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        margin-top: auto;
    }

    .stat-item {
        text-align: center;
        flex: 1;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .stat-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
    }

    .rate-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #e8f5e9;
        color: #2e7d32;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
    }

    .rate-badge.hourly {
        background: #e3f2fd;
        color: #1565c0;
    }

    .rate-badge.fixed {
        background: #fff3e0;
        color: #e65100;
    }

    .load-more-section {
        text-align: center;
        margin-top: 32px;
    }

    .load-more-btn {
        padding: 12px 32px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .load-more-btn:hover {
        opacity: 0.9;
    }

    .load-more-info {
        margin-top: 12px;
        font-size: 14px;
        color: var(--text-gray);
    }

    .error-message, .empty-state {
        grid-column: 1/-1;
        text-align: center;
        padding: 60px 20px;
    }

    .error-message {
        background: #fee;
        color: #c33;
        border-radius: var(--radius-md);
        border: 1px solid #fcc;
    }

    .empty-state {
        color: var(--text-gray);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .checkbox-filter {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--text-dark);
        cursor: pointer;
    }

    .checkbox-filter input {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="workers-container">
    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Search Workers</label>
                <input type="text" class="filter-input" placeholder="Name, skill, specialization..." id="searchInput">
            </div>

            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" id="categorySelect">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Hourly Rate (RM)</label>
                <div class="rate-inputs">
                    <input type="number" class="filter-input" placeholder="Min" id="rateMin">
                    <span>-</span>
                    <input type="number" class="filter-input" placeholder="Max" id="rateMax">
                </div>
            </div>

            <div class="filter-group" style="flex: 0;">
                <button class="search-btn" id="searchBtn" onclick="loadWorkers()">Search Workers</button>
            </div>
        </div>

        <button class="toggle-filters-btn" onclick="toggleAdvancedFilters()">
            <i data-feather="sliders"></i>
            <span id="toggleFiltersText">Show More Filters</span>
        </button>

        <div class="advanced-filters" id="advancedFilters">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Fixed Rate (RM)</label>
                    <div class="rate-inputs">
                        <input type="number" class="filter-input" placeholder="Min" id="fixedRateMin">
                        <span>-</span>
                        <input type="number" class="filter-input" placeholder="Max" id="fixedRateMax">
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Min Rating</label>
                    <select class="filter-select" id="minRating">
                        <option value="">Any Rating</option>
                        <option value="4.5">4.5+ Stars</option>
                        <option value="4">4+ Stars</option>
                        <option value="3.5">3.5+ Stars</option>
                        <option value="3">3+ Stars</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Location</label>
                    <input type="text" class="filter-input" placeholder="City or area..." id="locationInput">
                </div>

                <div class="filter-group" style="min-width: 140px;">
                    <label class="filter-label">&nbsp;</label>
                    <label class="checkbox-filter">
                        <input type="checkbox" id="verifiedOnly">
                        Verified Only
                    </label>
                </div>

                <div class="filter-group" style="min-width: 140px;">
                    <label class="filter-label">&nbsp;</label>
                    <label class="checkbox-filter">
                        <input type="checkbox" id="hasRatesOnly">
                        With Rates Only
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Header -->
    <div class="results-header">
        <div class="results-count">
            <strong id="resultCount">0</strong> workers found
        </div>
        <div>
            <label style="margin-right: 8px; font-size: 14px; color: var(--text-gray);">Sort by:</label>
            <select class="sort-select" id="sortSelect" onchange="loadWorkers()">
                <option value="rating" selected>Highest Rated</option>
                <option value="jobs">Most Jobs</option>
                <option value="rate_low">Rate: Low to High</option>
                <option value="rate_high">Rate: High to Low</option>
                <option value="newest">Newest</option>
            </select>
        </div>
    </div>

    <!-- Workers Grid -->
    <div class="workers-grid" id="workersGrid">
        <div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>
    </div>

    <!-- Load More -->
    <div class="load-more-section" id="loadMoreSection" style="display: none;">
        <button class="load-more-btn" onclick="loadMore()">Load More</button>
        <div class="load-more-info">
            Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> workers
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============ STATE MANAGEMENT ============
    let allWorkers = [];
    let allCategories = [];
    let currentPage = 1;
    let totalWorkers = 0;
    const pageSize = 12;

    // ============ INITIALIZATION ============
    async function init() {
        try {
            await loadCategories();
            loadURLParams();
            await loadWorkers();
            feather.replace();
        } catch (error) {
            console.error('Initialization error:', error);
            showError('Failed to initialize page. Please refresh.');
        }
    }

    // ============ TOGGLE ADVANCED FILTERS ============
    function toggleAdvancedFilters() {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleText = document.getElementById('toggleFiltersText');
        advancedFilters.classList.toggle('show');
        toggleText.textContent = advancedFilters.classList.contains('show') ? 'Hide Filters' : 'Show More Filters';
    }

    // ============ LOAD CATEGORIES FROM API ============
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) throw new Error('Failed to fetch categories');

            allCategories = await response.json();

            const categorySelect = document.getElementById('categorySelect');
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // ============ LOAD URL PARAMETERS ============
    function loadURLParams() {
        const urlParams = new URLSearchParams(window.location.search);

        const category = urlParams.get('category');
        if (category) {
            document.getElementById('categorySelect').value = category;
        }

        const search = urlParams.get('q');
        if (search) {
            document.getElementById('searchInput').value = search;
        }

        const skill = urlParams.get('skill');
        if (skill) {
            document.getElementById('searchInput').value = skill;
        }
    }

    // ============ LOAD WORKERS FROM API ============
    async function loadWorkers(append = false) {
        const searchBtn = document.getElementById('searchBtn');
        const workersGrid = document.getElementById('workersGrid');

        try {
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            if (!append) {
                workersGrid.innerHTML = '<div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>';
                currentPage = 1;
            }

            // Build API URL with parameters
            const params = new URLSearchParams();

            const search = document.getElementById('searchInput').value.trim();
            if (search) params.append('q', search);

            const category = document.getElementById('categorySelect').value;
            if (category) params.append('category_id', category);

            const rateMin = document.getElementById('rateMin').value;
            if (rateMin) params.append('min_rate', rateMin);

            const rateMax = document.getElementById('rateMax').value;
            if (rateMax) params.append('max_rate', rateMax);

            const fixedRateMin = document.getElementById('fixedRateMin').value;
            if (fixedRateMin) params.append('min_fixed_rate', fixedRateMin);

            const fixedRateMax = document.getElementById('fixedRateMax').value;
            if (fixedRateMax) params.append('max_fixed_rate', fixedRateMax);

            const minRating = document.getElementById('minRating').value;
            if (minRating) params.append('min_rating', minRating);

            const location = document.getElementById('locationInput').value.trim();
            if (location) params.append('location', location);

            const verifiedOnly = document.getElementById('verifiedOnly').checked;
            if (verifiedOnly) params.append('verified_only', 'true');

            const hasRatesOnly = document.getElementById('hasRatesOnly').checked;
            if (hasRatesOnly) params.append('has_rates', 'true');

            params.append('page', currentPage);
            params.append('limit', pageSize);

            const apiUrl = `/api/workers/search?${params.toString()}`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Failed to fetch workers');

            const data = await response.json();

            if (append) {
                allWorkers = [...allWorkers, ...data.workers];
            } else {
                allWorkers = data.workers;
            }
            totalWorkers = data.total;

            displayWorkers();

        } catch (error) {
            console.error('Error loading workers:', error);
            showError('Failed to load workers. Please try again.');
        } finally {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Search Workers';
        }
    }

    // ============ DISPLAY WORKERS ============
    function displayWorkers() {
        const workersGrid = document.getElementById('workersGrid');
        const resultCount = document.getElementById('resultCount');

        resultCount.textContent = totalWorkers;

        if (allWorkers.length === 0) {
            workersGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ‘·</div>
                    <h3>No workers found</h3>
                    <p>Try adjusting your search filters</p>
                </div>
            `;
            document.getElementById('loadMoreSection').style.display = 'none';
            return;
        }

        workersGrid.innerHTML = allWorkers.map(worker => renderWorkerCard(worker)).join('');

        // Update load more section
        document.getElementById('showingCount').textContent = allWorkers.length;
        document.getElementById('totalCount').textContent = totalWorkers;

        if (allWorkers.length < totalWorkers) {
            document.getElementById('loadMoreSection').style.display = 'block';
        } else {
            document.getElementById('loadMoreSection').style.display = 'none';
        }
    }

    // ============ RENDER WORKER CARD ============
    function renderWorkerCard(worker) {
        const avatarContent = worker.profile_picture
            ? `<img src="${worker.profile_picture}" alt="${escapeHtml(worker.name)}">`
            : worker.name.charAt(0).toUpperCase();

        // Format rating
        const rating = worker.rating || 0;
        const ratingStars = 'â˜…'.repeat(Math.floor(rating)) + 'â˜†'.repeat(5 - Math.floor(rating));

        // Format specializations with rates
        let specializationsHtml = '';
        if (worker.specializations && worker.specializations.length > 0) {
            specializationsHtml = worker.specializations.slice(0, 3).map(spec => {
                let rateHtml = '';
                if (spec.base_hourly_rate) {
                    rateHtml = `<span class="rate">RM${parseFloat(spec.base_hourly_rate).toFixed(0)}/jam</span>`;
                } else if (spec.base_fixed_rate) {
                    rateHtml = `<span class="rate">RM${parseFloat(spec.base_fixed_rate).toFixed(0)}</span>`;
                }
                return `<span class="specialization-tag">${escapeHtml(spec.skill_name || spec.category_name)}${rateHtml ? ' Â· ' + rateHtml : ''}</span>`;
            }).join('');

            if (worker.specializations.length > 3) {
                specializationsHtml += `<span class="specialization-tag">+${worker.specializations.length - 3} more</span>`;
            }
        }

        // Format min rates for display
        let rateDisplay = '';
        if (worker.min_hourly_rate) {
            rateDisplay += `<span class="rate-badge hourly">From RM${parseFloat(worker.min_hourly_rate).toFixed(0)}/jam</span>`;
        }
        if (worker.min_fixed_rate) {
            rateDisplay += `<span class="rate-badge fixed">From RM${parseFloat(worker.min_fixed_rate).toFixed(0)}/gig</span>`;
        }

        return `
            <div class="worker-card" onclick="window.location.href='/profile/${worker.id}'">
                <div class="worker-header">
                    <div class="worker-avatar">
                        ${avatarContent}
                    </div>
                    <div class="worker-info">
                        <div class="worker-name">
                            ${escapeHtml(worker.name)}
                            ${worker.is_verified ? '<span class="verified-badge">âœ“</span>' : ''}
                        </div>
                        ${worker.location ? `<div class="worker-location"><i data-feather="map-pin" style="width:14px;height:14px;"></i> ${escapeHtml(worker.location)}</div>` : ''}
                        <div class="worker-rating">
                            <span class="rating-stars">${ratingStars}</span>
                            <span>${rating.toFixed(1)} (${worker.total_reviews || 0} reviews)</span>
                        </div>
                    </div>
                </div>

                ${worker.bio ? `<div class="worker-bio">${escapeHtml(worker.bio)}</div>` : ''}

                <div class="worker-specializations">
                    ${specializationsHtml || '<span class="specialization-tag" style="color: var(--text-gray);">No specializations listed</span>'}
                </div>

                ${rateDisplay ? `<div style="margin-bottom: 16px;">${rateDisplay}</div>` : ''}

                <div class="worker-stats">
                    <div class="stat-item">
                        <div class="stat-value">${worker.completed_gigs || 0}</div>
                        <div class="stat-label">Jobs Done</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${worker.specializations ? worker.specializations.length : 0}</div>
                        <div class="stat-label">Skills</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${worker.response_rate ? worker.response_rate + '%' : '-'}</div>
                        <div class="stat-label">Response</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ============ LOAD MORE ============
    function loadMore() {
        currentPage++;
        loadWorkers(true);
    }

    // ============ SHOW ERROR ============
    function showError(message) {
        const workersGrid = document.getElementById('workersGrid');
        workersGrid.innerHTML = `
            <div class="error-message">
                <h3>Error</h3>
                <p>${escapeHtml(message)}</p>
                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #c33; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button>
            </div>
        `;
    }

    // ============ UTILITY FUNCTIONS ============
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============ EVENT LISTENERS ============
    document.addEventListener('DOMContentLoaded', init);

    // Allow Enter key to trigger search
    ['searchInput', 'rateMin', 'rateMax', 'fixedRateMin', 'fixedRateMax', 'locationInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadWorkers();
            });
        }
    });

    // Reset pagination and reload when filters change
    ['categorySelect', 'minRating'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            currentPage = 1;
            loadWorkers();
        });
    });

    // Checkboxes
    ['verifiedOnly', 'hasRatesOnly'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            currentPage = 1;
            loadWorkers();
        });
    });
</script>
{% endblock %}
