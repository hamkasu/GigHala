{% extends "base.html" %}

{% block title %}Escrow Management{% endblock %}

{% block extra_styles %}
<style>
    .page-header {
        margin-bottom: 32px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
    }
    
    .page-subtitle {
        color: var(--text-gray);
        font-size: 16px;
    }
    
    .tabs-container {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0;
    }
    
    .tab-btn {
        padding: 12px 24px;
        background: transparent;
        border: none;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-gray);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.2s;
    }
    
    .tab-btn:hover {
        color: var(--text-dark);
    }
    
    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .escrow-card {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        padding: 24px;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    
    .escrow-card:hover {
        box-shadow: var(--shadow-md);
    }
    
    .escrow-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .escrow-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
    }
    
    .escrow-meta {
        font-size: 13px;
        color: var(--text-gray);
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-pending { background: #FEF3C7; color: #92400E; }
    .status-funded { background: #DBEAFE; color: #1E40AF; }
    .status-released { background: #D1FAE5; color: #065F46; }
    .status-refunded { background: #E5E7EB; color: #374151; }
    .status-disputed { background: #FEE2E2; color: #991B1B; }
    .status-cancelled { background: #F3F4F6; color: #6B7280; }
    
    .escrow-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-light);
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .detail-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .detail-value.amount {
        color: var(--primary);
        font-size: 20px;
    }
    
    .fee-breakdown {
        background: #FFFBEB;
        border: 1px solid #FCD34D;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .fee-breakdown h4 {
        font-size: 13px;
        font-weight: 600;
        color: #92400E;
        margin-bottom: 12px;
    }
    
    .fee-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 6px;
    }
    
    .fee-row.total {
        border-top: 1px solid #FCD34D;
        padding-top: 10px;
        margin-top: 10px;
        font-weight: 700;
    }
    
    .escrow-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn-fund {
        background: var(--primary);
        color: white;
    }
    
    .btn-fund:hover {
        background: var(--primary-dark);
    }
    
    .btn-release {
        background: #10B981;
        color: white;
    }
    
    .btn-release:hover {
        background: #059669;
    }
    
    .btn-refund {
        background: #EF4444;
        color: white;
    }
    
    .btn-refund:hover {
        background: #DC2626;
    }
    
    .btn-dispute {
        background: #F59E0B;
        color: white;
    }
    
    .btn-dispute:hover {
        background: #D97706;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }
    
    .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        font-size: 18px;
        color: var(--text-dark);
        margin-bottom: 8px;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        padding: 32px;
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        margin-bottom: 20px;
    }
    
    .modal-header h2 {
        font-size: 20px;
        color: var(--text-dark);
    }
    
    .modal-body {
        margin-bottom: 24px;
    }
    
    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-dark);
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .payment-methods {
        display: grid;
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .payment-method {
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .payment-method:hover {
        border-color: var(--primary);
    }
    
    .payment-method.selected {
        border-color: var(--primary);
        background: #F0FDF4;
    }
    
    .payment-method-icon {
        font-size: 24px;
    }
    
    .payment-method-info h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .payment-method-info p {
        font-size: 12px;
        color: var(--text-gray);
        margin: 0;
    }
    
    .bank-details {
        background: var(--bg-light);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-top: 16px;
    }
    
    .bank-details h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
    }
    
    .bank-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .bank-row span:first-child {
        color: var(--text-gray);
    }
    
    .bank-row span:last-child {
        font-weight: 600;
    }
    
    .alert {
        padding: 16px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .alert-success {
        background: #D1FAE5;
        color: #065F46;
    }
    
    .alert-error {
        background: #FEE2E2;
        color: #991B1B;
    }
    
    .alert-info {
        background: #DBEAFE;
        color: #1E40AF;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .escrow-header {
            flex-direction: column;
            gap: 12px;
        }
        
        .escrow-details {
            grid-template-columns: 1fr 1fr;
        }
        
        .escrow-actions {
            flex-direction: column;
        }
        
        .escrow-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Escrow Management</h1>
    <p class="page-subtitle">View and manage your escrow payments for secure gig transactions</p>
</div>

<div id="alertContainer"></div>

<div class="tabs-container">
    <button class="tab-btn active" data-tab="as-client">As Client</button>
    <button class="tab-btn" data-tab="as-freelancer">As Freelancer</button>
    <button class="tab-btn" data-tab="all">All Escrows</button>
</div>

<div id="as-client" class="tab-content active">
    <div class="loading" id="clientLoading">
        <div class="spinner"></div>
        <p>Loading your escrows...</p>
    </div>
    <div id="clientEscrows"></div>
</div>

<div id="as-freelancer" class="tab-content">
    <div class="loading" id="freelancerLoading">
        <div class="spinner"></div>
        <p>Loading your escrows...</p>
    </div>
    <div id="freelancerEscrows"></div>
</div>

<div id="all" class="tab-content">
    <div class="loading" id="allLoading">
        <div class="spinner"></div>
        <p>Loading all escrows...</p>
    </div>
    <div id="allEscrows"></div>
</div>

<div class="modal" id="fundModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Fund Escrow</h2>
        </div>
        <div class="modal-body">
            <div id="fundModalContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('fundModal')">Cancel</button>
            <button class="btn btn-fund" id="confirmFundBtn" onclick="confirmFund()">Proceed to Payment</button>
        </div>
    </div>
</div>

<div class="modal" id="releaseModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Release Escrow</h2>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to release the escrow funds to the freelancer?</p>
            <p style="margin-top: 12px; color: var(--text-gray); font-size: 14px;">This action cannot be undone. The freelancer will receive the payment minus platform fees.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('releaseModal')">Cancel</button>
            <button class="btn btn-release" onclick="confirmRelease()">Release Funds</button>
        </div>
    </div>
</div>

<div class="modal" id="disputeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Raise Dispute</h2>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">Please describe the issue with this gig:</p>
            <div class="form-group">
                <label for="disputeReason">Reason for Dispute</label>
                <textarea id="disputeReason" placeholder="Explain why you are raising a dispute..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('disputeModal')">Cancel</button>
            <button class="btn btn-dispute" onclick="confirmDispute()">Submit Dispute</button>
        </div>
    </div>
</div>

<div class="modal" id="manualPaymentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Manual Bank Transfer</h2>
        </div>
        <div class="modal-body">
            <div id="bankDetails"></div>
            <div class="form-group" style="margin-top: 20px;">
                <label for="transferReference">Your Transfer Reference</label>
                <input type="text" id="transferReference" placeholder="Enter your bank transfer reference number">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal('manualPaymentModal')">Cancel</button>
            <button class="btn btn-fund" onclick="submitManualPayment()">Submit for Verification</button>
        </div>
    </div>
</div>

<script>
    let currentGigId = null;
    let currentEscrowData = null;
    let allEscrows = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadEscrows();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            showAlert('Payment successful! Your escrow has been funded.', 'success');
        }
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.dataset.tab;
                document.getElementById(tabId).classList.add('active');
                
                renderEscrows();
            });
        });
    });

    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }

    function loadEscrows() {
        fetch('/api/escrow/my-escrows')
            .then(response => response.json())
            .then(data => {
                document.querySelectorAll('.loading').forEach(l => l.style.display = 'none');
                
                if (data.success) {
                    allEscrows = data.escrows || [];
                    renderEscrows();
                } else {
                    showAlert(data.error || 'Failed to load escrows', 'error');
                }
            })
            .catch(error => {
                document.querySelectorAll('.loading').forEach(l => l.style.display = 'none');
                showAlert('Failed to load escrows', 'error');
            });
    }

    function renderEscrows() {
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        
        let filtered = allEscrows;
        if (activeTab === 'as-client') {
            filtered = allEscrows.filter(e => e.is_client);
        } else if (activeTab === 'as-freelancer') {
            filtered = allEscrows.filter(e => e.is_freelancer);
        }
        
        const containerId = activeTab === 'as-client' ? 'clientEscrows' : 
                           activeTab === 'as-freelancer' ? 'freelancerEscrows' : 'allEscrows';
        const container = document.getElementById(containerId);
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üîí</div>
                    <h3>No Escrows Found</h3>
                    <p>You don't have any escrow transactions yet.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(escrow => renderEscrowCard(escrow, activeTab)).join('');
    }

    function renderEscrowCard(escrow, view) {
        const isClient = escrow.is_client;
        const statusClass = `status-${escrow.status}`;
        
        let actions = '';
        if (isClient && escrow.status === 'pending') {
            actions = `<button class="btn btn-fund" onclick="openFundModal(${escrow.gig_id})">Fund Escrow</button>`;
        } else if (isClient && escrow.status === 'funded') {
            actions = `
                <button class="btn btn-release" onclick="openReleaseModal(${escrow.gig_id})">Release to Freelancer</button>
                <button class="btn btn-dispute" onclick="openDisputeModal(${escrow.gig_id})">Raise Dispute</button>
            `;
        } else if (!isClient && escrow.status === 'funded') {
            actions = `<button class="btn btn-dispute" onclick="openDisputeModal(${escrow.gig_id})">Raise Dispute</button>`;
        }
        
        return `
            <div class="escrow-card">
                <div class="escrow-header">
                    <div>
                        <div class="escrow-title">${escrow.gig_title}</div>
                        <div class="escrow-meta">
                            ${isClient ? `Freelancer: ${escrow.freelancer_name}` : `Client: ${escrow.client_name}`}
                            &bull; Ref: ${escrow.payment_reference || 'N/A'}
                        </div>
                    </div>
                    <span class="status-badge ${statusClass}">${escrow.status_label}</span>
                </div>
                
                <div class="escrow-details">
                    <div class="detail-item">
                        <span class="detail-label">Escrow Amount</span>
                        <span class="detail-value amount">RM ${escrow.amount.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Platform Fee</span>
                        <span class="detail-value">RM ${escrow.platform_fee.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SOCSO Deduction (1.25%)</span>
                        <span class="detail-value">RM ${escrow.socso_amount.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Freelancer Receives</span>
                        <span class="detail-value">RM ${escrow.final_payout.toFixed(2)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Created</span>
                        <span class="detail-value">${escrow.created_at ? new Date(escrow.created_at).toLocaleDateString('ms-MY') : 'N/A'}</span>
                    </div>
                </div>
                
                ${actions ? `<div class="escrow-actions">${actions}</div>` : ''}
            </div>
        `;
    }

    function openFundModal(gigId) {
        currentGigId = gigId;
        const escrow = allEscrows.find(e => e.gig_id === gigId);
        
        document.getElementById('fundModalContent').innerHTML = `
            <p style="margin-bottom: 16px;">You are about to fund the escrow for: <strong>${escrow.gig_title}</strong></p>
            
            <div class="fee-breakdown">
                <h4>Payment Breakdown</h4>
                <div class="fee-row">
                    <span>Gig Amount</span>
                    <span>RM ${escrow.amount.toFixed(2)}</span>
                </div>
                <div class="fee-row">
                    <span>Processing Fee (2%)</span>
                    <span>RM ${(escrow.amount * 0.02).toFixed(2)}</span>
                </div>
                <div class="fee-row total">
                    <span>Total to Pay</span>
                    <span>RM ${(escrow.amount * 1.02).toFixed(2)}</span>
                </div>
            </div>
            
            <div style="background: #F0FDF4; border: 1px solid #86EFAC; border-radius: var(--radius-md); padding: 16px; margin-top: 16px;">
                <h4 style="font-size: 13px; font-weight: 600; color: #15803D; margin-bottom: 12px;">Freelancer Deductions (Paid to Platform)</h4>
                <div class="fee-row">
                    <span>Platform Fee (15%)</span>
                    <span>RM ${escrow.platform_fee.toFixed(2)}</span>
                </div>
                <div class="fee-row">
                    <span>SOCSO Contribution (1.25% of net)</span>
                    <span>RM ${escrow.socso_amount.toFixed(2)}</span>
                </div>
                <div class="fee-row total">
                    <span>Total Deductions</span>
                    <span>RM ${(escrow.platform_fee + escrow.socso_amount).toFixed(2)}</span>
                </div>
                <div class="fee-row total" style="border-top: 2px solid #86EFAC; margin-top: 12px; padding-top: 12px;">
                    <span>Freelancer Net Earnings</span>
                    <span style="color: #15803D; font-size: 18px;">RM ${escrow.final_payout.toFixed(2)}</span>
                </div>
            </div>
            
            <div class="payment-methods">
                <div class="payment-method selected" data-method="payhalal">
                    <div class="payment-method-icon">üè¶</div>
                    <div class="payment-method-info">
                        <h4>PayHalal (FPX / Card / E-Wallet)</h4>
                        <p>Pay via online banking, credit card, or e-wallet</p>
                    </div>
                </div>
                <div class="payment-method" data-method="manual">
                    <div class="payment-method-icon">üí≥</div>
                    <div class="payment-method-info">
                        <h4>Manual Bank Transfer</h4>
                        <p>Transfer directly to our bank account</p>
                    </div>
                </div>
            </div>
        `;
        
        document.querySelectorAll('.payment-method').forEach(pm => {
            pm.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(p => p.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        document.getElementById('fundModal').classList.add('active');
    }

    function confirmFund() {
        const selectedMethod = document.querySelector('.payment-method.selected').dataset.method;
        document.getElementById('confirmFundBtn').disabled = true;
        document.getElementById('confirmFundBtn').textContent = 'Processing...';
        
        fetch(`/api/escrow/${currentGigId}/pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.payment_method === 'payhalal' && data.payment_url) {
                    window.location.href = data.payment_url;
                } else if (data.payment_method === 'manual') {
                    closeModal('fundModal');
                    showManualPaymentModal(data.manual_instructions);
                }
            } else {
                showAlert(data.error || 'Failed to initiate payment', 'error');
                document.getElementById('confirmFundBtn').disabled = false;
                document.getElementById('confirmFundBtn').textContent = 'Proceed to Payment';
            }
        })
        .catch(error => {
            showAlert('Failed to initiate payment', 'error');
            document.getElementById('confirmFundBtn').disabled = false;
            document.getElementById('confirmFundBtn').textContent = 'Proceed to Payment';
        });
    }

    function showManualPaymentModal(instructions) {
        currentEscrowData = instructions;
        document.getElementById('bankDetails').innerHTML = `
            <div class="bank-details">
                <h4>Bank Transfer Details</h4>
                <div class="bank-row">
                    <span>Bank Name</span>
                    <span>${instructions.bank_name}</span>
                </div>
                <div class="bank-row">
                    <span>Account Number</span>
                    <span>${instructions.account_number}</span>
                </div>
                <div class="bank-row">
                    <span>Account Name</span>
                    <span>${instructions.account_name}</span>
                </div>
                <div class="bank-row">
                    <span>Reference</span>
                    <span>${instructions.reference}</span>
                </div>
                <div class="bank-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <span>Amount to Transfer</span>
                    <span style="color: var(--primary); font-size: 18px;">RM ${instructions.amount.toFixed(2)}</span>
                </div>
            </div>
            <p style="margin-top: 16px; font-size: 13px; color: var(--text-gray);">
                Please use the reference number above when making your transfer. After completing the transfer, enter your bank transaction reference below.
            </p>
        `;
        document.getElementById('manualPaymentModal').classList.add('active');
    }

    function submitManualPayment() {
        const transferRef = document.getElementById('transferReference').value.trim();
        if (!transferRef) {
            showAlert('Please enter your transfer reference number', 'error');
            return;
        }
        
        fetch(`/api/escrow/${currentGigId}/confirm-manual`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transfer_reference: transferRef })
        })
        .then(response => response.json())
        .then(data => {
            closeModal('manualPaymentModal');
            if (data.success) {
                showAlert(data.message, 'success');
                loadEscrows();
            } else {
                showAlert(data.error || 'Failed to submit payment', 'error');
            }
        })
        .catch(error => {
            showAlert('Failed to submit payment', 'error');
        });
    }

    function openReleaseModal(gigId) {
        currentGigId = gigId;
        document.getElementById('releaseModal').classList.add('active');
    }

    function confirmRelease() {
        fetch(`/api/escrow/${currentGigId}/release`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            closeModal('releaseModal');
            if (data.message) {
                showAlert(data.message, 'success');
                loadEscrows();
            } else {
                showAlert(data.error || 'Failed to release escrow', 'error');
            }
        })
        .catch(error => {
            showAlert('Failed to release escrow', 'error');
        });
    }

    function openDisputeModal(gigId) {
        currentGigId = gigId;
        document.getElementById('disputeReason').value = '';
        document.getElementById('disputeModal').classList.add('active');
    }

    function confirmDispute() {
        const reason = document.getElementById('disputeReason').value.trim();
        if (!reason) {
            showAlert('Please provide a reason for the dispute', 'error');
            return;
        }
        
        fetch(`/api/escrow/${currentGigId}/dispute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            closeModal('disputeModal');
            if (data.message) {
                showAlert(data.message, 'success');
                loadEscrows();
            } else {
                showAlert(data.error || 'Failed to raise dispute', 'error');
            }
        })
        .catch(error => {
            showAlert('Failed to raise dispute', 'error');
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
</script>

{% block extra_footer %}
<div style="text-align: center; padding: 24px; font-size: 11px; color: var(--text-gray); margin-top: 32px; border-top: 1px solid var(--border);">
    Semua transaksi diproses melalui PayHalal ‚Äì Shariah-Compliant, Selamat, dan Dipercayai oleh Bank Negara Malaysia. Pembayaran anda dilindungi sepenuhnya.
</div>
{% endblock %}
{% endblock %}
