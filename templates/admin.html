{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, var(--primary) 0%, #00a844 100%);
        color: white;
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
    }

    .admin-header h1 {
        margin: 0 0 6px 0;
        font-size: 28px;
    }

    .admin-header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-white);
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
        margin: 0 0 6px 0;
        color: var(--text-gray);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .stat-card .label {
        color: var(--text-light);
        font-size: 12px;
    }

    .data-table {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .table-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .table-header h2 {
        margin: 0;
        color: var(--text-dark);
        font-size: 17px;
    }

    .search-box {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 220px;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        background: var(--bg-light);
        font-weight: 600;
        color: var(--text-dark);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    tr:hover {
        background: var(--bg-light);
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge.verified { background: #d1fae5; color: #065f46; }
    .badge.unverified { background: #fee2e2; color: #991b1b; }
    .badge.admin { background: #dbeafe; color: #1e40af; }
    .badge.freelancer { background: #fef3c7; color: #92400e; }
    .badge.client { background: #e0e7ff; color: #3730a3; }
    .badge.open { background: #d1fae5; color: #065f46; }
    .badge.in-progress { background: #fef3c7; color: #92400e; }
    .badge.completed { background: #dbeafe; color: #1e40af; }
    .badge.cancelled { background: #fee2e2; color: #991b1b; }

    .action-btns {
        display: flex;
        gap: 6px;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 11px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-view {
        background: #3b82f6;
        color: white;
    }

    .btn-view:hover {
        background: #2563eb;
    }

    .btn-edit {
        background: var(--primary);
        color: white;
    }

    .btn-edit:hover {
        background: var(--primary-dark);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .modal-lg {
        max-width: 800px;
    }

    .user-detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .detail-section {
        background: var(--bg-light);
        padding: 16px;
        border-radius: var(--radius-md);
    }

    .detail-section.full-width {
        grid-column: span 2;
    }

    .detail-section h4 {
        margin: 0 0 12px 0;
        color: var(--primary);
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row .label {
        color: var(--text-gray);
        font-size: 13px;
    }

    .detail-row .value {
        font-weight: 500;
        color: var(--text-dark);
        font-size: 13px;
    }

    @media (max-width: 600px) {
        .user-detail-grid {
            grid-template-columns: 1fr;
        }
        .detail-section.full-width {
            grid-column: span 1;
        }
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 18px;
    }

    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--primary);
        background: var(--bg-white);
        color: var(--primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
        background: var(--primary);
        color: white;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-gray);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: var(--bg-white);
        padding: 28px;
        border-radius: var(--radius-lg);
        max-width: 450px;
        width: 90%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        margin: 0 0 20px 0;
        color: var(--text-dark);
        font-size: 18px;
        padding-right: 30px;
    }

    .modal-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-gray);
        cursor: pointer;
        padding: 4px 8px;
        line-height: 1;
        transition: color 0.2s;
    }

    .modal-close-btn:hover {
        color: var(--text-dark);
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 13px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .section-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-gray);
        margin: 24px 0 14px 0;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .table-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .search-box {
            width: 100%;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Admin Dashboard</h1>
    <p id="admin-welcome">Welcome, Administrator</p>
</div>

<div id="error-container"></div>
<div id="success-container"></div>

<!-- Landscape Mode Recommendation Popup -->
<div id="landscape-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 400px; text-align: center; margin: 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì± ‚û°Ô∏è üì≤</div>
        <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 20px;">Landscape Mode Recommended</h3>
        <p style="color: var(--text-gray); margin: 0 0 20px 0; line-height: 1.5;">
            For the best viewing experience with financial reports and tables, we recommend rotating your device to landscape mode.
        </p>
        <button onclick="closeLandscapePopup()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
            Got it!
        </button>
        <label style="display: flex; align-items: center; justify-content: center; margin-top: 16px; cursor: pointer; color: var(--text-gray); font-size: 13px;">
            <input type="checkbox" id="dont-show-landscape" style="margin-right: 6px;">
            Don't show this again
        </label>
    </div>
</div>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('users')">Users</button>
    <button class="tab-btn" onclick="switchTab('gigs')">Gigs</button>
    <button class="tab-btn" onclick="switchTab('payouts')">Payouts</button>
    <button class="tab-btn" onclick="switchTab('reports')">Financial Reports</button>
    <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
    <a href="/admin/feedback" class="tab-btn" style="text-decoration:none;">Feedback</a>
    <button class="tab-btn" onclick="switchTab('reset')" style="color: #dc2626;">Reset Data</button>
</div>

<div id="dashboard-tab" class="tab-content active">
    <div id="stats-loading" class="loading">Loading statistics...</div>
    <div id="stats-content" style="display: none;">
        <h3 class="section-title">User Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="stat-total-users">0</div>
                <div class="label" id="stat-recent-users">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Freelancers</h3>
                <div class="value" id="stat-freelancers">0</div>
            </div>
            <div class="stat-card">
                <h3>Clients</h3>
                <div class="value" id="stat-clients">0</div>
            </div>
            <div class="stat-card">
                <h3>Verified Users</h3>
                <div class="value" id="stat-verified">0</div>
            </div>
        </div>

        <h3 class="section-title">Gig Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Gigs</h3>
                <div class="value" id="stat-total-gigs">0</div>
                <div class="label" id="stat-recent-gigs">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Open Gigs</h3>
                <div class="value" id="stat-open-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="value" id="stat-progress-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <div class="value" id="stat-completed-gigs">0</div>
            </div>
        </div>

        <h3 class="section-title">Financial Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Payout</h3>
                <div class="value" id="stat-payout">RM 0</div>
                <div class="label">Total amount paid to workers</div>
            </div>
            <div class="stat-card">
                <h3>Commission</h3>
                <div class="value" id="stat-commission">RM 0</div>
                <div class="label">Cumulative commission earned</div>
            </div>
            <div class="stat-card">
                <h3>Escrow</h3>
                <div class="value" id="stat-escrow">RM 0</div>
                <div class="label">Amount held in escrow</div>
            </div>
            <div class="stat-card">
                <h3>Applications</h3>
                <div class="value" id="stat-applications">0</div>
                <div class="label" id="stat-pending-apps">0 pending</div>
            </div>
        </div>

        <h3 class="section-title">SOCSO Compliance (Gig Workers Bill 2025)</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total SOCSO Collected</h3>
                <div class="value" id="stat-socso-collected">RM 0</div>
                <div class="label">1.25% deducted from freelancer earnings</div>
            </div>
            <div class="stat-card">
                <h3>Remitted to SOCSO</h3>
                <div class="value" id="stat-socso-remitted">RM 0</div>
                <div class="label">Paid via ASSIST Portal</div>
            </div>
            <div class="stat-card">
                <h3>Pending Remittance</h3>
                <div class="value" id="stat-socso-pending">RM 0</div>
                <div class="label">Awaiting ASSIST Portal submission</div>
            </div>
            <div class="stat-card">
                <h3>Registered Freelancers</h3>
                <div class="value" id="stat-socso-registered">0</div>
                <div class="label" id="stat-socso-compliance">0% compliance rate</div>
            </div>
            <div class="stat-card">
                <h3>Current Month Collection</h3>
                <div class="value" id="stat-socso-current-month">RM 0</div>
                <div class="label">This month's SOCSO deductions</div>
            </div>
        </div>
    </div>
</div>

<div id="users-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>User Management</h2>
            <input type="text" id="user-search" class="search-box" placeholder="Search users...">
        </div>
        <div id="users-loading" class="loading">Loading users...</div>
        <div id="users-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
            <div class="pagination" id="users-pagination"></div>
        </div>
    </div>
</div>

<div id="gigs-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Gig Management</h2>
            <select id="gig-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <option value="">All Status</option>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div id="gigs-loading" class="loading">Loading gigs...</div>
        <div id="gigs-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Client</th>
                        <th>Worker</th>
                        <th>Category</th>
                        <th>Budget</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gigs-tbody"></tbody>
            </table>
            <div class="pagination" id="gigs-pagination"></div>
        </div>
    </div>
</div>

<div id="payouts-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Payout Requests</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
                <select id="payout-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);" onchange="loadPayouts()">
                    <option value="">All Status</option>
                    <option value="pending" selected>Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <div class="stat-card" style="padding: 10px 16px; margin: 0; min-width: 200px;">
                    <h3 style="margin: 0; font-size: 11px;">Pending Amount</h3>
                    <div class="value" style="font-size: 18px; margin: 0;" id="pending-payout-amount">MYR 0.00</div>
                </div>
            </div>
        </div>
        <div id="payouts-loading" class="loading">Loading payouts...</div>
        <div id="payouts-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Freelancer</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Net Amount</th>
                        <th>Method</th>
                        <th>Account Info</th>
                        <th>Status</th>
                        <th>Requested</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payouts-tbody"></tbody>
            </table>
            <div class="pagination" id="payouts-pagination"></div>
        </div>
    </div>
</div>

<div id="settings-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Payment Gateway Settings</h2>
        </div>
        <div style="padding: 24px;">
            <p style="color: var(--text-gray); margin-bottom: 24px;">Select which payment gateway to use for processing payments. The selected gateway will be used for all transactions.</p>
            
            <div id="gateway-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div class="gateway-card" id="gateway-payhalal" onclick="selectGateway('payhalal')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">‚ò™Ô∏è</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">PayHalal</h3>
                            <span style="background: #10B981; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">SHARIAH COMPLIANT</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Malaysia's first Shariah-compliant payment gateway. Supports FPX, cards, and e-wallets.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Processing Fee: <strong>2%</strong></div>
                        <div>Methods: FPX, Visa, Mastercard, TnG, GrabPay</div>
                    </div>
                </div>
                
                <div class="gateway-card" id="gateway-stripe" onclick="selectGateway('stripe')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">üí≥</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">Stripe</h3>
                            <span style="background: #6366F1; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">INTERNATIONAL</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Global payment processor with international card support and multi-currency.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Processing Fee: <strong>2.9% + RM1</strong></div>
                        <div>Methods: Visa, Mastercard, Amex, Apple Pay</div>
                    </div>
                </div>
            </div>
            
            <div id="gateway-status" style="padding: 16px; background: var(--bg-light); border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="gateway-status-icon">‚è≥</span>
                    <span id="gateway-status-text">Loading current gateway...</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveGatewaySettings()" id="save-gateway-btn" style="display: none;">
                Save Gateway Settings
            </button>
        </div>
    </div>
    
    <div class="data-table" style="margin-top: 24px;">
        <div class="table-header">
            <h2>Fee Configuration</h2>
        </div>
        <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="stat-card">
                    <h3>Platform Commission</h3>
                    <div class="value">15% / 10% / 5%</div>
                    <div class="label">Tiered based on gig amount</div>
                </div>
                <div class="stat-card">
                    <h3>Payout Fee</h3>
                    <div class="value">2%</div>
                    <div class="label">Charged on withdrawals</div>
                </div>
                <div class="stat-card" id="processing-fee-card">
                    <h3>Processing Fee</h3>
                    <div class="value" id="current-processing-fee">2%</div>
                    <div class="label">Based on selected gateway</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="reports-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Financial Reports</h2>
        </div>
        <div style="padding: 24px;">
            <!-- Report Type Selection -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Report Type</label>
                <select id="report-type" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;" onchange="handleReportTypeChange()">
                    <option value="">Select Report Type</option>
                    <option value="platform">Platform-Wide Financial Report</option>
                    <option value="worker">Worker Financial Report</option>
                    <option value="client">Client Spending Report</option>
                </select>
            </div>

            <!-- User Selection (for worker/client reports) -->
            <div id="user-selection-section" style="display: none; margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);" id="user-selection-label">Select User</label>
                <select id="user-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                    <option value="">Select...</option>
                </select>
            </div>

            <!-- Date Range Selection -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Start Date</label>
                    <input type="date" id="report-start-date" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">End Date</label>
                    <input type="date" id="report-end-date" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
                </div>
            </div>

            <!-- Quick Date Range Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;">
                <button onclick="setDateRange('thisMonth')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">This Month</button>
                <button onclick="setDateRange('lastMonth')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">Last Month</button>
                <button onclick="setDateRange('last3Months')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">Last 3 Months</button>
                <button onclick="setDateRange('last6Months')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">Last 6 Months</button>
                <button onclick="setDateRange('thisYear')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">This Year</button>
            </div>

            <!-- Generate Button -->
            <button onclick="generateReport()" class="btn-primary" style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600;">
                Generate Report
            </button>

            <!-- Report Loading -->
            <div id="report-loading" style="display: none; text-align: center; padding: 40px; color: var(--text-gray);">
                <div class="loading">Generating report...</div>
            </div>

            <!-- Report Results -->
            <div id="report-results" style="display: none; margin-top: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text);" id="report-title">Report</h3>
                    <button onclick="exportReportToCSV()" class="btn-secondary">Export to CSV</button>
                </div>

                <!-- Platform Report -->
                <div id="platform-report" style="display: none;">
                    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #1e40af;">
                            <strong>Period:</strong> <span id="platform-period"></span>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Overview</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <div class="value" id="platform-total-revenue">RM 0</div>
                            <div class="label">Commission + Fees</div>
                        </div>
                        <div class="stat-card">
                            <h3>New Users</h3>
                            <div class="value" id="platform-new-users">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Completed Gigs</h3>
                            <div class="value" id="platform-gigs-completed">0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Transactions</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Transactions</h3>
                            <div class="value" id="platform-tx-count">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Transaction Amount</h3>
                            <div class="value" id="platform-tx-amount">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Commission Earned</h3>
                            <div class="value" id="platform-tx-commission">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Net to Workers</h3>
                            <div class="value" id="platform-tx-net">RM 0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Escrow</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Funded</h3>
                            <div class="value" id="platform-escrow-funded">RM 0</div>
                            <div class="label" id="platform-escrow-funded-count">0 escrows</div>
                        </div>
                        <div class="stat-card">
                            <h3>Released</h3>
                            <div class="value" id="platform-escrow-released">RM 0</div>
                            <div class="label" id="platform-escrow-released-count">0 escrows</div>
                        </div>
                        <div class="stat-card">
                            <h3>Platform Fees</h3>
                            <div class="value" id="platform-escrow-fees">RM 0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Payouts</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Completed Payouts</h3>
                            <div class="value" id="platform-payout-count">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Payout Amount</h3>
                            <div class="value" id="platform-payout-amount">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Payout Fees</h3>
                            <div class="value" id="platform-payout-fees">RM 0</div>
                        </div>
                    </div>

                    <div id="platform-payment-methods" style="margin-top: 24px;"></div>
                    <div id="platform-commission-tiers" style="margin-top: 24px;"></div>
                </div>

                <!-- Worker Report -->
                <div id="worker-report" style="display: none;">
                    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #1e40af; margin-bottom: 8px;">
                            <strong>Worker:</strong> <span id="worker-name"></span> (<span id="worker-email"></span>)
                        </div>
                        <div style="font-size: 13px; color: #1e40af;">
                            <strong>Period:</strong> <span id="worker-period"></span>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Wallet Status</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Current Balance</h3>
                            <div class="value" id="worker-balance">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Held Balance</h3>
                            <div class="value" id="worker-held">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Lifetime Earnings</h3>
                            <div class="value" id="worker-total-earned">RM 0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Period Earnings</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Earned</h3>
                            <div class="value" id="worker-earned">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Commission Paid</h3>
                            <div class="value" id="worker-commission">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Transactions</h3>
                            <div class="value" id="worker-tx-count">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Escrow Released</h3>
                            <div class="value" id="worker-escrow">RM 0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Gigs</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Completed</h3>
                            <div class="value" id="worker-gigs-completed">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>In Progress</h3>
                            <div class="value" id="worker-gigs-progress">0</div>
                        </div>
                    </div>

                    <div id="worker-gig-details" style="margin-top: 24px;"></div>
                    <div id="worker-payout-details" style="margin-top: 24px;"></div>
                </div>

                <!-- Client Report -->
                <div id="client-report" style="display: none;">
                    <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #1e40af; margin-bottom: 8px;">
                            <strong>Client:</strong> <span id="client-name"></span> (<span id="client-email"></span>)
                        </div>
                        <div style="font-size: 13px; color: #1e40af;">
                            <strong>Period:</strong> <span id="client-period"></span>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Wallet Status</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Current Balance</h3>
                            <div class="value" id="client-balance">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Lifetime Spent</h3>
                            <div class="value" id="client-total-spent">RM 0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Period Spending</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Spent</h3>
                            <div class="value" id="client-spent">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Commission Paid</h3>
                            <div class="value" id="client-commission">RM 0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Transactions</h3>
                            <div class="value" id="client-tx-count">0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Gigs</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Gigs</h3>
                            <div class="value" id="client-gigs-total">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Completed</h3>
                            <div class="value" id="client-gigs-completed">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Active</h3>
                            <div class="value" id="client-gigs-active">0</div>
                        </div>
                    </div>

                    <h4 style="color: var(--text); margin: 20px 0 12px 0;">Escrow</h4>
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card">
                            <h3>Total Funded</h3>
                            <div class="value" id="client-escrow-funded">RM 0</div>
                            <div class="label" id="client-escrow-funded-count">0 escrows</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending</h3>
                            <div class="value" id="client-escrow-pending">RM 0</div>
                        </div>
                    </div>

                    <div id="client-payment-methods" style="margin-top: 24px;"></div>
                    <div id="client-gig-details" style="margin-top: 24px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="reset-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header" style="background: #fef2f2; border-bottom-color: #fecaca;">
            <h2 style="color: #dc2626;">‚ö†Ô∏è Master Data Reset</h2>
        </div>
        <div style="padding: 24px;">
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                <h3 style="color: #dc2626; margin: 0 0 12px 0;">Warning: Destructive Action</h3>
                <p style="color: #7f1d1d; margin: 0 0 16px 0;">This action will permanently delete all platform data except user account information. This cannot be undone.</p>
                <div style="font-size: 14px; color: #991b1b;">
                    <strong>What will be DELETED:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>All gigs and applications</li>
                        <li>All transactions, invoices, and receipts</li>
                        <li>All messages and conversations</li>
                        <li>All reviews and ratings</li>
                        <li>All disputes and milestones</li>
                        <li>All notifications</li>
                        <li>All portfolio items</li>
                        <li>All payouts and payment history</li>
                        <li>All platform feedback</li>
                    </ul>
                </div>
                <div style="font-size: 14px; color: #065f46; margin-top: 16px;">
                    <strong>What will be PRESERVED:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>User accounts (username, email, password)</li>
                        <li>User profiles and settings</li>
                        <li>Wallet balances (will be reset to 0)</li>
                        <li>Identity verification status</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: var(--bg-light); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                <h4 style="margin: 0 0 16px 0; color: var(--text-dark);">Security Confirmation</h4>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type "RESET" to confirm:</label>
                    <input type="text" id="reset-confirm-text" placeholder="Type RESET" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 300px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enter your admin password:</label>
                    <input type="password" id="reset-admin-password" placeholder="Your password" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 300px; font-size: 16px;">
                </div>
                <button onclick="performMasterReset()" style="background: #dc2626; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer;">
                    üóëÔ∏è Reset All Data
                </button>
            </div>
            
            <div id="reset-log" style="display: none; background: #1f2937; color: #10b981; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto;">
            </div>
        </div>
    </div>
</div>

<div id="payout-detail-modal" class="modal" onclick="if(event.target===this) closePayoutModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closePayoutModal()">&times;</button>
        <h3>Payout Details</h3>
        <div id="payout-detail-content"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePayoutModal()">Close</button>
            <button class="btn btn-danger" id="payout-reject-btn" onclick="updatePayoutStatus('failed')">Reject</button>
            <button class="btn btn-warning" id="payout-processing-btn" onclick="updatePayoutStatus('processing')">Mark Processing</button>
            <button class="btn btn-success" id="payout-approve-btn" onclick="updatePayoutStatus('completed')">Mark Completed</button>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="modal" onclick="closeModalOnBackdrop(event, 'edit-user-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('edit-user-modal')">&times;</button>
        <h3>Edit User</h3>
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="edit-username" disabled>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="text" id="edit-email" disabled>
        </div>
        <div class="form-group">
            <label>User Type:</label>
            <select id="edit-user-type">
                <option value="freelancer">Freelancer</option>
                <option value="client">Client</option>
                <option value="both">Both</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-verified">
                <label for="edit-verified">Verified</label>
            </div>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-is-admin">
                <label for="edit-is-admin">Admin</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-user-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="view-user-modal" class="modal" onclick="closeModalOnBackdrop(event, 'view-user-modal')">
    <div class="modal-content modal-lg" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('view-user-modal')">&times;</button>
        <h3>User Details</h3>
        <div id="view-user-content">
            <p>Loading...</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('view-user-modal')">Close</button>
        </div>
    </div>
</div>

<div id="edit-gig-modal" class="modal" onclick="closeModalOnBackdrop(event, 'edit-gig-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('edit-gig-modal')">&times;</button>
        <h3>Edit Gig</h3>
        <div class="form-group">
            <label>Title:</label>
            <input type="text" id="edit-gig-title" disabled>
        </div>
        <div class="form-group">
            <label>Status:</label>
            <select id="edit-gig-status">
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-gig-halal-verified">
                <label for="edit-gig-halal-verified">Halal Verified</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveGigChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-gig-modal')">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentEditUserId = null;
    let currentEditGigId = null;
    let usersCurrentPage = 1;
    let gigsCurrentPage = 1;

    async function checkAdminAccess() {
        try {
            const response = await fetch('/api/admin/check');
            const data = await response.json();

            if (!data.is_admin) {
                window.location.href = '/';
                return;
            }

            if (data.user) {
                document.getElementById('admin-welcome').textContent = `Welcome, ${data.user.username}`;
            }

            loadDashboard();
        } catch (error) {
            console.error('Error checking admin access:', error);
            window.location.href = '/';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadUsers(1);
        else if (tabName === 'gigs') loadGigs(1);
        else if (tabName === 'payouts') loadPayouts();
        else if (tabName === 'reports') initReports();
        else if (tabName === 'settings') loadSettings();
    }

    let selectedGateway = 'stripe';
    let currentGateway = 'stripe';

    async function loadSettings() {
        try {
            const response = await fetch('/api/admin/settings/payment-gateway');
            const data = await response.json();
            
            currentGateway = data.gateway || 'stripe';
            selectedGateway = currentGateway;
            
            updateGatewayUI();
            
            document.getElementById('gateway-status-icon').textContent = '‚úÖ';
            document.getElementById('gateway-status-text').textContent = 
                `Current gateway: ${currentGateway === 'payhalal' ? 'PayHalal' : 'Stripe'}`;
            
            if (currentGateway === 'payhalal') {
                document.getElementById('current-processing-fee').textContent = '2%';
            } else {
                document.getElementById('current-processing-fee').textContent = '2.9% + RM1';
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            document.getElementById('gateway-status-icon').textContent = '‚ö†Ô∏è';
            document.getElementById('gateway-status-text').textContent = 'Error loading settings';
        }
    }

    function selectGateway(gateway) {
        selectedGateway = gateway;
        updateGatewayUI();
        
        if (selectedGateway !== currentGateway) {
            document.getElementById('save-gateway-btn').style.display = 'inline-flex';
        } else {
            document.getElementById('save-gateway-btn').style.display = 'none';
        }
    }

    function updateGatewayUI() {
        document.querySelectorAll('.gateway-card').forEach(card => {
            card.style.borderColor = 'var(--border)';
            card.style.boxShadow = 'none';
        });
        
        const selectedCard = document.getElementById(`gateway-${selectedGateway}`);
        if (selectedCard) {
            selectedCard.style.borderColor = 'var(--primary)';
            selectedCard.style.boxShadow = '0 0 0 3px rgba(0, 200, 83, 0.2)';
        }
    }

    async function saveGatewaySettings() {
        try {
            const response = await fetch('/api/admin/settings/payment-gateway', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gateway: selectedGateway })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentGateway = selectedGateway;
                document.getElementById('save-gateway-btn').style.display = 'none';
                document.getElementById('gateway-status-text').textContent = 
                    `Current gateway: ${currentGateway === 'payhalal' ? 'PayHalal' : 'Stripe'} (saved)`;
                
                if (currentGateway === 'payhalal') {
                    document.getElementById('current-processing-fee').textContent = '2%';
                } else {
                    document.getElementById('current-processing-fee').textContent = '2.9% + RM1';
                }
                
                showSuccess('Payment gateway updated successfully!');
            } else {
                showError(data.error || 'Failed to save settings');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            showError('Failed to save settings');
        }
    }

    async function loadDashboard() {
        const loading = document.getElementById('stats-loading');
        const content = document.getElementById('stats-content');

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch('/api/admin/stats');
            const data = await response.json();

            if (data.users) {
                document.getElementById('stat-total-users').textContent = data.users.total || 0;
                document.getElementById('stat-recent-users').textContent = `${data.users.recent || 0} this week`;
                document.getElementById('stat-freelancers').textContent = data.users.freelancers || 0;
                document.getElementById('stat-clients').textContent = data.users.clients || 0;
                document.getElementById('stat-verified').textContent = data.users.verified || 0;
            }

            if (data.gigs) {
                document.getElementById('stat-total-gigs').textContent = data.gigs.total || 0;
                document.getElementById('stat-recent-gigs').textContent = `${data.gigs.recent || 0} this week`;
                document.getElementById('stat-open-gigs').textContent = data.gigs.open || 0;
                document.getElementById('stat-progress-gigs').textContent = data.gigs.in_progress || 0;
                document.getElementById('stat-completed-gigs').textContent = data.gigs.completed || 0;
            }

            if (data.financial) {
                document.getElementById('stat-payout').textContent = `RM ${(data.financial.total_payout || 0).toFixed(2)}`;
                document.getElementById('stat-commission').textContent = `RM ${(data.financial.commission || 0).toFixed(2)}`;
                document.getElementById('stat-escrow').textContent = `RM ${(data.financial.escrow || 0).toFixed(2)}`;
            }

            if (data.socso) {
                document.getElementById('stat-socso-collected').textContent = `RM ${(data.socso.total_collected || 0).toFixed(2)}`;
                document.getElementById('stat-socso-remitted').textContent = `RM ${(data.socso.total_remitted || 0).toFixed(2)}`;
                document.getElementById('stat-socso-pending').textContent = `RM ${(data.socso.pending_remittance || 0).toFixed(2)}`;
                document.getElementById('stat-socso-registered').textContent = data.socso.registered_freelancers || 0;
                document.getElementById('stat-socso-compliance').textContent = `${(data.socso.compliance_rate || 0).toFixed(1)}% compliance rate`;
                document.getElementById('stat-socso-current-month').textContent = `RM ${(data.socso.current_month_collection || 0).toFixed(2)}`;
            }

            if (data.applications) {
                document.getElementById('stat-applications').textContent = data.applications.total || 0;
                document.getElementById('stat-pending-apps').textContent = `${data.applications.pending || 0} pending`;
            }

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading dashboard:', error);
            loading.textContent = 'Error loading statistics';
        }
    }

    async function loadUsers(page) {
        const loading = document.getElementById('users-loading');
        const content = document.getElementById('users-content');
        const search = document.getElementById('user-search').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/users?page=${page}&search=${search}`);
            const data = await response.json();

            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.user_type}">${user.user_type}</span></td>
                    <td><span class="badge ${user.is_verified ? 'verified' : 'unverified'}">${user.is_verified ? 'Verified' : 'Unverified'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-view" onclick="viewUserDetails(${user.id})">View</button>
                            <button class="btn-sm btn-edit" onclick="editUser(${user.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading users:', error);
            loading.textContent = 'Error loading users';
        }
    }

    async function loadGigs(page) {
        const loading = document.getElementById('gigs-loading');
        const content = document.getElementById('gigs-content');
        const status = document.getElementById('gig-status-filter').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/gigs?page=${page}&status=${status}`);
            const data = await response.json();

            const tbody = document.getElementById('gigs-tbody');
            tbody.innerHTML = data.gigs.map(gig => `
                <tr>
                    <td>${gig.id}</td>
                    <td>${gig.title}</td>
                    <td>${gig.client ? gig.client.username : 'N/A'}</td>
                    <td>${gig.worker ? `${gig.worker.username}<br><small>RM ${gig.agreed_amount || 'N/A'}</small>` : 'Not assigned'}</td>
                    <td>${gig.category || 'N/A'}</td>
                    <td>RM ${gig.approved_budget || (gig.budget_min + '-' + gig.budget_max)}</td>
                    <td><span class="badge ${gig.status.replace('_', '-')}">${gig.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-edit" onclick="editGig(${gig.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading gigs:', error);
            loading.textContent = 'Error loading gigs';
        }
    }

    async function editUser(userId) {
        currentEditUserId = userId;
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                credentials: 'include'
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to load user');
            }
            const data = await response.json();
            const user = data.user;
            
            const usernameField = document.getElementById('edit-username');
            const emailField = document.getElementById('edit-email');
            const userTypeField = document.getElementById('edit-user-type');
            const verifiedField = document.getElementById('edit-verified');
            const isAdminField = document.getElementById('edit-is-admin');
            
            if (usernameField) usernameField.value = user.username || '';
            if (emailField) emailField.value = user.email || '';
            if (userTypeField) userTypeField.value = user.user_type || 'freelancer';
            if (verifiedField) verifiedField.checked = user.is_verified || false;
            if (isAdminField) isAdminField.checked = user.is_admin || false;
            
            document.getElementById('edit-user-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Failed to load user details: ' + error.message);
        }
    }

    async function viewUserDetails(userId) {
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('Failed to load user');
            const data = await response.json();
            const user = data.user;
            
            document.getElementById('view-user-content').innerHTML = `
                <div class="user-detail-grid">
                    <div class="detail-section">
                        <h4>Basic Information</h4>
                        <div class="detail-row"><span class="label">ID:</span><span class="value">${user.id}</span></div>
                        <div class="detail-row"><span class="label">Username:</span><span class="value">${user.username || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Full Name:</span><span class="value">${user.full_name || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Email:</span><span class="value">${user.email || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Phone:</span><span class="value">${user.phone || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">IC Number:</span><span class="value">${user.ic_number || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Location:</span><span class="value">${user.location || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">User Type:</span><span class="value badge ${user.user_type}">${user.user_type || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Created:</span><span class="value">${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Status & Verification</h4>
                        <div class="detail-row"><span class="label">Verified:</span><span class="value badge ${user.is_verified ? 'verified' : 'unverified'}">${user.is_verified ? 'Yes' : 'No'}</span></div>
                        <div class="detail-row"><span class="label">Halal Verified:</span><span class="value badge ${user.halal_verified ? 'verified' : 'unverified'}">${user.halal_verified ? 'Yes' : 'No'}</span></div>
                        <div class="detail-row"><span class="label">Admin:</span><span class="value badge ${user.is_admin ? 'admin' : ''}">${user.is_admin ? 'Yes' : 'No'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Performance</h4>
                        <div class="detail-row"><span class="label">Rating:</span><span class="value">${user.rating ? user.rating.toFixed(1) : '0.0'} / 5.0</span></div>
                        <div class="detail-row"><span class="label">Reviews:</span><span class="value">${user.review_count || 0}</span></div>
                        <div class="detail-row"><span class="label">Completed Gigs:</span><span class="value">${user.completed_gigs || 0}</span></div>
                        <div class="detail-row"><span class="label">Total Earnings:</span><span class="value">RM ${(user.total_earnings || 0).toFixed(2)}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Bank Details</h4>
                        <div class="detail-row"><span class="label">Bank Name:</span><span class="value">${user.bank_name || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Account Number:</span><span class="value">${user.bank_account_number || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Account Holder:</span><span class="value">${user.bank_account_holder || 'N/A'}</span></div>
                    </div>
                    <div class="detail-section full-width">
                        <h4>Bio & Skills</h4>
                        <div class="detail-row"><span class="label">Bio:</span><span class="value">${user.bio || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Skills:</span><span class="value">${user.skills || 'N/A'}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('view-user-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading user details:', error);
            alert('Failed to load user details');
        }
    }

    function editGig(gigId) {
        currentEditGigId = gigId;
        document.getElementById('edit-gig-modal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function closeModalOnBackdrop(event, modalId) {
        if (event.target.classList.contains('modal')) {
            closeModal(modalId);
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (document.getElementById('payout-detail-modal').classList.contains('active')) {
                closePayoutModal();
            }
            if (document.getElementById('edit-user-modal').classList.contains('active')) {
                closeModal('edit-user-modal');
            }
            if (document.getElementById('view-user-modal').classList.contains('active')) {
                closeModal('view-user-modal');
            }
            if (document.getElementById('edit-gig-modal').classList.contains('active')) {
                closeModal('edit-gig-modal');
            }
        }
    });

    async function saveUserChanges() {
        if (!currentEditUserId) return;
        
        const userData = {
            user_type: document.getElementById('edit-user-type').value,
            is_verified: document.getElementById('edit-verified').checked,
            is_admin: document.getElementById('edit-is-admin').checked
        };
        
        try {
            const response = await fetch(`/api/admin/users/${currentEditUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(userData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update user');
            }
            
            closeModal('edit-user-modal');
            loadUsers(usersCurrentPage);
            alert('User updated successfully!');
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Failed to save user: ' + error.message);
        }
    }

    async function saveGigChanges() {
        closeModal('edit-gig-modal');
        loadGigs(gigsCurrentPage);
    }

    document.getElementById('user-search').addEventListener('input', () => loadUsers(1));
    document.getElementById('gig-status-filter').addEventListener('change', () => loadGigs(1));

    let currentPayoutId = null;

    async function loadPayouts() {
        const loading = document.getElementById('payouts-loading');
        const content = document.getElementById('payouts-content');
        const tbody = document.getElementById('payouts-tbody');
        const statusFilter = document.getElementById('payout-status-filter').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/billing/payouts?status=${statusFilter}`);
            if (!response.ok) throw new Error('Failed to load payouts');

            const data = await response.json();
            const payouts = data.payouts || [];

            loading.style.display = 'none';
            content.style.display = 'block';

            // Update pending amount
            const pendingAmount = payouts
                .filter(p => p.status === 'pending')
                .reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('pending-payout-amount').textContent = `MYR ${pendingAmount.toFixed(2)}`;

            if (payouts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No payouts found</td></tr>';
                return;
            }

            tbody.innerHTML = payouts.map(payout => `
                <tr>
                    <td><strong>${payout.payout_number}</strong></td>
                    <td>${payout.freelancer_name}</td>
                    <td>MYR ${payout.amount.toFixed(2)}</td>
                    <td>MYR ${payout.fee.toFixed(2)}</td>
                    <td>MYR ${payout.net_amount.toFixed(2)}</td>
                    <td>${payout.payment_method.replace(/_/g, ' ').toUpperCase()}</td>
                    <td>
                        ${payout.bank_name || 'N/A'}<br>
                        ${payout.account_number ? `****${payout.account_number.slice(-4)}` : 'N/A'}
                    </td>
                    <td><span class="badge ${payout.status}">${payout.status.toUpperCase()}</span></td>
                    <td>${new Date(payout.requested_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPayoutDetails(${payout.id})">View</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading payouts:', error);
            loading.style.display = 'none';
            tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Error: ${error.message}</td></tr>`;
        }
    }

    async function viewPayoutDetails(payoutId) {
        currentPayoutId = payoutId;
        try {
            const response = await fetch('/api/admin/billing/payouts');
            if (!response.ok) throw new Error('Failed to load payout details');

            const data = await response.json();
            const payout = data.payouts.find(p => p.id === payoutId);

            if (!payout) throw new Error('Payout not found');

            const detailContent = document.getElementById('payout-detail-content');
            detailContent.innerHTML = `
                <div class="form-group">
                    <label>Payout Number:</label>
                    <div><strong>${payout.payout_number}</strong></div>
                </div>
                <div class="form-group">
                    <label>Freelancer:</label>
                    <div>${payout.freelancer_name} (${payout.freelancer_email})</div>
                </div>
                <div class="form-group">
                    <label>Amount Details:</label>
                    <div>
                        Requested Amount: <strong>MYR ${payout.amount.toFixed(2)}</strong><br>
                        Processing Fee (2%): MYR ${payout.fee.toFixed(2)}<br>
                        Net Amount: <strong>MYR ${payout.net_amount.toFixed(2)}</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method:</label>
                    <div>${payout.payment_method.replace(/_/g, ' ').toUpperCase()}</div>
                </div>
                <div class="form-group">
                    <label>Account Details:</label>
                    <div>
                        Bank: ${payout.bank_name || 'N/A'}<br>
                        Account Number: ${payout.account_number || 'N/A'}<br>
                        Account Name: ${payout.account_name || 'N/A'}
                    </div>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <div><span class="badge ${payout.status}">${payout.status.toUpperCase()}</span></div>
                </div>
                <div class="form-group">
                    <label>Requested At:</label>
                    <div>${new Date(payout.requested_at).toLocaleString()}</div>
                </div>
                ${payout.processed_at ? `
                <div class="form-group">
                    <label>Processed At:</label>
                    <div>${new Date(payout.processed_at).toLocaleString()}</div>
                </div>
                ` : ''}
                ${payout.completed_at ? `
                <div class="form-group">
                    <label>Completed At:</label>
                    <div>${new Date(payout.completed_at).toLocaleString()}</div>
                </div>
                ` : ''}
                ${payout.admin_notes ? `
                <div class="form-group">
                    <label>Admin Notes:</label>
                    <div>${payout.admin_notes}</div>
                </div>
                ` : ''}
                ${payout.failure_reason ? `
                <div class="form-group">
                    <label>Failure Reason:</label>
                    <div style="color: red;">${payout.failure_reason}</div>
                </div>
                ` : ''}
                <div class="form-group">
                    <label>Admin Notes (optional):</label>
                    <textarea id="payout-admin-notes" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">${payout.admin_notes || ''}</textarea>
                </div>
                ${payout.status === 'failed' || payout.status === 'cancelled' ? '' : `
                <div class="form-group">
                    <label>Failure Reason (for rejection):</label>
                    <textarea id="payout-failure-reason" rows="2" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);"></textarea>
                </div>
                `}
            `;

            // Show/hide action buttons based on status
            const rejectBtn = document.getElementById('payout-reject-btn');
            const processingBtn = document.getElementById('payout-processing-btn');
            const approveBtn = document.getElementById('payout-approve-btn');

            if (payout.status === 'completed' || payout.status === 'failed' || payout.status === 'cancelled') {
                rejectBtn.style.display = 'none';
                processingBtn.style.display = 'none';
                approveBtn.style.display = 'none';
            } else {
                rejectBtn.style.display = payout.status !== 'failed' ? 'inline-block' : 'none';
                processingBtn.style.display = payout.status === 'pending' ? 'inline-block' : 'none';
                approveBtn.style.display = 'inline-block';
            }

            document.getElementById('payout-detail-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading payout details:', error);
            alert('Failed to load payout details: ' + error.message);
        }
    }

    async function updatePayoutStatus(newStatus) {
        if (!currentPayoutId) return;

        const adminNotes = document.getElementById('payout-admin-notes').value;
        const failureReasonEl = document.getElementById('payout-failure-reason');
        const failureReason = failureReasonEl ? failureReasonEl.value : '';

        if (newStatus === 'failed' && !failureReason) {
            alert('Please provide a failure reason');
            return;
        }

        if (!confirm(`Are you sure you want to mark this payout as ${newStatus}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/billing/payouts/${currentPayoutId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus,
                    admin_notes: adminNotes,
                    failure_reason: failureReason
                })
            });

            if (!response.ok) throw new Error('Failed to update payout status');

            const data = await response.json();
            alert(data.message || 'Payout status updated successfully');

            closePayoutModal();
            loadPayouts();
        } catch (error) {
            console.error('Error updating payout:', error);
            alert('Failed to update payout: ' + error.message);
        }
    }

    function closePayoutModal() {
        document.getElementById('payout-detail-modal').classList.remove('active');
        currentPayoutId = null;
    }

    async function performMasterReset() {
        const confirmText = document.getElementById('reset-confirm-text').value;
        const password = document.getElementById('reset-admin-password').value;
        const resetLog = document.getElementById('reset-log');
        
        if (confirmText !== 'RESET') {
            alert('Please type "RESET" to confirm.');
            return;
        }
        
        if (!password) {
            alert('Please enter your admin password.');
            return;
        }
        
        if (!confirm('FINAL WARNING: This will permanently delete all platform data except user accounts. This action CANNOT be undone. Are you absolutely sure?')) {
            return;
        }
        
        resetLog.style.display = 'block';
        resetLog.innerHTML = '> Starting master reset...\n';
        
        try {
            const response = await fetch('/api/admin/master-reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                resetLog.innerHTML += '> Deleted gig applications...\n';
                resetLog.innerHTML += '> Deleted transactions and payments...\n';
                resetLog.innerHTML += '> Deleted messages and conversations...\n';
                resetLog.innerHTML += '> Deleted reviews and ratings...\n';
                resetLog.innerHTML += '> Deleted disputes and milestones...\n';
                resetLog.innerHTML += '> Deleted notifications...\n';
                resetLog.innerHTML += '> Deleted portfolio items...\n';
                resetLog.innerHTML += '> Deleted gigs...\n';
                resetLog.innerHTML += '> Reset wallet balances...\n';
                resetLog.innerHTML += '> ‚úÖ Master reset completed successfully!\n';
                resetLog.innerHTML += `> Deleted: ${data.deleted_count || 'all'} records\n`;
                
                document.getElementById('reset-confirm-text').value = '';
                document.getElementById('reset-admin-password').value = '';
                
                alert('Master reset completed successfully. All data has been cleared.');
            } else {
                resetLog.innerHTML += `> ‚ùå Error: ${data.error}\n`;
                alert(data.error || 'Failed to perform reset');
            }
        } catch (error) {
            resetLog.innerHTML += `> ‚ùå Error: ${error.message}\n`;
            alert('An error occurred during reset');
        }
    }

    // ==================== FINANCIAL REPORTS FUNCTIONS ====================

    let currentReportData = null;
    let currentReportType = null;

    function initReports() {
        // Set default date range to last month
        setDateRange('lastMonth');
    }

    async function handleReportTypeChange() {
        const reportType = document.getElementById('report-type').value;
        const userSelectionSection = document.getElementById('user-selection-section');
        const userSelectionLabel = document.getElementById('user-selection-label');
        const userSelect = document.getElementById('user-select');

        // Hide results when changing report type
        document.getElementById('report-results').style.display = 'none';

        if (reportType === 'worker') {
            userSelectionSection.style.display = 'block';
            userSelectionLabel.textContent = 'Select Worker';
            userSelect.innerHTML = '<option value="">Loading workers...</option>';

            try {
                const response = await fetch('/api/admin/reports/workers');
                const data = await response.json();

                userSelect.innerHTML = '<option value="">Select a worker...</option>';
                data.workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = `${worker.username} (${worker.email}) - ${worker.completed_gigs} gigs, RM ${worker.total_earnings.toFixed(2)}`;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading workers:', error);
                userSelect.innerHTML = '<option value="">Error loading workers</option>';
            }
        } else if (reportType === 'client') {
            userSelectionSection.style.display = 'block';
            userSelectionLabel.textContent = 'Select Client';
            userSelect.innerHTML = '<option value="">Loading clients...</option>';

            try {
                const response = await fetch('/api/admin/reports/clients');
                const data = await response.json();

                userSelect.innerHTML = '<option value="">Select a client...</option>';
                data.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.username} (${client.email}) - RM ${client.total_spent.toFixed(2)} spent`;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients:', error);
                userSelect.innerHTML = '<option value="">Error loading clients</option>';
            }
        } else {
            userSelectionSection.style.display = 'none';
        }
    }

    function setDateRange(range) {
        const now = new Date();
        const startDate = new Date();
        const endDate = new Date();

        switch (range) {
            case 'thisMonth':
                startDate.setDate(1);
                break;
            case 'lastMonth':
                startDate.setMonth(now.getMonth() - 1);
                startDate.setDate(1);
                endDate.setMonth(now.getMonth());
                endDate.setDate(0); // Last day of previous month
                break;
            case 'last3Months':
                startDate.setMonth(now.getMonth() - 3);
                break;
            case 'last6Months':
                startDate.setMonth(now.getMonth() - 6);
                break;
            case 'thisYear':
                startDate.setMonth(0);
                startDate.setDate(1);
                break;
        }

        document.getElementById('report-start-date').value = formatDate(startDate);
        document.getElementById('report-end-date').value = formatDate(endDate);
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    async function generateReport() {
        const reportType = document.getElementById('report-type').value;
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const userId = document.getElementById('user-select').value;

        if (!reportType) {
            alert('Please select a report type');
            return;
        }

        if (!startDate || !endDate) {
            alert('Please select start and end dates');
            return;
        }

        if ((reportType === 'worker' || reportType === 'client') && !userId) {
            alert(`Please select a ${reportType}`);
            return;
        }

        // Show loading
        document.getElementById('report-loading').style.display = 'block';
        document.getElementById('report-results').style.display = 'none';

        try {
            let url = '';
            if (reportType === 'platform') {
                url = `/api/admin/reports/platform?start_date=${startDate}&end_date=${endDate}`;
            } else if (reportType === 'worker') {
                url = `/api/admin/reports/worker/${userId}?start_date=${startDate}&end_date=${endDate}`;
            } else if (reportType === 'client') {
                url = `/api/admin/reports/client/${userId}?start_date=${startDate}&end_date=${endDate}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate report');
            }

            currentReportData = data;
            currentReportType = reportType;

            // Hide loading
            document.getElementById('report-loading').style.display = 'none';
            document.getElementById('report-results').style.display = 'block';

            // Hide all report sections
            document.getElementById('platform-report').style.display = 'none';
            document.getElementById('worker-report').style.display = 'none';
            document.getElementById('client-report').style.display = 'none';

            // Display the appropriate report
            if (reportType === 'platform') {
                displayPlatformReport(data);
            } else if (reportType === 'worker') {
                displayWorkerReport(data);
            } else if (reportType === 'client') {
                displayClientReport(data);
            }
        } catch (error) {
            console.error('Error generating report:', error);
            alert(error.message || 'Failed to generate report');
            document.getElementById('report-loading').style.display = 'none';
        }
    }

    function displayPlatformReport(data) {
        document.getElementById('report-title').textContent = 'Platform Financial Report';
        document.getElementById('platform-report').style.display = 'block';

        // Period
        document.getElementById('platform-period').textContent =
            `${data.period.start_date} to ${data.period.end_date}`;

        // Overview
        document.getElementById('platform-total-revenue').textContent =
            `RM ${data.overview.total_revenue.toFixed(2)}`;
        document.getElementById('platform-new-users').textContent = data.overview.new_users;
        document.getElementById('platform-gigs-completed').textContent = data.overview.gigs_completed;

        // Transactions
        document.getElementById('platform-tx-count').textContent = data.transactions.total_count;
        document.getElementById('platform-tx-amount').textContent =
            `RM ${data.transactions.total_amount.toFixed(2)}`;
        document.getElementById('platform-tx-commission').textContent =
            `RM ${data.transactions.total_commission.toFixed(2)}`;
        document.getElementById('platform-tx-net').textContent =
            `RM ${data.transactions.total_net_amount.toFixed(2)}`;

        // Escrow
        document.getElementById('platform-escrow-funded').textContent =
            `RM ${data.escrow.funded_amount.toFixed(2)}`;
        document.getElementById('platform-escrow-funded-count').textContent =
            `${data.escrow.funded_count} escrows`;
        document.getElementById('platform-escrow-released').textContent =
            `RM ${data.escrow.released_amount.toFixed(2)}`;
        document.getElementById('platform-escrow-released-count').textContent =
            `${data.escrow.released_count} escrows`;
        document.getElementById('platform-escrow-fees').textContent =
            `RM ${data.escrow.platform_fees.toFixed(2)}`;

        // Payouts
        document.getElementById('platform-payout-count').textContent = data.payouts.total_count;
        document.getElementById('platform-payout-amount').textContent =
            `RM ${data.payouts.total_amount.toFixed(2)}`;
        document.getElementById('platform-payout-fees').textContent =
            `RM ${data.payouts.total_fees.toFixed(2)}`;

        // Payment methods breakdown
        const pmContainer = document.getElementById('platform-payment-methods');
        pmContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Payment Methods</h4>';

        if (Object.keys(data.transactions.payment_methods).length > 0) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Payment Method</th>
                        <th>Transactions</th>
                        <th>Amount</th>
                        <th>Commission</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(data.transactions.payment_methods).map(([method, stats]) => `
                        <tr>
                            <td style="text-transform: capitalize;">${method}</td>
                            <td>${stats.count}</td>
                            <td>RM ${stats.amount.toFixed(2)}</td>
                            <td>RM ${stats.commission.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            pmContainer.appendChild(table);
        } else {
            pmContainer.innerHTML += '<p style="color: var(--text-gray);">No payment data available</p>';
        }

        // Commission tiers
        const ctContainer = document.getElementById('platform-commission-tiers');
        ctContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Commission Breakdown by Tier</h4>';

        const tiersGrid = document.createElement('div');
        tiersGrid.className = 'stats-grid';
        tiersGrid.innerHTML = `
            <div class="stat-card">
                <h3>15% Tier (‚â§RM 500)</h3>
                <div class="value">${data.transactions.commission_breakdown.tier_15_percent.count}</div>
                <div class="label">RM ${data.transactions.commission_breakdown.tier_15_percent.commission.toFixed(2)} commission</div>
            </div>
            <div class="stat-card">
                <h3>10% Tier (RM 501-2000)</h3>
                <div class="value">${data.transactions.commission_breakdown.tier_10_percent.count}</div>
                <div class="label">RM ${data.transactions.commission_breakdown.tier_10_percent.commission.toFixed(2)} commission</div>
            </div>
            <div class="stat-card">
                <h3>5% Tier (>RM 2000)</h3>
                <div class="value">${data.transactions.commission_breakdown.tier_5_percent.count}</div>
                <div class="label">RM ${data.transactions.commission_breakdown.tier_5_percent.commission.toFixed(2)} commission</div>
            </div>
        `;
        ctContainer.appendChild(tiersGrid);
    }

    function displayWorkerReport(data) {
        document.getElementById('report-title').textContent = 'Worker Financial Report';
        document.getElementById('worker-report').style.display = 'block';

        // Worker info
        document.getElementById('worker-name').textContent = data.worker.username;
        document.getElementById('worker-email').textContent = data.worker.email;
        document.getElementById('worker-period').textContent =
            `${data.period.start_date} to ${data.period.end_date}`;

        // Wallet
        document.getElementById('worker-balance').textContent =
            `RM ${data.wallet.current_balance.toFixed(2)}`;
        document.getElementById('worker-held').textContent =
            `RM ${data.wallet.held_balance.toFixed(2)}`;
        document.getElementById('worker-total-earned').textContent =
            `RM ${data.wallet.total_earned.toFixed(2)}`;

        // Earnings
        document.getElementById('worker-earned').textContent =
            `RM ${data.earnings.total_earned.toFixed(2)}`;
        document.getElementById('worker-commission').textContent =
            `RM ${data.earnings.total_commission_paid.toFixed(2)}`;
        document.getElementById('worker-tx-count').textContent = data.earnings.transaction_count;
        document.getElementById('worker-escrow').textContent =
            `RM ${data.earnings.escrow_released.toFixed(2)}`;

        // Gigs
        document.getElementById('worker-gigs-completed').textContent = data.gigs.completed_count;
        document.getElementById('worker-gigs-progress').textContent = data.gigs.in_progress_count;

        // Gig details
        const gigContainer = document.getElementById('worker-gig-details');
        gigContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Completed Gigs</h4>';

        if (data.gigs.gig_details.length > 0) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Gig ID</th>
                        <th>Title</th>
                        <th>Budget</th>
                        <th>Earned</th>
                        <th>Commission</th>
                        <th>Completed</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.gigs.gig_details.map(gig => `
                        <tr>
                            <td>${gig.gig_id}</td>
                            <td>${gig.title}</td>
                            <td>RM ${gig.budget.toFixed(2)}</td>
                            <td>RM ${gig.earned.toFixed(2)}</td>
                            <td>RM ${gig.commission.toFixed(2)}</td>
                            <td>${gig.completed_at || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            gigContainer.appendChild(table);
        } else {
            gigContainer.innerHTML += '<p style="color: var(--text-gray);">No completed gigs in this period</p>';
        }

        // Payout details
        const payoutContainer = document.getElementById('worker-payout-details');
        payoutContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Payouts</h4>';

        if (data.payouts.payout_details.length > 0) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Net Amount</th>
                        <th>Method</th>
                        <th>Completed</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.payouts.payout_details.map(payout => `
                        <tr>
                            <td>${payout.payout_number}</td>
                            <td>RM ${payout.amount.toFixed(2)}</td>
                            <td>RM ${payout.fee.toFixed(2)}</td>
                            <td>RM ${payout.net_amount.toFixed(2)}</td>
                            <td style="text-transform: capitalize;">${payout.payment_method}</td>
                            <td>${payout.completed_at || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            payoutContainer.appendChild(table);
        } else {
            payoutContainer.innerHTML += '<p style="color: var(--text-gray);">No payouts in this period</p>';
        }
    }

    function displayClientReport(data) {
        document.getElementById('report-title').textContent = 'Client Spending Report';
        document.getElementById('client-report').style.display = 'block';

        // Client info
        document.getElementById('client-name').textContent = data.client.username;
        document.getElementById('client-email').textContent = data.client.email;
        document.getElementById('client-period').textContent =
            `${data.period.start_date} to ${data.period.end_date}`;

        // Wallet
        document.getElementById('client-balance').textContent =
            `RM ${data.wallet.current_balance.toFixed(2)}`;
        document.getElementById('client-total-spent').textContent =
            `RM ${data.wallet.total_spent.toFixed(2)}`;

        // Spending
        document.getElementById('client-spent').textContent =
            `RM ${data.spending.total_spent.toFixed(2)}`;
        document.getElementById('client-commission').textContent =
            `RM ${data.spending.total_commission.toFixed(2)}`;
        document.getElementById('client-tx-count').textContent = data.spending.transaction_count;

        // Gigs
        document.getElementById('client-gigs-total').textContent = data.gigs.total_count;
        document.getElementById('client-gigs-completed').textContent = data.gigs.completed_count;
        document.getElementById('client-gigs-active').textContent = data.gigs.active_count;

        // Escrow
        document.getElementById('client-escrow-funded').textContent =
            `RM ${data.escrow.total_funded.toFixed(2)}`;
        document.getElementById('client-escrow-funded-count').textContent =
            `${data.escrow.funded_count} escrows`;
        document.getElementById('client-escrow-pending').textContent =
            `RM ${data.escrow.pending_amount.toFixed(2)}`;

        // Payment methods
        const pmContainer = document.getElementById('client-payment-methods');
        pmContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Payment Methods Used</h4>';

        if (Object.keys(data.spending.payment_methods).length > 0) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Payment Method</th>
                        <th>Transactions</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(data.spending.payment_methods).map(([method, stats]) => `
                        <tr>
                            <td style="text-transform: capitalize;">${method}</td>
                            <td>${stats.count}</td>
                            <td>RM ${stats.amount.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            pmContainer.appendChild(table);
        } else {
            pmContainer.innerHTML += '<p style="color: var(--text-gray);">No payment data available</p>';
        }

        // Gig details
        const gigContainer = document.getElementById('client-gig-details');
        gigContainer.innerHTML = '<h4 style="color: var(--text); margin: 20px 0 12px 0;">Gigs</h4>';

        if (data.gigs.gig_details.length > 0) {
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Gig ID</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Budget</th>
                        <th>Spent</th>
                        <th>Commission</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.gigs.gig_details.map(gig => `
                        <tr>
                            <td>${gig.gig_id}</td>
                            <td>${gig.title}</td>
                            <td><span class="badge badge-${gig.status}">${gig.status}</span></td>
                            <td>RM ${gig.budget.toFixed(2)}</td>
                            <td>RM ${gig.spent.toFixed(2)}</td>
                            <td>RM ${gig.commission.toFixed(2)}</td>
                            <td>${gig.created_at || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            gigContainer.appendChild(table);
        } else {
            gigContainer.innerHTML += '<p style="color: var(--text-gray);">No gigs in this period</p>';
        }
    }

    function exportReportToCSV() {
        if (!currentReportData || !currentReportType) {
            alert('No report data to export');
            return;
        }

        let csvContent = '';
        let filename = '';

        if (currentReportType === 'platform') {
            filename = `platform_report_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
            csvContent = 'Platform Financial Report\n\n';
            csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

            csvContent += 'Overview\n';
            csvContent += `Total Revenue,${currentReportData.overview.total_revenue}\n`;
            csvContent += `New Users,${currentReportData.overview.new_users}\n`;
            csvContent += `Completed Gigs,${currentReportData.overview.gigs_completed}\n\n`;

            csvContent += 'Transactions\n';
            csvContent += `Total Count,${currentReportData.transactions.total_count}\n`;
            csvContent += `Total Amount,${currentReportData.transactions.total_amount}\n`;
            csvContent += `Total Commission,${currentReportData.transactions.total_commission}\n`;
            csvContent += `Net to Workers,${currentReportData.transactions.total_net_amount}\n\n`;

            csvContent += 'Payment Methods\n';
            csvContent += 'Method,Count,Amount,Commission\n';
            Object.entries(currentReportData.transactions.payment_methods).forEach(([method, stats]) => {
                csvContent += `${method},${stats.count},${stats.amount},${stats.commission}\n`;
            });
        } else if (currentReportType === 'worker') {
            filename = `worker_report_${currentReportData.worker.username}_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
            csvContent = 'Worker Financial Report\n\n';
            csvContent += `Worker,${currentReportData.worker.username}\n`;
            csvContent += `Email,${currentReportData.worker.email}\n`;
            csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

            csvContent += 'Wallet Status\n';
            csvContent += `Current Balance,${currentReportData.wallet.current_balance}\n`;
            csvContent += `Held Balance,${currentReportData.wallet.held_balance}\n`;
            csvContent += `Lifetime Earnings,${currentReportData.wallet.total_earned}\n\n`;

            csvContent += 'Period Earnings\n';
            csvContent += `Total Earned,${currentReportData.earnings.total_earned}\n`;
            csvContent += `Commission Paid,${currentReportData.earnings.total_commission_paid}\n`;
            csvContent += `Transaction Count,${currentReportData.earnings.transaction_count}\n\n`;

            csvContent += 'Completed Gigs\n';
            csvContent += 'Gig ID,Title,Budget,Earned,Commission,Completed\n';
            currentReportData.gigs.gig_details.forEach(gig => {
                csvContent += `${gig.gig_id},"${gig.title}",${gig.budget},${gig.earned},${gig.commission},${gig.completed_at || 'N/A'}\n`;
            });
        } else if (currentReportType === 'client') {
            filename = `client_report_${currentReportData.client.username}_${currentReportData.period.start_date}_to_${currentReportData.period.end_date}.csv`;
            csvContent = 'Client Spending Report\n\n';
            csvContent += `Client,${currentReportData.client.username}\n`;
            csvContent += `Email,${currentReportData.client.email}\n`;
            csvContent += `Period,${currentReportData.period.start_date} to ${currentReportData.period.end_date}\n\n`;

            csvContent += 'Wallet Status\n';
            csvContent += `Current Balance,${currentReportData.wallet.current_balance}\n`;
            csvContent += `Lifetime Spent,${currentReportData.wallet.total_spent}\n\n`;

            csvContent += 'Period Spending\n';
            csvContent += `Total Spent,${currentReportData.spending.total_spent}\n`;
            csvContent += `Commission Paid,${currentReportData.spending.total_commission}\n`;
            csvContent += `Transaction Count,${currentReportData.spending.transaction_count}\n\n`;

            csvContent += 'Gigs\n';
            csvContent += 'Gig ID,Title,Status,Budget,Spent,Commission,Created\n';
            currentReportData.gigs.gig_details.forEach(gig => {
                csvContent += `${gig.gig_id},"${gig.title}",${gig.status},${gig.budget},${gig.spent},${gig.commission},${gig.created_at || 'N/A'}\n`;
            });
        }

        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ==================== LANDSCAPE MODE POPUP ====================

    function checkOrientation() {
        const dontShow = localStorage.getItem('hideLandscapePopup');
        if (dontShow === 'true') return;

        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        const isMobileOrTablet = window.matchMedia("(max-width: 1024px)").matches;

        if (isPortrait && isMobileOrTablet) {
            document.getElementById('landscape-popup').style.display = 'flex';
        } else {
            document.getElementById('landscape-popup').style.display = 'none';
        }
    }

    function closeLandscapePopup() {
        const dontShowAgain = document.getElementById('dont-show-landscape').checked;
        if (dontShowAgain) {
            localStorage.setItem('hideLandscapePopup', 'true');
        }
        document.getElementById('landscape-popup').style.display = 'none';
    }

    // Check orientation on load and orientation change
    window.addEventListener('load', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    window.addEventListener('resize', checkOrientation);

    checkAdminAccess();
</script>
{% endblock %}