{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, var(--primary) 0%, #00a844 100%);
        color: white;
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
    }

    .admin-header h1 {
        margin: 0 0 6px 0;
        font-size: 28px;
    }

    .admin-header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-white);
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
        margin: 0 0 6px 0;
        color: var(--text-gray);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .stat-card .label {
        color: var(--text-light);
        font-size: 12px;
    }

    .data-table {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .table-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .table-header h2 {
        margin: 0;
        color: var(--text-dark);
        font-size: 17px;
    }

    .search-box {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 220px;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        background: var(--bg-light);
        font-weight: 600;
        color: var(--text-dark);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    tr:hover {
        background: var(--bg-light);
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge.verified { background: #d1fae5; color: #065f46; }
    .badge.unverified { background: #fee2e2; color: #991b1b; }
    .badge.admin { background: #dbeafe; color: #1e40af; }
    .badge.freelancer { background: #fef3c7; color: #92400e; }
    .badge.client { background: #e0e7ff; color: #3730a3; }
    .badge.open { background: #d1fae5; color: #065f46; }
    .badge.in-progress { background: #fef3c7; color: #92400e; }
    .badge.completed { background: #dbeafe; color: #1e40af; }
    .badge.cancelled { background: #fee2e2; color: #991b1b; }

    .action-btns {
        display: flex;
        gap: 6px;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 11px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-view {
        background: #3b82f6;
        color: white;
    }

    .btn-view:hover {
        background: #2563eb;
    }

    .btn-edit {
        background: var(--primary);
        color: white;
    }

    .btn-edit:hover {
        background: var(--primary-dark);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .modal-lg {
        max-width: 800px;
    }

    .user-detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .detail-section {
        background: var(--bg-light);
        padding: 16px;
        border-radius: var(--radius-md);
    }

    .detail-section.full-width {
        grid-column: span 2;
    }

    .detail-section h4 {
        margin: 0 0 12px 0;
        color: var(--primary);
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row .label {
        color: var(--text-gray);
        font-size: 13px;
    }

    .detail-row .value {
        font-weight: 500;
        color: var(--text-dark);
        font-size: 13px;
    }

    @media (max-width: 600px) {
        .user-detail-grid {
            grid-template-columns: 1fr;
        }
        .detail-section.full-width {
            grid-column: span 1;
        }
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 18px;
    }

    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--primary);
        background: var(--bg-white);
        color: var(--primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
        background: var(--primary);
        color: white;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-gray);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: var(--bg-white);
        padding: 28px;
        border-radius: var(--radius-lg);
        max-width: 450px;
        width: 90%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        margin: 0 0 20px 0;
        color: var(--text-dark);
        font-size: 18px;
        padding-right: 30px;
    }

    .modal-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-gray);
        cursor: pointer;
        padding: 4px 8px;
        line-height: 1;
        transition: color 0.2s;
    }

    .modal-close-btn:hover {
        color: var(--text-dark);
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 13px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .section-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-gray);
        margin: 24px 0 14px 0;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .table-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .search-box {
            width: 100%;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Admin Dashboard</h1>
    <p id="admin-welcome">Welcome, Administrator</p>
</div>

<div id="error-container"></div>
<div id="success-container"></div>

<!-- Landscape Mode Recommendation Popup -->
<div id="landscape-popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 32px; border-radius: 16px; max-width: 400px; text-align: center; margin: 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì± ‚û°Ô∏è üì≤</div>
        <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 20px;">Landscape Mode Recommended</h3>
        <p style="color: var(--text-gray); margin: 0 0 20px 0; line-height: 1.5;">
            For the best viewing experience with financial reports and tables, we recommend rotating your device to landscape mode.
        </p>
        <button onclick="closeLandscapePopup()" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
            Got it!
        </button>
        <label style="display: flex; align-items: center; justify-content: center; margin-top: 16px; cursor: pointer; color: var(--text-gray); font-size: 13px;">
            <input type="checkbox" id="dont-show-landscape" style="margin-right: 6px;">
            Don't show this again
        </label>
    </div>
</div>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
    <button class="tab-btn" onclick="switchTab('users')">Users</button>
    <button class="tab-btn" onclick="switchTab('gigs')">Gigs</button>
    <button class="tab-btn" onclick="switchTab('gig-reports')" style="color: #dc2626;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
            <circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        Gig Reports
    </button>
    <button class="tab-btn" onclick="switchTab('blocked-gigs')" style="color: #dc2626;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
            <circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
        </svg>
        Blocked Gigs
    </button>
    <button class="tab-btn" onclick="switchTab('payouts')">Payouts</button>
    <button class="tab-btn" onclick="switchTab('socso')">SOCSO Compliance</button>
    <a href="/admin/accounting" class="tab-btn" style="text-decoration:none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none;">
        üí∞ Accounting Dashboard
    </a>
    <button class="tab-btn" onclick="switchTab('messaging')">SMS & WhatsApp</button>
    <button class="tab-btn" onclick="switchTab('email')">Email</button>
    <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
    <a href="/admin/feedback" class="tab-btn" style="text-decoration:none;">Feedback</a>
    <a href="/admin/security-logs" class="tab-btn" style="text-decoration:none; color: #dc2626;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        Security Logs
    </a>
    <button class="tab-btn" onclick="switchTab('reset')" style="color: #dc2626;">Reset Data</button>
</div>

<div id="dashboard-tab" class="tab-content active">
    <div id="stats-loading" class="loading">Loading statistics...</div>
    <div id="stats-content" style="display: none;">
        <h3 class="section-title">User Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="stat-total-users">0</div>
                <div class="label" id="stat-recent-users">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Freelancers</h3>
                <div class="value" id="stat-freelancers">0</div>
            </div>
            <div class="stat-card">
                <h3>Clients</h3>
                <div class="value" id="stat-clients">0</div>
            </div>
            <div class="stat-card">
                <h3>Verified Users</h3>
                <div class="value" id="stat-verified">0</div>
            </div>
        </div>

        <h3 class="section-title">Gig Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Gigs</h3>
                <div class="value" id="stat-total-gigs">0</div>
                <div class="label" id="stat-recent-gigs">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Open Gigs</h3>
                <div class="value" id="stat-open-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="value" id="stat-progress-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <div class="value" id="stat-completed-gigs">0</div>
            </div>
        </div>

        <h3 class="section-title">Financial Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Payout</h3>
                <div class="value" id="stat-payout">RM 0</div>
                <div class="label">Total amount paid to workers</div>
            </div>
            <div class="stat-card">
                <h3>Commission</h3>
                <div class="value" id="stat-commission">RM 0</div>
                <div class="label">Cumulative commission earned</div>
            </div>
            <div class="stat-card">
                <h3>Escrow</h3>
                <div class="value" id="stat-escrow">RM 0</div>
                <div class="label">Amount held in escrow</div>
            </div>
            <div class="stat-card">
                <h3>Applications</h3>
                <div class="value" id="stat-applications">0</div>
                <div class="label" id="stat-pending-apps">0 pending</div>
            </div>
        </div>

        <h3 class="section-title">SOCSO Compliance (Gig Workers Bill 2025)</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total SOCSO Collected</h3>
                <div class="value" id="stat-socso-collected">RM 0</div>
                <div class="label">1.25% deducted from freelancer earnings</div>
            </div>
            <div class="stat-card">
                <h3>Remitted to SOCSO</h3>
                <div class="value" id="stat-socso-remitted">RM 0</div>
                <div class="label">Paid via ASSIST Portal</div>
            </div>
            <div class="stat-card">
                <h3>Pending Remittance</h3>
                <div class="value" id="stat-socso-pending">RM 0</div>
                <div class="label">Awaiting ASSIST Portal submission</div>
            </div>
            <div class="stat-card">
                <h3>Registered Freelancers</h3>
                <div class="value" id="stat-socso-registered">0</div>
                <div class="label" id="stat-socso-compliance">0% compliance rate</div>
            </div>
            <div class="stat-card">
                <h3>Current Month Collection</h3>
                <div class="value" id="stat-socso-current-month">RM 0</div>
                <div class="label">This month's SOCSO deductions</div>
            </div>
        </div>
    </div>
</div>

<div id="analytics-tab" class="tab-content">
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Visits</h3>
            <div class="value" id="analytic-total-visits">0</div>
        </div>
        <div class="stat-card">
            <h3>Recent (30d)</h3>
            <div class="value" id="analytic-recent-visits">0</div>
        </div>
        <div class="stat-card">
            <h3>Unique Visitors</h3>
            <div class="value" id="analytic-unique-visitors">0</div>
        </div>
    </div>

    <div class="data-table" style="margin-bottom: 24px;">
        <div class="table-header">
            <h2>Top Pages</h2>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Page Path</th>
                    <th>Visits</th>
                </tr>
            </thead>
            <tbody id="top-pages-tbody">
                <tr><td colspan="2" style="text-align:center;">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="data-table">
        <div class="table-header">
            <h2>Daily Visits (Last 7 Days)</h2>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Visits</th>
                </tr>
            </thead>
            <tbody id="daily-visits-tbody">
                <tr><td colspan="2" style="text-align:center;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="users-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>User Management</h2>
            <input type="text" id="user-search" class="search-box" placeholder="Search users...">
        </div>
        <div id="users-loading" class="loading">Loading users...</div>
        <div id="users-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th style="cursor: pointer; user-select: none;" onclick="toggleUserSort()" id="users-id-header">ID <span id="users-sort-indicator"></span></th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
            <div class="pagination" id="users-pagination"></div>
        </div>
    </div>
</div>

<div id="gigs-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Gig Management</h2>
            <select id="gig-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <option value="">All Status</option>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div id="gigs-loading" class="loading">Loading gigs...</div>
        <div id="gigs-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Client</th>
                        <th>Worker</th>
                        <th>Category</th>
                        <th>Budget</th>
                        <th>Applications</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gigs-tbody"></tbody>
            </table>
            <div class="pagination" id="gigs-pagination"></div>
        </div>
    </div>
</div>

<!-- Gig Reports Tab -->
<div id="gig-reports-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Gig Reports - Content Moderation</h2>
            <select id="report-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);" onchange="loadGigReports()">
                <option value="">All Status</option>
                <option value="pending" selected>Pending Review</option>
                <option value="reviewed">Reviewed</option>
                <option value="dismissed">Dismissed</option>
                <option value="action_taken">Action Taken</option>
            </select>
        </div>
        <div id="reports-loading" class="loading">Loading reports...</div>
        <div id="reports-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Report ID</th>
                        <th>Gig</th>
                        <th>Reporter</th>
                        <th>Reason</th>
                        <th>Description</th>
                        <th>Gig Status</th>
                        <th>Reported At</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-tbody"></tbody>
            </table>
            <div class="pagination" id="reports-pagination"></div>
        </div>
    </div>
</div>

<!-- Blocked Gigs Tab -->
<div id="blocked-gigs-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Blocked Gigs</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span style="color: #dc2626; font-weight: 600;">‚ö†Ô∏è Gigs hidden from public view</span>
            </div>
        </div>
        <div id="blocked-gigs-loading" class="loading">Loading blocked gigs...</div>
        <div id="blocked-gigs-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Gig ID</th>
                        <th>Title</th>
                        <th>Client</th>
                        <th>Category</th>
                        <th>Reports</th>
                        <th>Blocked At</th>
                        <th>Blocked By</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="blocked-gigs-tbody"></tbody>
            </table>
            <div class="pagination" id="blocked-gigs-pagination"></div>
        </div>
    </div>
</div>

<div id="payouts-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Payout Requests</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
                <select id="payout-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);" onchange="loadPayouts()">
                    <option value="">All Status</option>
                    <option value="pending" selected>Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <div class="stat-card" style="padding: 10px 16px; margin: 0; min-width: 200px;">
                    <h3 style="margin: 0; font-size: 11px;">Pending Amount</h3>
                    <div class="value" style="font-size: 18px; margin: 0;" id="pending-payout-amount">MYR 0.00</div>
                </div>
            </div>
        </div>
        <div id="payouts-loading" class="loading">Loading payouts...</div>
        <div id="payouts-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Freelancer</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Net Amount</th>
                        <th>Method</th>
                        <th>Account Info</th>
                        <th>Status</th>
                        <th>Requested</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payouts-tbody"></tbody>
            </table>
            <div class="pagination" id="payouts-pagination"></div>
        </div>
    </div>
</div>

<div id="socso-tab" class="tab-content">
        <h3 class="section-title">SOCSO Compliance Management (Gig Workers Bill 2025)</h3>
        <div style="background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <p style="color: #166534; font-size: 13px; margin: 0; flex: 1;">Track and manage mandatory SOCSO contributions from freelancer earnings. Export data for ASSIST Portal bulk upload.</p>
            <a href="/admin/socso-registration" class="btn-sm btn-view" style="background: #8b5cf6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600; white-space: nowrap;">üè• Register Freelancers</a>
        </div>

        <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
                <h3>Total Collected</h3>
                <div class="value" id="stat-socso-collected">RM 0</div>
                <div class="label">Total SOCSO collected this month</div>
            </div>
            <div class="stat-card">
                <h3>Pending Remittance</h3>
                <div class="value" id="stat-socso-pending">RM 0</div>
                <div class="label">Awaiting ASSIST Portal upload</div>
            </div>
            <div class="stat-card">
                <h3>Registered Freelancers</h3>
                <div class="value" id="stat-freelancers-socso">0</div>
                <div class="label">With SOCSO consent</div>
            </div>
            <div class="stat-card">
                <h3>Compliance Rate</h3>
                <div class="value" id="stat-socso-compliance">0%</div>
                <div class="label">Freelancers with complete data</div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <h2>Monthly SOCSO Report</h2>
                <div style="display: flex; gap: 10px;">
                    <select id="socsoReportYear" onchange="loadSocsoReport()">
                        <option value="">Select Year</option>
                    </select>
                    <select id="socsoReportMonth" onchange="loadSocsoReport()">
                        <option value="">All Months</option>
                        <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                        <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                    </select>
                    <button class="btn-sm btn-view" onclick="exportSOCSO()">Export CSV</button>
                </div>
            </div>
            <div id="socsoReportLoading" class="loading">Loading report...</div>
            <div id="socsoReportContent" style="display: none;">
                <table>
                    <thead>
                        <tr><th>Month</th><th>Freelancer</th><th>IC Number</th><th>SOCSO Number</th><th>Email</th><th>Transactions</th><th>Net Earnings</th><th>SOCSO</th><th>Status</th></tr>
                    </thead>
                    <tbody id="socsoReportBody"></tbody>
                </table>
            </div>
            <div id="socsoEmpty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìä</div>
                <h3>No SOCSO Data Available</h3>
                <p>No SOCSO contributions recorded for the selected period</p>
            </div>
        </div>

        <!-- SOCSO Payment Totals Per User Section -->
        <div class="data-table" style="margin-top: 24px;">
            <div class="table-header">
                <h2>SOCSO Payment Totals Per User</h2>
                <div style="display: flex; gap: 10px;">
                    <select id="socsoPeriodFilter" onchange="loadSocsoUserTotals()">
                        <option value="1">Last 1 Month</option>
                        <option value="6">Last 6 Months</option>
                        <option value="12">Last 12 Months</option>
                    </select>
                    <button class="btn-sm btn-view" onclick="exportSocsoUserTotals()">Export CSV</button>
                </div>
            </div>
            <div id="socsoUserTotalsLoading" class="loading">Loading user totals...</div>
            <div id="socsoUserTotalsContent" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Freelancer</th>
                            <th>IC Number</th>
                            <th>SOCSO Number</th>
                            <th>Email</th>
                            <th>Total Transactions</th>
                            <th>Total Net Earnings</th>
                            <th>Total SOCSO</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="socsoUserTotalsBody"></tbody>
                </table>
            </div>
            <div id="socsoUserTotalsEmpty" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üìä</div>
                <h3>No SOCSO Data Available</h3>
                <p>No SOCSO contributions found for the selected period</p>
            </div>
        </div>

        <!-- Borang 8A Generator Section -->
        <div class="data-table" style="margin-top: 24px;">
            <div class="table-header">
                <h2>üóÇÔ∏è Generate Borang 8A (Monthly Submission Form)</h2>
            </div>
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <p style="color: #92400e; font-size: 13px; margin: 0;">
                    <strong>‚ö†Ô∏è Monthly Submission Deadline:</strong> Borang 8A must be submitted to PERKESO ASSIST Portal by the 15th of each month for the previous month's contributions.
                </p>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px;">
                <h3 style="margin-top: 0; color: #003366;">Generate SOCSO Borang 8A</h3>
                <p style="color: #666; margin-bottom: 24px;">
                    Official monthly SOCSO contribution report for ASSIST Portal submission.
                </p>

                <!-- Employer Settings Check -->
                <div id="borang8aSettingsWarning" style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 20px; display: none;">
                    <p style="color: #991b1b; font-weight: 600; margin: 0 0 10px 0;">‚ö†Ô∏è Employer Settings Required</p>
                    <p style="color: #7f1d1d; font-size: 13px; margin: 0;">
                        Please configure your SOCSO Employer Code and SSM Number in Settings before generating Borang 8A.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label for="borang8aYear" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Year</label>
                        <select id="borang8aYear" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <option value="">Select Year</option>
                        </select>
                    </div>
                    <div>
                        <label for="borang8aMonth" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Month</label>
                        <select id="borang8aMonth" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-sm btn-view" onclick="viewBorang8A()" style="background: #003366; color: white; padding: 12px 24px; display: flex; align-items: center; gap: 8px;">
                        <span>üìÑ</span> View Printable Form
                    </button>
                    <button class="btn-sm btn-view" onclick="downloadBorang8ATXT()" style="background: #10b981; color: white; padding: 12px 24px; display: flex; align-items: center; gap: 8px;">
                        <span>üì•</span> Download TXT File
                    </button>
                    <button class="btn-sm btn-view" onclick="previewBorang8AData()" style="background: #6366f1; color: white; padding: 12px 24px; display: flex; align-items: center; gap: 8px;">
                        <span>üëÅÔ∏è</span> Preview Data
                    </button>
                </div>

                <div id="borang8aPreview" style="display: none; margin-top: 24px; padding: 20px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #003366;">Borang 8A Preview</h4>
                    <div id="borang8aPreviewContent"></div>
                </div>
            </div>

            <div style="background: #eff6ff; border: 1px solid #dbeafe; border-radius: 8px; padding: 16px; margin-top: 20px;">
                <h4 style="margin: 0 0 12px 0; color: #1e40af;">üìã Submission Instructions</h4>
                <ol style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 13px;">
                    <li>Generate Borang 8A for the previous month</li>
                    <li>Review the printable form for accuracy</li>
                    <li>Download the TXT file for ASSIST Portal upload</li>
                    <li>Login to <a href="https://assist.perkeso.gov.my/employer/login" target="_blank" style="color: #2563eb;">ASSIST Portal</a></li>
                    <li>Navigate to "Bulk Contribution Upload" or "Borang 8A Submission"</li>
                    <li>Upload the TXT file and complete the submission</li>
                    <li>Keep the submission reference number for records</li>
                </ol>
            </div>
        </div>
</div>

<div id="messaging-tab" class="tab-content">
    <!-- SMS Section -->
    <div class="data-table">
        <div class="table-header">
            <h2>üì± Send SMS to All Users</h2>
        </div>
        <div style="padding: 24px;">
            <form id="sms-broadcast-form" onsubmit="sendSMSBroadcast(event)">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Message</label>
                    <textarea id="sms-message" name="message" placeholder="Enter your message (max 160 characters)" maxlength="160" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; resize: vertical; min-height: 100px; font-family: inherit;" required></textarea>
                    <div id="sms-char-count" style="font-size: 12px; color: var(--text-gray); margin-top: 6px;">0 / 160 characters</div>
                </div>
                <button type="submit" class="btn btn-primary" id="sms-send-btn" style="width: 100%; padding: 12px;">Send SMS to All Users</button>
            </form>
            <div id="sms-status" style="margin-top: 16px;"></div>
        </div>
    </div>

    <!-- WhatsApp Section -->
    <div class="data-table" style="margin-top: 24px;">
        <div class="table-header">
            <h2>üí¨ Send WhatsApp Message to All Users</h2>
        </div>
        <div style="padding: 24px;">
            <form id="whatsapp-broadcast-form" onsubmit="sendWhatsAppBroadcast(event)">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Message</label>
                    <textarea id="whatsapp-message" name="message" placeholder="Enter your message (max 1024 characters)" maxlength="1024" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; resize: vertical; min-height: 100px; font-family: inherit;" required></textarea>
                    <div id="whatsapp-char-count" style="font-size: 12px; color: var(--text-gray); margin-top: 6px;">0 / 1024 characters</div>
                </div>
                <button type="submit" class="btn btn-primary" id="whatsapp-send-btn" style="width: 100%; padding: 12px; background: #25D366;">Send WhatsApp to All Users</button>
            </form>
            <div id="whatsapp-status" style="margin-top: 16px;"></div>
        </div>
    </div>

    <!-- History Section -->
    <div class="data-table" style="margin-top: 24px;">
        <div class="table-header">
            <h2>üìã Broadcast History</h2>
        </div>
        <div id="messaging-history" style="padding: 24px; color: var(--text-gray);">
            <p>Messages will be logged here</p>
        </div>
    </div>
</div>

<div id="email-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>üìß Send Email to Users</h2>
        </div>
        <div style="padding: 24px;">
            <form id="email-broadcast-form" onsubmit="sendEmailBroadcast(event)">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Recipient Type</label>
                    <select id="email-recipient-type" name="recipient_type" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; background: white;" onchange="updateRecipientInfo()">
                        <option value="all">All Users</option>
                        <option value="freelancers">Freelancers Only</option>
                        <option value="clients">Clients Only</option>
                        <option value="selected">Selected Users</option>
                    </select>
                    <div id="recipient-info" style="font-size: 12px; color: var(--text-gray); margin-top: 6px;"></div>
                </div>
                
                <div id="selected-users-section" style="display: none; margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Select Users</label>
                    <input type="text" id="user-search" placeholder="Search users..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; margin-bottom: 8px;">
                    <div id="user-list" style="border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto; padding: 8px;"></div>
                    <div id="selected-users-count" style="font-size: 12px; color: var(--text-gray); margin-top: 6px;">0 users selected</div>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Email Subject</label>
                    <input type="text" id="email-subject" name="subject" placeholder="Enter email subject" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;" required>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">Email Content</label>
                    <textarea id="email-content" name="html_content" placeholder="Enter your email message. Line breaks will be automatically converted to HTML." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; resize: vertical; min-height: 200px;" required></textarea>
                    <div style="font-size: 12px; color: var(--text-gray); margin-top: 6px;">Line breaks are automatically preserved. You can also use HTML tags for advanced formatting.</div>
                </div>

                <button type="submit" class="btn btn-primary" id="email-send-btn" style="width: 100%; padding: 12px;">Send Email</button>
            </form>
            <div id="email-status" style="margin-top: 16px;"></div>
        </div>
    </div>
</div>

<div id="settings-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Payment Gateway Settings</h2>
        </div>
        <div style="padding: 24px;">
            <p style="color: var(--text-gray); margin-bottom: 24px;">Select which payment gateway to use for processing payments. The selected gateway will be used for all transactions.</p>
            
            <div id="gateway-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div class="gateway-card" id="gateway-payhalal" onclick="selectGateway('payhalal')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">‚ò™Ô∏è</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">PayHalal</h3>
                            <span style="background: #10B981; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">SHARIAH COMPLIANT</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Malaysia's first Shariah-compliant payment gateway. Supports FPX, cards, and e-wallets.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Processing Fee: <strong>2%</strong></div>
                        <div>Methods: FPX, Visa, Mastercard, TnG, GrabPay</div>
                    </div>
                </div>
                
                <div class="gateway-card" id="gateway-stripe" onclick="selectGateway('stripe')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">üí≥</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">Stripe</h3>
                            <span style="background: #6366F1; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">INTERNATIONAL</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Global payment processor with international card support and multi-currency.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Processing Fee: <strong>2.9% + RM1</strong></div>
                        <div>Methods: Visa, Mastercard, Amex, Apple Pay</div>
                    </div>
                </div>
            </div>
            
            <div id="gateway-status" style="padding: 16px; background: var(--bg-light); border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="gateway-status-icon">‚è≥</span>
                    <span id="gateway-status-text">Loading current gateway...</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveGatewaySettings()" id="save-gateway-btn" style="display: none;">
                Save Gateway Settings
            </button>
        </div>
    </div>

    <div class="data-table" style="margin-top: 24px;">
        <div class="table-header">
            <h2>Stripe Transaction Mode</h2>
        </div>
        <div style="padding: 24px;">
            <p style="color: var(--text-gray); margin-bottom: 24px;">
                <strong>‚ö†Ô∏è IMPORTANT:</strong> Switch between test and live modes for Stripe transactions.
                Test mode uses sandbox keys for testing without real money. Live mode processes actual payments.
            </p>

            <div id="stripe-mode-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div class="stripe-mode-card" id="mode-test" onclick="selectStripeMode('test')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">üß™</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">Test Mode</h3>
                            <span style="background: #F59E0B; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">SANDBOX</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Use test API keys for development and testing. No real money is charged.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Status: <span id="test-mode-status">‚è≥ Checking...</span></div>
                    </div>
                </div>

                <div class="stripe-mode-card" id="mode-live" onclick="selectStripeMode('live')" style="background: var(--bg-white); border: 2px solid var(--border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 32px;">üî¥</span>
                        <div>
                            <h3 style="margin: 0; color: var(--text-dark);">Live Mode</h3>
                            <span style="background: #DC2626; color: white; font-size: 10px; padding: 2px 8px; border-radius: 4px;">PRODUCTION</span>
                        </div>
                    </div>
                    <p style="color: var(--text-gray); font-size: 14px; margin-bottom: 12px;">Use live API keys for real transactions. Real money will be charged.</p>
                    <div style="font-size: 13px; color: var(--text-light);">
                        <div>Status: <span id="live-mode-status">‚è≥ Checking...</span></div>
                    </div>
                </div>
            </div>

            <div id="stripe-mode-status" style="padding: 16px; background: var(--bg-light); border-radius: 8px; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="stripe-mode-status-icon">‚è≥</span>
                    <span id="stripe-mode-status-text">Loading current mode...</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveStripeModeSettings()" id="save-stripe-mode-btn" style="display: none;">
                Save Stripe Mode
            </button>
        </div>
    </div>

    <div class="data-table" style="margin-top: 24px;">
        <div class="table-header">
            <h2>Fee Configuration</h2>
        </div>
        <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="stat-card">
                    <h3>Platform Commission</h3>
                    <div class="value">15% / 10% / 5%</div>
                    <div class="label">Tiered based on gig amount</div>
                </div>
                <div class="stat-card">
                    <h3>Payout Fee</h3>
                    <div class="value">2%</div>
                    <div class="label">Charged on withdrawals</div>
                </div>
                <div class="stat-card" id="processing-fee-card">
                    <h3>Processing Fee</h3>
                    <div class="value" id="current-processing-fee">2%</div>
                    <div class="label">Based on selected gateway</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="reset-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header" style="background: #fef2f2; border-bottom-color: #fecaca;">
            <h2 style="color: #dc2626;">‚ö†Ô∏è Master Data Reset</h2>
        </div>
        <div style="padding: 24px;">
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                <h3 style="color: #dc2626; margin: 0 0 12px 0;">Warning: Destructive Action</h3>
                <p style="color: #7f1d1d; margin: 0 0 16px 0;">This action will permanently delete all platform data except user account information. This cannot be undone.</p>
                <div style="font-size: 14px; color: #991b1b;">
                    <strong>What will be DELETED:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>All gigs and applications</li>
                        <li>All transactions, invoices, and receipts</li>
                        <li>All messages and conversations</li>
                        <li>All reviews and ratings</li>
                        <li>All disputes and milestones</li>
                        <li>All notifications</li>
                        <li>All portfolio items</li>
                        <li>All payouts and payment history</li>
                        <li>All platform feedback</li>
                    </ul>
                </div>
                <div style="font-size: 14px; color: #065f46; margin-top: 16px;">
                    <strong>What will be PRESERVED:</strong>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                        <li>User accounts (username, email, password)</li>
                        <li>User profiles and settings</li>
                        <li>Wallet balances (will be reset to 0)</li>
                        <li>Identity verification status</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: var(--bg-light); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                <h4 style="margin: 0 0 16px 0; color: var(--text-dark);">Security Confirmation</h4>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type "RESET" to confirm:</label>
                    <input type="text" id="reset-confirm-text" placeholder="Type RESET" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 300px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enter your admin password:</label>
                    <input type="password" id="reset-admin-password" placeholder="Your password" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 300px; font-size: 16px;">
                </div>
                <button onclick="performMasterReset()" style="background: #dc2626; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer;">
                    üóëÔ∏è Reset All Data
                </button>
            </div>
            
            <div id="reset-log" style="display: none; background: #1f2937; color: #10b981; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto;">
            </div>
        </div>
    </div>
</div>

<div id="payout-detail-modal" class="modal" onclick="if(event.target===this) closePayoutModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closePayoutModal()">&times;</button>
        <h3>Payout Details</h3>
        <div id="payout-detail-content"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePayoutModal()">Close</button>
            <button class="btn btn-danger" id="payout-reject-btn" onclick="updatePayoutStatus('failed')">Reject</button>
            <button class="btn btn-warning" id="payout-processing-btn" onclick="updatePayoutStatus('processing')">Mark Processing</button>
            <button class="btn btn-success" id="payout-approve-btn" onclick="updatePayoutStatus('completed')">Mark Completed</button>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="modal" onclick="closeModalOnBackdrop(event, 'edit-user-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('edit-user-modal')">&times;</button>
        <h3>Edit User</h3>
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="edit-username" disabled>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="text" id="edit-email" disabled>
        </div>
        <div class="form-group">
            <label>User Type:</label>
            <select id="edit-user-type">
                <option value="freelancer">Freelancer</option>
                <option value="client">Client</option>
                <option value="both">Both</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-verified">
                <label for="edit-verified">Verified</label>
            </div>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-is-admin">
                <label for="edit-is-admin">Admin</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-user-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="view-user-modal" class="modal" onclick="closeModalOnBackdrop(event, 'view-user-modal')">
    <div class="modal-content modal-lg" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('view-user-modal')">&times;</button>
        <h3>User Details</h3>
        <div id="view-user-content">
            <p>Loading...</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('view-user-modal')">Close</button>
        </div>
    </div>
</div>

<div id="edit-gig-modal" class="modal" onclick="closeModalOnBackdrop(event, 'edit-gig-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('edit-gig-modal')">&times;</button>
        <h3>Edit Gig</h3>
        <div class="form-group">
            <label>Title:</label>
            <input type="text" id="edit-gig-title" disabled>
        </div>
        <div class="form-group">
            <label>Status:</label>
            <select id="edit-gig-status">
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-gig-halal-verified">
                <label for="edit-gig-halal-verified">Halal Verified</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveGigChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-gig-modal')">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadAnalytics() {
        try {
            const response = await fetch('/api/admin/analytics');
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('analytic-total-visits').textContent = data.total_visits;
                document.getElementById('analytic-recent-visits').textContent = data.recent_visits;
                document.getElementById('analytic-unique-visitors').textContent = data.unique_visitors;
                
                const topPagesBody = document.getElementById('top-pages-tbody');
                topPagesBody.innerHTML = data.top_pages.map(p => `
                    <tr>
                        <td>${p.path}</td>
                        <td>${p.count}</td>
                    </tr>
                `).join('') || '<tr><td colspan="2" style="text-align:center;">No data</td></tr>';
                
                const dailyVisitsBody = document.getElementById('daily-visits-tbody');
                dailyVisitsBody.innerHTML = data.daily_visits.map(d => `
                    <tr>
                        <td>${d.date}</td>
                        <td>${d.count}</td>
                    </tr>
                `).join('') || '<tr><td colspan="2" style="text-align:center;">No data</td></tr>';
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    let currentEditUserId = null;
    let currentEditGigId = null;
    let usersCurrentPage = 1;
    let gigsCurrentPage = 1;
    let usersSortAscending = true;

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.color = '#dc2626';
            element.textContent = message;
            element.style.padding = '12px';
            element.style.backgroundColor = '#fee2e2';
            element.style.borderRadius = '8px';
            element.style.marginTop = '16px';
        }
    }

    function showSuccess(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.color = '#059669';
            element.textContent = message;
            element.style.padding = '12px';
            element.style.backgroundColor = '#d1fae5';
            element.style.borderRadius = '8px';
            element.style.marginTop = '16px';
        }
    }

    async function checkAdminAccess() {
        try {
            const response = await fetch('/api/admin/check');
            const data = await response.json();

            if (!data.is_admin) {
                window.location.href = '/';
                return;
            }

            if (data.user) {
                document.getElementById('admin-welcome').textContent = `Welcome, ${data.user.username}`;
            }

            loadDashboard();
            populateSocsoYears();
        } catch (error) {
            console.error('Error checking admin access:', error);
            window.location.href = '/';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'analytics') loadAnalytics();
        else if (tabName === 'users') loadUsers(1);
        else if (tabName === 'gigs') loadGigs(1);
        else if (tabName === 'payouts') loadPayouts();
        else if (tabName === 'reports') initReports();
        else if (tabName === 'socso') {
            loadSocsoReport();
            loadSocsoUserTotals();
            initBorang8AYearSelector();
        }
        else if (tabName === 'messaging') initMessaging();
        else if (tabName === 'settings') {
            loadSettings();
            loadStripeModeSettings();
        }
    }

    function initMessaging() {
        const smsTextarea = document.getElementById('sms-message');
        const whatsappTextarea = document.getElementById('whatsapp-message');
        smsTextarea.addEventListener('input', updateSMSCharCount);
        whatsappTextarea.addEventListener('input', updateWhatsAppCharCount);
        updateSMSCharCount();
        updateWhatsAppCharCount();
    }

    function updateSMSCharCount() {
        const textarea = document.getElementById('sms-message');
        const count = textarea.value.length;
        document.getElementById('sms-char-count').textContent = `${count} / 160 characters`;
    }

    function updateWhatsAppCharCount() {
        const textarea = document.getElementById('whatsapp-message');
        const count = textarea.value.length;
        document.getElementById('whatsapp-char-count').textContent = `${count} / 1024 characters`;
    }

    async function sendSMSBroadcast(event) {
        event.preventDefault();
        const message = document.getElementById('sms-message').value.trim();
        const btn = document.getElementById('sms-send-btn');
        const statusDiv = document.getElementById('sms-status');

        if (!message) {
            statusDiv.innerHTML = '<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;">Message cannot be empty</div>';
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Sending...';
        statusDiv.innerHTML = '<div style="padding: 12px; background: #E0E7FF; color: #3730A3; border-radius: 8px;">Sending SMS to all users...</div>';

        try {
            const response = await fetch('/api/admin/send-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            if (response.ok) {
                statusDiv.innerHTML = `<div style="padding: 16px; background: #DCFCE7; color: #15803D; border-radius: 8px; border: 1px solid #BBF7D0;">
                    <strong>‚úÖ SMS Broadcast Sent Successfully!</strong><br>
                    <div style="margin-top: 8px; font-size: 14px;">
                        <div>üì± Sent to: <strong>${data.sent}</strong> users</div>
                        ${data.failed > 0 ? `<div>‚ö†Ô∏è Failed: <strong>${data.failed}</strong> users</div>` : ''}
                    </div>
                </div>`;
                document.getElementById('sms-message').value = '';
                updateSMSCharCount();

                if (data.failed_users && data.failed_users.length > 0) {
                    let failedHTML = '<div style="margin-top: 12px; padding: 12px; background: #FEE2E2; border-radius: 8px; color: #991B1B;"><strong>Failed deliveries:</strong><ul style="margin: 6px 0; padding-left: 20px;">';
                    data.failed_users.forEach(u => {
                        failedHTML += `<li>${u.username} (${u.phone}): ${u.error}</li>`;
                    });
                    failedHTML += '</ul></div>';
                    statusDiv.innerHTML += failedHTML;
                }
            } else {
                statusDiv.innerHTML = `<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;"><strong>Error:</strong> ${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'Send SMS to All Users';
        }
    }

    async function sendWhatsAppBroadcast(event) {
        event.preventDefault();
        const message = document.getElementById('whatsapp-message').value.trim();
        const btn = document.getElementById('whatsapp-send-btn');
        const statusDiv = document.getElementById('whatsapp-status');

        if (!message) {
            statusDiv.innerHTML = '<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;">Message cannot be empty</div>';
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Sending...';
        statusDiv.innerHTML = '<div style="padding: 12px; background: #D1FAE5; color: #065F46; border-radius: 8px;">Sending WhatsApp to all users...</div>';

        try {
            const response = await fetch('/api/admin/send-whatsapp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            if (response.ok) {
                statusDiv.innerHTML = `<div style="padding: 16px; background: #DCFCE7; color: #15803D; border-radius: 8px; border: 1px solid #BBF7D0;">
                    <strong>‚úÖ WhatsApp Broadcast Sent Successfully!</strong><br>
                    <div style="margin-top: 8px; font-size: 14px;">
                        <div>üí¨ Sent to: <strong>${data.sent}</strong> users</div>
                        ${data.failed > 0 ? `<div>‚ö†Ô∏è Failed: <strong>${data.failed}</strong> users</div>` : ''}
                    </div>
                </div>`;
                document.getElementById('whatsapp-message').value = '';
                updateWhatsAppCharCount();

                if (data.failed_users && data.failed_users.length > 0) {
                    let failedHTML = '<div style="margin-top: 12px; padding: 12px; background: #FEE2E2; border-radius: 8px; color: #991B1B;"><strong>Failed deliveries:</strong><ul style="margin: 6px 0; padding-left: 20px;">';
                    data.failed_users.forEach(u => {
                        failedHTML += `<li>${u.username} (${u.phone}): ${u.error}</li>`;
                    });
                    failedHTML += '</ul></div>';
                    statusDiv.innerHTML += failedHTML;
                }
            } else {
                statusDiv.innerHTML = `<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;"><strong>Error:</strong> ${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div style="padding: 12px; background: #FEE2E2; color: #DC2626; border-radius: 8px; border: 1px solid #FCA5A5;"><strong>Error:</strong> ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'Send WhatsApp to All Users';
        }
    }

    let selectedGateway = 'stripe';
    let currentGateway = 'stripe';
    let selectedStripeMode = 'test';
    let currentStripeMode = 'test';

    async function loadSettings() {
        try {
            const response = await fetch('/api/admin/settings/payment-gateway');
            const data = await response.json();
            
            currentGateway = data.gateway || 'stripe';
            selectedGateway = currentGateway;
            
            updateGatewayUI();
            
            document.getElementById('gateway-status-icon').textContent = '‚úÖ';
            document.getElementById('gateway-status-text').textContent = 
                `Current gateway: ${currentGateway === 'payhalal' ? 'PayHalal' : 'Stripe'}`;
            
            if (currentGateway === 'payhalal') {
                document.getElementById('current-processing-fee').textContent = '2%';
            } else {
                document.getElementById('current-processing-fee').textContent = '2.9% + RM1';
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            document.getElementById('gateway-status-icon').textContent = '‚ö†Ô∏è';
            document.getElementById('gateway-status-text').textContent = 'Error loading settings';
        }
    }

    function selectGateway(gateway) {
        selectedGateway = gateway;
        updateGatewayUI();
        
        if (selectedGateway !== currentGateway) {
            document.getElementById('save-gateway-btn').style.display = 'inline-flex';
        } else {
            document.getElementById('save-gateway-btn').style.display = 'none';
        }
    }

    function updateGatewayUI() {
        document.querySelectorAll('.gateway-card').forEach(card => {
            card.style.borderColor = 'var(--border)';
            card.style.boxShadow = 'none';
        });
        
        const selectedCard = document.getElementById(`gateway-${selectedGateway}`);
        if (selectedCard) {
            selectedCard.style.borderColor = 'var(--primary)';
            selectedCard.style.boxShadow = '0 0 0 3px rgba(0, 200, 83, 0.2)';
        }
    }

    async function saveGatewaySettings() {
        try {
            const response = await fetch('/api/admin/settings/payment-gateway', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gateway: selectedGateway })
            });

            const data = await response.json();

            if (response.ok) {
                currentGateway = selectedGateway;
                document.getElementById('save-gateway-btn').style.display = 'none';
                document.getElementById('gateway-status-text').textContent =
                    `Current gateway: ${currentGateway === 'payhalal' ? 'PayHalal' : 'Stripe'} (saved)`;

                if (currentGateway === 'payhalal') {
                    document.getElementById('current-processing-fee').textContent = '2%';
                } else {
                    document.getElementById('current-processing-fee').textContent = '2.9% + RM1';
                }

                showSuccess('Payment gateway updated successfully!');
            } else {
                showError(data.error || 'Failed to save settings');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            showError('Failed to save settings');
        }
    }

    // Stripe Mode Functions
    async function loadStripeModeSettings() {
        try {
            const response = await fetch('/api/admin/settings/stripe-mode');
            const data = await response.json();

            currentStripeMode = data.mode || 'test';
            selectedStripeMode = currentStripeMode;

            // Update status displays
            document.getElementById('test-mode-status').innerHTML =
                data.test_configured ? '<strong style="color: #10B981;">‚úì Keys Configured</strong>' : '<strong style="color: #EF4444;">‚úó Not Configured</strong>';
            document.getElementById('live-mode-status').innerHTML =
                data.live_configured ? '<strong style="color: #10B981;">‚úì Keys Configured</strong>' : '<strong style="color: #EF4444;">‚úó Not Configured</strong>';

            updateStripeModeUI();

            // Update status message
            const modeLabel = currentStripeMode === 'live' ? 'LIVE (Production)' : 'TEST (Sandbox)';
            const modeIcon = currentStripeMode === 'live' ? 'üî¥' : 'üß™';
            document.getElementById('stripe-mode-status-icon').textContent = modeIcon;
            document.getElementById('stripe-mode-status-text').textContent =
                `Current mode: ${modeLabel} ${data.current_key_set ? '(configured)' : '(missing keys)'}`;

        } catch (error) {
            console.error('Error loading Stripe mode:', error);
            document.getElementById('stripe-mode-status-icon').textContent = '‚ö†Ô∏è';
            document.getElementById('stripe-mode-status-text').textContent = 'Error loading Stripe mode';
        }
    }

    function selectStripeMode(mode) {
        selectedStripeMode = mode;
        updateStripeModeUI();

        if (selectedStripeMode !== currentStripeMode) {
            document.getElementById('save-stripe-mode-btn').style.display = 'inline-flex';
        } else {
            document.getElementById('save-stripe-mode-btn').style.display = 'none';
        }
    }

    function updateStripeModeUI() {
        document.querySelectorAll('.stripe-mode-card').forEach(card => {
            card.style.borderColor = 'var(--border)';
            card.style.boxShadow = 'none';
        });

        const selectedCard = document.getElementById(`mode-${selectedStripeMode}`);
        if (selectedCard) {
            selectedCard.style.borderColor = 'var(--primary)';
            selectedCard.style.boxShadow = '0 0 0 3px rgba(0, 200, 83, 0.2)';
        }
    }

    async function saveStripeModeSettings() {
        try {
            // Show confirmation for live mode
            if (selectedStripeMode === 'live') {
                if (!confirm('‚ö†Ô∏è WARNING: You are about to switch to LIVE mode.\n\nThis will process REAL transactions with REAL money.\n\nAre you sure you want to continue?')) {
                    return;
                }
            }

            const response = await fetch('/api/admin/settings/stripe-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: selectedStripeMode })
            });

            const data = await response.json();

            if (response.ok) {
                currentStripeMode = selectedStripeMode;
                document.getElementById('save-stripe-mode-btn').style.display = 'none';

                const modeLabel = currentStripeMode === 'live' ? 'LIVE (Production)' : 'TEST (Sandbox)';
                const modeIcon = currentStripeMode === 'live' ? 'üî¥' : 'üß™';
                document.getElementById('stripe-mode-status-icon').textContent = modeIcon;
                document.getElementById('stripe-mode-status-text').textContent =
                    `Current mode: ${modeLabel} (saved)`;

                showSuccess(`Stripe mode updated to ${modeLabel}!`);
            } else {
                showError(data.error || 'Failed to save Stripe mode');
            }
        } catch (error) {
            console.error('Error saving Stripe mode:', error);
            showError('Failed to save Stripe mode');
        }
    }

    async function populateSocsoYears() {
        try {
            const response = await fetch('/api/admin/socso/monthly-report?year=all');
            const data = await response.json();
            if (data.report && data.report.length > 0) {
                const years = new Set();
                data.report.forEach(row => {
                    const year = new Date(row.contribution_month).getFullYear();
                    years.add(year);
                });
                const yearSelect = document.getElementById('socsoReportYear');
                [...years].sort().reverse().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error populating SOCSO years:', error);
        }
    }

    async function loadSocsoReport() {
        const loading = document.getElementById('socsoReportLoading');
        const content = document.getElementById('socsoReportContent');
        const empty = document.getElementById('socsoEmpty');
        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';
        try {
            const year = document.getElementById('socsoReportYear').value || new Date().getFullYear();
            const month = document.getElementById('socsoReportMonth').value;
            let url = `/api/admin/socso/monthly-report?year=${year}`;
            if (month) url += `&month=${month}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.report && data.report.length > 0) {
                const tbody = document.getElementById('socsoReportBody');
                tbody.innerHTML = '';
                data.report.forEach(row => {
                    tbody.innerHTML += `<tr>
                        <td>${row.contribution_month}</td>
                        <td>${row.full_name}</td>
                        <td>${row.ic_number}</td>
                        <td>${row.socso_membership_number || 'N/A'}</td>
                        <td>${row.email}</td>
                        <td>${row.transaction_count}</td>
                        <td>RM ${row.total_net_earnings.toFixed(2)}</td>
                        <td style="font-weight: 600; color: var(--primary);">RM ${row.total_socso_amount.toFixed(2)}</td>
                        <td><span class="badge ${row.all_remitted ? 'completed' : 'pending'}">${row.all_remitted ? 'Remitted' : 'Pending'}</span></td>
                    </tr>`;
                });
                content.style.display = 'block';
            } else {
                empty.style.display = 'block';
            }
            loading.style.display = 'none';
        } catch (error) {
            console.error('SOCSO report error:', error);
            empty.style.display = 'block';
            loading.style.display = 'none';
        }
    }

    async function loadSocsoUserTotals() {
        const loading = document.getElementById('socsoUserTotalsLoading');
        const content = document.getElementById('socsoUserTotalsContent');
        const empty = document.getElementById('socsoUserTotalsEmpty');
        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const period = document.getElementById('socsoPeriodFilter').value;
            const url = `/api/admin/socso/user-totals?period=${period}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.totals && data.totals.length > 0) {
                const tbody = document.getElementById('socsoUserTotalsBody');
                tbody.innerHTML = '';
                data.totals.forEach(row => {
                    tbody.innerHTML += `<tr>
                        <td>${row.full_name}</td>
                        <td>${row.ic_number}</td>
                        <td>${row.socso_membership_number || 'N/A'}</td>
                        <td>${row.email}</td>
                        <td>${row.transaction_count}</td>
                        <td>RM ${row.total_net_earnings.toFixed(2)}</td>
                        <td style="font-weight: 600; color: var(--primary);">RM ${row.total_socso.toFixed(2)}</td>
                        <td><span class="badge ${row.all_remitted ? 'completed' : 'pending'}">${row.all_remitted ? 'Remitted' : 'Pending'}</span></td>
                    </tr>`;
                });
                content.style.display = 'block';
            } else {
                empty.style.display = 'block';
            }
            loading.style.display = 'none';
        } catch (error) {
            console.error('SOCSO user totals error:', error);
            empty.style.display = 'block';
            loading.style.display = 'none';
        }
    }

    function exportSocsoUserTotals() {
        const period = document.getElementById('socsoPeriodFilter').value;
        window.location.href = `/api/admin/socso/user-totals/export?period=${period}`;
    }

    function exportSOCSO() {
        const year = document.getElementById('socsoReportYear').value || new Date().getFullYear();
        const month = document.getElementById('socsoReportMonth').value;
        let url = `/api/admin/socso/monthly-report?year=${year}&format=csv`;
        if (month) url += `&month=${month}`;
        window.location.href = url;
    }

    // Borang 8A Functions
    function initBorang8AYearSelector() {
        const yearSelect = document.getElementById('borang8aYear');
        const currentYear = new Date().getFullYear();

        for (let year = currentYear; year >= currentYear - 3; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }

        // Set default to current year
        yearSelect.value = currentYear;

        // Set default month to previous month
        const monthSelect = document.getElementById('borang8aMonth');
        const currentMonth = new Date().getMonth(); // 0-11
        const previousMonth = currentMonth === 0 ? 12 : currentMonth;
        monthSelect.value = previousMonth;
    }

    function viewBorang8A() {
        const year = document.getElementById('borang8aYear').value;
        const month = document.getElementById('borang8aMonth').value;

        if (!year || !month) {
            alert('Please select both year and month');
            return;
        }

        const url = `/api/admin/socso/borang-8a?year=${year}&month=${month}&format=html`;
        window.open(url, '_blank');
    }

    function downloadBorang8ATXT() {
        const year = document.getElementById('borang8aYear').value;
        const month = document.getElementById('borang8aMonth').value;

        if (!year || !month) {
            alert('Please select both year and month');
            return;
        }

        const url = `/api/admin/socso/borang-8a?year=${year}&month=${month}&format=txt`;
        window.location.href = url;
    }

    async function previewBorang8AData() {
        const year = document.getElementById('borang8aYear').value;
        const month = document.getElementById('borang8aMonth').value;

        if (!year || !month) {
            alert('Please select both year and month');
            return;
        }

        const previewDiv = document.getElementById('borang8aPreview');
        const contentDiv = document.getElementById('borang8aPreviewContent');

        try {
            const url = `/api/admin/socso/borang-8a?year=${year}&month=${month}&format=json`;
            const response = await fetch(url);
            const data = await response.json();

            if (response.status === 404) {
                contentDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #991b1b;">
                        <p><strong>No Data Found</strong></p>
                        <p>${data.message || 'No SOCSO contributions found for the selected period'}</p>
                    </div>
                `;
                previewDiv.style.display = 'block';
                return;
            }

            if (response.status === 400) {
                const warningDiv = document.getElementById('borang8aSettingsWarning');
                warningDiv.style.display = 'block';
                contentDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #991b1b;">
                        <p><strong>Configuration Required</strong></p>
                        <p>${data.message || 'Please configure SOCSO employer settings'}</p>
                    </div>
                `;
                previewDiv.style.display = 'block';
                return;
            }

            if (!response.ok) {
                throw new Error(data.error || 'Failed to load Borang 8A data');
            }

            // Hide warning if settings are complete
            document.getElementById('borang8aSettingsWarning').style.display = 'none';

            // Display preview
            contentDiv.innerHTML = `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h5 style="margin: 0 0 12px 0; color: #374151;">Employer Information</h5>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px; font-size: 13px;">
                        <strong>Employer Code:</strong><span>${data.employer.employer_code}</span>
                        <strong>SSM Number:</strong><span>${data.employer.ssm_number}</span>
                        <strong>Company:</strong><span>${data.employer.company_name}</span>
                        <strong>Period:</strong><span>${data.period.month_name} ${data.period.year}</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h5 style="margin: 0 0 12px 0; color: #374151;">Summary</h5>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div style="background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280;">Total Employees</div>
                            <div style="font-size: 20px; font-weight: 700; color: #003366;">${data.summary.total_employees}</div>
                        </div>
                        <div style="background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280;">New Employees</div>
                            <div style="font-size: 20px; font-weight: 700; color: #10b981;">${data.summary.new_employees}</div>
                        </div>
                        <div style="background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280;">Total Wages</div>
                            <div style="font-size: 20px; font-weight: 700; color: #374151;">RM ${data.summary.total_wages.toFixed(2)}</div>
                        </div>
                        <div style="background: white; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div style="font-size: 12px; color: #6b7280;">Total Contribution</div>
                            <div style="font-size: 20px; font-weight: 700; color: #003366;">RM ${data.summary.total_contribution.toFixed(2)}</div>
                        </div>
                    </div>
                </div>

                <div>
                    <h5 style="margin: 0 0 12px 0; color: #374151;">Employees (${data.employees.length})</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="position: sticky; top: 0; background: #f9fafb;">
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 8px; text-align: left;">Name</th>
                                    <th style="padding: 8px; text-align: left;">IC Number</th>
                                    <th style="padding: 8px; text-align: right;">Wages</th>
                                    <th style="padding: 8px; text-align: right;">Contribution</th>
                                    <th style="padding: 8px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.employees.map(emp => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 8px;">${emp.full_name}</td>
                                        <td style="padding: 8px;">${emp.ic_number}</td>
                                        <td style="padding: 8px; text-align: right;">RM ${emp.monthly_wages.toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: right;">RM ${emp.contribution_amount.toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            ${emp.employment_status === 'B' ? '<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">NEW</span>' :
                                              emp.employment_status === 'H' ? '<span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">TERMINATED</span>' :
                                              '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            previewDiv.style.display = 'block';

        } catch (error) {
            console.error('Error loading Borang 8A preview:', error);
            contentDiv.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #991b1b;">
                    <p><strong>Error</strong></p>
                    <p>${error.message}</p>
                </div>
            `;
            previewDiv.style.display = 'block';
        }
    }

    async function loadDashboard() {
        const loading = document.getElementById('stats-loading');
        const content = document.getElementById('stats-content');

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch('/api/admin/stats');
            const data = await response.json();

            if (data.users) {
                document.getElementById('stat-total-users').textContent = data.users.total || 0;
                document.getElementById('stat-recent-users').textContent = `${data.users.recent || 0} this week`;
                document.getElementById('stat-freelancers').textContent = data.users.freelancers || 0;
                document.getElementById('stat-clients').textContent = data.users.clients || 0;
                document.getElementById('stat-verified').textContent = data.users.verified || 0;
            }

            if (data.gigs) {
                document.getElementById('stat-total-gigs').textContent = data.gigs.total || 0;
                document.getElementById('stat-recent-gigs').textContent = `${data.gigs.recent || 0} this week`;
                document.getElementById('stat-open-gigs').textContent = data.gigs.open || 0;
                document.getElementById('stat-progress-gigs').textContent = data.gigs.in_progress || 0;
                document.getElementById('stat-completed-gigs').textContent = data.gigs.completed || 0;
            }

            if (data.financial) {
                document.getElementById('stat-payout').textContent = `RM ${(data.financial.total_payout || 0).toFixed(2)}`;
                document.getElementById('stat-commission').textContent = `RM ${(data.financial.commission || 0).toFixed(2)}`;
                document.getElementById('stat-escrow').textContent = `RM ${(data.financial.escrow || 0).toFixed(2)}`;
            }

            if (data.socso) {
                document.getElementById('stat-socso-collected').textContent = `RM ${(data.socso.total_collected || 0).toFixed(2)}`;
                document.getElementById('stat-socso-remitted').textContent = `RM ${(data.socso.total_remitted || 0).toFixed(2)}`;
                document.getElementById('stat-socso-pending').textContent = `RM ${(data.socso.pending_remittance || 0).toFixed(2)}`;
                document.getElementById('stat-socso-registered').textContent = data.socso.registered_freelancers || 0;
                document.getElementById('stat-socso-compliance').textContent = `${(data.socso.compliance_rate || 0).toFixed(1)}% compliance rate`;
                document.getElementById('stat-socso-current-month').textContent = `RM ${(data.socso.current_month_collection || 0).toFixed(2)}`;
            }

            if (data.applications) {
                document.getElementById('stat-applications').textContent = data.applications.total || 0;
                document.getElementById('stat-pending-apps').textContent = `${data.applications.pending || 0} pending`;
            }

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading dashboard:', error);
            loading.textContent = 'Error loading statistics';
        }
    }

    async function loadUsers(page) {
        const loading = document.getElementById('users-loading');
        const content = document.getElementById('users-content');
        const search = document.getElementById('user-search').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/users?per_page=10000&search=${search}`);
            const data = await response.json();

            let users = data.users;
            if (usersSortAscending) {
                users.sort((a, b) => a.id - b.id);
            } else {
                users.sort((a, b) => b.id - a.id);
            }

            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.user_type}">${user.user_type}</span></td>
                    <td><span class="badge ${user.is_verified ? 'verified' : 'unverified'}">${user.is_verified ? 'Verified' : 'Unverified'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-view" onclick="viewUserDetails(${user.id})">View</button>
                            <button class="btn-sm btn-edit" onclick="editUser(${user.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            const pagination = document.getElementById('users-pagination');
            pagination.innerHTML = '';

            usersCurrentPage = page;
            updateUserSortIndicator();
            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading users:', error);
            loading.textContent = 'Error loading users';
        }
    }

    function toggleUserSort() {
        usersSortAscending = !usersSortAscending;
        loadUsers(1);
    }

    function updateUserSortIndicator() {
        const indicator = document.getElementById('users-sort-indicator');
        indicator.textContent = usersSortAscending ? '‚Üë' : '‚Üì';
    }

    async function loadGigs(page) {
        const loading = document.getElementById('gigs-loading');
        const content = document.getElementById('gigs-content');
        const status = document.getElementById('gig-status-filter').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/gigs?page=${page}&status=${status}`);
            const data = await response.json();

            const tbody = document.getElementById('gigs-tbody');
            tbody.innerHTML = data.gigs.map(gig => `
                <tr>
                    <td>${gig.id}</td>
                    <td>${gig.title}</td>
                    <td>${gig.client ? gig.client.username : 'N/A'}</td>
                    <td>${gig.worker ? `${gig.worker.username}<br><small>RM ${gig.agreed_amount || 'N/A'}</small>` : 'Not assigned'}</td>
                    <td>${gig.category || 'N/A'}</td>
                    <td>RM ${gig.approved_budget || (gig.budget_min + '-' + gig.budget_max)}</td>
                    <td>${gig.applications || 0}</td>
                    <td><span class="badge ${gig.status.replace('_', '-')}">${gig.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-edit" onclick="editGig(${gig.id})">Edit</button>
                            <button class="btn-sm btn-delete" onclick="deleteGig(${gig.id}, '${gig.title.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading gigs:', error);
            loading.textContent = 'Error loading gigs';
        }
    }

    async function editUser(userId) {
        currentEditUserId = userId;
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                credentials: 'include'
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to load user');
            }
            const data = await response.json();
            const user = data.user;
            
            const usernameField = document.getElementById('edit-username');
            const emailField = document.getElementById('edit-email');
            const userTypeField = document.getElementById('edit-user-type');
            const verifiedField = document.getElementById('edit-verified');
            const isAdminField = document.getElementById('edit-is-admin');
            
            if (usernameField) usernameField.value = user.username || '';
            if (emailField) emailField.value = user.email || '';
            if (userTypeField) userTypeField.value = user.user_type || 'freelancer';
            if (verifiedField) verifiedField.checked = user.is_verified || false;
            if (isAdminField) isAdminField.checked = user.is_admin || false;
            
            document.getElementById('edit-user-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Failed to load user details: ' + error.message);
        }
    }

    async function viewUserDetails(userId) {
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('Failed to load user');
            const data = await response.json();
            const user = data.user;
            
            document.getElementById('view-user-content').innerHTML = `
                <div class="user-detail-grid">
                    <div class="detail-section">
                        <h4>Basic Information</h4>
                        <div class="detail-row"><span class="label">ID:</span><span class="value">${user.id}</span></div>
                        <div class="detail-row"><span class="label">Username:</span><span class="value">${user.username || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Full Name:</span><span class="value">${user.full_name || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Email:</span><span class="value">${user.email || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Phone:</span><span class="value">${user.phone || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">IC Number:</span><span class="value">${user.ic_number || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Location:</span><span class="value">${user.location || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">User Type:</span><span class="value badge ${user.user_type}">${user.user_type || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Created:</span><span class="value">${user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Status & Verification</h4>
                        <div class="detail-row"><span class="label">Verified:</span><span class="value badge ${user.is_verified ? 'verified' : 'unverified'}">${user.is_verified ? 'Yes' : 'No'}</span></div>
                        <div class="detail-row"><span class="label">Halal Verified:</span><span class="value badge ${user.halal_verified ? 'verified' : 'unverified'}">${user.halal_verified ? 'Yes' : 'No'}</span></div>
                        <div class="detail-row"><span class="label">Admin:</span><span class="value badge ${user.is_admin ? 'admin' : ''}">${user.is_admin ? 'Yes' : 'No'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Performance</h4>
                        <div class="detail-row"><span class="label">Rating:</span><span class="value">${user.rating ? user.rating.toFixed(1) : '0.0'} / 5.0</span></div>
                        <div class="detail-row"><span class="label">Reviews:</span><span class="value">${user.review_count || 0}</span></div>
                        <div class="detail-row"><span class="label">Completed Gigs:</span><span class="value">${user.completed_gigs || 0}</span></div>
                        <div class="detail-row"><span class="label">Total Earnings:</span><span class="value">RM ${(user.total_earnings || 0).toFixed(2)}</span></div>
                    </div>
                    <div class="detail-section">
                        <h4>Bank Details</h4>
                        <div class="detail-row"><span class="label">Bank Name:</span><span class="value">${user.bank_name || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Account Number:</span><span class="value">${user.bank_account_number || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Account Holder:</span><span class="value">${user.bank_account_holder || 'N/A'}</span></div>
                    </div>
                    <div class="detail-section full-width">
                        <h4>Bio & Skills</h4>
                        <div class="detail-row"><span class="label">Bio:</span><span class="value">${user.bio || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Skills:</span><span class="value">${user.skills || 'N/A'}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('view-user-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading user details:', error);
            alert('Failed to load user details');
        }
    }

    function editGig(gigId) {
        currentEditGigId = gigId;
        document.getElementById('edit-gig-modal').classList.add('active');
    }

    async function deleteGig(gigId, gigTitle) {
        if (!confirm(`Are you sure you want to delete the gig "${gigTitle}"?\n\nThis will permanently delete:\n- The gig and all its details\n- All applications\n- All photos and files\n- All reviews and ratings\n- All transactions and escrow records\n- All disputes and messages\n\nThis action CANNOT be undone!`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/gigs/${gigId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                alert('Gig deleted successfully');
                loadGigs(1); // Reload the gigs list
            } else {
                alert('Failed to delete gig: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting gig:', error);
            alert('Error deleting gig: ' + error.message);
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function closeModalOnBackdrop(event, modalId) {
        if (event.target.classList.contains('modal')) {
            closeModal(modalId);
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (document.getElementById('payout-detail-modal').classList.contains('active')) {
                closePayoutModal();
            }
            if (document.getElementById('edit-user-modal').classList.contains('active')) {
                closeModal('edit-user-modal');
            }
            if (document.getElementById('view-user-modal').classList.contains('active')) {
                closeModal('view-user-modal');
            }
            if (document.getElementById('edit-gig-modal').classList.contains('active')) {
                closeModal('edit-gig-modal');
            }
        }
    });

    async function saveUserChanges() {
        if (!currentEditUserId) return;
        
        const userData = {
            user_type: document.getElementById('edit-user-type').value,
            is_verified: document.getElementById('edit-verified').checked,
            is_admin: document.getElementById('edit-is-admin').checked
        };
        
        try {
            const response = await fetch(`/api/admin/users/${currentEditUserId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(userData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update user');
            }
            
            closeModal('edit-user-modal');
            loadUsers(usersCurrentPage);
            alert('User updated successfully!');
        } catch (error) {
            console.error('Error saving user:', error);
            alert('Failed to save user: ' + error.message);
        }
    }

    async function saveGigChanges() {
        closeModal('edit-gig-modal');
        loadGigs(gigsCurrentPage);
    }

    document.getElementById('user-search').addEventListener('input', () => loadUsers(1));
    document.getElementById('gig-status-filter').addEventListener('change', () => loadGigs(1));

    let currentPayoutId = null;

    async function loadPayouts() {
        const loading = document.getElementById('payouts-loading');
        const content = document.getElementById('payouts-content');
        const tbody = document.getElementById('payouts-tbody');
        const statusFilter = document.getElementById('payout-status-filter').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/billing/payouts?status=${statusFilter}`);
            if (!response.ok) throw new Error('Failed to load payouts');

            const data = await response.json();
            const payouts = data.payouts || [];

            loading.style.display = 'none';
            content.style.display = 'block';

            // Update pending amount
            const pendingAmount = payouts
                .filter(p => p.status === 'pending')
                .reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('pending-payout-amount').textContent = `MYR ${pendingAmount.toFixed(2)}`;

            if (payouts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No payouts found</td></tr>';
                return;
            }

            tbody.innerHTML = payouts.map(payout => `
                <tr>
                    <td><strong>${payout.payout_number}</strong></td>
                    <td>${payout.freelancer_name}</td>
                    <td>MYR ${payout.amount.toFixed(2)}</td>
                    <td>MYR ${payout.fee.toFixed(2)}</td>
                    <td>MYR ${payout.net_amount.toFixed(2)}</td>
                    <td>${payout.payment_method.replace(/_/g, ' ').toUpperCase()}</td>
                    <td>
                        ${payout.bank_name || 'N/A'}<br>
                        ${payout.account_number ? `****${payout.account_number.slice(-4)}` : 'N/A'}
                    </td>
                    <td><span class="badge ${payout.status}">${payout.status.toUpperCase()}</span></td>
                    <td>${new Date(payout.requested_at).toLocaleDateString('ms-MY')}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPayoutDetails(${payout.id})">View</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading payouts:', error);
            loading.style.display = 'none';
            tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Error: ${error.message}</td></tr>`;
        }
    }

    async function viewPayoutDetails(payoutId) {
        currentPayoutId = payoutId;
        try {
            const response = await fetch('/api/admin/billing/payouts');
            if (!response.ok) throw new Error('Failed to load payout details');

            const data = await response.json();
            const payout = data.payouts.find(p => p.id === payoutId);

            if (!payout) throw new Error('Payout not found');

            const detailContent = document.getElementById('payout-detail-content');
            detailContent.innerHTML = `
                <div class="form-group">
                    <label>Payout Number:</label>
                    <div><strong>${payout.payout_number}</strong></div>
                </div>
                <div class="form-group">
                    <label>Freelancer:</label>
                    <div>${payout.freelancer_name} (${payout.freelancer_email})</div>
                </div>
                <div class="form-group">
                    <label>Amount Details:</label>
                    <div>
                        Requested Amount: <strong>MYR ${payout.amount.toFixed(2)}</strong><br>
                        Processing Fee (2%): MYR ${payout.fee.toFixed(2)}<br>
                        Net Amount: <strong>MYR ${payout.net_amount.toFixed(2)}</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method:</label>
                    <div>${payout.payment_method.replace(/_/g, ' ').toUpperCase()}</div>
                </div>
                <div class="form-group">
                    <label>Account Details:</label>
                    <div>
                        Bank: ${payout.bank_name || 'N/A'}<br>
                        Account Number: ${payout.account_number || 'N/A'}<br>
                        Account Name: ${payout.account_name || 'N/A'}
                    </div>
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <div><span class="badge ${payout.status}">${payout.status.toUpperCase()}</span></div>
                </div>
                <div class="form-group">
                    <label>Requested At:</label>
                    <div>${new Date(payout.requested_at).toLocaleString()}</div>
                </div>
                ${payout.processed_at ? `
                <div class="form-group">
                    <label>Processed At:</label>
                    <div>${new Date(payout.processed_at).toLocaleString()}</div>
                </div>
                ` : ''}
                ${payout.completed_at ? `
                <div class="form-group">
                    <label>Completed At:</label>
                    <div>${new Date(payout.completed_at).toLocaleString()}</div>
                </div>
                ` : ''}
                ${payout.admin_notes ? `
                <div class="form-group">
                    <label>Admin Notes:</label>
                    <div>${payout.admin_notes}</div>
                </div>
                ` : ''}
                ${payout.failure_reason ? `
                <div class="form-group">
                    <label>Failure Reason:</label>
                    <div style="color: red;">${payout.failure_reason}</div>
                </div>
                ` : ''}
                <div class="form-group">
                    <label>Admin Notes (optional):</label>
                    <textarea id="payout-admin-notes" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">${payout.admin_notes || ''}</textarea>
                </div>
                ${payout.status === 'failed' || payout.status === 'cancelled' ? '' : `
                <div class="form-group">
                    <label>Failure Reason (for rejection):</label>
                    <textarea id="payout-failure-reason" rows="2" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);"></textarea>
                </div>
                `}
            `;

            // Show/hide action buttons based on status
            const rejectBtn = document.getElementById('payout-reject-btn');
            const processingBtn = document.getElementById('payout-processing-btn');
            const approveBtn = document.getElementById('payout-approve-btn');

            if (payout.status === 'completed' || payout.status === 'failed' || payout.status === 'cancelled') {
                rejectBtn.style.display = 'none';
                processingBtn.style.display = 'none';
                approveBtn.style.display = 'none';
            } else {
                rejectBtn.style.display = payout.status !== 'failed' ? 'inline-block' : 'none';
                processingBtn.style.display = payout.status === 'pending' ? 'inline-block' : 'none';
                approveBtn.style.display = 'inline-block';
            }

            document.getElementById('payout-detail-modal').classList.add('active');
        } catch (error) {
            console.error('Error loading payout details:', error);
            alert('Failed to load payout details: ' + error.message);
        }
    }

    async function updatePayoutStatus(newStatus) {
        if (!currentPayoutId) return;

        const adminNotes = document.getElementById('payout-admin-notes').value;
        const failureReasonEl = document.getElementById('payout-failure-reason');
        const failureReason = failureReasonEl ? failureReasonEl.value : '';

        if (newStatus === 'failed' && !failureReason) {
            alert('Please provide a failure reason');
            return;
        }

        if (!confirm(`Are you sure you want to mark this payout as ${newStatus}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/billing/payouts/${currentPayoutId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus,
                    admin_notes: adminNotes,
                    failure_reason: failureReason
                })
            });

            if (!response.ok) throw new Error('Failed to update payout status');

            const data = await response.json();
            alert(data.message || 'Payout status updated successfully');

            closePayoutModal();
            loadPayouts();
        } catch (error) {
            console.error('Error updating payout:', error);
            alert('Failed to update payout: ' + error.message);
        }
    }

    function closePayoutModal() {
        document.getElementById('payout-detail-modal').classList.remove('active');
        currentPayoutId = null;
    }

    async function performMasterReset() {
        const confirmText = document.getElementById('reset-confirm-text').value;
        const password = document.getElementById('reset-admin-password').value;
        const resetLog = document.getElementById('reset-log');
        
        if (confirmText !== 'RESET') {
            alert('Please type "RESET" to confirm.');
            return;
        }
        
        if (!password) {
            alert('Please enter your admin password.');
            return;
        }
        
        if (!confirm('FINAL WARNING: This will permanently delete all platform data except user accounts. This action CANNOT be undone. Are you absolutely sure?')) {
            return;
        }
        
        resetLog.style.display = 'block';
        resetLog.innerHTML = '> Starting master reset...\n';
        
        try {
            const response = await fetch('/api/admin/master-reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                resetLog.innerHTML += '> Deleted gig applications...\n';
                resetLog.innerHTML += '> Deleted transactions and payments...\n';
                resetLog.innerHTML += '> Deleted messages and conversations...\n';
                resetLog.innerHTML += '> Deleted reviews and ratings...\n';
                resetLog.innerHTML += '> Deleted disputes and milestones...\n';
                resetLog.innerHTML += '> Deleted notifications...\n';
                resetLog.innerHTML += '> Deleted portfolio items...\n';
                resetLog.innerHTML += '> Deleted gigs...\n';
                resetLog.innerHTML += '> Reset wallet balances...\n';
                resetLog.innerHTML += '> ‚úÖ Master reset completed successfully!\n';
                resetLog.innerHTML += `> Deleted: ${data.deleted_count || 'all'} records\n`;
                
                document.getElementById('reset-confirm-text').value = '';
                document.getElementById('reset-admin-password').value = '';
                
                alert('Master reset completed successfully. All data has been cleared.');
            } else {
                resetLog.innerHTML += `> ‚ùå Error: ${data.error}\n`;
                alert(data.error || 'Failed to perform reset');
            }
        } catch (error) {
            resetLog.innerHTML += `> ‚ùå Error: ${error.message}\n`;
            alert('An error occurred during reset');
        }
    }

    // ==================== LANDSCAPE MODE POPUP ====================

    function checkOrientation() {
        const dontShow = localStorage.getItem('hideLandscapePopup');
        if (dontShow === 'true') return;

        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        const isMobileOrTablet = window.matchMedia("(max-width: 1024px)").matches;

        if (isPortrait && isMobileOrTablet) {
            document.getElementById('landscape-popup').style.display = 'flex';
        } else {
            document.getElementById('landscape-popup').style.display = 'none';
        }
    }

    function closeLandscapePopup() {
        const dontShowAgain = document.getElementById('dont-show-landscape').checked;
        if (dontShowAgain) {
            localStorage.setItem('hideLandscapePopup', 'true');
        }
        document.getElementById('landscape-popup').style.display = 'none';
    }

    // Check orientation on load and orientation change
    window.addEventListener('load', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    window.addEventListener('resize', checkOrientation);

    // ==================== EMAIL FUNCTIONALITY ====================
    let allUsers = [];
    let selectedUserIds = new Set();

    async function loadAllUsers() {
        try {
            const response = await fetch('/api/admin/users?per_page=10000');
            const data = await response.json();
            allUsers = data.users || [];
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // ==================== LANDSCAPE MODE POPUP ====================

    function checkOrientation() {
        const dontShow = localStorage.getItem('hideLandscapePopup');
        if (dontShow === 'true') return;

        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        const isMobileOrTablet = window.matchMedia("(max-width: 1024px)").matches;

        if (isPortrait && isMobileOrTablet) {
            document.getElementById('landscape-popup').style.display = 'flex';
        } else {
            document.getElementById('landscape-popup').style.display = 'none';
        }
    }

    function closeLandscapePopup() {
        const dontShowAgain = document.getElementById('dont-show-landscape').checked;
        if (dontShowAgain) {
            localStorage.setItem('hideLandscapePopup', 'true');
        }
        document.getElementById('landscape-popup').style.display = 'none';
    }

    // Check orientation on load and orientation change
    window.addEventListener('load', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    window.addEventListener('resize', checkOrientation);

    // ==================== EMAIL FUNCTIONALITY ====================
    let allUsers = [];
    let selectedUserIds = new Set();

    async function loadAllUsers() {
        try {
            const response = await fetch('/api/admin/users?per_page=10000');
            const data = await response.json();
            allUsers = data.users || [];
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function updateRecipientInfo() {
        const type = document.getElementById('email-recipient-type').value;
        const selectedSection = document.getElementById('selected-users-section');
        const recipientInfo = document.getElementById('recipient-info');
        
        if (type === 'selected') {
            selectedSection.style.display = 'block';
            loadAllUsers().then(() => renderUserList());
            recipientInfo.textContent = '';
        } else {
            selectedSection.style.display = 'none';
            const counts = {
                'all': allUsers.length,
                'freelancers': allUsers.filter(u => u.user_type.includes('freelancer')).length,
                'clients': allUsers.filter(u => u.user_type.includes('client')).length
            };
            recipientInfo.textContent = `Will send to ${counts[type] || 0} users`;
        }
    }

    function renderUserList() {
        const search = document.getElementById('user-search').value.toLowerCase();
        const userList = document.getElementById('user-list');
        const filtered = allUsers.filter(u => 
            u.username.toLowerCase().includes(search) || 
            u.email.toLowerCase().includes(search)
        );
        
        userList.innerHTML = filtered.map(user => `
            <label style="display: flex; align-items: center; padding: 6px; cursor: pointer;">
                <input type="checkbox" value="${user.id}" onchange="toggleUser(${user.id}, this.checked)" style="margin-right: 8px;">
                <span style="flex: 1; font-size: 13px;">${user.username} (${user.email})</span>
            </label>
        `).join('');
        
        updateSelectedCount();
    }

    function toggleUser(userId, checked) {
        if (checked) {
            selectedUserIds.add(userId);
        } else {
            selectedUserIds.delete(userId);
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selected-users-count').textContent = `${selectedUserIds.size} users selected`;
    }

    document.getElementById('user-search')?.addEventListener('input', renderUserList);

    async function sendEmailBroadcast(event) {
        event.preventDefault();
        
        const subject = document.getElementById('email-subject').value.trim();
        const html_content = document.getElementById('email-content').value.trim();
        const recipient_type = document.getElementById('email-recipient-type').value;
        const selected_user_ids = recipient_type === 'selected' ? Array.from(selectedUserIds) : [];
        
        if (!subject || !html_content) {
            showError('email-status', 'Subject and content are required');
            return;
        }

        if (recipient_type === 'selected' && selected_user_ids.length === 0) {
            showError('email-status', 'Please select at least one user');
            return;
        }
        
        try {
            const btn = document.getElementById('email-send-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            const response = await fetch('/api/admin/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    subject,
                    html_content,
                    text_content: html_content,
                    recipient_type,
                    selected_user_ids
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showSuccess('email-status', `‚úì Email sent to ${data.recipients_count} ${data.recipient_type} ${data.recipient_type === 'selected' ? 'user' : 'users'}!`);
                document.getElementById('email-broadcast-form').reset();
                selectedUserIds.clear();
            } else {
                showError('email-status', data.error || 'Failed to send email');
            }
        } catch (error) {
            showError('email-status', 'Error: ' + error.message);
        } finally {
            const btn = document.getElementById('email-send-btn');
            btn.disabled = false;
            btn.textContent = 'Send Email';
        }
    }

    // Load users on page load
    window.addEventListener('load', loadAllUsers);

    // ==================== GIG REPORTS FUNCTIONS ====================
    async function loadGigReports(page = 1) {
        const status = document.getElementById('report-status-filter').value;
        try {
            document.getElementById('reports-loading').style.display = 'block';
            document.getElementById('reports-content').style.display = 'none';

            const response = await fetch(`/api/admin/reports?status=${status}&page=${page}&per_page=50`, {
                credentials: 'include'
            });
            const data = await response.json();

            const tbody = document.getElementById('reports-tbody');
            tbody.innerHTML = '';

            if (data.reports && data.reports.length > 0) {
                data.reports.forEach(report => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${report.id}</td>
                        <td><a href="/gig/${report.gig_id}" target="_blank">${report.gig_title}</a></td>
                        <td>${report.reporter_name}</td>
                        <td><span class="badge ${report.reason}">${formatReason(report.reason)}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${report.description}</td>
                        <td><span class="badge ${report.gig_status}">${report.gig_status}</span></td>
                        <td>${new Date(report.created_at).toLocaleString()}</td>
                        <td><span class="badge ${report.status}">${report.status}</span></td>
                        <td>
                            <button onclick="viewReport(${report.id})" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 4px;">View</button>
                            ${report.gig_status !== 'blocked' && report.gig_status !== 'deleted' ? `
                                <button onclick="blockGigFromReport(${report.gig_id}, ${report.id})" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Block Gig</button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No reports found</td></tr>';
            }

            document.getElementById('reports-loading').style.display = 'none';
            document.getElementById('reports-content').style.display = 'block';
        } catch (error) {
            console.error('Error loading reports:', error);
            alert('Failed to load reports');
        }
    }

    function formatReason(reason) {
        const reasons = {
            'haram_content': 'Haram Content',
            'inappropriate': 'Inappropriate',
            'spam': 'Spam',
            'fraud': 'Fraud',
            'other': 'Other'
        };
        return reasons[reason] || reason;
    }

    async function viewReport(reportId) {
        const report = await fetch(`/api/admin/reports?page=1&per_page=1000`, {credentials: 'include'}).then(r => r.json());
        const reportData = report.reports.find(r => r.id === reportId);
        if (reportData) {
            alert(`Report #${reportId}\n\nGig: ${reportData.gig_title}\nReporter: ${reportData.reporter_name}\nReason: ${formatReason(reportData.reason)}\nDescription: ${reportData.description}\n\nGig Status: ${reportData.gig_status}\nReport Status: ${reportData.status}`);
        }
    }

    async function blockGigFromReport(gigId, reportId) {
        const reason = prompt('Enter reason for blocking this gig:');
        if (!reason) return;

        try {
            const response = await fetch(`/api/admin/gigs/${gigId}/block`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({reason})
            });
            const data = await response.json();

            if (response.ok) {
                // Update report status
                await fetch(`/api/admin/reports/${reportId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        status: 'action_taken',
                        admin_notes: `Gig blocked: ${reason}`
                    })
                });

                alert('Gig blocked successfully!');
                loadGigReports();
            } else {
                alert(data.error || 'Failed to block gig');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to block gig');
        }
    }

    // ==================== BLOCKED GIGS FUNCTIONS ====================
    async function loadBlockedGigs(page = 1) {
        try {
            document.getElementById('blocked-gigs-loading').style.display = 'block';
            document.getElementById('blocked-gigs-content').style.display = 'none';

            const response = await fetch(`/api/admin/gigs?status=blocked&page=${page}&per_page=50`, {
                credentials: 'include'
            });
            const data = await response.json();

            const tbody = document.getElementById('blocked-gigs-tbody');
            tbody.innerHTML = '';

            if (data.gigs && data.gigs.length > 0) {
                data.gigs.forEach(gig => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>#${gig.id}</td>
                        <td><a href="/gig/${gig.id}" target="_blank">${gig.title}</a></td>
                        <td>${gig.client_name || 'N/A'}</td>
                        <td>${gig.category}</td>
                        <td><span class="badge" style="background: #dc2626;">${gig.report_count || 0}</span></td>
                        <td>${gig.blocked_at ? new Date(gig.blocked_at).toLocaleString() : 'N/A'}</td>
                        <td>Admin #${gig.blocked_by || 'System'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${gig.block_reason || 'N/A'}</td>
                        <td>
                            <button onclick="unblockGig(${gig.id})" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 4px;">Unblock</button>
                            <button onclick="deleteGig(${gig.id})" style="padding: 6px 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No blocked gigs found</td></tr>';
            }

            document.getElementById('blocked-gigs-loading').style.display = 'none';
            document.getElementById('blocked-gigs-content').style.display = 'block';
        } catch (error) {
            console.error('Error loading blocked gigs:', error);
            alert('Failed to load blocked gigs');
        }
    }

    async function unblockGig(gigId) {
        if (!confirm('Are you sure you want to unblock this gig?')) return;

        try {
            const response = await fetch(`/api/admin/gigs/${gigId}/unblock`, {
                method: 'POST',
                credentials: 'include'
            });
            const data = await response.json();

            if (response.ok) {
                alert('Gig unblocked successfully!');
                loadBlockedGigs();
            } else {
                alert(data.error || 'Failed to unblock gig');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to unblock gig');
        }
    }

    checkAdminAccess();
</script>
{% endblock %}