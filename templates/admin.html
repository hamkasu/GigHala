{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, var(--primary) 0%, #00a844 100%);
        color: white;
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
    }

    .admin-header h1 {
        margin: 0 0 6px 0;
        font-size: 28px;
    }

    .admin-header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .admin-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-white);
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
        margin: 0 0 6px 0;
        color: var(--text-gray);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .stat-card .label {
        color: var(--text-light);
        font-size: 12px;
    }

    .data-table {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .table-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .table-header h2 {
        margin: 0;
        color: var(--text-dark);
        font-size: 17px;
    }

    .search-box {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 220px;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        background: var(--bg-light);
        font-weight: 600;
        color: var(--text-dark);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    tr:hover {
        background: var(--bg-light);
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge.verified { background: #d1fae5; color: #065f46; }
    .badge.unverified { background: #fee2e2; color: #991b1b; }
    .badge.admin { background: #dbeafe; color: #1e40af; }
    .badge.freelancer { background: #fef3c7; color: #92400e; }
    .badge.client { background: #e0e7ff; color: #3730a3; }
    .badge.open { background: #d1fae5; color: #065f46; }
    .badge.in-progress { background: #fef3c7; color: #92400e; }
    .badge.completed { background: #dbeafe; color: #1e40af; }
    .badge.cancelled { background: #fee2e2; color: #991b1b; }

    .action-btns {
        display: flex;
        gap: 6px;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 11px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-edit {
        background: var(--primary);
        color: white;
    }

    .btn-edit:hover {
        background: var(--primary-dark);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 18px;
    }

    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--primary);
        background: var(--bg-white);
        color: var(--primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
        background: var(--primary);
        color: white;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-gray);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: var(--bg-white);
        padding: 28px;
        border-radius: var(--radius-lg);
        max-width: 450px;
        width: 90%;
    }

    .modal-content h3 {
        margin: 0 0 20px 0;
        color: var(--text-dark);
        font-size: 18px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 13px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    .section-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-gray);
        margin: 24px 0 14px 0;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .table-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .search-box {
            width: 100%;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Admin Dashboard</h1>
    <p id="admin-welcome">Welcome, Administrator</p>
</div>

<div id="error-container"></div>
<div id="success-container"></div>

<div class="admin-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('users')">Users</button>
    <button class="tab-btn" onclick="switchTab('gigs')">Gigs</button>
</div>

<div id="dashboard-tab" class="tab-content active">
    <div id="stats-loading" class="loading">Loading statistics...</div>
    <div id="stats-content" style="display: none;">
        <h3 class="section-title">User Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="value" id="stat-total-users">0</div>
                <div class="label" id="stat-recent-users">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Freelancers</h3>
                <div class="value" id="stat-freelancers">0</div>
            </div>
            <div class="stat-card">
                <h3>Clients</h3>
                <div class="value" id="stat-clients">0</div>
            </div>
            <div class="stat-card">
                <h3>Verified Users</h3>
                <div class="value" id="stat-verified">0</div>
            </div>
        </div>

        <h3 class="section-title">Gig Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Gigs</h3>
                <div class="value" id="stat-total-gigs">0</div>
                <div class="label" id="stat-recent-gigs">0 this week</div>
            </div>
            <div class="stat-card">
                <h3>Open Gigs</h3>
                <div class="value" id="stat-open-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="value" id="stat-progress-gigs">0</div>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <div class="value" id="stat-completed-gigs">0</div>
            </div>
        </div>

        <h3 class="section-title">Financial Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="stat-revenue">RM 0</div>
            </div>
            <div class="stat-card">
                <h3>Commission</h3>
                <div class="value" id="stat-commission">RM 0</div>
            </div>
            <div class="stat-card">
                <h3>Applications</h3>
                <div class="value" id="stat-applications">0</div>
                <div class="label" id="stat-pending-apps">0 pending</div>
            </div>
        </div>
    </div>
</div>

<div id="users-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>User Management</h2>
            <input type="text" id="user-search" class="search-box" placeholder="Search users...">
        </div>
        <div id="users-loading" class="loading">Loading users...</div>
        <div id="users-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
            <div class="pagination" id="users-pagination"></div>
        </div>
    </div>
</div>

<div id="gigs-tab" class="tab-content">
    <div class="data-table">
        <div class="table-header">
            <h2>Gig Management</h2>
            <select id="gig-status-filter" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                <option value="">All Status</option>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div id="gigs-loading" class="loading">Loading gigs...</div>
        <div id="gigs-content" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Budget</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gigs-tbody"></tbody>
            </table>
            <div class="pagination" id="gigs-pagination"></div>
        </div>
    </div>
</div>

<div id="edit-user-modal" class="modal">
    <div class="modal-content">
        <h3>Edit User</h3>
        <div class="form-group">
            <label>Username:</label>
            <input type="text" id="edit-username" disabled>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="text" id="edit-email" disabled>
        </div>
        <div class="form-group">
            <label>User Type:</label>
            <select id="edit-user-type">
                <option value="freelancer">Freelancer</option>
                <option value="client">Client</option>
                <option value="both">Both</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-verified">
                <label for="edit-verified">Verified</label>
            </div>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-is-admin">
                <label for="edit-is-admin">Admin</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-user-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="edit-gig-modal" class="modal">
    <div class="modal-content">
        <h3>Edit Gig</h3>
        <div class="form-group">
            <label>Title:</label>
            <input type="text" id="edit-gig-title" disabled>
        </div>
        <div class="form-group">
            <label>Status:</label>
            <select id="edit-gig-status">
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="edit-gig-halal-verified">
                <label for="edit-gig-halal-verified">Halal Verified</label>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" onclick="saveGigChanges()">Save Changes</button>
            <button class="btn btn-cancel" onclick="closeModal('edit-gig-modal')">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentEditUserId = null;
    let currentEditGigId = null;
    let usersCurrentPage = 1;
    let gigsCurrentPage = 1;

    async function checkAdminAccess() {
        try {
            const response = await fetch('/api/admin/check');
            const data = await response.json();

            if (!data.is_admin) {
                window.location.href = '/';
                return;
            }

            if (data.user) {
                document.getElementById('admin-welcome').textContent = `Welcome, ${data.user.username}`;
            }

            loadDashboard();
        } catch (error) {
            console.error('Error checking admin access:', error);
            window.location.href = '/';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadUsers(1);
        else if (tabName === 'gigs') loadGigs(1);
    }

    async function loadDashboard() {
        const loading = document.getElementById('stats-loading');
        const content = document.getElementById('stats-content');

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch('/api/admin/stats');
            const data = await response.json();

            if (data.users) {
                document.getElementById('stat-total-users').textContent = data.users.total || 0;
                document.getElementById('stat-recent-users').textContent = `${data.users.recent || 0} this week`;
                document.getElementById('stat-freelancers').textContent = data.users.freelancers || 0;
                document.getElementById('stat-clients').textContent = data.users.clients || 0;
                document.getElementById('stat-verified').textContent = data.users.verified || 0;
            }

            if (data.gigs) {
                document.getElementById('stat-total-gigs').textContent = data.gigs.total || 0;
                document.getElementById('stat-recent-gigs').textContent = `${data.gigs.recent || 0} this week`;
                document.getElementById('stat-open-gigs').textContent = data.gigs.open || 0;
                document.getElementById('stat-progress-gigs').textContent = data.gigs.in_progress || 0;
                document.getElementById('stat-completed-gigs').textContent = data.gigs.completed || 0;
            }

            if (data.financial) {
                document.getElementById('stat-revenue').textContent = `RM ${(data.financial.total_revenue || 0).toFixed(2)}`;
                document.getElementById('stat-commission').textContent = `RM ${(data.financial.commission || 0).toFixed(2)}`;
            }

            if (data.applications) {
                document.getElementById('stat-applications').textContent = data.applications.total || 0;
                document.getElementById('stat-pending-apps').textContent = `${data.applications.pending || 0} pending`;
            }

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading dashboard:', error);
            loading.textContent = 'Error loading statistics';
        }
    }

    async function loadUsers(page) {
        const loading = document.getElementById('users-loading');
        const content = document.getElementById('users-content');
        const search = document.getElementById('user-search').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/users?page=${page}&search=${search}`);
            const data = await response.json();

            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.user_type}">${user.user_type}</span></td>
                    <td><span class="badge ${user.is_verified ? 'verified' : 'unverified'}">${user.is_verified ? 'Verified' : 'Unverified'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-edit" onclick="editUser(${user.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading users:', error);
            loading.textContent = 'Error loading users';
        }
    }

    async function loadGigs(page) {
        const loading = document.getElementById('gigs-loading');
        const content = document.getElementById('gigs-content');
        const status = document.getElementById('gig-status-filter').value;

        loading.style.display = 'block';
        content.style.display = 'none';

        try {
            const response = await fetch(`/api/admin/gigs?page=${page}&status=${status}`);
            const data = await response.json();

            const tbody = document.getElementById('gigs-tbody');
            tbody.innerHTML = data.gigs.map(gig => `
                <tr>
                    <td>${gig.id}</td>
                    <td>${gig.title}</td>
                    <td>${gig.category || 'N/A'}</td>
                    <td>RM ${gig.budget_min}-${gig.budget_max}</td>
                    <td><span class="badge ${gig.status.replace('_', '-')}">${gig.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-sm btn-edit" onclick="editGig(${gig.id})">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (error) {
            console.error('Error loading gigs:', error);
            loading.textContent = 'Error loading gigs';
        }
    }

    function editUser(userId) {
        currentEditUserId = userId;
        document.getElementById('edit-user-modal').classList.add('active');
    }

    function editGig(gigId) {
        currentEditGigId = gigId;
        document.getElementById('edit-gig-modal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    async function saveUserChanges() {
        closeModal('edit-user-modal');
        loadUsers(usersCurrentPage);
    }

    async function saveGigChanges() {
        closeModal('edit-gig-modal');
        loadGigs(gigsCurrentPage);
    }

    document.getElementById('user-search').addEventListener('input', () => loadUsers(1));
    document.getElementById('gig-status-filter').addEventListener('change', () => loadGigs(1));

    checkAdminAccess();
</script>
{% endblock %}