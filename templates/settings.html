{% extends "base.html" %}

{% block title %}{{ t('settings') if t else 'Tetapan Akaun' }}{% endblock %}

{% block extra_styles %}
<style>
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 32px 24px;
    }

    .page-header {
        background: var(--bg-white);
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
        border: 1px solid var(--border);
    }

    .page-header h1 {
        color: var(--text-dark);
        font-size: 28px;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .page-header p {
        color: var(--text-gray);
        font-size: 15px;
    }

    .verified-badge-header {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        background: #d1fae5;
        color: #065f46;
    }

    .unverified-badge-header {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        background: #fef3c7;
        color: #92400e;
    }

    .settings-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .settings-tab {
        padding: 12px 20px;
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.2s;
    }

    .settings-tab:hover {
        background: var(--bg-light);
    }

    .settings-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .settings-section {
        background: var(--bg-white);
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .section-description {
        color: var(--text-gray);
        font-size: 14px;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        color: var(--text-dark);
        transition: all 0.2s;
        background: var(--bg-white);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.1);
    }

    .form-input:disabled {
        background: var(--bg-light);
        color: var(--text-gray);
        cursor: not-allowed;
    }

    .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        color: var(--text-dark);
        background: var(--bg-white);
        cursor: pointer;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-hint {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 6px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-secondary {
        background: var(--bg-light);
        color: var(--text-dark);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .btn-danger {
        background: var(--error);
        color: white;
    }

    .btn-danger:hover {
        background: #d63030;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border);
    }

    .alert {
        padding: 14px 18px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        font-size: 14px;
    }

    .alert-success {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert-error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .alert-warning {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    .info-card {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 20px;
    }

    .info-card p {
        color: #0c4a6e;
        font-size: 14px;
        margin: 0;
    }

    .masked-value {
        font-family: monospace;
        letter-spacing: 1px;
    }

    .password-requirements {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 8px;
    }

    .password-requirements li {
        margin-bottom: 4px;
    }

    .divider {
        height: 1px;
        background: var(--border);
        margin: 24px 0;
    }

    /* Specializations Styles */
    .specialization-card {
        background: var(--bg-light);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 16px;
    }

    .specialization-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .specialization-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .category-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
    }

    .category-option {
        padding: 14px 16px;
        background: var(--bg-white);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--text-dark);
    }

    .category-option:hover {
        border-color: var(--primary);
        background: #f0fdf4;
    }

    .category-option.selected {
        border-color: var(--primary);
        background: #dcfce7;
        font-weight: 600;
    }

    .skill-input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .skill-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .skill-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--primary);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        margin: 4px;
    }

    .skill-tag button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        margin: 0;
        line-height: 1;
    }

    .skills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
        min-height: 32px;
    }

    .skill-input-wrapper {
        position: relative;
        flex: 1;
    }

    .skill-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .skill-suggestions.active {
        display: block;
    }

    .skill-suggestion-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-dark);
        border-bottom: 1px solid var(--border-light, #f0f0f0);
        transition: background 0.15s;
    }

    .skill-suggestion-item:last-child {
        border-bottom: none;
    }

    .skill-suggestion-item:hover,
    .skill-suggestion-item.highlighted {
        background: #f0fdf4;
        color: var(--primary);
    }

    .skill-suggestions-header {
        padding: 8px 14px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #fafafa;
        border-bottom: 1px solid var(--border-light, #f0f0f0);
        position: sticky;
        top: 0;
    }

    .add-specialization-section {
        background: #f0fdf4;
        border: 2px dashed var(--primary);
        border-radius: var(--radius-md);
        padding: 24px;
        text-align: center;
        margin-top: 16px;
    }

    @media (max-width: 768px) {
        .settings-container {
            padding: 16px;
        }

        .page-header, .settings-section {
            padding: 20px;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="page-header">
        <h1>
            <span>Tetapan Akaun</span>
            {% if user.is_verified %}
            <span class="verified-badge-header">✓ Verified</span>
            {% else %}
            <span class="unverified-badge-header">⚠ Unverified</span>
            {% endif %}
        </h1>
        <p>Urus maklumat peribadi, keselamatan dan butiran pembayaran anda</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="settings-tabs">
        <button class="settings-tab active" data-tab="profile">Maklumat Peribadi</button>
        <button class="settings-tab" data-tab="specializations">Kepakaran & Kemahiran</button>
        <button class="settings-tab" data-tab="verification">Pengesahan Identiti</button>
        <button class="settings-tab" data-tab="security">Keselamatan</button>
        <button class="settings-tab" data-tab="payment">Maklumat Pembayaran</button>
    </div>

    <!-- Profile Settings Section -->
    <div class="settings-section active" id="profile-section">
        <h2 class="section-title">Maklumat Peribadi</h2>
        <p class="section-description">Kemaskini maklumat profil anda. Maklumat ini akan dipaparkan kepada klien dan pekerja lain.</p>

        <!-- Profile Photo Upload -->
        <div style="margin-bottom:28px; padding-bottom:24px; border-bottom:1px solid var(--border);">
            <label class="form-label">Gambar Profil</label>
            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap;">
                <div id="profile-photo-preview" style="width:96px; height:96px; border-radius:50%; overflow:hidden; background:var(--primary); display:flex; align-items:center; justify-content:center; font-size:36px; font-weight:700; color:white; flex-shrink:0; border:3px solid var(--border);">
                    {% if user.profile_photo %}
                        <img src="/uploads/profile_photos/{{ user.profile_photo }}" alt="Gambar Profil" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <img src="https://api.dicebear.com/9.x/adventurer/svg?seed={{ user.username }}" alt="Avatar" style="width:100%; height:100%; object-fit:cover;">
                    {% endif %}
                </div>
                <div>
                    <label for="profile-photo-input" class="btn btn-secondary" style="cursor:pointer; margin-bottom:8px;">
                        Muat Naik Gambar
                    </label>
                    <input type="file" id="profile-photo-input" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none;">
                    {% if user.profile_photo %}
                    <button type="button" id="remove-photo-btn" class="btn btn-danger" style="margin-left:8px;">Padam Gambar</button>
                    {% endif %}
                    <p class="form-hint" style="margin-top:6px;">PNG, JPG, GIF atau WEBP. Saiz maksimum 5MB.</p>
                    <div id="photo-upload-status" style="margin-top:6px; font-size:13px;"></div>
                </div>
            </div>
        </div>

        <form action="/settings/profile" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nama Penuh</label>
                    <input type="text" name="full_name" class="form-input" value="{{ user.full_name or '' }}" placeholder="Masukkan nama penuh">
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" value="{{ user.username }}" disabled>
                    <p class="form-hint">Username tidak boleh diubah</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">No. Telefon</label>
                    <input type="tel" name="phone" class="form-input" value="{{ user.phone or '' }}" placeholder="Contoh: 0123456789">
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasi</label>
                    <select name="location" class="form-select">
                        <option value="">Pilih lokasi</option>
                        <!-- Kuala Lumpur -->
                        <optgroup label="Kuala Lumpur">
                            <option value="Kuala Lumpur" {{ 'selected' if user.location == 'Kuala Lumpur' else '' }}>Kuala Lumpur</option>
                            <option value="Cheras, KL" {{ 'selected' if user.location == 'Cheras, KL' else '' }}>Cheras</option>
                            <option value="Kepong, KL" {{ 'selected' if user.location == 'Kepong, KL' else '' }}>Kepong</option>
                            <option value="Bangsar, KL" {{ 'selected' if user.location == 'Bangsar, KL' else '' }}>Bangsar</option>
                        </optgroup>
                        <!-- Johor -->
                        <optgroup label="Johor">
                            <option value="Johor Bahru, Johor" {{ 'selected' if user.location == 'Johor Bahru, Johor' else '' }}>Johor Bahru</option>
                            <option value="Skudai, Johor" {{ 'selected' if user.location == 'Skudai, Johor' else '' }}>Skudai</option>
                            <option value="Kulai, Johor" {{ 'selected' if user.location == 'Kulai, Johor' else '' }}>Kulai</option>
                            <option value="Kluang, Johor" {{ 'selected' if user.location == 'Kluang, Johor' else '' }}>Kluang</option>
                            <option value="Muar, Johor" {{ 'selected' if user.location == 'Muar, Johor' else '' }}>Muar</option>
                            <option value="Batu Pahat, Johor" {{ 'selected' if user.location == 'Batu Pahat, Johor' else '' }}>Batu Pahat</option>
                            <option value="Segamat, Johor" {{ 'selected' if user.location == 'Segamat, Johor' else '' }}>Segamat</option>
                        </optgroup>
                        <!-- Penang -->
                        <optgroup label="Penang">
                            <option value="George Town, Penang" {{ 'selected' if user.location == 'George Town, Penang' else '' }}>George Town</option>
                            <option value="Butterworth, Penang" {{ 'selected' if user.location == 'Butterworth, Penang' else '' }}>Butterworth</option>
                            <option value="Bayan Lepas, Penang" {{ 'selected' if user.location == 'Bayan Lepas, Penang' else '' }}>Bayan Lepas</option>
                            <option value="Seberang Jaya, Penang" {{ 'selected' if user.location == 'Seberang Jaya, Penang' else '' }}>Seberang Jaya</option>
                            <option value="Sungai Petani, Penang" {{ 'selected' if user.location == 'Sungai Petani, Penang' else '' }}>Sungai Petani</option>
                        </optgroup>
                        <!-- Selangor -->
                        <optgroup label="Selangor">
                            <option value="Petaling Jaya, Selangor" {{ 'selected' if user.location == 'Petaling Jaya, Selangor' else '' }}>Petaling Jaya</option>
                            <option value="Shah Alam, Selangor" {{ 'selected' if user.location == 'Shah Alam, Selangor' else '' }}>Shah Alam</option>
                            <option value="Subang Jaya, Selangor" {{ 'selected' if user.location == 'Subang Jaya, Selangor' else '' }}>Subang Jaya</option>
                            <option value="Klang, Selangor" {{ 'selected' if user.location == 'Klang, Selangor' else '' }}>Klang</option>
                            <option value="Ampang, Selangor" {{ 'selected' if user.location == 'Ampang, Selangor' else '' }}>Ampang</option>
                            <option value="Kajang, Selangor" {{ 'selected' if user.location == 'Kajang, Selangor' else '' }}>Kajang</option>
                            <option value="Rawang, Selangor" {{ 'selected' if user.location == 'Rawang, Selangor' else '' }}>Rawang</option>
                            <option value="Sepang, Selangor" {{ 'selected' if user.location == 'Sepang, Selangor' else '' }}>Sepang</option>
                            <option value="Serdang, Selangor" {{ 'selected' if user.location == 'Serdang, Selangor' else '' }}>Serdang</option>
                        </optgroup>
                        <!-- Perak -->
                        <optgroup label="Perak">
                            <option value="Ipoh, Perak" {{ 'selected' if user.location == 'Ipoh, Perak' else '' }}>Ipoh</option>
                            <option value="Taiping, Perak" {{ 'selected' if user.location == 'Taiping, Perak' else '' }}>Taiping</option>
                            <option value="Teluk Intan, Perak" {{ 'selected' if user.location == 'Teluk Intan, Perak' else '' }}>Teluk Intan</option>
                            <option value="Kuala Lumpur, Perak" {{ 'selected' if user.location == 'Kuala Lumpur, Perak' else '' }}>Kuala Lumpur (Perak)</option>
                        </optgroup>
                        <!-- Kedah -->
                        <optgroup label="Kedah">
                            <option value="Alor Setar, Kedah" {{ 'selected' if user.location == 'Alor Setar, Kedah' else '' }}>Alor Setar</option>
                            <option value="Sungai Petani, Kedah" {{ 'selected' if user.location == 'Sungai Petani, Kedah' else '' }}>Sungai Petani</option>
                            <option value="Kulim, Kedah" {{ 'selected' if user.location == 'Kulim, Kedah' else '' }}>Kulim</option>
                        </optgroup>
                        <!-- Kelantan -->
                        <optgroup label="Kelantan">
                            <option value="Kota Bharu, Kelantan" {{ 'selected' if user.location == 'Kota Bharu, Kelantan' else '' }}>Kota Bharu</option>
                            <option value="Kuantan, Kelantan" {{ 'selected' if user.location == 'Kuantan, Kelantan' else '' }}>Kuantan</option>
                        </optgroup>
                        <!-- Terengganu -->
                        <optgroup label="Terengganu">
                            <option value="Kuala Terengganu, Terengganu" {{ 'selected' if user.location == 'Kuala Terengganu, Terengganu' else '' }}>Kuala Terengganu</option>
                            <option value="Kuantan, Terengganu" {{ 'selected' if user.location == 'Kuantan, Terengganu' else '' }}>Kuantan</option>
                        </optgroup>
                        <!-- Pahang -->
                        <optgroup label="Pahang">
                            <option value="Kuantan, Pahang" {{ 'selected' if user.location == 'Kuantan, Pahang' else '' }}>Kuantan</option>
                            <option value="Temerloh, Pahang" {{ 'selected' if user.location == 'Temerloh, Pahang' else '' }}>Temerloh</option>
                            <option value="Pekan, Pahang" {{ 'selected' if user.location == 'Pekan, Pahang' else '' }}>Pekan</option>
                        </optgroup>
                        <!-- Melaka -->
                        <optgroup label="Melaka">
                            <option value="Melaka City, Melaka" {{ 'selected' if user.location == 'Melaka City, Melaka' else '' }}>Melaka City</option>
                            <option value="Alor Gajah, Melaka" {{ 'selected' if user.location == 'Alor Gajah, Melaka' else '' }}>Alor Gajah</option>
                        </optgroup>
                        <!-- Negeri Sembilan -->
                        <optgroup label="Negeri Sembilan">
                            <option value="Seremban, Negeri Sembilan" {{ 'selected' if user.location == 'Seremban, Negeri Sembilan' else '' }}>Seremban</option>
                            <option value="Nilai, Negeri Sembilan" {{ 'selected' if user.location == 'Nilai, Negeri Sembilan' else '' }}>Nilai</option>
                        </optgroup>
                        <!-- Sabah -->
                        <optgroup label="Sabah">
                            <option value="Kota Kinabalu, Sabah" {{ 'selected' if user.location == 'Kota Kinabalu, Sabah' else '' }}>Kota Kinabalu</option>
                            <option value="Sandakan, Sabah" {{ 'selected' if user.location == 'Sandakan, Sabah' else '' }}>Sandakan</option>
                            <option value="Tawau, Sabah" {{ 'selected' if user.location == 'Tawau, Sabah' else '' }}>Tawau</option>
                            <option value="Lahad Datu, Sabah" {{ 'selected' if user.location == 'Lahad Datu, Sabah' else '' }}>Lahad Datu</option>
                        </optgroup>
                        <!-- Sarawak -->
                        <optgroup label="Sarawak">
                            <option value="Kuching, Sarawak" {{ 'selected' if user.location == 'Kuching, Sarawak' else '' }}>Kuching</option>
                            <option value="Miri, Sarawak" {{ 'selected' if user.location == 'Miri, Sarawak' else '' }}>Miri</option>
                            <option value="Sibu, Sarawak" {{ 'selected' if user.location == 'Sibu, Sarawak' else '' }}>Sibu</option>
                            <option value="Bintulu, Sarawak" {{ 'selected' if user.location == 'Bintulu, Sarawak' else '' }}>Bintulu</option>
                        </optgroup>
                        <!-- Perlis -->
                        <optgroup label="Perlis">
                            <option value="Kangar, Perlis" {{ 'selected' if user.location == 'Kangar, Perlis' else '' }}>Kangar</option>
                        </optgroup>
                        <!-- Putrajaya & Labuan -->
                        <optgroup label="Federal Territories">
                            <option value="Putrajaya, Putrajaya" {{ 'selected' if user.location == 'Putrajaya, Putrajaya' else '' }}>Putrajaya</option>
                            <option value="Labuan, Labuan" {{ 'selected' if user.location == 'Labuan, Labuan' else '' }}>Labuan</option>
                        </optgroup>
                        <option value="Lain-lain" {{ 'selected' if user.location == 'Lain-lain' else '' }}>Lain-lain</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Jenis Pengguna</label>
                    <select name="user_type" class="form-select">
                        <option value="freelancer" {{ 'selected' if user.user_type == 'freelancer' else '' }}>Freelancer (Cari Kerja)</option>
                        <option value="client" {{ 'selected' if user.user_type == 'client' else '' }}>Client (Post Kerja)</option>
                        <option value="both" {{ 'selected' if user.user_type == 'both' else '' }}>Kedua-duanya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Bahasa Pilihan</label>
                    <select name="language" class="form-select">
                        <option value="ms" {{ 'selected' if user.language == 'ms' else '' }}>Bahasa Melayu</option>
                        <option value="en" {{ 'selected' if user.language == 'en' else '' }}>English</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Bio / Tentang Saya</label>
                <textarea name="bio" class="form-input" rows="4" placeholder="Ceritakan tentang diri anda, pengalaman dan kemahiran...">{{ user.bio or '' }}</textarea>
            </div>

            <div class="form-group">
                <label class="form-label">No. Kad Pengenalan (IC)</label>
                <input type="text" name="ic_number" class="form-input" value="{{ user.ic_number or '' }}" placeholder="Contoh: 901234567890" maxlength="12" pattern="[0-9]{12}">
                <p class="form-hint">12 digit tanpa sengkang (-). Diperlukan untuk pengesahan identiti.</p>
            </div>

            <div class="form-group">
                <label class="form-label">No. Ahli SOCSO</label>
                <input type="text" name="socso_membership_number" class="form-input" value="{{ user.socso_membership_number or '' }}" placeholder="Contoh: 1234567890" maxlength="20">
                <p class="form-hint">Nombor keahlian SOCSO anda (jika ada).</p>
            </div>

            <div class="form-group" style="padding: 16px; background: var(--bg-light); border-radius: var(--radius-md); border-left: 4px solid var(--primary);">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                    <input type="checkbox" name="socso_consent" value="1" {% if user.socso_consent %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                    <span>
                        <strong>Saya Bersetuju dengan Potongan SOCSO</strong>
                        <p style="font-size: 13px; color: var(--text-gray); margin: 4px 0 0 0; font-weight: normal;">
                            Saya memahami dan bersetuju untuk memotong sumbangan SOCSO sebanyak 1.25% daripada pendapatan saya untuk perlindungan sosial.
                        </p>
                    </span>
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            </div>
        </form>
    </div>

    <!-- Specializations Section -->
    <div class="settings-section" id="specializations-section">
        <h2 class="section-title">Kepakaran & Kemahiran</h2>
        <p class="section-description">Pilih kategori yang anda pakar dan tambah kemahiran khusus untuk setiap kategori. Ini membantu klien mencari anda berdasarkan kepakaran anda.</p>

        <div class="info-card">
            <p><strong>Panduan:</strong> Pilih kategori yang anda mahir, kemudian tambah kemahiran khusus untuk kategori tersebut. Anda boleh menambah sehingga 10 kemahiran setiap kategori.</p>
        </div>

        <!-- Existing Specializations -->
        <div id="specializations-list">
            <!-- Existing specializations will be loaded here via JavaScript -->
        </div>

        <!-- Add New Specialization -->
        <div class="add-specialization-section" id="add-specialization-section">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">Tambah Kepakaran Baru</h3>
            <p style="color: var(--text-gray); margin-bottom: 20px; font-size: 14px;">Pilih kategori untuk menambah kemahiran anda</p>

            <div class="category-selector">
                {% if categories %}
                    {% for category in categories %}
                    <div class="category-option" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-slug="{{ category.slug }}" data-category-icon="{{ category.icon or 'clipboard' }}">
                        <i data-feather="{{ category.icon or 'clipboard' }}" style="width: 20px; height: 20px;"></i>
                        <span>{{ category.name }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-gray);">Tiada kategori tersedia</p>
                {% endif %}
            </div>
        </div>

        <!-- Edit Specialization Modal (hidden by default) -->
        <div id="edit-specialization-modal" style="display: none;">
            <h3 style="margin-bottom: 16px; color: var(--text-dark); display: flex; align-items: center; gap: 10px;">
                <span id="modal-category-icon" style="font-size: 24px;"></span>
                <span id="modal-category-name"></span>
            </h3>

            <!-- Specialization Title -->
            <div class="form-group">
                <label class="form-label">Tajuk Kepakaran (Pilihan)</label>
                <input type="text" id="specialization-title" class="form-input" placeholder="Contoh: Guru Quran Bertauliah, Chef Halal Bersijil" maxlength="100">
                <p class="form-hint">Tajuk khusus yang dipaparkan kepada klien (contoh: "Senior Quran Tutor")</p>
            </div>

            <div class="form-group">
                <label class="form-label">Kemahiran (sehingga 10)</label>
                <div class="skill-input-group">
                    <div class="skill-input-wrapper">
                        <input type="text" id="skill-input" class="skill-input" style="width:100%;" placeholder="Pilih atau taip kemahiran..." maxlength="50" autocomplete="off">
                        <div id="skill-suggestions" class="skill-suggestions"></div>
                    </div>
                    <button type="button" id="add-skill-btn" class="btn btn-primary" style="white-space: nowrap;">Tambah</button>
                </div>
                <p class="form-hint">Pilih dari senarai cadangan atau taip kemahiran anda sendiri</p>

                <div id="skills-list" class="skills-list">
                    <!-- Skills will be added here -->
                </div>
            </div>

            <!-- Rate Settings Section -->
            <div style="background: #f0fdf4; border: 1px solid var(--primary); border-radius: var(--radius-md); padding: 20px; margin-top: 20px;">
                <h4 style="margin: 0 0 16px; color: var(--primary); font-size: 16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Kadar Caj Anda (Pilihan)
                </h4>
                <p style="color: var(--text-gray); font-size: 13px; margin-bottom: 16px;">
                    Tetapkan kadar asas anda untuk kategori ini. Klien akan melihat kadar ini di profil anda - harga telus, tiada yuran tersembunyi.
                </p>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Kadar Sejam (RM/jam)</label>
                        <input type="number" id="base-hourly-rate" class="form-input" placeholder="Contoh: 50" min="0" max="10000" step="1">
                        <p class="form-hint">Untuk gig berkontrak jam</p>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Kadar Tetap (RM/gig)</label>
                        <input type="number" id="base-fixed-rate" class="form-input" placeholder="Contoh: 500" min="0" max="1000000" step="1">
                        <p class="form-hint">Untuk gig harga tetap</p>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                    <label class="form-label">Premium Multiplier (Pilihan)</label>
                    <select id="premium-multiplier" class="form-select">
                        <option value="1.0">1.0x - Kadar Standard</option>
                        <option value="1.1">1.1x - 10% Premium</option>
                        <option value="1.2">1.2x - 20% Premium</option>
                        <option value="1.3">1.3x - 30% Premium</option>
                        <option value="1.5">1.5x - 50% Premium</option>
                        <option value="2.0">2.0x - 100% Premium</option>
                    </select>
                    <p class="form-hint">Untuk kerja khusus atau kompleks (contoh: kerja malam, projek segera)</p>
                </div>
            </div>

            <div class="form-actions" style="margin-top: 24px;">
                <button type="button" id="save-specialization-btn" class="btn btn-primary">Simpan Kepakaran</button>
                <button type="button" id="cancel-specialization-btn" class="btn btn-secondary">Batal</button>
            </div>
        </div>
    </div>

    <!-- Verification Settings Section -->
    <div class="settings-section" id="verification-section">
        <h2 class="section-title">Pengesahan Identiti</h2>
        <p class="section-description">Muat naik salinan IC/MyKad atau pasport anda untuk pengesahan identiti. Pengguna yang disahkan mendapat kepercayaan lebih tinggi.</p>

        {% if verification %}
        <div class="{% if verification.status == 'approved' %}alert alert-success{% elif verification.status == 'rejected' %}alert alert-error{% else %}alert alert-warning{% endif %}">
            <strong>Status Pengesahan:</strong>
            {% if verification.status == 'approved' %}
                ✅ Disahkan pada {{ verification.verified_at.strftime('%d %b %Y') if verification.verified_at else '-' }}
            {% elif verification.status == 'rejected' %}
                ❌ Ditolak - {{ verification.rejection_reason or 'Tiada sebab diberikan' }}
            {% else %}
                ⏳ Sedang Diproses
            {% endif %}
        </div>
        
        {% if verification.ic_front_image or verification.ic_back_image %}
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text-dark);">Dokumen Dimuat Naik</h3>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                {% if verification.ic_front_image %}
                <div style="text-align: center;">
                    <img src="/uploads/{{ verification.ic_front_image }}" alt="IC Front" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid var(--border);">
                    <p style="font-size: 12px; color: var(--text-gray); margin-top: 4px;">IC Depan</p>
                </div>
                {% endif %}
                {% if verification.ic_back_image %}
                <div style="text-align: center;">
                    <img src="/uploads/{{ verification.ic_back_image }}" alt="IC Back" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid var(--border);">
                    <p style="font-size: 12px; color: var(--text-gray); margin-top: 4px;">IC Belakang</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        {% if not verification or verification.status in ['rejected'] %}
        <div class="info-card">
            <p><strong>Keperluan:</strong> Muat naik gambar IC/MyKad atau pasport yang jelas (depan dan belakang). Pastikan semua maklumat boleh dibaca dengan jelas.</p>
        </div>

        <form action="/settings/verification" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">IC/Pasport (Depan) *</label>
                    <input type="file" name="ic_front" class="form-input" accept="image/*" required style="padding: 10px;">
                    <p class="form-hint">Format: PNG, JPG, JPEG (Max 5MB)</p>
                </div>
                <div class="form-group">
                    <label class="form-label">IC/Pasport (Belakang) *</label>
                    <input type="file" name="ic_back" class="form-input" accept="image/*" required style="padding: 10px;">
                    <p class="form-hint">Format: PNG, JPG, JPEG (Max 5MB)</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Hantar untuk Pengesahan</button>
            </div>
        </form>
        {% elif verification.status == 'pending' %}
        <div class="info-card">
            <p>Dokumen anda sedang disemak oleh pasukan kami. Proses ini biasanya mengambil masa 1-3 hari bekerja.</p>
        </div>
        
        <form action="/settings/verification" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--text-dark);">Muat Naik Semula (Jika Diperlukan)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">IC/Pasport (Depan) *</label>
                    <input type="file" name="ic_front" class="form-input" accept="image/*" required style="padding: 10px;">
                </div>
                <div class="form-group">
                    <label class="form-label">IC/Pasport (Belakang) *</label>
                    <input type="file" name="ic_back" class="form-input" accept="image/*" required style="padding: 10px;">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-secondary">Muat Naik Semula</button>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Security Settings Section -->
    <div class="settings-section" id="security-section">
        <h2 class="section-title">Keselamatan Akaun</h2>
        <p class="section-description">Urus kata laluan dan emel akaun anda</p>

        <!-- Change Email -->
        <div class="info-card">
            <p><strong>Emel Semasa:</strong> {{ user.email }}</p>
        </div>

        <form action="/settings/email" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--text-dark);">Tukar Emel</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Emel Baru</label>
                    <input type="email" name="new_email" class="form-input" placeholder="Masukkan emel baru" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Kata Laluan Semasa</label>
                    <input type="password" name="current_password" class="form-input" placeholder="Masukkan kata laluan" required>
                    <p class="form-hint">Diperlukan untuk pengesahan</p>
                </div>
            </div>
            <div class="form-actions" style="border-top: none; padding-top: 0;">
                <button type="submit" class="btn btn-primary">Tukar Emel</button>
            </div>
        </form>

        <div class="divider"></div>

        <!-- Change Password -->
        <form action="/settings/password" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--text-dark);">Tukar Kata Laluan</h3>
            <div class="form-group">
                <label class="form-label">Kata Laluan Semasa</label>
                <input type="password" name="current_password" class="form-input" placeholder="Masukkan kata laluan semasa" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Kata Laluan Baru</label>
                    <input type="password" name="new_password" class="form-input" placeholder="Masukkan kata laluan baru" required minlength="8">
                </div>
                <div class="form-group">
                    <label class="form-label">Sahkan Kata Laluan Baru</label>
                    <input type="password" name="confirm_password" class="form-input" placeholder="Masukkan semula kata laluan baru" required>
                </div>
            </div>
            <ul class="password-requirements">
                <li>Minimum 8 aksara</li>
                <li>Disyorkan: gabungan huruf besar, huruf kecil, nombor dan simbol</li>
            </ul>
            <div class="form-actions" style="border-top: none; padding-top: 16px;">
                <button type="submit" class="btn btn-primary">Tukar Kata Laluan</button>
            </div>
        </form>
    </div>

    <!-- Payment Settings Section -->
    <div class="settings-section" id="payment-section">
        <h2 class="section-title">Maklumat Pembayaran</h2>
        <p class="section-description">Tambah maklumat bank anda untuk menerima bayaran daripada klien atau membuat pembayaran kepada pekerja.</p>

        <div class="info-card">
            <p><strong>Penting:</strong> Pastikan nama pemegang akaun sama dengan nama di IC anda untuk mengelakkan masalah pembayaran.</p>
        </div>

        <form action="/settings/bank" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-group">
                <label class="form-label">Nama Bank</label>
                <select name="bank_name" class="form-select">
                    <option value="">Pilih bank</option>
                    {% for bank in ['Maybank', 'CIMB Bank', 'Public Bank', 'RHB Bank', 'Hong Leong Bank', 'AmBank', 'Bank Islam', 'Bank Rakyat', 'Bank Simpanan Nasional (BSN)', 'Affin Bank', 'Alliance Bank', 'Standard Chartered', 'HSBC', 'OCBC Bank', 'UOB Malaysia', 'Agrobank', 'Bank Muamalat', 'MBSB Bank'] %}
                        <option value="{{ bank }}" {{ 'selected' if user.bank_name == bank else '' }}>{{ bank }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nombor Akaun</label>
                    <input type="text" name="bank_account_number" class="form-input" value="{{ user.bank_account_number or '' }}" placeholder="Masukkan nombor akaun bank" pattern="[0-9]{8,20}">
                    <p class="form-hint">8-20 digit nombor sahaja</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama Pemegang Akaun</label>
                    <input type="text" name="bank_account_holder" class="form-input" value="{{ user.bank_account_holder or '' }}" placeholder="Nama seperti di buku akaun bank">
                    <p class="form-hint">Nama mesti sama dengan nama di IC</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Simpan Maklumat Bank</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.settings-tab');
    const sections = document.querySelectorAll('.settings-section');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            tabs.forEach(t => t.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(targetTab + '-section').classList.add('active');
        });
    });

    // ==================== SPECIALIZATIONS MANAGEMENT ====================
    let currentCategoryId = null;
    let currentCategorySlug = null;
    let currentSpecializationId = null;
    let currentSkills = [];
    let allSpecializations = [];
    let highlightedIndex = -1;

    // Predefined skills for each category (main + subcategories)
    const PREDEFINED_SKILLS = {
        // ── Design ──
        'design': ['Logo Design', 'Graphic Design', 'UI/UX Design', 'Branding', 'Poster Design', 'Banner Design', 'Flyer Design', 'Business Card Design', 'Packaging Design', 'Illustration'],
        'graphic-design': ['Logo Design', 'Banner Design', 'Poster Design', 'Brochure Design', 'Infographic Design', 'Social Media Graphics', 'Flyer Design', 'Print Design', 'Brand Identity', 'Packaging Design'],
        'ui-ux': ['UI Design', 'UX Research', 'Wireframing', 'Prototyping', 'Figma', 'User Testing', 'Responsive Design', 'Design System', 'Interaction Design', 'Information Architecture'],
        'illustration': ['Digital Illustration', 'Character Design', 'Book Illustration', 'Vector Art', 'Concept Art', 'Comic Art', 'Storyboard', 'Pattern Design', 'Icon Design', 'Infographic Illustration'],
        'logo-design': ['Minimalist Logo', 'Wordmark Logo', 'Mascot Logo', 'Emblem Logo', 'Brand Identity', 'Logo Animation', 'Logo Redesign', 'Monogram Logo', 'Vintage Logo', '3D Logo'],
        'fashion': ['Fashion Illustration', 'Pattern Making', 'Garment Design', 'Textile Design', 'Fashion Sketching', 'Clothing Design', 'Costume Design', 'Baju Kurung Design', 'Hijab Design', 'Streetwear Design'],
        'interior-design': ['Room Layout', 'Space Planning', 'Furniture Selection', '3D Rendering', 'Color Scheme', 'Home Staging', 'Kitchen Design', 'Bathroom Design', 'Office Design', 'Mood Board'],
        // ── Writing & Content ──
        'writing': ['Copywriting', 'Content Writing', 'Blog Writing', 'Technical Writing', 'Proofreading', 'Editing', 'SEO Writing', 'Academic Writing', 'Creative Writing', 'Translation'],
        'content-writing': ['Blog Posts', 'Website Copy', 'Article Writing', 'SEO Content', 'Product Description', 'Technical Writing', 'Ghostwriting', 'Press Release', 'White Paper', 'Case Study'],
        'translation': ['English-Malay', 'Malay-English', 'Arabic-Malay', 'Chinese-Malay', 'Document Translation', 'Website Localization', 'Subtitle Translation', 'Legal Translation', 'Medical Translation', 'Certified Translation'],
        'proofreading': ['Grammar Checking', 'Copy Editing', 'Academic Proofreading', 'Business Proofreading', 'Manuscript Editing', 'ESL Editing', 'Formatting', 'Fact Checking', 'Style Guide Compliance', 'Content Review'],
        'resume': ['Resume Writing', 'CV Formatting', 'Cover Letter', 'LinkedIn Profile', 'Portfolio Design', 'Career Consulting', 'Interview Prep', 'Bio Writing', 'Executive Resume', 'Fresh Graduate Resume'],
        'email-marketing': ['Newsletter Design', 'Email Campaign', 'Email Template', 'Drip Campaign', 'Mailchimp', 'Email Copywriting', 'A/B Testing', 'List Management', 'Automation Setup', 'Email Analytics'],
        'social-copy': ['Instagram Captions', 'Facebook Posts', 'TikTok Scripts', 'Twitter/X Posts', 'LinkedIn Posts', 'Hashtag Strategy', 'Content Calendar', 'Brand Voice', 'Engagement Copy', 'Ad Copy'],
        'content': ['Social Media Content', 'Blog Posts', 'Newsletter', 'Infographic', 'Podcast', 'Ebook', 'Whitepaper', 'Press Release', 'Script Writing', 'Storytelling'],
        // ── Video & Media ──
        'video': ['Video Editing', 'Motion Graphics', 'Animation', 'Videography', 'Video Production', 'Color Grading', 'Subtitling', 'Short Film', 'Drone Videography', 'Live Streaming'],
        'video-editing': ['Premiere Pro', 'Final Cut Pro', 'DaVinci Resolve', 'Color Grading', 'Sound Design', 'Subtitling', 'Transitions', 'Short Form Video', 'YouTube Editing', 'Wedding Video'],
        'animation': ['2D Animation', '3D Animation', 'Motion Graphics', 'Explainer Video', 'Character Animation', 'After Effects', 'Whiteboard Animation', 'Logo Animation', 'GIF Animation', 'Stop Motion'],
        'voiceover': ['Malay Voiceover', 'English Voiceover', 'Commercial VO', 'Narration', 'Character Voice', 'IVR Recording', 'Audiobook', 'E-learning VO', 'Dubbing', 'Radio Ad'],
        'podcast': ['Podcast Editing', 'Audio Mixing', 'Sound Design', 'Intro/Outro', 'Show Notes', 'Transcript', 'Music Production', 'Audio Restoration', 'RSS Setup', 'Podcast Launch'],
        'photography': ['Portrait Photography', 'Product Photography', 'Event Photography', 'Wedding Photography', 'Photo Editing', 'Photo Retouching', 'Food Photography', 'Real Estate Photography', 'Aerial Photography', 'Studio Photography'],
        // ── Web & App Development ──
        'web': ['Web Development', 'WordPress', 'Frontend Development', 'Backend Development', 'E-commerce', 'Landing Page', 'Web Design', 'Shopify', 'API Development', 'Database Design'],
        'web-development': ['HTML/CSS', 'JavaScript', 'React', 'WordPress', 'PHP', 'Node.js', 'Python', 'Responsive Design', 'Landing Page', 'Web App'],
        'app-development': ['iOS Development', 'Android Development', 'Flutter', 'React Native', 'Mobile UI Design', 'App Prototyping', 'API Integration', 'App Testing', 'App Store Submission', 'Cross-platform App'],
        'ecommerce': ['Shopify Setup', 'WooCommerce', 'Product Listing', 'Payment Gateway', 'Inventory System', 'Order Management', 'Store Theme Design', 'SEO Optimization', 'Product Photography', 'Dropship Setup'],
        // ── Marketing & Business ──
        'marketing': ['Digital Marketing', 'Social Media Marketing', 'SEO', 'SEM', 'Email Marketing', 'Facebook Ads', 'Google Ads', 'TikTok Marketing', 'Influencer Marketing', 'Content Marketing'],
        'digital-marketing': ['SEO', 'Google Ads', 'Facebook Ads', 'TikTok Ads', 'Content Marketing', 'Email Marketing', 'Analytics', 'Conversion Optimization', 'Funnel Building', 'Marketing Strategy'],
        'social-media': ['Content Planning', 'Community Management', 'Instagram Management', 'TikTok Management', 'Facebook Management', 'Posting Schedule', 'Engagement Strategy', 'Analytics Reporting', 'Influencer Outreach', 'Hashtag Research'],
        'business-consulting': ['Business Plan', 'Market Research', 'Financial Modeling', 'Startup Consulting', 'Operations Strategy', 'Growth Strategy', 'Competitive Analysis', 'SWOT Analysis', 'Pitch Deck', 'Business Registration'],
        'data-analysis': ['Excel Analysis', 'Google Sheets', 'Data Visualization', 'Survey Analysis', 'Report Generation', 'Dashboard Creation', 'Statistical Analysis', 'Data Cleaning', 'Trend Analysis', 'Power BI'],
        'consulting': ['Business Consulting', 'Management Consulting', 'HR Consulting', 'IT Consulting', 'Financial Advisory', 'Legal Advisory', 'Strategy Planning', 'Risk Management', 'Process Improvement', 'Market Research'],
        // ── Education & Tutoring ──
        'tutoring': ['Mengaji Al-Quran', 'Matematik', 'Bahasa Inggeris', 'Bahasa Melayu', 'Sains', 'Sejarah', 'Fizik', 'Kimia', 'Biologi', 'Bahasa Arab'],
        'language-teaching': ['Bahasa Inggeris', 'Bahasa Melayu', 'Bahasa Arab', 'Bahasa Mandarin', 'Bahasa Jepun', 'IELTS Prep', 'MUET Prep', 'Business English', 'Conversational English', 'Grammar'],
        // ── Technical & Engineering ──
        'programming': ['Python', 'JavaScript', 'Java', 'PHP', 'React', 'Node.js', 'Flutter', 'Mobile App', 'Machine Learning', 'SQL'],
        'engineering': ['CAD Design', 'Mechanical Engineering', 'Electrical Engineering', 'Civil Engineering', 'Project Management', 'Quality Control', 'Prototyping', '3D Modeling', 'Technical Drawing', 'Structural Analysis'],
        // ── Admin & Support ──
        'admin': ['Data Entry', 'Virtual Assistant', 'Bookkeeping', 'Scheduling', 'Email Management', 'Document Preparation', 'Filing', 'Customer Service', 'Transcription', 'Research'],
        'virtual-assistant': ['Admin Support', 'Calendar Management', 'Email Management', 'Social Media Management', 'Data Entry', 'Research', 'Customer Support', 'Document Formatting', 'Travel Booking', 'CRM Management'],
        'transcription': ['Audio Transcription', 'Video Transcription', 'Meeting Minutes', 'Medical Transcription', 'Legal Transcription', 'Interview Transcription', 'Subtitle Creation', 'Malay Transcription', 'English Transcription', 'Verbatim Transcription'],
        'data-entry': ['Data Input', 'Spreadsheet Work', 'Database Entry', 'Form Filling', 'PDF to Excel', 'Web Scraping', 'CRM Data Entry', 'Invoice Processing', 'List Building', 'Data Migration'],
        // ── Finance & Legal ──
        'finance': ['Accounting', 'Tax Filing', 'Financial Planning', 'Budgeting', 'Payroll', 'Invoice Management', 'Audit', 'GST/SST', 'Financial Analysis', 'Bookkeeping'],
        'bookkeeping': ['Basic Accounting', 'Invoice Management', 'Bank Reconciliation', 'Tax Preparation', 'SST Filing', 'Payroll Processing', 'Financial Reports', 'QuickBooks', 'Cash Flow Management', 'Expense Tracking'],
        'legal': ['Contract Drafting', 'Document Review', 'Legal Research', 'Agreement Templates', 'Terms & Conditions', 'Privacy Policy', 'Notarization', 'Company Secretary', 'IP Registration', 'Compliance'],
        // ── Lifestyle & Personal ──
        'coaching': ['Life Coaching', 'Fitness Training', 'Yoga', 'Personal Training', 'Nutrition Coaching', 'Career Coaching', 'Public Speaking', 'Leadership Training', 'Motivational Speaking', 'Sports Coaching'],
        'wellness-coaching': ['Health Coaching', 'Fitness Guidance', 'Nutrition Plan', 'Weight Management', 'Mental Wellness', 'Stress Management', 'Meditation Guide', 'Wellness Consulting', 'Lifestyle Coaching', 'Detox Program'],
        'personal-styling': ['Wardrobe Styling', 'Personal Shopping', 'Image Consulting', 'Color Analysis', 'Outfit Planning', 'Hijab Styling', 'Fashion Advice', 'Grooming Tips', 'Event Styling', 'Capsule Wardrobe'],
        'pets': ['Dog Walking', 'Pet Sitting', 'Pet Grooming', 'Pet Training', 'Pet Photography', 'Veterinary Advice', 'Pet Boarding', 'Cat Care', 'Aquarium Maintenance', 'Bird Care'],
        'pet-services': ['Dog Walking', 'Pet Sitting', 'Pet Grooming', 'Pet Training', 'Pet Boarding', 'Cat Care', 'Fish Tank Maintenance', 'Pet Photography', 'Pet Transport', 'Veterinary Advice'],
        // ── Home & Handyman ──
        'handyman': ['Plumbing', 'Electrical Work', 'Painting', 'Tiling', 'Carpentry', 'Furniture Assembly', 'Aircon Service', 'Door/Lock Repair', 'Renovation', 'Waterproofing'],
        'home-repair': ['Plumbing', 'Electrical Repair', 'Painting', 'Furniture Assembly', 'Aircon Service', 'Door Repair', 'Lock Installation', 'Shelving', 'Curtain Rod', 'TV Mounting'],
        'cleaning': ['House Cleaning', 'Office Cleaning', 'Deep Cleaning', 'Post-renovation Cleaning', 'Carpet Cleaning', 'Window Cleaning', 'Disinfection', 'Move-in Cleaning', 'Upholstery Cleaning', 'Kitchen Deep Clean'],
        'garden': ['Landscaping', 'Garden Maintenance', 'Lawn Mowing', 'Tree Trimming', 'Plant Care', 'Garden Design', 'Irrigation', 'Pest Control', 'Composting', 'Indoor Plants'],
        'gardening': ['Lawn Mowing', 'Tree Trimming', 'Plant Care', 'Garden Design', 'Landscaping', 'Pest Control', 'Irrigation Setup', 'Composting', 'Herb Garden', 'Vertical Garden'],
        // ── Specialized Services ──
        'crafts': ['Handmade Crafts', 'Sewing', 'Embroidery', 'Woodworking', 'Jewelry Making', 'Calligraphy', 'Gift Wrapping', 'Custom Gifts', 'Batik', 'Kraftangan'],
        'music': ['Music Production', 'Mixing', 'Mastering', 'Songwriting', 'Vocal Recording', 'Guitar', 'Piano', 'Nasyid', 'Jingle', 'Sound Design'],
        'music-production': ['Beat Making', 'Mixing', 'Mastering', 'Music Composition', 'Songwriting', 'Vocal Production', 'Jingle Creation', 'Film Score', 'Nasyid Production', 'Sound Design'],
        'events': ['Event Planning', 'Wedding Planning', 'MC/Emcee', 'Sound System', 'Decoration', 'Catering', 'Canopy Rental', 'Event Photography', 'Invitation Design', 'Stage Setup'],
        'event-planning': ['Wedding Planning', 'Corporate Event', 'Birthday Party', 'Kenduri', 'MC/Emcee', 'Decoration', 'Vendor Coordination', 'Catering Management', 'Invitation Design', 'Event Logistics'],
        'tours': ['Tour Guide', 'Travel Planning', 'City Tours', 'Heritage Tours', 'Nature Trekking', 'Food Tours', 'Transportation', 'Itinerary Planning', 'Local Guide', 'Adventure Tours'],
        // ── Other Categories ──
        'online-selling': ['Shopee', 'Lazada', 'Product Listing', 'Product Photography', 'Inventory Management', 'Customer Service', 'Social Commerce', 'Dropshipping', 'TikTok Shop', 'Order Fulfillment'],
        'delivery': ['Food Delivery', 'Parcel Delivery', 'Same-day Delivery', 'Courier Service', 'Grocery Delivery', 'Document Delivery', 'Motorcycle Delivery', 'Van Delivery', 'Interstate Delivery', 'Last-mile Delivery'],
        'micro-tasks': ['Survey', 'App Testing', 'Mystery Shopping', 'Data Labeling', 'Feedback', 'Short Tasks', 'Product Review', 'Sign Up Tasks', 'QR Scanning', 'Quick Research'],
        'caregiving': ['Elderly Care', 'Child Care', 'Babysitting', 'Disability Care', 'Home Nursing', 'Companionship', 'Meal Preparation', 'Personal Care', 'Respite Care', 'Special Needs Care'],
        'creative-other': ['Custom Art', 'Digital Art', 'Mural Painting', 'Face Painting', 'Henna Art', 'Balloon Decoration', 'Custom Printing', 'Sticker Design', 'T-shirt Design', 'Caricature'],
        'data': ['Data Analysis', 'Data Visualization', 'Excel', 'Power BI', 'Tableau', 'SQL', 'Python Analytics', 'Report Generation', 'Dashboard Design', 'Data Cleaning'],
        'general': ['Khidmat Am', 'Pemasangan', 'Pembersihan', 'Penghantaran', 'Pemindahan', 'Bantuan Acara', 'Kerja Manual', 'Pengangkutan', 'Susun Atur', 'Kerja Pejabat']
    };

    // Load existing specializations
    function loadSpecializations() {
        fetch('/api/specializations')
            .then(response => response.json())
            .then(data => {
                allSpecializations = data.specializations || [];
                renderSpecializations();
                updateCategoryOptions();
            })
            .catch(error => {
                console.error('Error loading specializations:', error);
            });
    }

    // Render specializations list
    function renderSpecializations() {
        const container = document.getElementById('specializations-list');
        if (!container) return;

        if (allSpecializations.length === 0) {
            container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Tiada kepakaran ditambah lagi. Pilih kategori di bawah untuk bermula.</p>';
            return;
        }

        container.innerHTML = allSpecializations.map(spec => {
            // Build rate display string
            let rateDisplay = '';
            if (spec.base_hourly_rate || spec.base_fixed_rate) {
                const rates = [];
                if (spec.base_hourly_rate) rates.push(`RM${spec.base_hourly_rate}/jam`);
                if (spec.base_fixed_rate) rates.push(`RM${spec.base_fixed_rate}/gig`);
                const premium = spec.premium_multiplier > 1.0 ? ` <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${spec.premium_multiplier}x premium</span>` : '';
                rateDisplay = `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border); font-size: 13px; color: var(--text-gray);">
                    <strong style="color: var(--primary);">Kadar:</strong> ${rates.join(' / ')}${premium}
                </div>`;
            }

            // Build specialization title display
            const titleDisplay = spec.specialization_title
                ? `<div style="font-size: 13px; color: var(--text-gray); margin-top: 4px;">${spec.specialization_title}</div>`
                : '';

            // Escape data for onclick handler
            const specData = JSON.stringify({
                skills: spec.skills,
                title: spec.specialization_title || '',
                hourlyRate: spec.base_hourly_rate || '',
                fixedRate: spec.base_fixed_rate || '',
                multiplier: spec.premium_multiplier || 1.0,
                slug: spec.category_slug || ''
            }).replace(/'/g, '&#39;').replace(/"/g, '&quot;');

            return `
            <div class="specialization-card">
                <div class="specialization-header">
                    <div class="specialization-title">
                        <i data-feather="${spec.category_icon || 'clipboard'}" style="width: 20px; height: 20px;"></i>
                        <span>${spec.category_name}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick='editSpecializationFull(${spec.id}, ${spec.category_id}, "${spec.category_name}", "${spec.category_icon || 'clipboard'}", ${specData})'>Edit</button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="deleteSpecialization(${spec.id})">Padam</button>
                    </div>
                </div>
                ${titleDisplay}
                <div class="skills-list">
                    ${spec.skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                    ${spec.skills.length === 0 ? '<span style="color: var(--text-gray); font-size: 13px;">Tiada kemahiran ditambah</span>' : ''}
                </div>
                ${rateDisplay}
            </div>
        `;
        }).join('');

        // Re-initialize feather icons after rendering
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    // Update category options (disable already selected categories)
    function updateCategoryOptions() {
        const categoryOptions = document.querySelectorAll('.category-option');
        const usedCategoryIds = allSpecializations.map(s => s.category_id);

        categoryOptions.forEach(option => {
            const categoryId = parseInt(option.dataset.categoryId);
            if (usedCategoryIds.includes(categoryId)) {
                option.style.opacity = '0.5';
                option.style.pointerEvents = 'none';
                option.style.cursor = 'not-allowed';
            } else {
                option.style.opacity = '1';
                option.style.pointerEvents = 'auto';
                option.style.cursor = 'pointer';
            }
        });
    }

    // Handle category selection
    document.querySelectorAll('.category-option').forEach(option => {
        option.addEventListener('click', function() {
            const categoryId = parseInt(this.dataset.categoryId);
            const categoryName = this.dataset.categoryName;
            const categoryIcon = this.dataset.categoryIcon;
            const categorySlug = this.dataset.categorySlug;

            // Show edit modal
            showEditModal(null, categoryId, categoryName, categoryIcon, [], null, categorySlug);
        });
    });

    // Show edit modal with all fields
    function showEditModal(specializationId, categoryId, categoryName, categoryIcon, skills, specData = null, categorySlug = null) {
        currentSpecializationId = specializationId;
        currentCategoryId = categoryId;
        currentCategorySlug = categorySlug;
        currentSkills = [...skills];

        document.getElementById('modal-category-name').textContent = categoryName;
        // Use Feather icon in modal header
        document.getElementById('modal-category-icon').innerHTML = `<i data-feather="${categoryIcon || 'clipboard'}" style="width: 24px; height: 24px;"></i>`;
        document.getElementById('skill-input').value = '';

        // Set rate fields
        document.getElementById('specialization-title').value = specData?.title || '';
        document.getElementById('base-hourly-rate').value = specData?.hourlyRate || '';
        document.getElementById('base-fixed-rate').value = specData?.fixedRate || '';
        document.getElementById('premium-multiplier').value = specData?.multiplier || '1.0';

        renderSkills();
        hideSuggestions();

        // Hide category selector and show modal
        document.getElementById('add-specialization-section').style.display = 'none';
        document.getElementById('edit-specialization-modal').style.display = 'block';

        // Re-initialize feather icons after showing modal
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }

    // Edit specialization with full data (called from list)
    window.editSpecializationFull = function(id, categoryId, categoryName, categoryIcon, specData) {
        showEditModal(id, categoryId, categoryName, categoryIcon, specData.skills || [], specData, specData.slug || '');
    };

    // Hide edit modal
    function hideEditModal() {
        document.getElementById('add-specialization-section').style.display = 'block';
        document.getElementById('edit-specialization-modal').style.display = 'none';
        currentCategoryId = null;
        currentCategorySlug = null;
        currentSpecializationId = null;
        currentSkills = [];
        hideSuggestions();
        // Clear rate fields
        document.getElementById('specialization-title').value = '';
        document.getElementById('base-hourly-rate').value = '';
        document.getElementById('base-fixed-rate').value = '';
        document.getElementById('premium-multiplier').value = '1.0';
    }

    // Render skills in modal
    function renderSkills() {
        const container = document.getElementById('skills-list');
        container.innerHTML = currentSkills.map((skill, index) => `
            <span class="skill-tag">
                ${skill}
                <button onclick="removeSkill(${index})">&times;</button>
            </span>
        `).join('');
    }

    // Add skill
    function addSkill() {
        const input = document.getElementById('skill-input');
        const skill = input.value.trim();

        if (!skill) {
            alert('Sila masukkan kemahiran');
            return;
        }

        if (currentSkills.length >= 10) {
            alert('Anda hanya boleh menambah sehingga 10 kemahiran setiap kategori');
            return;
        }

        if (currentSkills.includes(skill)) {
            alert('Kemahiran ini sudah ditambah');
            return;
        }

        currentSkills.push(skill);
        input.value = '';
        renderSkills();
    }

    // Remove skill
    window.removeSkill = function(index) {
        currentSkills.splice(index, 1);
        renderSkills();
        updateSuggestions();
    };

    // ==================== SKILL SUGGESTIONS DROPDOWN ====================

    function getFilteredSuggestions(query) {
        const predefined = PREDEFINED_SKILLS[currentCategorySlug] || [];
        return predefined.filter(skill =>
            !currentSkills.includes(skill) &&
            skill.toLowerCase().includes(query.toLowerCase())
        );
    }

    function showSuggestions(query) {
        const container = document.getElementById('skill-suggestions');
        const suggestions = getFilteredSuggestions(query || '');

        if (suggestions.length === 0 || currentSkills.length >= 10) {
            hideSuggestions();
            return;
        }

        const header = query ? 'Cadangan' : 'Kemahiran Popular';
        container.innerHTML = `<div class="skill-suggestions-header">${header}</div>` +
            suggestions.map((skill, i) =>
                `<div class="skill-suggestion-item${i === highlightedIndex ? ' highlighted' : ''}" data-skill="${skill}" data-index="${i}">${skill}</div>`
            ).join('');

        container.classList.add('active');

        // Add click handlers
        container.querySelectorAll('.skill-suggestion-item').forEach(item => {
            item.addEventListener('mousedown', function(e) {
                e.preventDefault(); // Prevent input blur
                selectSuggestion(this.dataset.skill);
            });
        });
    }

    function hideSuggestions() {
        const container = document.getElementById('skill-suggestions');
        if (container) {
            container.classList.remove('active');
            container.innerHTML = '';
        }
        highlightedIndex = -1;
    }

    function updateSuggestions() {
        const input = document.getElementById('skill-input');
        if (input && document.activeElement === input) {
            showSuggestions(input.value.trim());
        }
    }

    function selectSuggestion(skill) {
        if (currentSkills.length >= 10) {
            alert('Anda hanya boleh menambah sehingga 10 kemahiran setiap kategori');
            return;
        }
        if (!currentSkills.includes(skill)) {
            currentSkills.push(skill);
            renderSkills();
        }
        const input = document.getElementById('skill-input');
        input.value = '';
        highlightedIndex = -1;
        showSuggestions('');
        input.focus();
    }

    // ==================== END SKILL SUGGESTIONS ====================

    // Save specialization with rate fields
    function saveSpecialization() {
        if (!currentCategoryId) {
            alert('Sila pilih kategori');
            return;
        }

        if (currentSkills.length === 0) {
            alert('Sila tambah sekurang-kurangnya satu kemahiran');
            return;
        }

        // Get rate field values
        const specializationTitle = document.getElementById('specialization-title').value.trim();
        const baseHourlyRate = document.getElementById('base-hourly-rate').value;
        const baseFixedRate = document.getElementById('base-fixed-rate').value;
        const premiumMultiplier = document.getElementById('premium-multiplier').value;

        const data = {
            category_id: currentCategoryId,
            skills: currentSkills,
            specialization_title: specializationTitle || null,
            base_hourly_rate: baseHourlyRate ? parseFloat(baseHourlyRate) : null,
            base_fixed_rate: baseFixedRate ? parseFloat(baseFixedRate) : null,
            premium_multiplier: premiumMultiplier ? parseFloat(premiumMultiplier) : 1.0
        };

        fetch('/api/specializations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Ralat: ' + data.error);
                return;
            }

            alert(data.message || 'Kepakaran berjaya disimpan');
            hideEditModal();
            loadSpecializations();
        })
        .catch(error => {
            console.error('Error saving specialization:', error);
            alert('Ralat menyimpan kepakaran. Sila cuba lagi.');
        });
    }

    // Edit specialization
    window.editSpecialization = function(id, categoryId, categoryName, categoryIcon, skills) {
        showEditModal(id, categoryId, categoryName, categoryIcon, skills);
    };

    // Delete specialization
    window.deleteSpecialization = function(id) {
        if (!confirm('Adakah anda pasti mahu memadamkan kepakaran ini?')) {
            return;
        }

        fetch(`/api/specializations/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Ralat: ' + data.error);
                return;
            }

            alert(data.message || 'Kepakaran berjaya dipadamkan');
            loadSpecializations();
        })
        .catch(error => {
            console.error('Error deleting specialization:', error);
            alert('Ralat memadamkan kepakaran. Sila cuba lagi.');
        });
    };

    // Event listeners
    const skillInput = document.getElementById('skill-input');

    document.getElementById('add-skill-btn').addEventListener('click', function() {
        addSkill();
        hideSuggestions();
    });

    skillInput.addEventListener('keydown', function(e) {
        const container = document.getElementById('skill-suggestions');
        const items = container.querySelectorAll('.skill-suggestion-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            showSuggestions(this.value.trim());
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, -1);
            showSuggestions(this.value.trim());
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                selectSuggestion(items[highlightedIndex].dataset.skill);
            } else {
                addSkill();
                hideSuggestions();
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });

    skillInput.addEventListener('input', function() {
        highlightedIndex = -1;
        showSuggestions(this.value.trim());
    });

    skillInput.addEventListener('focus', function() {
        showSuggestions(this.value.trim());
    });

    skillInput.addEventListener('blur', function() {
        // Delay to allow click on suggestion
        setTimeout(hideSuggestions, 200);
    });

    document.getElementById('save-specialization-btn').addEventListener('click', saveSpecialization);
    document.getElementById('cancel-specialization-btn').addEventListener('click', hideEditModal);

    // Load specializations on page load
    loadSpecializations();

    // Initialize Feather icons for category selector
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>

<script>
// Profile Photo Upload
(function() {
    const input = document.getElementById('profile-photo-input');
    const preview = document.getElementById('profile-photo-preview');
    const status = document.getElementById('photo-upload-status');
    const removeBtn = document.getElementById('remove-photo-btn');

    if (!input) return;

    input.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            status.textContent = 'Fail terlalu besar. Saiz maksimum 5MB.';
            status.style.color = 'var(--error, #dc2626)';
            return;
        }

        const formData = new FormData();
        formData.append('photo', file);
        formData.append('csrf_token', '{{ csrf_token() }}');

        status.textContent = 'Memuat naik...';
        status.style.color = 'var(--text-gray)';

        fetch('/settings/profile/photo', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.photo_url) {
                preview.innerHTML = '<img src="' + data.photo_url + '?t=' + Date.now() + '" alt="Gambar Profil" style="width:100%;height:100%;object-fit:cover;">';
                status.textContent = 'Gambar profil berjaya dikemaskini!';
                status.style.color = '#065f46';
                // Show remove button if not already shown
                if (!removeBtn) {
                    const newBtn = document.createElement('button');
                    newBtn.type = 'button';
                    newBtn.id = 'remove-photo-btn';
                    newBtn.className = 'btn btn-danger';
                    newBtn.style.marginLeft = '8px';
                    newBtn.textContent = 'Padam Gambar';
                    newBtn.addEventListener('click', removePhoto);
                    document.querySelector('[for="profile-photo-input"]').insertAdjacentElement('afterend', newBtn);
                }
            } else {
                status.textContent = data.error || 'Gagal memuat naik gambar.';
                status.style.color = 'var(--error, #dc2626)';
            }
        })
        .catch(() => {
            status.textContent = 'Ralat rangkaian. Sila cuba lagi.';
            status.style.color = 'var(--error, #dc2626)';
        });
    });

    function removePhoto() {
        if (!confirm('Adakah anda pasti mahu memadamkan gambar profil?')) return;

        fetch('/settings/profile/photo', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.message) {
                const initial = '{{ (user.full_name or user.username)[0].upper() }}';
                preview.innerHTML = initial;
                if (removeBtn) removeBtn.remove();
                status.textContent = 'Gambar profil telah dipadamkan.';
                status.style.color = '#065f46';
            } else {
                status.textContent = data.error || 'Gagal memadamkan gambar.';
                status.style.color = 'var(--error, #dc2626)';
            }
        })
        .catch(() => {
            status.textContent = 'Ralat rangkaian. Sila cuba lagi.';
            status.style.color = 'var(--error, #dc2626)';
        });
    }

    if (removeBtn) removeBtn.addEventListener('click', removePhoto);
})();
</script>
{% endblock %}
