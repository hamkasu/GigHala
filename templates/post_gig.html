{% extends "base.html" %}

{% block title %}{{ t('post_new_gig') }}{% endblock %}

{% block extra_styles %}
<style>
    .page-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-gray);
        font-size: 15px;
    }

    .form-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
    }

    .form-section {
        margin-bottom: 32px;
        padding-bottom: 32px;
        border-bottom: 1px solid var(--border);
    }

    .form-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-label .required {
        color: var(--error);
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 27px 36px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(29, 191, 115, 0.1);
    }

    .form-textarea {
        min-height: 315px;
        resize: vertical;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-hint {
        color: var(--text-light);
        font-size: 12px;
        margin-top: 6px;
    }

    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .checkbox-item:hover {
        border-color: var(--primary);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .checkbox-item .checkbox-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
    }

    .checkbox-item .checkbox-desc {
        font-size: 12px;
        color: var(--text-light);
    }

    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        min-height: 50px;
        background: var(--bg-white);
    }

    .skill-tag {
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .skill-tag button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        opacity: 0.8;
    }

    .skill-tag button:hover {
        opacity: 1;
    }

    .skills-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
        padding: 4px;
        font-family: inherit;
    }

    .category-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .category-card {
        padding: 16px 12px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .category-card:hover {
        border-color: var(--primary);
    }

    .category-card.selected {
        border-color: var(--primary);
        background: rgba(29, 191, 115, 0.05);
    }

    .category-card input {
        display: none;
    }

    .category-icon {
        font-size: 28px;
        margin-bottom: 8px;
    }

    .category-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .alert {
        padding: 14px 18px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 14px;
    }

    .alert-error {
        background: #FEE2E2;
        color: #DC2626;
        border: 1px solid #FECACA;
    }

    .alert-success {
        background: #D1FAE5;
        color: #059669;
        border: 1px solid #A7F3D0;
    }

    .photo-upload-area {
        border: 2px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 32px;
        text-align: center;
        background: var(--bg-light);
        transition: all 0.2s;
        cursor: pointer;
    }

    .photo-upload-area:hover, .photo-upload-area.dragover {
        border-color: var(--primary);
        background: rgba(29, 191, 115, 0.05);
    }

    .photo-upload-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .photo-upload-text {
        color: var(--text-gray);
        margin-bottom: 8px;
    }

    .photo-upload-text strong {
        color: var(--primary);
    }

    .photo-upload-hint {
        font-size: 12px;
        color: var(--text-light);
    }

    .photo-previews {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }

    .photo-preview {
        position: relative;
        aspect-ratio: 1;
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid var(--border);
    }

    .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-preview .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .photo-preview .remove-btn:hover {
        background: #DC2626;
    }

    .submit-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
    }

    .submit-info {
        font-size: 13px;
        color: var(--text-light);
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .category-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .checkbox-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Shake animation for halal compliance validation */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* AI Halal Compliance Status Badge */
    .ai-compliance-status {
        animation: fadeIn 0.3s ease-in;
    }

    .compliance-badge {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        border-radius: var(--radius-md);
        border: 2px solid;
        background: white;
        transition: all 0.3s ease;
    }

    .compliance-badge.checking {
        border-color: #94A3B8;
        background: #F8FAFC;
    }

    .compliance-badge.approved {
        border-color: #10B981;
        background: #ECFDF5;
    }

    .compliance-badge.flagged {
        border-color: #F59E0B;
        background: #FFFBEB;
    }

    .compliance-badge.rejected {
        border-color: #EF4444;
        background: #FEF2F2;
    }

    .badge-icon {
        font-size: 24px;
        flex-shrink: 0;
        animation: pulse 2s infinite;
    }

    .compliance-badge.approved .badge-icon {
        animation: none;
    }

    .compliance-badge.rejected .badge-icon {
        animation: shake 0.5s ease;
    }

    .badge-content {
        flex: 1;
    }

    .badge-title {
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 4px;
    }

    .compliance-badge.checking .badge-title {
        color: #475569;
    }

    .compliance-badge.approved .badge-title {
        color: #047857;
    }

    .compliance-badge.flagged .badge-title {
        color: #D97706;
    }

    .compliance-badge.rejected .badge-title {
        color: #DC2626;
    }

    .badge-message {
        font-size: 13px;
        line-height: 1.5;
        color: #64748B;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">{% if edit_mode %}{{ t('edit_gig') }}{% else %}{{ t('post_new_gig') }}{% endif %}</h1>
        <p class="page-subtitle">{% if edit_mode %}{{ t('update_gig_subtitle') }}{% else %}{{ t('find_freelancer_subtitle') }}{% endif %}</p>
    </div>

    <div class="form-card">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div id="alertContainer"></div>

        <form id="postGigForm" method="POST" action="{% if edit_mode %}/edit-gig/{{ gig.id }}{% else %}/post-gig{% endif %}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="file-text" width="18"></i>
                    {{ t('gig_information') }}
                </h3>

                <div class="form-group">
                    <label class="form-label">
                        {{ t('gig_title') }} <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="title" name="title"
                           placeholder="{{ t('gig_title_placeholder') }}" required
                           value="{{ form_data.title if form_data else '' }}">
                    <p class="form-hint">{{ t('gig_title_hint') }}</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        {{ t('description') }} <span class="required">*</span>
                    </label>
                    <textarea class="form-textarea" id="description" name="description"
                              placeholder="{{ t('description_placeholder') }}" required>{{ form_data.description if form_data else '' }}</textarea>
                </div>

                <!-- AI Halal Compliance Status Badge -->
                <div id="ai-compliance-status" class="ai-compliance-status" style="display: none; margin-bottom: 20px;">
                    <div class="compliance-badge" id="compliance-badge">
                        <div class="badge-icon" id="badge-icon"></div>
                        <div class="badge-content">
                            <div class="badge-title" id="badge-title">Checking compliance...</div>
                            <div class="badge-message" id="badge-message"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        {{ t('category') }} <span class="required">*</span>
                    </label>
                    <div class="category-cards" id="category-cards-container">
                        {% for cat in categories %}
                        <label class="category-card {% if form_data and form_data.category == cat.slug %}selected{% endif %}" onclick="selectCategory(this)">
                            <input type="radio" name="category" value="{{ cat.slug }}" required {% if form_data and form_data.category == cat.slug %}checked{% endif %} style="position: absolute; opacity: 0; pointer-events: none;">
                            <div class="category-icon">
                                {% if cat.slug == 'design' %}üé®
                                {% elif cat.slug == 'writing' %}‚úçÔ∏è
                                {% elif cat.slug == 'video' %}üé¨
                                {% elif cat.slug == 'tutoring' %}üìö
                                {% elif cat.slug == 'content' %}üì±
                                {% elif cat.slug == 'web' %}üíª
                                {% elif cat.slug == 'marketing' %}üìà
                                {% elif cat.slug == 'admin' %}üìã
                                {% elif cat.slug == 'general' %}üì¶
                                {% elif cat.slug == 'programming' %}üñ•Ô∏è
                                {% elif cat.slug == 'consulting' %}üíº
                                {% elif cat.slug == 'engineering' %}üõ†Ô∏è
                                {% elif cat.slug == 'music' %}üéµ
                                {% elif cat.slug == 'photography' %}üì∏
                                {% elif cat.slug == 'finance' %}üí∞
                                {% elif cat.slug == 'crafts' %}‚ú®
                                {% elif cat.slug == 'garden' %}üå±
                                {% elif cat.slug == 'coaching' %}üí™
                                {% elif cat.slug == 'data' %}üìä
                                {% elif cat.slug == 'pets' %}üêæ
                                {% elif cat.slug == 'handyman' %}üîß
                                {% elif cat.slug == 'tours' %}‚úàÔ∏è
                                {% elif cat.slug == 'events' %}üéâ
                                {% elif cat.slug == 'online-selling' %}üõçÔ∏è
                                {% elif cat.slug == 'virtual-assistant' %}üíº
                                {% elif cat.slug == 'delivery' %}üöö
                                {% elif cat.slug == 'micro-tasks' %}‚úÖ
                                {% elif cat.slug == 'caregiving' %}ü§ù
                                {% elif cat.slug == 'creative-other' %}üé≠
                                {% else %}üìã{% endif %}
                            </div>
                            <div class="category-name">{{ t('category_' + cat.slug) }}</div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="dollar-sign" width="18"></i>
                    {{ t('budget_duration') }}
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            {{ t('budget_min') }} <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="budget_min" name="budget_min"
                               placeholder="100" min="1" required value="{{ form_data.budget_min if form_data else '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            {{ t('budget_max') }} <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="budget_max" name="budget_max"
                               placeholder="500" min="1" required value="{{ form_data.budget_max if form_data else '' }}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            {{ t('approved_budget') }}
                            <small class="text-muted" style="font-weight: normal;">{{ t('approved_budget_hint') }}</small>
                        </label>
                        <input type="number" class="form-input" id="approved_budget" name="approved_budget"
                               placeholder="300" min="1" step="0.01" value="{{ form_data.approved_budget if form_data else '' }}">
                        <small class="form-text text-muted">{{ t('approved_budget_help') }}</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">{{ t('duration') }}</label>
                        <select class="form-select" id="duration" name="duration">
                            <option value="">{{ t('select_duration') }}</option>
                            <option value="1-3 days" {% if form_data and form_data.duration == '1-3 days' %}selected{% endif %}>{{ t('duration_1_3_days') }}</option>
                            <option value="1 week" {% if form_data and form_data.duration == '1 week' %}selected{% endif %}>{{ t('duration_1_week') }}</option>
                            <option value="2 weeks" {% if form_data and form_data.duration == '2 weeks' %}selected{% endif %}>{{ t('duration_2_weeks') }}</option>
                            <option value="1 month" {% if form_data and form_data.duration == '1 month' %}selected{% endif %}>{{ t('duration_1_month') }}</option>
                            <option value="Ongoing" {% if form_data and form_data.duration == 'Ongoing' %}selected{% endif %}>{{ t('duration_ongoing') }}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">{{ t('deadline') }}</label>
                        <input type="date" class="form-input" id="deadline" name="deadline" value="{{ form_data.deadline if form_data else '' }}">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="map-pin" width="18"></i>
                    {{ t('location_skills') }}
                </h3>

                <div class="form-group">
                    <label class="form-label">{{ t('location') }}</label>
                    <input
                        type="text"
                        class="form-select"
                        id="location"
                        name="location"
                        list="locationsList"
                        placeholder="{{ t('type_or_select_location') }}"
                        value="{{ form_data.location if form_data else '' }}"
                    >
                    <datalist id="locationsList">
                        <option value="{{ t('all_locations_option') }}">
                        <option value="{{ t('remote_option') }}">

                        <!-- Johor -->
                        <option value="Batu Pahat, Johor">
                        <option value="Johor Bahru, Johor">
                        <option value="Kluang, Johor">
                        <option value="Kota Tinggi, Johor">
                        <option value="Kulai, Johor">
                        <option value="Mersing, Johor">
                        <option value="Muar, Johor">
                        <option value="Pontian, Johor">
                        <option value="Segamat, Johor">
                        <option value="Tangkak, Johor">

                        <!-- Kedah -->
                        <option value="Alor Setar, Kedah">
                        <option value="Baling, Kedah">
                        <option value="Bandar Baharu, Kedah">
                        <option value="Kota Setar, Kedah">
                        <option value="Kuala Muda, Kedah">
                        <option value="Kubang Pasu, Kedah">
                        <option value="Kulim, Kedah">
                        <option value="Langkawi, Kedah">
                        <option value="Padang Terap, Kedah">
                        <option value="Pendang, Kedah">
                        <option value="Pokok Sena, Kedah">
                        <option value="Sik, Kedah">
                        <option value="Yan, Kedah">

                        <!-- Kelantan -->
                        <option value="Bachok, Kelantan">
                        <option value="Gua Musang, Kelantan">
                        <option value="Jeli, Kelantan">
                        <option value="Kota Bharu, Kelantan">
                        <option value="Kuala Krai, Kelantan">
                        <option value="Machang, Kelantan">
                        <option value="Pasir Mas, Kelantan">
                        <option value="Pasir Puteh, Kelantan">
                        <option value="Tanah Merah, Kelantan">
                        <option value="Tumpat, Kelantan">

                        <!-- Melaka -->
                        <option value="Alor Gajah, Melaka">
                        <option value="Jasin, Melaka">
                        <option value="Melaka Tengah, Melaka">

                        <!-- Negeri Sembilan -->
                        <option value="Jelebu, Negeri Sembilan">
                        <option value="Jempol, Negeri Sembilan">
                        <option value="Kuala Pilah, Negeri Sembilan">
                        <option value="Port Dickson, Negeri Sembilan">
                        <option value="Rembau, Negeri Sembilan">
                        <option value="Seremban, Negeri Sembilan">
                        <option value="Tampin, Negeri Sembilan">

                        <!-- Pahang -->
                        <option value="Bentong, Pahang">
                        <option value="Bera, Pahang">
                        <option value="Cameron Highlands, Pahang">
                        <option value="Jerantut, Pahang">
                        <option value="Kuantan, Pahang">
                        <option value="Lipis, Pahang">
                        <option value="Maran, Pahang">
                        <option value="Pekan, Pahang">
                        <option value="Raub, Pahang">
                        <option value="Rompin, Pahang">
                        <option value="Temerloh, Pahang">

                        <!-- Penang -->
                        <option value="Barat Daya, Penang">
                        <option value="Seberang Perai Selatan, Penang">
                        <option value="Seberang Perai Tengah, Penang">
                        <option value="Seberang Perai Utara, Penang">
                        <option value="Timur Laut, Penang">

                        <!-- Perak -->
                        <option value="Batang Padang, Perak">
                        <option value="Hilir Perak, Perak">
                        <option value="Hulu Perak, Perak">
                        <option value="Kampar, Perak">
                        <option value="Kerian, Perak">
                        <option value="Kinta, Perak">
                        <option value="Kuala Kangsar, Perak">
                        <option value="Larut, Matang dan Selama, Perak">
                        <option value="Manjung, Perak">
                        <option value="Muallim, Perak">
                        <option value="Perak Tengah, Perak">

                        <!-- Perlis -->
                        <option value="Arau, Perlis">
                        <option value="Kangar, Perlis">
                        <option value="Padang Besar, Perlis">

                        <!-- Sabah -->
                        <option value="Beaufort, Sabah">
                        <option value="Beluran, Sabah">
                        <option value="Keningau, Sabah">
                        <option value="Kinabatangan, Sabah">
                        <option value="Kota Belud, Sabah">
                        <option value="Kota Kinabalu, Sabah">
                        <option value="Kota Marudu, Sabah">
                        <option value="Kuala Penyu, Sabah">
                        <option value="Kudat, Sabah">
                        <option value="Kunak, Sabah">
                        <option value="Lahad Datu, Sabah">
                        <option value="Nabawan, Sabah">
                        <option value="Papar, Sabah">
                        <option value="Penampang, Sabah">
                        <option value="Pitas, Sabah">
                        <option value="Putatan, Sabah">
                        <option value="Ranau, Sabah">
                        <option value="Sandakan, Sabah">
                        <option value="Semporna, Sabah">
                        <option value="Sipitang, Sabah">
                        <option value="Tambunan, Sabah">
                        <option value="Tawau, Sabah">
                        <option value="Tenom, Sabah">
                        <option value="Tuaran, Sabah">

                        <!-- Sarawak -->
                        <option value="Asajaya, Sarawak">
                        <option value="Belaga, Sarawak">
                        <option value="Betong, Sarawak">
                        <option value="Bintulu, Sarawak">
                        <option value="Dalat, Sarawak">
                        <option value="Daro, Sarawak">
                        <option value="Kapit, Sarawak">
                        <option value="Kuching, Sarawak">
                        <option value="Lawas, Sarawak">
                        <option value="Limbang, Sarawak">
                        <option value="Lubok Antu, Sarawak">
                        <option value="Marudi, Sarawak">
                        <option value="Matu, Sarawak">
                        <option value="Miri, Sarawak">
                        <option value="Mukah, Sarawak">
                        <option value="Pakan, Sarawak">
                        <option value="Pusa, Sarawak">
                        <option value="Saratok, Sarawak">
                        <option value="Sarikei, Sarawak">
                        <option value="Serian, Sarawak">
                        <option value="Sibu, Sarawak">
                        <option value="Simunjan, Sarawak">
                        <option value="Subis, Sarawak">

                        <!-- Selangor -->
                        <option value="Gombak, Selangor">
                        <option value="Hulu Langat, Selangor">
                        <option value="Hulu Selangor, Selangor">
                        <option value="Klang, Selangor">
                        <option value="Kuala Langat, Selangor">
                        <option value="Kuala Selangor, Selangor">
                        <option value="Petaling, Selangor">
                        <option value="Sabak Bernam, Selangor">
                        <option value="Sepang, Selangor">

                        <!-- Terengganu -->
                        <option value="Besut, Terengganu">
                        <option value="Dungun, Terengganu">
                        <option value="Hulu Terengganu, Terengganu">
                        <option value="Kemaman, Terengganu">
                        <option value="Kuala Nerus, Terengganu">
                        <option value="Kuala Terengganu, Terengganu">
                        <option value="Marang, Terengganu">
                        <option value="Setiu, Terengganu">

                        <!-- Federal Territories -->
                        <option value="Kuala Lumpur">
                        <option value="Labuan">
                        <option value="Putrajaya">
                    </datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">{{ t('skills_required') }}</label>
                    <div class="skills-container" id="skillsContainer">
                        <input type="text" class="skills-input" id="skillInput"
                               placeholder="{{ t('type_skill_enter') }}">
                    </div>
                    <p class="form-hint">{{ t('press_enter_add_skill') }}</p>
                    <input type="hidden" id="skillsHidden" name="skills_required" value="{{ form_data.skills_required if form_data else '[]' }}">
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="image" width="18"></i>
                    {{ t('reference_photos') }}
                </h3>

                <div class="form-group">
                    <label class="form-label">{{ t('upload_photos_optional') }}</label>
                    <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                        <div class="photo-upload-icon">üìé</div>
                        <p class="photo-upload-text"><strong>{{ t('click_to_upload') }}</strong> {{ t('drag_photos_here') }}</p>
                        <p class="photo-upload-hint">{{ t('photo_format_hint') }}</p>
                    </div>
                    <input type="file" id="photoInput" name="photos" multiple accept="image/png,image/jpeg,image/webp,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" style="display: none;">
                    <div class="photo-previews" id="photoPreviews"></div>
                </div>
            </div>

            <!-- HALAL COMPLIANCE NOTICE -->
            <div class="form-section" style="background: #E8F5E9; border-left: 4px solid #2E7D32;">
                <h3 class="form-section-title" style="color: #2E7D32;">
                    <i data-feather="alert-circle" width="18"></i>
                    ‚ò™Ô∏è Pematuhan Halal Wajib / Mandatory Halal Compliance
                </h3>

                <div style="padding: 0 1rem 1rem 1rem;">
                    <p style="margin-bottom: 1rem; font-weight: 500; color: #1B5E20;">
                        <strong>PENTING:</strong> GigHala adalah platform 100% halal. Semua gig MESTI mematuhi syariah Islam dan undang-undang Malaysia.<br>
                        <strong>IMPORTANT:</strong> GigHala is a 100% halal platform. All gigs MUST comply with Shariah Islam and Malaysian law.
                    </p>

                    <details style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <summary style="cursor: pointer; font-weight: 600; color: #D32F2F;">
                            ‚ùå Kandungan & Aktiviti Yang DILARANG / PROHIBITED Content & Activities
                        </summary>
                        <ul style="margin-top: 1rem; line-height: 1.8; color: #424242;">
                            <li>‚ùå Alkohol, bir, arak, minuman keras / Alcohol, beer, wine, liquor</li>
                            <li>‚ùå Judi, pertaruhan, loteri, kasino / Gambling, betting, lottery, casino</li>
                            <li>‚ùå Daging babi, ham, bacon / Pork, ham, bacon</li>
                            <li>‚ùå Kandungan dewasa, pornografi, seksual / Adult content, pornography, sexual services</li>
                            <li>‚ùå Riba, faedah, pinjaman berasaskan faedah / Usury, interest, interest-based loans</li>
                            <li>‚ùå Penipuan, skim cepat kaya, MLM haram / Fraud, get-rich-quick schemes, illegal MLM</li>
                            <li>‚ùå Dadah, tembakau, rokok, vape / Drugs, tobacco, cigarettes, vaping</li>
                            <li>‚ùå Sihir, bomoh, ramalan nasib / Black magic, fortune telling, occult</li>
                            <li>‚ùå Penghujatan agama / Religious defamation</li>
                            <li>‚ùå Perkhidmatan dating tidak halal / Non-halal dating services</li>
                        </ul>
                    </details>

                    <details style="background: white; border-radius: 8px; padding: 1rem;">
                        <summary style="cursor: pointer; font-weight: 600; color: #2E7D32;">
                            ‚úÖ Contoh Gig Yang DIBENARKAN / ALLOWED Gigs Examples
                        </summary>
                        <ul style="margin-top: 1rem; line-height: 1.8; color: #424242;">
                            <li>‚úÖ Reka bentuk logo, poster halal / Halal logo & poster design</li>
                            <li>‚úÖ Penulisan artikel, terjemahan / Article writing, translation</li>
                            <li>‚úÖ Pengaturcaraan & pembangunan web / Programming & web development</li>
                            <li>‚úÖ Pengajaran & bimbingan / Teaching & tutoring</li>
                            <li>‚úÖ Penghantaran makanan halal / Halal food delivery</li>
                            <li>‚úÖ Perkhidmatan pembersihan / Cleaning services</li>
                            <li>‚úÖ Pemasaran digital produk halal / Digital marketing for halal products</li>
                            <li>‚úÖ Fotografi & videografi acara halal / Photography for halal events</li>
                        </ul>
                    </details>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="settings" width="18"></i>
                    {{ t('additional_options') }}
                </h3>

                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" id="is_remote" name="is_remote" {% if not form_data or form_data.is_remote %}checked{% endif %}>
                        <div>
                            <div class="checkbox-label">üè† {{ t('remote_work') }}</div>
                            <div class="checkbox-desc">{{ t('remote_work_desc') }}</div>
                        </div>
                    </label>

                    <!-- MANDATORY HALAL COMPLIANCE CHECKBOX -->
                    <label class="checkbox-item" style="border: 2px solid #2E7D32; background: #E8F5E9;">
                        <input type="checkbox" id="halal_compliant" name="halal_compliant" required checked>
                        <div>
                            <div class="checkbox-label" style="color: #1B5E20; font-weight: 600;">
                                ‚ò™Ô∏è {{ t('halal_compliant') }} <span style="color: #D32F2F;">*WAJIB/REQUIRED</span>
                            </div>
                            <div class="checkbox-desc" style="color: #2E7D32; font-weight: 500;">
                                Saya mengesahkan gig ini 100% halal dan mematuhi syariah Islam serta undang-undang Malaysia.<br>
                                I confirm this gig is 100% halal and complies with Shariah Islam and Malaysian law.
                            </div>
                        </div>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="is_instant_payout" name="is_instant_payout" {% if form_data and form_data.is_instant_payout %}checked{% endif %}>
                        <div>
                            <div class="checkbox-label">‚ö° {{ t('instant_payout_label') }}</div>
                            <div class="checkbox-desc">{{ t('instant_payout_desc') }}</div>
                        </div>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="is_brand_partnership" name="is_brand_partnership" {% if form_data and form_data.is_brand_partnership %}checked{% endif %}>
                        <div>
                            <div class="checkbox-label">üåü {{ t('brand_partnership') }}</div>
                            <div class="checkbox-desc">{{ t('brand_partnership_desc') }}</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="submit-section">
                <div class="submit-info">
                    {% if edit_mode %}
                    <a href="/gig/{{ gig.id }}" style="color: var(--primary);">‚Üê {{ t('back_to_gig') }}</a>
                    {% else %}
                    ‚úì {{ t('no_post_fee') }}
                    {% endif %}
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i data-feather="{% if edit_mode %}check{% else %}send{% endif %}" width="16"></i>
                    {% if edit_mode %}{{ t('save_changes') }}{% else %}{{ t('post_gig_btn') }}{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let skills = [];
    try {
        const savedSkills = document.getElementById('skillsHidden').value;
        if (savedSkills && savedSkills !== '[]') {
            skills = JSON.parse(savedSkills);
            if (!Array.isArray(skills)) skills = [];
        }
    } catch(e) {
        skills = [];
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        if (skills.length > 0) {
            updateSkillsDisplay();
        }
    });

    function selectCategory(element) {
        document.querySelectorAll('.category-card').forEach(card => {
            card.classList.remove('selected');
        });
        element.classList.add('selected');
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        const input = document.getElementById('skillInput');
        
        const tags = container.querySelectorAll('.skill-tag');
        tags.forEach(tag => tag.remove());
        
        skills.forEach((skill, index) => {
            const tag = document.createElement('span');
            tag.className = 'skill-tag';
            tag.innerHTML = `${skill} <button type="button" onclick="removeSkill(${index})">&times;</button>`;
            container.insertBefore(tag, input);
        });
        
        document.getElementById('skillsHidden').value = JSON.stringify(skills);
    }

    function removeSkill(index) {
        skills.splice(index, 1);
        updateSkillsDisplay();
    }

    document.getElementById('skillInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value && !skills.includes(value) && skills.length < 20) {
                skills.push(value);
                updateSkillsDisplay();
                this.value = '';
            }
        }
    });

    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        container.scrollIntoView({ behavior: 'smooth' });
    }

    // ======================================================================
    // AI-POWERED HALAL COMPLIANCE CHECK - Real-time validation
    // ======================================================================

    let complianceCheckTimeout = null;
    let lastCheckContent = '';

    // Get form field elements
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const categoryInputs = document.querySelectorAll('input[name="category"]');

    // Add event listeners for real-time checking
    titleInput.addEventListener('input', debounceComplianceCheck);
    descriptionInput.addEventListener('input', debounceComplianceCheck);
    categoryInputs.forEach(input => {
        input.addEventListener('change', debounceComplianceCheck);
    });

    function debounceComplianceCheck() {
        // Clear existing timeout
        if (complianceCheckTimeout) {
            clearTimeout(complianceCheckTimeout);
        }

        // Set new timeout for debounced check (wait 1.5 seconds after user stops typing)
        complianceCheckTimeout = setTimeout(checkHalalCompliance, 1500);

        // Show "checking" status immediately
        showComplianceStatus('checking');
    }

    async function checkHalalCompliance() {
        const title = titleInput.value.trim();
        const description = descriptionInput.value.trim();
        const category = document.querySelector('input[name="category"]:checked')?.value || '';

        // Don't check if content is too short
        if (title.length + description.length < 10) {
            hideComplianceStatus();
            return;
        }

        // Don't re-check if content hasn't changed
        const currentContent = title + '|' + description + '|' + category;
        if (currentContent === lastCheckContent) {
            return;
        }
        lastCheckContent = currentContent;

        try {
            showComplianceStatus('checking');

            const response = await fetch('/api/check-halal-compliance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    category: category,
                    skills: skills.join(' ')
                })
            });

            const result = await response.json();

            // Update UI based on result
            if (result.action === 'approve') {
                showComplianceStatus('approved', result);
            } else if (result.action === 'flag') {
                showComplianceStatus('flagged', result);
            } else if (result.action === 'reject') {
                showComplianceStatus('rejected', result);
            } else {
                showComplianceStatus('checking', result);
            }

        } catch (error) {
            console.error('Compliance check error:', error);
            // Silently fail - don't block the user
            hideComplianceStatus();
        }
    }

    function showComplianceStatus(status, result = null) {
        const statusContainer = document.getElementById('ai-compliance-status');
        const badge = document.getElementById('compliance-badge');
        const icon = document.getElementById('badge-icon');
        const title = document.getElementById('badge-title');
        const message = document.getElementById('badge-message');

        // Reset classes
        badge.className = 'compliance-badge';
        badge.classList.add(status);

        // Update content based on status
        if (status === 'checking') {
            icon.innerHTML = 'üîç';
            title.textContent = 'Checking halal compliance... / Menyemak pematuhan halal...';
            message.textContent = 'AI is analyzing your content for Shariah compliance.';
        } else if (status === 'approved') {
            icon.innerHTML = '‚úÖ';
            title.textContent = 'Halal-compliant! / Patuh halal!';
            message.innerHTML = `<strong>Your gig meets Islamic Shariah requirements.</strong><br>` +
                (result?.confidence ? `AI confidence: ${(result.confidence * 100).toFixed(0)}%` : '');
        } else if (status === 'flagged') {
            icon.innerHTML = '‚ö†Ô∏è';
            title.textContent = 'Flagged for review / Ditandakan untuk semakan';
            message.innerHTML = `<strong>Your gig will be reviewed by our admin team.</strong><br>` +
                `${result?.reason || 'Content may need verification for halal compliance.'}`;
        } else if (status === 'rejected') {
            icon.innerHTML = '‚ùå';
            title.textContent = 'Contains haram elements / Mengandungi unsur haram';
            message.innerHTML = `<strong>Your gig violates Shariah principles and cannot be posted.</strong><br>` +
                `${result?.reason || 'Please review and modify your content.'}`;
            if (result?.violations && result.violations.length > 0) {
                message.innerHTML += `<br><br><strong>Violations:</strong><br>‚Ä¢ ${result.violations.slice(0, 3).join('<br>‚Ä¢ ')}`;
            }
        }

        // Show the status
        statusContainer.style.display = 'block';
    }

    function hideComplianceStatus() {
        const statusContainer = document.getElementById('ai-compliance-status');
        statusContainer.style.display = 'none';
        lastCheckContent = '';
    }

    // ======================================================================
    // END OF AI COMPLIANCE CHECK
    // ======================================================================

    // HALAL COMPLIANCE VALIDATION - Prohibited keywords (subset for client-side checking)
    const prohibitedKeywords = [
        // Alcohol - general terms
        'alcohol', 'alkohol', 'beer', 'bir', 'wine', 'wain', 'whiskey', 'vodka', 'rum', 'arak',
        // Alcohol - popular brands
        'heineken', 'tiger beer', 'carlsberg', 'guinness', 'corona', 'budweiser', 'stella artois',
        'jack daniels', 'johnnie walker', 'chivas regal', 'jameson', 'hennessy', 'remy martin',
        'absolut', 'smirnoff', 'grey goose', 'bacardi', 'captain morgan', 'jose cuervo', 'patron',
        'bombay sapphire', 'tanqueray', 'baileys', 'jagermeister', 'black label', 'red label',
        'anchor beer', 'asahi', 'kirin', 'chang beer', 'singha',
        // Gambling
        'gambling', 'judi', 'casino', 'kasino', 'betting', 'pertaruhan', 'lottery', 'loteri',
        // Pork
        'pork', 'babi', 'pig', 'ham', 'bacon',
        // Adult content
        'porn', 'porno', 'pornography', 'pornografi', 'sex', 'seks', 'xxx', 'escort', 'prostitution',
        // Riba
        'interest', 'faedah', 'riba', 'usury', 'loan shark', 'along', 'ah long',
        // Fraud
        'scam', 'penipuan', 'fraud', 'ponzi', 'pyramid scheme',
        // Drugs
        'drugs', 'dadah', 'marijuana', 'ganja', 'cocaine', 'heroin', 'syabu',
        // Tobacco
        'cigarette', 'rokok', 'tobacco', 'tembakau', 'vape', 'vaping',
        // Occult
        'black magic', 'sihir', 'bomoh', 'dukun', 'fortune telling', 'ramalan nasib'
    ];

    function checkProhibitedContent(text) {
        if (!text) return null;
        const lowerText = text.toLowerCase();
        for (const keyword of prohibitedKeywords) {
            // Use word boundary matching
            const regex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
            if (regex.test(lowerText)) {
                return keyword;
            }
        }
        return null;
    }

    document.getElementById('postGigForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        const budgetMin = parseFloat(document.getElementById('budget_min').value);
        const budgetMax = parseFloat(document.getElementById('budget_max').value);
        const category = document.querySelector('input[name="category"]:checked')?.value;

        // HALAL COMPLIANCE CHECK - Mandatory checkbox
        const halalCheckbox = document.getElementById('halal_compliant');
        if (!halalCheckbox.checked) {
            e.preventDefault();
            showAlert('‚ö†Ô∏è Anda MESTI mengesahkan bahawa gig ini halal dan mematuhi syariah Islam. / You MUST confirm this gig is halal and Shariah-compliant.', 'error');
            halalCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            halalCheckbox.parentElement.parentElement.style.animation = 'shake 0.5s';
            setTimeout(() => {
                halalCheckbox.parentElement.parentElement.style.animation = '';
            }, 500);
            return;
        }

        // HALAL COMPLIANCE CHECK - Prohibited keywords in title
        const title = document.getElementById('title').value;
        const titleViolation = checkProhibitedContent(title);
        if (titleViolation) {
            e.preventDefault();
            showAlert(`‚ùå Tajuk mengandungi kandungan yang dilarang: "${titleViolation}". Sila ubah tajuk anda. / Title contains prohibited content: "${titleViolation}". Please modify your title.`, 'error');
            document.getElementById('title').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('title').style.borderColor = '#D32F2F';
            return;
        }

        // HALAL COMPLIANCE CHECK - Prohibited keywords in description
        const description = document.getElementById('description').value;
        const descViolation = checkProhibitedContent(description);
        if (descViolation) {
            e.preventDefault();
            showAlert(`‚ùå Penerangan mengandungi kandungan yang dilarang: "${descViolation}". Sila ubah penerangan anda. / Description contains prohibited content: "${descViolation}". Please modify your description.`, 'error');
            document.getElementById('description').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('description').style.borderColor = '#D32F2F';
            return;
        }

        // Reset border colors if validation passes
        document.getElementById('title').style.borderColor = '';
        document.getElementById('description').style.borderColor = '';

        if (!category) {
            e.preventDefault();
            showAlert('{{ t('please_select_category') }}', 'error');
            return;
        }

        if (budgetMin > budgetMax) {
            e.preventDefault();
            showAlert('{{ t('budget_max_error') }}', 'error');
            return;
        }

        document.getElementById('skillsHidden').value = JSON.stringify(skills);

        // Sync photo files before submit
        syncPhotoInput();

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i data-feather="loader" width="16"></i> {{ t('processing') }}';
        feather.replace();
    });

    let selectedFiles = [];
    const MAX_FILES = 5;
    const MAX_SIZE = 5 * 1024 * 1024;

    const photoUploadArea = document.getElementById('photoUploadArea');
    const photoInput = document.getElementById('photoInput');
    const photoPreviews = document.getElementById('photoPreviews');

    photoUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    photoUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    photoUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    photoInput.addEventListener('change', function(e) {
        const newFiles = Array.from(e.target.files);
        for (let file of newFiles) {
            if (selectedFiles.length >= MAX_FILES) {
                showAlert('{{ t('max_5_photos') }}', 'error');
                break;
            }
            if (!['image/png', 'image/jpeg', 'image/webp', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type)) {
                showAlert('{{ t('only_image_formats') }}', 'error');
                continue;
            }
            if (file.size > MAX_SIZE) {
                showAlert('{{ t('max_file_size_5mb') }}', 'error');
                continue;
            }
            selectedFiles.push(file);
        }
        syncPhotoInput();
        updatePhotoPreviews();
    });

    function handleFiles(files) {
        const validTypes = ['image/png', 'image/jpeg', 'image/webp', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

        for (let file of files) {
            if (selectedFiles.length >= MAX_FILES) {
                showAlert('{{ t('max_5_photos') }}', 'error');
                break;
            }

            if (!validTypes.includes(file.type)) {
                showAlert('{{ t('only_image_formats') }}', 'error');
                continue;
            }

            if (file.size > MAX_SIZE) {
                showAlert('{{ t('max_file_size_5mb') }}', 'error');
                continue;
            }

            selectedFiles.push(file);
        }

        syncPhotoInput();
        updatePhotoPreviews();
    }

    function syncPhotoInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        photoInput.files = dt.files;
    }

    function updatePhotoPreviews() {
        photoPreviews.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.createElement('div');
                preview.className = 'photo-preview';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">&times;</button>
                `;
                photoPreviews.appendChild(preview);
            };
            reader.readAsDataURL(file);
        });
    }

    function removePhoto(index) {
        selectedFiles.splice(index, 1);
        syncPhotoInput();
        updatePhotoPreviews();
    }
</script>
{% endblock %}