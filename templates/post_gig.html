{% extends "base.html" %}

{% block title %}Post a Gig{% endblock %}

{% block extra_styles %}
<style>
    .page-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .page-subtitle {
        color: var(--text-gray);
        font-size: 15px;
    }

    .form-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 32px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
    }

    .form-section {
        margin-bottom: 32px;
        padding-bottom: 32px;
        border-bottom: 1px solid var(--border);
    }

    .form-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-label .required {
        color: var(--error);
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(29, 191, 115, 0.1);
    }

    .form-textarea {
        min-height: 140px;
        resize: vertical;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-hint {
        color: var(--text-light);
        font-size: 12px;
        margin-top: 6px;
    }

    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .checkbox-item:hover {
        border-color: var(--primary);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .checkbox-item .checkbox-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
    }

    .checkbox-item .checkbox-desc {
        font-size: 12px;
        color: var(--text-light);
    }

    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        min-height: 50px;
        background: var(--bg-white);
    }

    .skill-tag {
        background: var(--primary);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }

    .skill-tag button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        opacity: 0.8;
    }

    .skill-tag button:hover {
        opacity: 1;
    }

    .skills-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
        padding: 4px;
        font-family: inherit;
    }

    .category-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .category-card {
        padding: 16px 12px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .category-card:hover {
        border-color: var(--primary);
    }

    .category-card.selected {
        border-color: var(--primary);
        background: rgba(29, 191, 115, 0.05);
    }

    .category-card input {
        display: none;
    }

    .category-icon {
        font-size: 28px;
        margin-bottom: 8px;
    }

    .category-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .alert {
        padding: 14px 18px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 14px;
    }

    .alert-error {
        background: #FEE2E2;
        color: #DC2626;
        border: 1px solid #FECACA;
    }

    .alert-success {
        background: #D1FAE5;
        color: #059669;
        border: 1px solid #A7F3D0;
    }

    .submit-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 32px;
    }

    .submit-info {
        font-size: 13px;
        color: var(--text-light);
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .category-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        .checkbox-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Post a New Gig</h1>
        <p class="page-subtitle">Cari freelancer yang sesuai untuk projek anda</p>
    </div>

    <div class="form-card">
        <div id="alertContainer"></div>

        <form id="postGigForm">
            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="file-text" width="18"></i>
                    Maklumat Gig
                </h3>

                <div class="form-group">
                    <label class="form-label">
                        Tajuk Gig <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="title" name="title" 
                           placeholder="e.g., Design logo untuk restoran halal saya" required>
                    <p class="form-hint">Tulis tajuk yang jelas dan menarik perhatian</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Penerangan <span class="required">*</span>
                    </label>
                    <textarea class="form-textarea" id="description" name="description" 
                              placeholder="Terangkan projek anda dengan terperinci. Masukkan keperluan, deliverables, dan arahan khusus." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Kategori <span class="required">*</span>
                    </label>
                    <div class="category-cards">
                        {% for cat in categories %}
                        <label class="category-card" onclick="selectCategory(this)">
                            <input type="radio" name="category" value="{{ cat.slug }}" required>
                            <div class="category-icon">
                                {% if cat.slug == 'design' %}üé®
                                {% elif cat.slug == 'writing' %}‚úçÔ∏è
                                {% elif cat.slug == 'video' %}üé¨
                                {% elif cat.slug == 'tutoring' %}üìö
                                {% elif cat.slug == 'content' %}üì±
                                {% elif cat.slug == 'web' %}üíª
                                {% elif cat.slug == 'marketing' %}üìà
                                {% elif cat.slug == 'admin' %}üìã
                                {% else %}üìã{% endif %}
                            </div>
                            <div class="category-name">{{ cat.name }}</div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="dollar-sign" width="18"></i>
                    Budget & Tempoh
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            Budget Minimum (RM) <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="budget_min" name="budget_min" 
                               placeholder="100" min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Budget Maksimum (RM) <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="budget_max" name="budget_max" 
                               placeholder="500" min="1" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tempoh</label>
                        <select class="form-select" id="duration" name="duration">
                            <option value="">Pilih tempoh</option>
                            <option value="1-3 days">1-3 hari</option>
                            <option value="1 week">1 minggu</option>
                            <option value="2 weeks">2 minggu</option>
                            <option value="1 month">1 bulan</option>
                            <option value="Ongoing">Berterusan</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tarikh Akhir</label>
                        <input type="date" class="form-input" id="deadline" name="deadline">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="map-pin" width="18"></i>
                    Lokasi & Kemahiran
                </h3>

                <div class="form-group">
                    <label class="form-label">Lokasi</label>
                    <select class="form-select" id="location" name="location">
                        <option value="">Semua lokasi</option>
                        <option value="Kuala Lumpur">Kuala Lumpur</option>
                        <option value="Selangor">Selangor</option>
                        <option value="Penang">Penang</option>
                        <option value="Johor Bahru">Johor Bahru</option>
                        <option value="Remote">Remote</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Kemahiran Diperlukan</label>
                    <div class="skills-container" id="skillsContainer">
                        <input type="text" class="skills-input" id="skillInput" 
                               placeholder="Taip kemahiran dan tekan Enter">
                    </div>
                    <p class="form-hint">Tekan Enter untuk menambah setiap kemahiran</p>
                    <input type="hidden" id="skillsHidden" name="skills_required">
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-section-title">
                    <i data-feather="settings" width="18"></i>
                    Pilihan Tambahan
                </h3>

                <div class="checkbox-grid">
                    <label class="checkbox-item">
                        <input type="checkbox" id="is_remote" name="is_remote" checked>
                        <div>
                            <div class="checkbox-label">üè† Kerja Remote</div>
                            <div class="checkbox-desc">Freelancer boleh bekerja dari mana-mana</div>
                        </div>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="halal_compliant" name="halal_compliant" checked>
                        <div>
                            <div class="checkbox-label">‚ò™Ô∏è Halal Compliant</div>
                            <div class="checkbox-desc">Projek patuh syariah</div>
                        </div>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="is_instant_payout" name="is_instant_payout">
                        <div>
                            <div class="checkbox-label">‚ö° Instant Payout</div>
                            <div class="checkbox-desc">Bayaran dalam 24 jam</div>
                        </div>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" id="is_brand_partnership" name="is_brand_partnership">
                        <div>
                            <div class="checkbox-label">üåü Brand Partnership</div>
                            <div class="checkbox-desc">Kolaborasi dengan jenama</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="submit-section">
                <div class="submit-info">
                    ‚úì Tiada bayaran untuk post gig
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i data-feather="send" width="16"></i>
                    Post Gig
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const skills = [];

    function selectCategory(element) {
        document.querySelectorAll('.category-card').forEach(card => {
            card.classList.remove('selected');
        });
        element.classList.add('selected');
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        const input = document.getElementById('skillInput');
        
        const tags = container.querySelectorAll('.skill-tag');
        tags.forEach(tag => tag.remove());
        
        skills.forEach((skill, index) => {
            const tag = document.createElement('span');
            tag.className = 'skill-tag';
            tag.innerHTML = `${skill} <button type="button" onclick="removeSkill(${index})">&times;</button>`;
            container.insertBefore(tag, input);
        });
        
        document.getElementById('skillsHidden').value = JSON.stringify(skills);
    }

    function removeSkill(index) {
        skills.splice(index, 1);
        updateSkillsDisplay();
    }

    document.getElementById('skillInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value && !skills.includes(value) && skills.length < 20) {
                skills.push(value);
                updateSkillsDisplay();
                this.value = '';
            }
        }
    });

    function showAlert(message, type) {
        const container = document.getElementById('alertContainer');
        container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        container.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('postGigForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i data-feather="loader" width="16"></i> Memproses...';
        feather.replace();

        const budgetMin = parseFloat(document.getElementById('budget_min').value);
        const budgetMax = parseFloat(document.getElementById('budget_max').value);
        const category = document.querySelector('input[name="category"]:checked')?.value;

        if (!category) {
            showAlert('Sila pilih kategori', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-feather="send" width="16"></i> Post Gig';
            feather.replace();
            return;
        }

        if (budgetMin > budgetMax) {
            showAlert('Budget maksimum mesti lebih besar daripada budget minimum', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-feather="send" width="16"></i> Post Gig';
            feather.replace();
            return;
        }

        const data = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            category: category,
            duration: document.getElementById('duration').value,
            budget_min: budgetMin,
            budget_max: budgetMax,
            location: document.getElementById('location').value,
            is_remote: document.getElementById('is_remote').checked,
            halal_compliant: document.getElementById('halal_compliant').checked,
            is_instant_payout: document.getElementById('is_instant_payout').checked,
            is_brand_partnership: document.getElementById('is_brand_partnership').checked,
            skills_required: skills,
            deadline: document.getElementById('deadline').value || null
        };

        try {
            const response = await fetch('/api/gigs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert('Gig berjaya dipost! Mengarahkan ke dashboard...', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                showAlert(result.error || 'Gagal post gig. Sila cuba lagi.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-feather="send" width="16"></i> Post Gig';
                feather.replace();
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Ralat berlaku. Sila cuba lagi.', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-feather="send" width="16"></i> Post Gig';
            feather.replace();
        }
    });
</script>
{% endblock %}