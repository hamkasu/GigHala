{% extends "base.html" %}

{% block title %}Wallet & Billing{% endblock %}

{% block extra_styles %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .wallet-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 28px;
    }

    .wallet-card {
        padding: 24px;
        border-radius: var(--radius-lg);
        color: white;
    }

    .wallet-card.primary {
        background: linear-gradient(135deg, var(--primary) 0%, #00a844 100%);
    }

    .wallet-card.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .wallet-card.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .wallet-card.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .wallet-card-label {
        font-size: 13px;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .wallet-card-amount {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .wallet-card-currency {
        font-size: 12px;
        opacity: 0.8;
    }

    .main-content-area {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .tabs {
        display: flex;
        background: var(--bg-light);
        border-bottom: 1px solid var(--border);
    }

    .tab {
        padding: 16px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab:hover {
        color: var(--primary);
    }

    .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: var(--bg-white);
    }

    .tab-content {
        display: none;
        padding: 24px;
    }

    .tab-content.active {
        display: block;
    }

    .filters {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-group label {
        font-size: 13px;
        color: var(--text-gray);
        font-weight: 600;
    }

    .filter-group select,
    .filter-group input {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 150px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--bg-light);
    }

    th {
        padding: 12px 14px;
        text-align: left;
        font-weight: 600;
        color: var(--text-dark);
        border-bottom: 1px solid var(--border);
        font-size: 13px;
    }

    td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    tr:hover {
        background: var(--bg-light);
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }

    .badge.pending { background: #fef3c7; color: #92400e; }
    .badge.processing { background: #dbeafe; color: #1e40af; }
    .badge.completed { background: #d1fae5; color: #065f46; }
    .badge.paid { background: #d1fae5; color: #065f46; }
    .badge.failed { background: #fee2e2; color: #991b1b; }
    .badge.cancelled { background: #e5e7eb; color: #1f2937; }
    .badge.sent { background: #fecaca; color: #991b1b; }
    .badge.received { background: #bbf7d0; color: #166534; }

    .loading {
        text-align: center;
        padding: 50px;
        color: var(--text-gray);
    }

    .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 50px;
        color: var(--text-gray);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
    }

    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--border);
        background: var(--bg-white);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-white);
        padding: 32px;
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .modal-header h2 {
        color: var(--text-dark);
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        padding: 0;
    }

    .modal-close:hover {
        color: var(--text-dark);
    }

    .form-group {
        margin-bottom: 18px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 14px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-group .help-text {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 4px;
    }

    .alert {
        padding: 14px 18px;
        border-radius: var(--radius-md);
        margin-bottom: 18px;
        font-size: 14px;
    }

    .alert.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .payout-summary {
        background: var(--bg-light);
        padding: 18px;
        border-radius: var(--radius-md);
        margin-bottom: 18px;
    }

    .payout-summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    .payout-summary-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 16px;
        padding-top: 12px;
    }

    @media (max-width: 768px) {
        .wallet-cards {
            grid-template-columns: 1fr;
        }
        .tabs {
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Wallet & Billing</h1>
    <button class="btn btn-primary" onclick="openPayoutModal()">üí∞ Request Payout</button>
</div>

<div class="wallet-cards" id="walletCards">
    <div class="wallet-card primary">
        <div class="wallet-card-label">Available Balance</div>
        <div class="wallet-card-amount" id="availableBalance">MYR 0.00</div>
        <div class="wallet-card-currency">Malaysian Ringgit</div>
    </div>
    <div class="wallet-card success">
        <div class="wallet-card-label">Total Earned</div>
        <div class="wallet-card-amount" id="totalEarned">MYR 0.00</div>
        <div class="wallet-card-currency">All-time earnings</div>
    </div>
    <div class="wallet-card warning">
        <div class="wallet-card-label">Held Balance</div>
        <div class="wallet-card-amount" id="heldBalance">MYR 0.00</div>
        <div class="wallet-card-currency">Pending payouts</div>
    </div>
    <div class="wallet-card info" id="socsoCard" style="display: none; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
        <div class="wallet-card-label">SOCSO Contributions</div>
        <div class="wallet-card-amount" id="totalSocso">MYR 0.00</div>
        <div class="wallet-card-currency">Mandatory 1.25% deductions</div>
    </div>
    <div class="wallet-card info">
        <div class="wallet-card-label">Total Spent</div>
        <div class="wallet-card-amount" id="totalSpent">MYR 0.00</div>
        <div class="wallet-card-currency">All payments made</div>
    </div>
</div>

<div class="main-content-area">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('transactions')">Transactions</button>
        <button class="tab" onclick="switchTab('invoices')">Invoices</button>
        <button class="tab" onclick="switchTab('payouts')">Payouts</button>
        <button class="tab" id="socsoTab" onclick="switchTab('socso')" style="display: none;">SOCSO Contributions</button>
    </div>

    <div id="transactions-tab" class="tab-content active">
        <div class="filters">
            <div class="filter-group">
                <label>Transaction Type</label>
                <select id="transactionType" onchange="loadTransactions()">
                    <option value="all">All Transactions</option>
                    <option value="sent">Sent (Payments Made)</option>
                    <option value="received">Received (Earnings)</option>
                </select>
            </div>
        </div>

        <div id="transactionsLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading transactions...</p>
        </div>

        <div id="transactionsContent" style="display: none;">
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody"></tbody>
            </table>
            <div id="transactionsPagination" class="pagination"></div>
        </div>

        <div id="transactionsEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h3>No Transactions Yet</h3>
            <p>Your transaction history will appear here</p>
        </div>
    </div>

    <div id="invoices-tab" class="tab-content">
        <div class="filters">
            <div class="filter-group">
                <label>Status</label>
                <select id="invoiceStatus" onchange="loadInvoices()">
                    <option value="all">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="issued">Issued</option>
                    <option value="paid">Paid</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>

        <div id="invoicesLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading invoices...</p>
        </div>

        <div id="invoicesContent" style="display: none;">
            <table id="invoicesTable">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Gig</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="invoicesBody"></tbody>
            </table>
            <div id="invoicesPagination" class="pagination"></div>
        </div>

        <div id="invoicesEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üìÑ</div>
            <h3>No Invoices Yet</h3>
            <p>Your invoices will appear here</p>
        </div>
    </div>

    <div id="payouts-tab" class="tab-content">
        <div id="payoutsLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading payouts...</p>
        </div>

        <div id="payoutsContent" style="display: none;">
            <table id="payoutsTable">
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Requested</th>
                    </tr>
                </thead>
                <tbody id="payoutsBody"></tbody>
            </table>
            <div id="payoutsPagination" class="pagination"></div>
        </div>

        <div id="payoutsEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üí∏</div>
            <h3>No Payout Requests</h3>
            <p>Request a payout to withdraw your earnings</p>
            <button class="btn btn-primary" onclick="openPayoutModal()" style="margin-top: 16px;">üí∞ Request Payout</button>
        </div>
    </div>

    <div id="socso-tab" class="tab-content">
        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px;">SOCSO Compliance - Gig Workers Bill 2025</h3>
            <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                As a registered gig worker, 1.25% of your net earnings (after platform fees) is automatically deducted
                and contributed to SOCSO for your social security protection. These contributions provide you with
                employment injury, invalidity, and other benefits under the Self-Employment Social Security Scheme (SESKSO).
            </p>
        </div>

        <div id="socsoLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading SOCSO contributions...</p>
        </div>

        <div id="socsoContent" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 6px;">Total Contributions</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="socsoTotalAmount">MYR 0.00</div>
                </div>
                <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 6px;">Total Net Earnings</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--text);" id="socsoTotalEarnings">MYR 0.00</div>
                </div>
                <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 6px;">Total Transactions</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--text);" id="socsoTotalCount">0</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 14px; color: var(--text-dark);">Monthly Breakdown</h3>
                <div id="monthlyBreakdownContainer" style="margin-bottom: 20px;"></div>
                <div id="monthlyEmpty" style="display: none; text-align: center; padding: 20px; color: var(--text-gray);">
                    No monthly data available yet
                </div>
            </div>

            <div style="margin-bottom: 20px; text-align: right;">
                <a href="/billing/socso-statement" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    {{ t('print_statement') }}
                </a>
            </div>

            <table id="socsoTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Gross Amount</th>
                        <th>Platform Fee</th>
                        <th>Net Earnings</th>
                        <th>SOCSO (1.25%)</th>
                        <th>Final Payout</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="socsoBody"></tbody>
            </table>
            <div id="socsoPagination" class="pagination"></div>
        </div>

        <div id="socsoEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üè•</div>
            <h3>No SOCSO Contributions Yet</h3>
            <p>Your SOCSO contribution history will appear here as you complete gigs and receive payouts.</p>
        </div>
    </div>
</div>

<div id="payoutModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∞ Request Payout</h2>
            <button class="modal-close" onclick="closePayoutModal()">&times;</button>
        </div>
        <div id="payoutAlert"></div>
        <form id="payoutForm" onsubmit="submitPayout(event)">
            <div class="form-group">
                <label>Amount (MYR)</label>
                <input type="number" id="payoutAmount" min="10" step="0.01" required placeholder="Enter amount">
                <div class="help-text">Minimum payout: MYR 10.00</div>
            </div>
            <div class="form-group">
                <label>Payout Method</label>
                <select id="payoutMethod" required>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="fpx">FPX</option>
                    <option value="ewallet">E-Wallet</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <select id="bankName" class="form-input" required>
                    <option value="">Pilih bank / Select bank</option>
                    <option value="Affin Bank">Affin Bank</option>
                    <option value="Agrobank">Agrobank</option>
                    <option value="Alliance Bank">Alliance Bank</option>
                    <option value="AmBank">AmBank</option>
                    <option value="Bank Islam">Bank Islam</option>
                    <option value="Bank Muamalat">Bank Muamalat</option>
                    <option value="Bank Rakyat">Bank Rakyat</option>
                    <option value="Bank Simpanan Nasional (BSN)">Bank Simpanan Nasional (BSN)</option>
                    <option value="CIMB Bank">CIMB Bank</option>
                    <option value="Hong Leong Bank">Hong Leong Bank</option>
                    <option value="HSBC">HSBC</option>
                    <option value="MBSB Bank">MBSB Bank</option>
                    <option value="Maybank">Maybank</option>
                    <option value="OCBC Bank">OCBC Bank</option>
                    <option value="Public Bank">Public Bank</option>
                    <option value="RHB Bank">RHB Bank</option>
                    <option value="Standard Chartered">Standard Chartered</option>
                    <option value="UOB Malaysia">UOB Malaysia</option>
                </select>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="text" id="accountNumber" placeholder="Your account number" required>
            </div>
            <div class="form-group">
                <label>Account Name</label>
                <input type="text" id="accountName" placeholder="Name on the account" required>
            </div>
            <div class="payout-summary">
                <div class="payout-summary-row">
                    <span>Payout Amount</span>
                    <span id="summaryAmount">MYR 0.00</span>
                </div>
                <div class="payout-summary-row">
                    <span>Processing Fee (2%)</span>
                    <span id="summaryFee">MYR 0.00</span>
                </div>
                <div class="payout-summary-row">
                    <span>You Will Receive</span>
                    <span id="summaryTotal">MYR 0.00</span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Payout Request</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let walletData = null;

    async function loadWalletData() {
        try {
            const response = await fetch('/api/billing/wallet');
            if (response.ok) {
                walletData = await response.json();
                document.getElementById('availableBalance').textContent = `MYR ${walletData.balance.toFixed(2)}`;
                document.getElementById('totalEarned').textContent = `MYR ${walletData.total_earned.toFixed(2)}`;
                document.getElementById('heldBalance').textContent = `MYR ${(walletData.held_balance || 0).toFixed(2)}`;
                document.getElementById('totalSpent').textContent = `MYR ${(walletData.total_spent || 0).toFixed(2)}`;

                // Load and display SOCSO data for freelancers
                if (walletData.user_type === 'freelancer' || walletData.user_type === 'both') {
                    // Always show SOCSO card and tab for freelancers (transparency & compliance)
                    document.getElementById('socsoCard').style.display = 'block';
                    document.getElementById('socsoTab').style.display = 'block';

                    try {
                        const socsoResponse = await fetch('/api/billing/socso-contributions');
                        if (socsoResponse.ok) {
                            const socsoData = await socsoResponse.json();
                            const totalSocso = socsoData.totals?.total_socso || 0;
                            document.getElementById('totalSocso').textContent = `MYR ${totalSocso.toFixed(2)}`;
                        } else {
                            // Show MYR 0.00 if API fails or no data
                            document.getElementById('totalSocso').textContent = 'MYR 0.00';
                        }
                    } catch (error) {
                        console.error('Error loading SOCSO data:', error);
                        // Still show MYR 0.00 even on error
                        document.getElementById('totalSocso').textContent = 'MYR 0.00';
                    }
                }
            }
        } catch (error) {
            console.error('Error loading wallet:', error);
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'transactions') loadTransactions();
        else if (tabName === 'invoices') loadInvoices();
        else if (tabName === 'payouts') loadPayouts();
        else if (tabName === 'socso') loadSocso();
    }

    async function loadTransactions() {
        const loading = document.getElementById('transactionsLoading');
        const content = document.getElementById('transactionsContent');
        const empty = document.getElementById('transactionsEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const type = document.getElementById('transactionType').value;
            const url = `/api/billing/transactions?type=${type}`;
            console.log('Fetching transactions from:', url);
            const response = await fetch(url);
            console.log('Transaction response status:', response.status);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                console.error('Transaction API error:', response.status, error);
                loading.style.display = 'none';
                empty.querySelector('h3').textContent = 'Error Loading Transactions';
                empty.querySelector('p').textContent = `Error ${response.status}: ${error.error || 'Failed to load transactions'}`;
                empty.style.display = 'block';
                return;
            }

            const data = await response.json();
            console.log('Transaction data received:', data);
            console.log('Is array:', Array.isArray(data), 'Length:', data.length);
            loading.style.display = 'none';

            if (!Array.isArray(data) || data.length === 0) {
                empty.querySelector('h3').textContent = 'No Transactions Yet';
                empty.querySelector('p').textContent = 'Your transaction history will appear here';
                empty.style.display = 'block';
            } else {
                content.style.display = 'block';
                const tbody = document.getElementById('transactionsBody');
                tbody.innerHTML = data.map(txn => `
                    <tr>
                        <td>${new Date(txn.transaction_date || txn.date).toLocaleDateString()}</td>
                        <td>${txn.gig_title ? txn.gig_title : 'Payment for Gig #' + (txn.gig_id || 'N/A')}</td>
                        <td>MYR ${txn.amount.toFixed(2)}</td>
                        <td><span class="badge ${txn.type || (txn.client_id === walletData?.user_id ? 'sent' : 'received')}">${txn.type === 'sent' || txn.client_id === walletData?.user_id ? 'Sent' : 'Received'}</span></td>
                        <td><span class="badge ${txn.status}">${txn.status}</span></td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading transactions:', error);
            loading.style.display = 'none';
            empty.querySelector('h3').textContent = 'Error Loading Transactions';
            empty.querySelector('p').textContent = error.message || 'An unexpected error occurred';
            empty.style.display = 'block';
        }
    }

    async function loadInvoices() {
        const loading = document.getElementById('invoicesLoading');
        const content = document.getElementById('invoicesContent');
        const empty = document.getElementById('invoicesEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const status = document.getElementById('invoiceStatus').value;
            const url = `/api/billing/invoices?status=${status}`;
            console.log('Fetching invoices from:', url);
            const response = await fetch(url);
            console.log('Invoice response status:', response.status);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                console.error('Invoice API error:', response.status, error);
                loading.style.display = 'none';
                empty.querySelector('h3').textContent = 'Error Loading Invoices';
                empty.querySelector('p').textContent = `Error ${response.status}: ${error.error || 'Failed to load invoices'}`;
                empty.style.display = 'block';
                return;
            }

            const data = await response.json();
            console.log('Invoice data received:', data);
            console.log('Is array:', Array.isArray(data), 'Length:', data.length);
            loading.style.display = 'none';

            if (!Array.isArray(data) || data.length === 0) {
                empty.querySelector('h3').textContent = 'No Invoices Yet';
                empty.querySelector('p').textContent = 'Your invoices will appear here';
                empty.style.display = 'block';
            } else {
                content.style.display = 'block';
                const tbody = document.getElementById('invoicesBody');
                tbody.innerHTML = data.map(inv => `
                    <tr>
                        <td>#${inv.invoice_number}</td>
                        <td>${inv.gig_title || 'Gig #' + inv.gig_id}</td>
                        <td>MYR ${inv.total_amount.toFixed(2)}</td>
                        <td><span class="badge ${inv.status}">${inv.status}</span></td>
                        <td>${new Date(inv.issue_date || inv.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading invoices:', error);
            loading.style.display = 'none';
            empty.querySelector('h3').textContent = 'Error Loading Invoices';
            empty.querySelector('p').textContent = error.message || 'An unexpected error occurred';
            empty.style.display = 'block';
        }
    }

    async function loadPayouts() {
        const loading = document.getElementById('payoutsLoading');
        const content = document.getElementById('payoutsContent');
        const empty = document.getElementById('payoutsEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const url = '/api/billing/payouts';
            console.log('Fetching payouts from:', url);
            const response = await fetch(url);
            console.log('Payout response status:', response.status);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                console.error('Payout API error:', response.status, error);
                loading.style.display = 'none';
                empty.querySelector('h3').textContent = 'Error Loading Payouts';
                empty.querySelector('p').textContent = `Error ${response.status}: ${error.error || 'Failed to load payouts'}`;
                empty.style.display = 'block';
                return;
            }

            const data = await response.json();
            console.log('Payout data received:', data);
            console.log('Is array:', Array.isArray(data), 'Length:', data.length);
            loading.style.display = 'none';

            if (!Array.isArray(data) || data.length === 0) {
                empty.querySelector('h3').textContent = 'No Payout Requests';
                empty.querySelector('p').textContent = 'Request a payout to withdraw your earnings';
                empty.style.display = 'block';
            } else {
                content.style.display = 'block';
                const tbody = document.getElementById('payoutsBody');
                tbody.innerHTML = data.map(p => `
                    <tr>
                        <td>#${p.payout_number || p.id}</td>
                        <td>MYR ${p.amount.toFixed(2)}</td>
                        <td>${p.payout_method || p.payment_method || 'N/A'}</td>
                        <td><span class="badge ${p.status}">${p.status.toUpperCase()}</span></td>
                        <td>${new Date(p.requested_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading payouts:', error);
            loading.style.display = 'none';
            empty.querySelector('h3').textContent = 'Error Loading Payouts';
            empty.querySelector('p').textContent = error.message || 'An unexpected error occurred';
            empty.style.display = 'block';
        }
    }

    async function loadSocso() {
        const loading = document.getElementById('socsoLoading');
        const content = document.getElementById('socsoContent');
        const empty = document.getElementById('socsoEmpty');
        const monthlyContainer = document.getElementById('monthlyBreakdownContainer');
        const monthlyEmpty = document.getElementById('monthlyEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            // Load monthly breakdown
            const monthlyResponse = await fetch('/api/billing/socso-monthly-breakdown');
            if (monthlyResponse.ok) {
                const monthlyData = await monthlyResponse.json();
                if (monthlyData.monthly_breakdown && monthlyData.monthly_breakdown.length > 0) {
                    const html = monthlyData.monthly_breakdown.map(m => `
                        <div style="background: var(--bg-light); padding: 14px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">Month</div>
                                    <div style="font-size: 15px; font-weight: 600;">${m.month}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">Transactions</div>
                                    <div style="font-size: 15px; font-weight: 600;">${m.transaction_count}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">Net Earnings</div>
                                    <div style="font-size: 15px; font-weight: 600;">MYR ${m.total_net.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">SOCSO (1.25%)</div>
                                    <div style="font-size: 15px; font-weight: 600; color: var(--primary);">MYR ${m.total_socso.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 4px;">Final Payout</div>
                                    <div style="font-size: 15px; font-weight: 600;">MYR ${m.total_payout.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    monthlyContainer.innerHTML = html;
                    monthlyEmpty.style.display = 'none';
                } else {
                    monthlyEmpty.style.display = 'block';
                    monthlyContainer.innerHTML = '';
                }
            }

            const url = '/api/billing/socso-contributions';
            console.log('Fetching SOCSO contributions from:', url);
            const response = await fetch(url);
            console.log('SOCSO response status:', response.status);

            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                console.error('SOCSO API error:', response.status, error);
                loading.style.display = 'none';
                empty.querySelector('h3').textContent = 'Error Loading SOCSO Contributions';
                empty.querySelector('p').textContent = `Error ${response.status}: ${error.error || 'Failed to load SOCSO contributions'}`;
                empty.style.display = 'block';
                return;
            }

            const data = await response.json();
            console.log('SOCSO data received:', data);
            loading.style.display = 'none';

            // Always show content for transparency (even with zero contributions)
            content.style.display = 'block';

            // Update summary stats
            document.getElementById('socsoTotalAmount').textContent = `MYR ${(data.totals?.total_socso || 0).toFixed(2)}`;
            document.getElementById('socsoTotalEarnings').textContent = `MYR ${(data.totals?.total_net_earnings || 0).toFixed(2)}`;
            document.getElementById('socsoTotalCount').textContent = data.totals?.transaction_count || 0;

            // Populate table
            const tbody = document.getElementById('socsoBody');
            if (!data.contributions || data.contributions.length === 0) {
                // Show informative message in table when no contributions yet
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-gray);">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No SOCSO Contributions Yet</div>
                            <div style="font-size: 14px;">Your SOCSO contribution history will appear here as you complete gigs and receive payouts.</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = data.contributions.map(c => `
                    <tr>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td><span class="badge">${c.contribution_type}</span></td>
                        <td>MYR ${c.gross_amount.toFixed(2)}</td>
                        <td>MYR ${c.platform_commission.toFixed(2)}</td>
                        <td>MYR ${c.net_earnings.toFixed(2)}</td>
                        <td style="color: var(--primary); font-weight: 600;">MYR ${c.socso_amount.toFixed(2)}</td>
                        <td style="font-weight: 600;">MYR ${c.final_payout.toFixed(2)}</td>
                        <td><span class="badge ${c.remitted_to_socso ? 'success' : 'warning'}">${c.remitted_to_socso ? 'Remitted' : 'Pending'}</span></td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading SOCSO contributions:', error);
            loading.style.display = 'none';

            // Still show content with zero values on error (transparency)
            content.style.display = 'block';
            document.getElementById('socsoTotalAmount').textContent = 'MYR 0.00';
            document.getElementById('socsoTotalEarnings').textContent = 'MYR 0.00';
            document.getElementById('socsoTotalCount').textContent = '0';

            const tbody = document.getElementById('socsoBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--error);">Error Loading SOCSO Contributions</div>
                        <div style="font-size: 14px;">${error.message || 'An unexpected error occurred. Please try again later.'}</div>
                    </td>
                </tr>
            `;
        }
    }

    function openPayoutModal() {
        document.getElementById('payoutModal').classList.add('active');
    }

    function closePayoutModal() {
        document.getElementById('payoutModal').classList.remove('active');
    }

    document.getElementById('payoutAmount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const fee = amount * 0.02;
        const total = amount - fee;
        document.getElementById('summaryAmount').textContent = `MYR ${amount.toFixed(2)}`;
        document.getElementById('summaryFee').textContent = `MYR ${fee.toFixed(2)}`;
        document.getElementById('summaryTotal').textContent = `MYR ${total.toFixed(2)}`;
    });

    async function submitPayout(e) {
        e.preventDefault();
        const alertDiv = document.getElementById('payoutAlert');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-sm"></span> Processing...';
        }

        const data = {
            amount: parseFloat(document.getElementById('payoutAmount').value),
            payment_method: document.getElementById('payoutMethod').value,
            bank_name: document.getElementById('bankName').value,
            account_number: document.getElementById('accountNumber').value,
            account_name: document.getElementById('accountName').value
        };

        try {
            const response = await fetch('/api/billing/payouts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alertDiv.innerHTML = '<div class="alert success">Payout request submitted successfully!</div>';
                setTimeout(() => {
                    closePayoutModal();
                    loadPayouts();
                    loadWalletData();
                    // Clear form
                    document.getElementById('payoutForm').reset();
                    document.getElementById('payoutAlert').innerHTML = '';
                }, 2000);
            } else {
                // Handle SOCSO compliance errors specially
                if (result.socso_required) {
                    let message = '<div class="alert error">';
                    message += '<strong>SOCSO Compliance Required</strong><br>';
                    message += (result.reason || 'Please complete your SOCSO profile setup');
                    message += '<br><br><a href="/settings" style="color: inherit; text-decoration: underline; font-weight: 600;">Go to Settings ‚Üí</a>';
                    message += '</div>';
                    alertDiv.innerHTML = message;
                } else {
                    alertDiv.innerHTML = `<div class="alert error">${result.error || 'Failed to submit payout'}</div>`;
                }
            }
        } catch (error) {
            alertDiv.innerHTML = '<div class="alert error">An error occurred. Please try again.</div>';
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Payout Request';
            }
        }
    }

    loadWalletData();
    loadTransactions();
</script>
{% endblock %}