{% extends "base.html" %}

{% block title %}Wallet & Billing{% endblock %}

{% block extra_styles %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .page-title {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .wallet-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 28px;
    }

    .wallet-card {
        padding: 24px;
        border-radius: var(--radius-lg);
        color: white;
    }

    .wallet-card.primary {
        background: linear-gradient(135deg, var(--primary) 0%, #00a844 100%);
    }

    .wallet-card.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .wallet-card.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .wallet-card.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .wallet-card-label {
        font-size: 13px;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .wallet-card-amount {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .wallet-card-currency {
        font-size: 12px;
        opacity: 0.8;
    }

    .main-content-area {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .tabs {
        display: flex;
        background: var(--bg-light);
        border-bottom: 1px solid var(--border);
    }

    .tab {
        padding: 16px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-gray);
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab:hover {
        color: var(--primary);
    }

    .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: var(--bg-white);
    }

    .tab-content {
        display: none;
        padding: 24px;
    }

    .tab-content.active {
        display: block;
    }

    .filters {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-group label {
        font-size: 13px;
        color: var(--text-gray);
        font-weight: 600;
    }

    .filter-group select,
    .filter-group input {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 150px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--bg-light);
    }

    th {
        padding: 12px 14px;
        text-align: left;
        font-weight: 600;
        color: var(--text-dark);
        border-bottom: 1px solid var(--border);
        font-size: 13px;
    }

    td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    tr:hover {
        background: var(--bg-light);
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }

    .badge.pending { background: #fef3c7; color: #92400e; }
    .badge.processing { background: #dbeafe; color: #1e40af; }
    .badge.completed { background: #d1fae5; color: #065f46; }
    .badge.paid { background: #d1fae5; color: #065f46; }
    .badge.failed { background: #fee2e2; color: #991b1b; }
    .badge.cancelled { background: #e5e7eb; color: #1f2937; }
    .badge.sent { background: #fecaca; color: #991b1b; }
    .badge.received { background: #bbf7d0; color: #166534; }

    .loading {
        text-align: center;
        padding: 50px;
        color: var(--text-gray);
    }

    .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 50px;
        color: var(--text-gray);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border);
    }

    .pagination button {
        padding: 8px 14px;
        border: 1px solid var(--border);
        background: var(--bg-white);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .pagination button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-white);
        padding: 32px;
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .modal-header h2 {
        color: var(--text-dark);
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
        padding: 0;
    }

    .modal-close:hover {
        color: var(--text-dark);
    }

    .form-group {
        margin-bottom: 18px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 14px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-group .help-text {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 4px;
    }

    .alert {
        padding: 14px 18px;
        border-radius: var(--radius-md);
        margin-bottom: 18px;
        font-size: 14px;
    }

    .alert.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .payout-summary {
        background: var(--bg-light);
        padding: 18px;
        border-radius: var(--radius-md);
        margin-bottom: 18px;
    }

    .payout-summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }

    .payout-summary-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 16px;
        padding-top: 12px;
    }

    @media (max-width: 768px) {
        .wallet-cards {
            grid-template-columns: 1fr;
        }
        .tabs {
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Wallet & Billing</h1>
    <button class="btn btn-primary" onclick="openPayoutModal()">Request Payout</button>
</div>

<div class="wallet-cards" id="walletCards">
    <div class="wallet-card primary">
        <div class="wallet-card-label">Available Balance</div>
        <div class="wallet-card-amount" id="availableBalance">MYR 0.00</div>
        <div class="wallet-card-currency">Malaysian Ringgit</div>
    </div>
    <div class="wallet-card success">
        <div class="wallet-card-label">Total Earned</div>
        <div class="wallet-card-amount" id="totalEarned">MYR 0.00</div>
        <div class="wallet-card-currency">All-time earnings</div>
    </div>
    <div class="wallet-card warning">
        <div class="wallet-card-label">Held Balance</div>
        <div class="wallet-card-amount" id="heldBalance">MYR 0.00</div>
        <div class="wallet-card-currency">Pending payouts</div>
    </div>
    <div class="wallet-card info">
        <div class="wallet-card-label">Total Spent</div>
        <div class="wallet-card-amount" id="totalSpent">MYR 0.00</div>
        <div class="wallet-card-currency">All payments made</div>
    </div>
</div>

<div class="main-content-area">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('transactions')">Transactions</button>
        <button class="tab" onclick="switchTab('invoices')">Invoices</button>
        <button class="tab" onclick="switchTab('payouts')">Payouts</button>
    </div>

    <div id="transactions-tab" class="tab-content active">
        <div class="filters">
            <div class="filter-group">
                <label>Transaction Type</label>
                <select id="transactionType" onchange="loadTransactions()">
                    <option value="all">All Transactions</option>
                    <option value="sent">Sent (Payments Made)</option>
                    <option value="received">Received (Earnings)</option>
                </select>
            </div>
        </div>

        <div id="transactionsLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading transactions...</p>
        </div>

        <div id="transactionsContent" style="display: none;">
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="transactionsBody"></tbody>
            </table>
            <div id="transactionsPagination" class="pagination"></div>
        </div>

        <div id="transactionsEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ðŸ“­</div>
            <h3>No Transactions Yet</h3>
            <p>Your transaction history will appear here</p>
        </div>
    </div>

    <div id="invoices-tab" class="tab-content">
        <div class="filters">
            <div class="filter-group">
                <label>Status</label>
                <select id="invoiceStatus" onchange="loadInvoices()">
                    <option value="all">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="issued">Issued</option>
                    <option value="paid">Paid</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>

        <div id="invoicesLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading invoices...</p>
        </div>

        <div id="invoicesContent" style="display: none;">
            <table id="invoicesTable">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Gig</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="invoicesBody"></tbody>
            </table>
            <div id="invoicesPagination" class="pagination"></div>
        </div>

        <div id="invoicesEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ðŸ“„</div>
            <h3>No Invoices Yet</h3>
            <p>Your invoices will appear here</p>
        </div>
    </div>

    <div id="payouts-tab" class="tab-content">
        <div id="payoutsLoading" class="loading">
            <div class="spinner"></div>
            <p>Loading payouts...</p>
        </div>

        <div id="payoutsContent" style="display: none;">
            <table id="payoutsTable">
                <thead>
                    <tr>
                        <th>Payout #</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Requested</th>
                    </tr>
                </thead>
                <tbody id="payoutsBody"></tbody>
            </table>
            <div id="payoutsPagination" class="pagination"></div>
        </div>

        <div id="payoutsEmpty" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ðŸ’¸</div>
            <h3>No Payout Requests</h3>
            <p>Request a payout to withdraw your earnings</p>
            <button class="btn btn-primary" onclick="openPayoutModal()" style="margin-top: 16px;">Request Payout</button>
        </div>
    </div>
</div>

<div id="payoutModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Request Payout</h2>
            <button class="modal-close" onclick="closePayoutModal()">&times;</button>
        </div>
        <div id="payoutAlert"></div>
        <form id="payoutForm" onsubmit="submitPayout(event)">
            <div class="form-group">
                <label>Amount (MYR)</label>
                <input type="number" id="payoutAmount" min="10" step="0.01" required placeholder="Enter amount">
                <div class="help-text">Minimum payout: MYR 10.00</div>
            </div>
            <div class="form-group">
                <label>Payout Method</label>
                <select id="payoutMethod" required>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="fpx">FPX</option>
                    <option value="ewallet">E-Wallet</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <select id="bankName" class="form-input" required>
                    <option value="">Pilih bank / Select bank</option>
                    <option value="Affin Bank">Affin Bank</option>
                    <option value="Agrobank">Agrobank</option>
                    <option value="Alliance Bank">Alliance Bank</option>
                    <option value="AmBank">AmBank</option>
                    <option value="Bank Islam">Bank Islam</option>
                    <option value="Bank Muamalat">Bank Muamalat</option>
                    <option value="Bank Rakyat">Bank Rakyat</option>
                    <option value="Bank Simpanan Nasional (BSN)">Bank Simpanan Nasional (BSN)</option>
                    <option value="CIMB Bank">CIMB Bank</option>
                    <option value="Hong Leong Bank">Hong Leong Bank</option>
                    <option value="HSBC">HSBC</option>
                    <option value="MBSB Bank">MBSB Bank</option>
                    <option value="Maybank">Maybank</option>
                    <option value="OCBC Bank">OCBC Bank</option>
                    <option value="Public Bank">Public Bank</option>
                    <option value="RHB Bank">RHB Bank</option>
                    <option value="Standard Chartered">Standard Chartered</option>
                    <option value="UOB Malaysia">UOB Malaysia</option>
                </select>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="text" id="accountNumber" placeholder="Your account number">
            </div>
            <div class="payout-summary">
                <div class="payout-summary-row">
                    <span>Payout Amount</span>
                    <span id="summaryAmount">MYR 0.00</span>
                </div>
                <div class="payout-summary-row">
                    <span>Processing Fee (2%)</span>
                    <span id="summaryFee">MYR 0.00</span>
                </div>
                <div class="payout-summary-row">
                    <span>You Will Receive</span>
                    <span id="summaryTotal">MYR 0.00</span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Payout Request</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let walletData = null;

    async function loadWalletData() {
        try {
            const response = await fetch('/api/billing/wallet');
            if (response.ok) {
                walletData = await response.json();
                document.getElementById('availableBalance').textContent = `MYR ${walletData.balance.toFixed(2)}`;
                document.getElementById('totalEarned').textContent = `MYR ${walletData.total_earned.toFixed(2)}`;
                document.getElementById('heldBalance').textContent = `MYR ${(walletData.held_balance || 0).toFixed(2)}`;
                document.getElementById('totalSpent').textContent = `MYR ${(walletData.total_spent || 0).toFixed(2)}`;
            }
        } catch (error) {
            console.error('Error loading wallet:', error);
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');

        if (tabName === 'transactions') loadTransactions();
        else if (tabName === 'invoices') loadInvoices();
        else if (tabName === 'payouts') loadPayouts();
    }

    async function loadTransactions() {
        const loading = document.getElementById('transactionsLoading');
        const content = document.getElementById('transactionsContent');
        const empty = document.getElementById('transactionsEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const type = document.getElementById('transactionType').value;
            const response = await fetch(`/api/billing/transactions?type=${type}`);
            if (response.ok) {
                const data = await response.json();
                loading.style.display = 'none';

                if (data.length === 0) {
                    empty.style.display = 'block';
                } else {
                    content.style.display = 'block';
                    const tbody = document.getElementById('transactionsBody');
                    tbody.innerHTML = data.map(txn => `
                        <tr>
                            <td>${new Date(txn.transaction_date).toLocaleDateString()}</td>
                            <td>Payment for Gig #${txn.gig_id || 'N/A'}</td>
                            <td>MYR ${txn.amount.toFixed(2)}</td>
                            <td><span class="badge ${txn.client_id === walletData?.user_id ? 'sent' : 'received'}">${txn.client_id === walletData?.user_id ? 'Sent' : 'Received'}</span></td>
                            <td><span class="badge ${txn.status}">${txn.status}</span></td>
                        </tr>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading transactions:', error);
            loading.style.display = 'none';
            empty.style.display = 'block';
        }
    }

    async function loadInvoices() {
        const loading = document.getElementById('invoicesLoading');
        const content = document.getElementById('invoicesContent');
        const empty = document.getElementById('invoicesEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const status = document.getElementById('invoiceStatus').value;
            const response = await fetch(`/api/billing/invoices?status=${status}`);
            if (response.ok) {
                const data = await response.json();
                loading.style.display = 'none';

                if (data.length === 0) {
                    empty.style.display = 'block';
                } else {
                    content.style.display = 'block';
                    const tbody = document.getElementById('invoicesBody');
                    tbody.innerHTML = data.map(inv => `
                        <tr>
                            <td>#${inv.invoice_number}</td>
                            <td>Gig #${inv.gig_id}</td>
                            <td>MYR ${inv.total_amount.toFixed(2)}</td>
                            <td><span class="badge ${inv.status}">${inv.status}</span></td>
                            <td>${new Date(inv.issue_date).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading invoices:', error);
            loading.style.display = 'none';
            empty.style.display = 'block';
        }
    }

    async function loadPayouts() {
        const loading = document.getElementById('payoutsLoading');
        const content = document.getElementById('payoutsContent');
        const empty = document.getElementById('payoutsEmpty');

        loading.style.display = 'block';
        content.style.display = 'none';
        empty.style.display = 'none';

        try {
            const response = await fetch('/api/billing/payouts');
            if (response.ok) {
                const data = await response.json();
                loading.style.display = 'none';

                if (data.length === 0) {
                    empty.style.display = 'block';
                } else {
                    content.style.display = 'block';
                    const tbody = document.getElementById('payoutsBody');
                    tbody.innerHTML = data.map(p => `
                        <tr>
                            <td>#${p.id}</td>
                            <td>MYR ${p.amount.toFixed(2)}</td>
                            <td>${p.payout_method}</td>
                            <td><span class="badge ${p.status}">${p.status}</span></td>
                            <td>${new Date(p.requested_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading payouts:', error);
            loading.style.display = 'none';
            empty.style.display = 'block';
        }
    }

    function openPayoutModal() {
        document.getElementById('payoutModal').classList.add('active');
    }

    function closePayoutModal() {
        document.getElementById('payoutModal').classList.remove('active');
    }

    document.getElementById('payoutAmount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const fee = amount * 0.02;
        const total = amount - fee;
        document.getElementById('summaryAmount').textContent = `MYR ${amount.toFixed(2)}`;
        document.getElementById('summaryFee').textContent = `MYR ${fee.toFixed(2)}`;
        document.getElementById('summaryTotal').textContent = `MYR ${total.toFixed(2)}`;
    });

    async function submitPayout(e) {
        e.preventDefault();
        const alertDiv = document.getElementById('payoutAlert');

        const data = {
            amount: parseFloat(document.getElementById('payoutAmount').value),
            payout_method: document.getElementById('payoutMethod').value,
            bank_name: document.getElementById('bankName').value,
            account_number: document.getElementById('accountNumber').value
        };

        try {
            const response = await fetch('/api/billing/payouts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alertDiv.innerHTML = '<div class="alert success">Payout request submitted successfully!</div>';
                setTimeout(() => {
                    closePayoutModal();
                    loadPayouts();
                    loadWalletData();
                }, 2000);
            } else {
                alertDiv.innerHTML = `<div class="alert error">${result.error || 'Failed to submit payout'}</div>`;
            }
        } catch (error) {
            alertDiv.innerHTML = '<div class="alert error">An error occurred. Please try again.</div>';
        }
    }

    loadWalletData();
    loadTransactions();
</script>
{% endblock %}