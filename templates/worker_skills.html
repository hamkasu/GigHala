{% extends "base.html" %}

{% block title %}{% if lang == 'ms' %}Perkhidmatan & Kemahiran Pekerja{% else %}Worker Services & Skills{% endif %}{% endblock %}

{% block extra_styles %}
<style>
    /* ===== PAGE LAYOUT ===== */
    .services-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    /* ===== HERO SECTION ===== */
    .services-hero {
        background: linear-gradient(135deg, #00C853 0%, #00A844 100%);
        border-radius: var(--radius-lg);
        padding: 40px 32px;
        margin-bottom: 28px;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .services-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.08);
        border-radius: 50%;
    }

    .services-hero h1 {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 8px;
        position: relative;
    }

    .services-hero p {
        font-size: 15px;
        opacity: 0.9;
        margin-bottom: 20px;
        position: relative;
    }

    .hero-search {
        display: flex;
        gap: 12px;
        max-width: 600px;
        position: relative;
    }

    .hero-search input {
        flex: 1;
        padding: 12px 18px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 15px;
        outline: none;
    }

    .hero-search button {
        padding: 12px 24px;
        background: var(--text-dark);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: opacity 0.2s;
    }

    .hero-search button:hover {
        opacity: 0.9;
    }

    /* ===== CATEGORY PILLS ===== */
    .category-pills {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
        margin-bottom: 24px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .category-pills::-webkit-scrollbar {
        display: none;
    }

    .category-pill {
        padding: 8px 18px;
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: 50px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-dark);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .category-pill:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .category-pill.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    /* ===== FILTERS BAR ===== */
    .filters-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .filters-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 13px;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-chip:hover {
        border-color: var(--primary);
    }

    .filter-chip select, .filter-chip input {
        border: none;
        background: transparent;
        font-size: 13px;
        color: var(--text-dark);
        outline: none;
        cursor: pointer;
        font-family: inherit;
    }

    .filter-chip input {
        width: 60px;
        text-align: center;
    }

    .filter-chip input::placeholder {
        color: var(--text-light);
    }

    .results-info {
        font-size: 14px;
        color: var(--text-gray);
    }

    .results-info strong {
        color: var(--text-dark);
    }

    /* ===== SERVICE CARDS GRID ===== */
    .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .service-card {
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }

    .service-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    /* Card thumbnail area */
    .service-card-thumb {
        height: 160px;
        background: linear-gradient(135deg, #f0fdf4 0%, #e8f5e9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .service-card-thumb .category-icon {
        font-size: 48px;
        opacity: 0.6;
    }

    .service-card-thumb .premium-tag {
        position: absolute;
        top: 12px;
        left: 12px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Card body */
    .service-card-body {
        padding: 16px;
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    /* Worker info row */
    .service-worker-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .service-worker-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-gray);
        flex-shrink: 0;
    }

    .service-worker-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .service-worker-name .verified-icon {
        width: 14px;
        height: 14px;
        background: #2e7d32;
        color: white;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
    }

    .service-worker-level {
        font-size: 11px;
        color: var(--text-gray);
    }

    /* Service title */
    .service-card-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-dark);
        line-height: 1.4;
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Skills tags */
    .service-skills-row {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 12px;
    }

    .skill-chip {
        padding: 2px 8px;
        background: var(--bg-light);
        border-radius: 4px;
        font-size: 11px;
        color: var(--text-gray);
    }

    /* Rating row */
    .service-rating-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
        font-size: 13px;
    }

    .service-rating-star {
        color: #f59e0b;
        font-weight: 700;
    }

    .service-rating-count {
        color: var(--text-gray);
    }

    /* Price footer */
    .service-card-footer {
        border-top: 1px solid var(--border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: auto;
    }

    .service-price-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .service-price {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .service-price .price-unit {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-gray);
    }

    .service-contact-btn {
        padding: 6px 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .service-contact-btn:hover {
        opacity: 0.9;
    }

    /* ===== LOAD MORE ===== */
    .load-more-area {
        text-align: center;
        padding: 32px 0;
    }

    .load-more-btn {
        padding: 12px 40px;
        background: var(--bg-white);
        color: var(--primary);
        border: 2px solid var(--primary);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .load-more-btn:hover {
        background: var(--primary);
        color: white;
    }

    .load-more-info {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-gray);
    }

    /* ===== EMPTY & ERROR STATES ===== */
    .empty-state, .error-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state-icon {
        font-size: 56px;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        font-size: 18px;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--text-gray);
        font-size: 14px;
    }

    .error-state {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--radius-md);
        color: #991b1b;
    }

    /* ===== LOADING ===== */
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        grid-column: 1 / -1;
        justify-self: center;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .services-page {
            padding: 16px;
        }

        .services-hero {
            padding: 28px 20px;
        }

        .services-hero h1 {
            font-size: 22px;
        }

        .hero-search {
            flex-direction: column;
        }

        .hero-search button {
            width: 100%;
        }

        .services-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .filters-toolbar {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    @media (max-width: 480px) {
        .services-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="services-page">
    <!-- Hero Section -->
    <div class="services-hero">
        <h1>{% if lang == 'ms' %}Cari Perkhidmatan Profesional{% else %}Find Professional Services{% endif %}</h1>
        <p>{% if lang == 'ms' %}Layari kemahiran pekerja berdaftar dan harga mereka. Tempah terus!{% else %}Browse registered workers' skills and pricing. Book directly!{% endif %}</p>
        <div class="hero-search">
            <input type="text" id="heroSearch" placeholder="{% if lang == 'ms' %}Cari kemahiran atau perkhidmatan...{% else %}Search skills or services...{% endif %}">
            <button onclick="searchServices()">{% if lang == 'ms' %}Cari{% else %}Search{% endif %}</button>
        </div>
    </div>

    <!-- Category Pills -->
    <div class="category-pills" id="categoryPills">
        <div class="category-pill active" data-id="">{% if lang == 'ms' %}Semua{% else %}All{% endif %}</div>
    </div>

    <!-- Filters Toolbar -->
    <div class="filters-toolbar">
        <div class="filters-left">
            <div class="filter-chip">
                <span>{% if lang == 'ms' %}Harga{% else %}Price{% endif %}</span>
                <select id="sortSelect" onchange="searchServices()">
                    <option value="popular">{% if lang == 'ms' %}Popular{% else %}Popular{% endif %}</option>
                    <option value="price_low">{% if lang == 'ms' %}Rendah ke Tinggi{% else %}Low to High{% endif %}</option>
                    <option value="price_high">{% if lang == 'ms' %}Tinggi ke Rendah{% else %}High to Low{% endif %}</option>
                    <option value="rating">{% if lang == 'ms' %}Penilaian Terbaik{% else %}Top Rated{% endif %}</option>
                    <option value="newest">{% if lang == 'ms' %}Terbaru{% else %}Newest{% endif %}</option>
                </select>
            </div>

            <div class="filter-chip">
                <span>RM</span>
                <input type="number" id="minPrice" placeholder="Min" min="0">
                <span>-</span>
                <input type="number" id="maxPrice" placeholder="Max" min="0">
            </div>

            <label class="filter-chip" style="cursor: pointer;">
                <input type="checkbox" id="verifiedOnly" onchange="searchServices()" style="accent-color: var(--primary);">
                <span>{% if lang == 'ms' %}Disahkan{% else %}Verified{% endif %}</span>
            </label>
        </div>

        <div class="results-info">
            <strong id="resultCount">0</strong> {% if lang == 'ms' %}perkhidmatan ditemui{% else %}services found{% endif %}
        </div>
    </div>

    <!-- Services Grid -->
    <div class="services-grid" id="servicesGrid">
        <div class="loading-spinner"></div>
    </div>

    <!-- Load More -->
    <div class="load-more-area" id="loadMoreArea" style="display: none;">
        <button class="load-more-btn" onclick="loadMore()">{% if lang == 'ms' %}Muatkan Lagi{% else %}Load More{% endif %}</button>
        <div class="load-more-info">
            {% if lang == 'ms' %}Menunjukkan{% else %}Showing{% endif %} <span id="showingCount">0</span> {% if lang == 'ms' %}daripada{% else %}of{% endif %} <span id="totalCount">0</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============ STATE ============
    let allServices = [];
    let currentPage = 1;
    let totalServices = 0;
    let selectedCategory = '';
    const pageSize = 24;

    // ============ CATEGORY ICONS MAP ============
    const categoryIcons = {
        'design': 'üé®', 'writing': '‚úçÔ∏è', 'video': 'üé¨', 'tutoring': 'üìö',
        'content': 'üìù', 'web': 'üåê', 'marketing': 'üì£', 'admin': 'üìã',
        'general': 'üîß', 'programming': 'üíª', 'consulting': 'üíº',
        'engineering': '‚öôÔ∏è', 'music': 'üéµ', 'photography': 'üì∑',
        'finance': 'üí∞', 'crafts': 'üéÅ', 'garden': 'üå±', 'coaching': 'üèãÔ∏è',
        'data': 'üìä', 'pets': 'üêæ', 'handyman': 'üî®', 'tours': 'üó∫Ô∏è',
        'events': 'üéâ', 'online-selling': 'üõí', 'virtual-assistant': 'ü§ñ',
        'delivery': 'üöö', 'micro-tasks': '‚ö°', 'caregiving': 'ü§≤',
        'creative-other': '‚ú®'
    };

    // ============ INIT ============
    async function init() {
        try {
            loadCategoryPills();
            loadURLParams();
            await searchServices();
            feather.replace();
        } catch (err) {
            console.error('Init error:', err);
            showError('{% if lang == "ms" %}Gagal memuatkan halaman. Sila muat semula.{% else %}Failed to load page. Please refresh.{% endif %}');
        }
    }

    // ============ CATEGORY PILLS ============
    function loadCategoryPills() {
        const container = document.getElementById('categoryPills');
        const categories = {{ categories | tojson }};

        categories.forEach(cat => {
            const pill = document.createElement('div');
            pill.className = 'category-pill';
            pill.dataset.id = cat.id;
            const icon = categoryIcons[cat.slug] || 'üìå';
            pill.innerHTML = `${icon} ${cat.name}`;
            pill.onclick = () => selectCategory(cat.id, pill);
            container.appendChild(pill);
        });
    }

    function selectCategory(catId, pillEl) {
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        pillEl.classList.add('active');
        selectedCategory = catId;
        currentPage = 1;
        searchServices();
    }

    // ============ URL PARAMS ============
    function loadURLParams() {
        const params = new URLSearchParams(window.location.search);
        const q = params.get('q');
        if (q) document.getElementById('heroSearch').value = q;

        const cat = params.get('category');
        if (cat) {
            selectedCategory = cat;
            const pill = document.querySelector(`.category-pill[data-id="${cat}"]`);
            if (pill) {
                document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
            }
        }
    }

    // ============ SEARCH / FETCH ============
    async function searchServices(append = false) {
        const grid = document.getElementById('servicesGrid');

        if (!append) {
            grid.innerHTML = '<div class="loading-spinner"></div>';
            currentPage = 1;
        }

        const params = new URLSearchParams();

        const q = document.getElementById('heroSearch').value.trim();
        if (q) params.append('q', q);

        if (selectedCategory) params.append('category_id', selectedCategory);

        const minPrice = document.getElementById('minPrice').value;
        if (minPrice) params.append('min_price', minPrice);

        const maxPrice = document.getElementById('maxPrice').value;
        if (maxPrice) params.append('max_price', maxPrice);

        const sort = document.getElementById('sortSelect').value;
        params.append('sort', sort);

        if (document.getElementById('verifiedOnly').checked) {
            params.append('verified_only', 'true');
        }

        params.append('page', currentPage);
        params.append('limit', pageSize);

        try {
            const resp = await fetch(`/api/skills/browse?${params.toString()}`);
            if (!resp.ok) throw new Error('API error');

            const data = await resp.json();

            if (append) {
                allServices = [...allServices, ...data.services];
            } else {
                allServices = data.services;
            }
            totalServices = data.total;

            renderServices();
        } catch (err) {
            console.error('Search error:', err);
            showError('{% if lang == "ms" %}Gagal mencari perkhidmatan.{% else %}Failed to search services.{% endif %}');
        }
    }

    // ============ RENDER ============
    function renderServices() {
        const grid = document.getElementById('servicesGrid');
        document.getElementById('resultCount').textContent = totalServices;

        if (allServices.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3>{% if lang == 'ms' %}Tiada perkhidmatan ditemui{% else %}No services found{% endif %}</h3>
                    <p>{% if lang == 'ms' %}Cuba ubah carian atau penapis anda{% else %}Try adjusting your search or filters{% endif %}</p>
                </div>`;
            document.getElementById('loadMoreArea').style.display = 'none';
            return;
        }

        grid.innerHTML = allServices.map(renderServiceCard).join('');

        // Load more toggle
        document.getElementById('showingCount').textContent = allServices.length;
        document.getElementById('totalCount').textContent = totalServices;
        document.getElementById('loadMoreArea').style.display =
            allServices.length < totalServices ? 'block' : 'none';

        feather.replace();
    }

    function renderServiceCard(svc) {
        const w = svc.worker;
        const initials = (w.name || 'U').charAt(0).toUpperCase();

        // Rating display
        const rating = w.rating || 0;
        const ratingHtml = rating > 0
            ? `<span class="service-rating-star">‚òÖ ${rating.toFixed(1)}</span><span class="service-rating-count">(${w.review_count})</span>`
            : `<span class="service-rating-count">{% if lang == 'ms' %}Baru{% else %}New{% endif %}</span>`;

        // Skills tags
        const skillsHtml = svc.skills.slice(0, 3).map(s =>
            `<span class="skill-chip">${escapeHtml(s)}</span>`
        ).join('');

        // Price display
        let priceHtml = '';
        if (svc.fixed_rate) {
            priceHtml = `<span class="service-price">RM${parseFloat(svc.fixed_rate).toFixed(0)}<span class="price-unit"> /{% if lang == 'ms' %}gig{% else %}gig{% endif %}</span></span>`;
        } else if (svc.hourly_rate) {
            priceHtml = `<span class="service-price">RM${parseFloat(svc.hourly_rate).toFixed(0)}<span class="price-unit"> /{% if lang == 'ms' %}jam{% else %}hr{% endif %}</span></span>`;
        }

        // Thumbnail bg colors based on category
        const thumbColors = [
            'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
            'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
            'linear-gradient(135deg, #fefce8 0%, #fef9c3 100%)',
            'linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%)',
            'linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%)',
            'linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%)'
        ];
        const thumbBg = thumbColors[svc.category_id % thumbColors.length];

        // Completed gigs level
        let levelText = '{% if lang == "ms" %}Baru{% else %}New Seller{% endif %}';
        if (w.completed_gigs >= 50) levelText = '{% if lang == "ms" %}Penjual Teratas{% else %}Top Rated{% endif %}';
        else if (w.completed_gigs >= 20) levelText = '{% if lang == "ms" %}Penjual Level 2{% else %}Level 2 Seller{% endif %}';
        else if (w.completed_gigs >= 5) levelText = '{% if lang == "ms" %}Penjual Level 1{% else %}Level 1 Seller{% endif %}';

        return `
        <div class="service-card" onclick="window.location.href='/profile/${escapeHtml(w.username)}'">
            <div class="service-card-thumb" style="background: ${thumbBg}">
                <span class="category-icon">${svc.category_icon || 'üìå'}</span>
                ${svc.has_premium ? '<span class="premium-tag">Premium</span>' : ''}
            </div>
            <div class="service-card-body">
                <div class="service-worker-row">
                    <div class="service-worker-avatar">${initials}</div>
                    <div>
                        <div class="service-worker-name">
                            ${escapeHtml(w.name)}
                            ${w.is_verified ? '<span class="verified-icon">‚úì</span>' : ''}
                        </div>
                        <div class="service-worker-level">${levelText}</div>
                    </div>
                </div>
                <div class="service-card-title">${escapeHtml(svc.title)}</div>
                <div class="service-skills-row">${skillsHtml}</div>
                <div class="service-rating-row">
                    ${ratingHtml}
                    ${w.completed_gigs > 0 ? `<span class="service-rating-count" style="margin-left: auto;">${w.completed_gigs} {% if lang == 'ms' %}gig selesai{% else %}gigs done{% endif %}</span>` : ''}
                </div>
            </div>
            <div class="service-card-footer">
                <div>
                    <div class="service-price-label">{% if lang == 'ms' %}BERMULA DARI{% else %}STARTING AT{% endif %}</div>
                    ${priceHtml}
                </div>
            </div>
        </div>`;
    }

    // ============ LOAD MORE ============
    function loadMore() {
        currentPage++;
        searchServices(true);
    }

    // ============ ERROR ============
    function showError(msg) {
        document.getElementById('servicesGrid').innerHTML = `
            <div class="error-state">
                <h3>Error</h3>
                <p>${escapeHtml(msg)}</p>
                <button onclick="location.reload()" style="margin-top: 12px; padding: 8px 20px; background: #991b1b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    {% if lang == 'ms' %}Muat Semula{% else %}Reload{% endif %}
                </button>
            </div>`;
    }

    // ============ UTILS ============
    function escapeHtml(text) {
        if (!text) return '';
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    // ============ EVENT LISTENERS ============
    document.addEventListener('DOMContentLoaded', init);

    document.getElementById('heroSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchServices();
    });

    ['minPrice', 'maxPrice'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchServices();
        });
    });
</script>
{% endblock %}
