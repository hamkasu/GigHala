{% extends "base.html" %}

{% block title %}Browse Gigs{% endblock %}

{% block extra_styles %}
<style>
    .gigs-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    .filters-bar {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
    }

    .filters-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .filter-input, .filter-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        background: white;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .budget-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .budget-inputs input {
        flex: 1;
    }

    .search-btn {
        padding: 10px 24px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: opacity 0.2s;
    }

    .search-btn:hover {
        opacity: 0.9;
    }

    .search-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .results-count {
        font-size: 16px;
        color: var(--text-gray);
    }

    .sort-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
    }

    .gigs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .gig-card {
        background: var(--bg-white);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .gig-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .gig-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
    }

    .gig-icon {
        font-size: 32px;
        flex-shrink: 0;
    }

    .gig-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .gig-category {
        font-size: 12px;
        color: var(--text-gray);
        text-transform: capitalize;
    }

    .gig-description {
        font-size: 14px;
        color: var(--text-gray);
        line-height: 1.6;
        margin-bottom: 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    .gig-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }

    .gig-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: var(--bg-light);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--text-gray);
    }

    .gig-badge.halal {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .gig-badge.instant {
        background: #fff3e0;
        color: #e65100;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: capitalize;
    }

    .status-badge.open {
        background: #e0e7ff;
        color: #3730a3;
    }

    .status-badge.in_progress {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.pending_review {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-badge.completed {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge.cancelled {
        background: #fee2e2;
        color: #991b1b;
    }

    .gig-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .gig-budget {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
    }

    .gig-client {
        font-size: 12px;
        color: var(--text-gray);
    }

    .load-more-section {
        text-align: center;
        margin-top: 32px;
    }

    .load-more-btn {
        padding: 12px 32px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .load-more-btn:hover {
        opacity: 0.9;
    }

    .load-more-info {
        margin-top: 12px;
        font-size: 14px;
        color: var(--text-gray);
    }

    .error-message, .empty-state {
        grid-column: 1/-1;
        text-align: center;
        padding: 60px 20px;
    }

    .error-message {
        background: #fee;
        color: #c33;
        border-radius: var(--radius-md);
        border: 1px solid #fcc;
    }

    .empty-state {
        color: var(--text-gray);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="gigs-container">
    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" class="filter-input" placeholder="Keywords..." id="searchInput">
            </div>

            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" id="categorySelect">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Budget (RM)</label>
                <div class="budget-inputs">
                    <input type="number" class="filter-input" placeholder="Min" id="priceMin">
                    <span>-</span>
                    <input type="number" class="filter-input" placeholder="Max" id="priceMax">
                </div>
            </div>

            <div class="filter-group" style="flex: 0;">
                <button class="search-btn" id="searchBtn" onclick="loadGigs()">Search Gigs</button>
            </div>
        </div>
    </div>

    <!-- Results Header -->
    <div class="results-header">
        <div class="results-count">
            <strong id="resultCount">0</strong> gigs found
        </div>
        <div>
            <label style="margin-right: 8px; font-size: 14px; color: var(--text-gray);">Sort by:</label>
            <select class="sort-select" id="sortSelect" onchange="loadGigs()">
                <option value="newest" selected>Newest</option>
                <option value="budget_high">Budget: High to Low</option>
                <option value="budget_low">Budget: Low to High</option>
            </select>
        </div>
    </div>

    <!-- Gigs Grid -->
    <div class="gigs-grid" id="gigsGrid">
        <div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>
    </div>

    <!-- Load More -->
    <div class="load-more-section" id="loadMoreSection" style="display: none;">
        <button class="load-more-btn" onclick="loadMore()">Load More</button>
        <div class="load-more-info">
            Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> gigs
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============ STATE MANAGEMENT ============
    let allGigs = [];
    let allCategories = [];
    let currentPage = 1;
    const pageSize = 12;

    // ============ CATEGORY ICONS MAPPING ============
    const categoryIconMap = {
        // Design & Creative
        'graphic-design': 'üé®',
        'ui-ux': 'üì±',
        'illustration': 'üñºÔ∏è',
        'logo-design': 'üè∑Ô∏è',
        'fashion': 'üëó',
        'interior-design': 'üè†',

        // Writing & Content
        'content-writing': '‚úçÔ∏è',
        'translation': 'üåê',
        'proofreading': 'üìù',
        'resume': 'üìÑ',
        'email-marketing': 'üìß',
        'social-copy': 'üì±',

        // Video & Media
        'video-editing': 'üé¨',
        'animation': 'üéûÔ∏è',
        'voiceover': 'üé§',
        'podcast': 'üéôÔ∏è',
        'photography': 'üì∏',

        // Web & App Development
        'web-development': 'üíª',
        'app-development': 'üì±',
        'ecommerce': 'üõí',

        // Marketing & Business
        'digital-marketing': 'üìà',
        'social-media': 'üì±',
        'business-consulting': 'üíº',
        'data-analysis': 'üìä',

        // Education & Tutoring
        'tutoring': 'üìö',
        'language-teaching': 'üó£Ô∏è',

        // Technical & Engineering
        'programming': 'üíª',
        'engineering': '‚öôÔ∏è',

        // Admin & Support
        'virtual-assistant': 'üíº',
        'transcription': '‚å®Ô∏è',
        'data-entry': 'üìã',

        // Finance & Legal
        'bookkeeping': 'üí∞',
        'legal': '‚öñÔ∏è',

        // Lifestyle & Personal
        'wellness-coaching': 'üßò',
        'personal-styling': 'üëî',
        'pet-services': 'üêæ',

        // Home & Handyman
        'home-repair': 'üîß',
        'cleaning': 'üßπ',
        'gardening': 'üå±',

        // Specialized Services
        'crafts': 'üé®',
        'music-production': 'üéµ',
        'event-planning': 'üéâ',
        'tours': 'üó∫Ô∏è',

        // General
        'general': 'üì¶'
    };

    // ============ INITIALIZATION ============
    async function init() {
        try {
            await loadCategories();
            loadURLParams();
            await loadGigs();
        } catch (error) {
            console.error('Initialization error:', error);
            showError('Failed to initialize page. Please refresh.');
        }
    }

    // ============ LOAD CATEGORIES FROM API ============
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) throw new Error('Failed to fetch categories');

            allCategories = await response.json();

            const categorySelect = document.getElementById('categorySelect');
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.slug;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
            // Continue with empty categories - not critical
        }
    }

    // ============ LOAD URL PARAMETERS ============
    function loadURLParams() {
        const urlParams = new URLSearchParams(window.location.search);

        const category = urlParams.get('category');
        if (category) {
            document.getElementById('categorySelect').value = category;
        }

        const search = urlParams.get('search');
        if (search) {
            document.getElementById('searchInput').value = search;
        }
    }

    // ============ LOAD GIGS FROM API ============
    async function loadGigs() {
        const searchBtn = document.getElementById('searchBtn');
        const gigsGrid = document.getElementById('gigsGrid');

        try {
            // Disable search button while loading
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            // Show loading state
            gigsGrid.innerHTML = '<div class="loading-spinner" style="grid-column: 1/-1; justify-self: center;"></div>';

            // Build API URL with parameters
            const params = new URLSearchParams();

            const search = document.getElementById('searchInput').value.trim();
            if (search) params.append('search', search);

            const category = document.getElementById('categorySelect').value;
            if (category) params.append('category', category);

            const apiUrl = `/api/gigs${params.toString() ? '?' + params.toString() : ''}`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Failed to fetch gigs');

            allGigs = await response.json();

            // Apply client-side filters
            filterAndDisplayGigs();

        } catch (error) {
            console.error('Error loading gigs:', error);
            showError('Failed to load gigs. Please try again.');
        } finally {
            searchBtn.disabled = false;
            searchBtn.textContent = 'Search Gigs';
        }
    }

    // ============ FILTER AND DISPLAY GIGS ============
    function filterAndDisplayGigs() {
        // Get filter values
        const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
        const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;

        // Filter gigs
        let filtered = allGigs.filter(gig => {
            // Price filter: Check if gig budget range overlaps with user's price range
            const gigMin = parseFloat(gig.budget_min) || 0;
            const gigMax = parseFloat(gig.budget_max) || Infinity;
            const matchesPrice = gigMax >= priceMin && gigMin <= priceMax;

            return matchesPrice;
        });

        // Sort gigs
        const sortBy = document.getElementById('sortSelect').value;
        if (sortBy === 'newest') {
            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortBy === 'budget_high') {
            filtered.sort((a, b) => (b.budget_max || 0) - (a.budget_max || 0));
        } else if (sortBy === 'budget_low') {
            filtered.sort((a, b) => (a.budget_min || 0) - (b.budget_min || 0));
        }

        // Display results
        displayGigs(filtered);
    }

    // ============ DISPLAY GIGS ============
    function displayGigs(gigs) {
        const gigsGrid = document.getElementById('gigsGrid');
        const resultCount = document.getElementById('resultCount');

        resultCount.textContent = gigs.length;

        if (gigs.length === 0) {
            gigsGrid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3>No gigs found</h3>
                    <p>Try adjusting your search filters</p>
                </div>
            `;
            document.getElementById('loadMoreSection').style.display = 'none';
            return;
        }

        // Pagination
        const start = 0;
        const end = currentPage * pageSize;
        const visibleGigs = gigs.slice(start, end);

        gigsGrid.innerHTML = visibleGigs.map(gig => renderGigCard(gig)).join('');

        // Update load more section
        document.getElementById('showingCount').textContent = visibleGigs.length;
        document.getElementById('totalCount').textContent = gigs.length;

        if (visibleGigs.length < gigs.length) {
            document.getElementById('loadMoreSection').style.display = 'block';
        } else {
            document.getElementById('loadMoreSection').style.display = 'none';
        }
    }

    // ============ RENDER GIG CARD ============
    function renderGigCard(gig) {
        const icon = categoryIconMap[gig.category] || 'üìã';
        const categoryName = allCategories.find(c => c.slug === gig.category)?.name || gig.category;

        // Format budget
        let budgetText = '';
        if (gig.approved_budget) {
            budgetText = `RM ${gig.approved_budget.toFixed(2)}`;
        } else if (gig.budget_min === gig.budget_max) {
            budgetText = `RM ${gig.budget_min.toFixed(2)}`;
        } else {
            budgetText = `RM ${gig.budget_min.toFixed(2)} - ${gig.budget_max.toFixed(2)}`;
        }

        // Format status
        const statusLabels = {
            'open': 'Open',
            'in_progress': 'In Progress',
            'pending_review': 'Pending Review',
            'completed': 'Completed',
            'cancelled': 'Cancelled'
        };
        const statusLabel = statusLabels[gig.status] || gig.status;

        return `
            <div class="gig-card" onclick="window.location.href='/gig/${gig.id}'">
                <div class="gig-header">
                    <div class="gig-icon">${icon}</div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="gig-title">${escapeHtml(gig.title)}</div>
                        <div class="gig-category">${escapeHtml(categoryName)}</div>
                    </div>
                </div>

                <div class="gig-description">${escapeHtml(gig.description)}</div>

                <div class="gig-meta">
                    ${gig.status ? `<span class="status-badge ${gig.status}">${statusLabel}</span>` : ''}
                    ${gig.halal_verified ? '<span class="gig-badge halal">‚úì Halal Verified</span>' : ''}
                    ${gig.is_instant_payout ? '<span class="gig-badge instant">‚ö° Instant Payout</span>' : ''}
                    ${gig.is_remote ? '<span class="gig-badge">üåê Remote</span>' : ''}
                    ${gig.location ? `<span class="gig-badge">üìç ${escapeHtml(gig.location)}</span>` : ''}
                </div>

                <div class="gig-footer">
                    <div class="gig-budget">${budgetText}</div>
                    <div class="gig-client">by ${escapeHtml(gig.client_name)}</div>
                </div>
            </div>
        `;
    }

    // ============ LOAD MORE ============
    function loadMore() {
        currentPage++;
        filterAndDisplayGigs();
    }

    // ============ SHOW ERROR ============
    function showError(message) {
        const gigsGrid = document.getElementById('gigsGrid');
        gigsGrid.innerHTML = `
            <div class="error-message">
                <h3>‚ö†Ô∏è Error</h3>
                <p>${escapeHtml(message)}</p>
                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #c33; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button>
            </div>
        `;
    }

    // ============ UTILITY FUNCTIONS ============
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============ EVENT LISTENERS ============
    document.addEventListener('DOMContentLoaded', init);

    // Allow Enter key to trigger search
    ['searchInput', 'priceMin', 'priceMax'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadGigs();
        });
    });

    // Reset pagination and reload gigs when category changes
    document.getElementById('categorySelect').addEventListener('change', () => {
        currentPage = 1;
        loadGigs();
    });
</script>
{% endblock %}
