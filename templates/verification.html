{% extends "base.html" %}

{% block title %}Identity Verification{% endblock %}

{% block extra_styles %}
<style>
    .verification-container {
        max-width: 700px;
        margin: 0 auto;
        padding: 32px 24px;
    }
    .page-header {
        background: var(--bg-white);
        padding: 28px 32px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
        border: 1px solid var(--border);
    }
    .page-header h1 {
        color: var(--text-dark);
        font-size: 28px;
        margin: 0;
    }
    .verification-status {
        background: var(--bg-white);
        padding: 24px 32px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .status-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
    }
    .status-icon.verified { background: #d1fae5; }
    .status-icon.pending { background: #fef3c7; }
    .status-icon.rejected { background: #fee2e2; }
    .status-icon.none { background: var(--bg-light); }
    .status-content h3 {
        margin: 0 0 4px;
        font-size: 18px;
        color: var(--text-dark);
    }
    .status-content p {
        margin: 0;
        color: var(--text-gray);
        font-size: 14px;
    }
    .verification-form {
        background: var(--bg-white);
        padding: 32px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }
    .form-section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }
    .form-label small {
        font-weight: 400;
        color: var(--text-gray);
    }
    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        color: var(--text-dark);
    }
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
    }
    .file-upload {
        border: 2px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .file-upload:hover {
        border-color: var(--primary);
        background: rgba(0, 200, 83, 0.05);
    }
    .file-upload input {
        display: none;
    }
    .file-upload-icon {
        font-size: 32px;
        margin-bottom: 8px;
    }
    .file-upload-text {
        color: var(--text-gray);
        font-size: 14px;
    }
    .file-upload-text span {
        color: var(--primary);
        font-weight: 600;
    }
    .btn-primary {
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: var(--radius-md);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 12px;
    }
    .btn-primary:hover {
        background: var(--primary-dark);
    }
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .info-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 24px;
        font-size: 14px;
        color: #1e40af;
    }
    .info-box ul {
        margin: 8px 0 0 20px;
        padding: 0;
    }
    .rejection-reason {
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: var(--radius-md);
        padding: 16px;
        margin-top: 12px;
        font-size: 14px;
        color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<div class="verification-container">
    <div class="page-header">
        <h1>Identity Verification</h1>
        <p style="color: var(--text-gray); margin-top: 4px;">Verify your identity to build trust with clients</p>
    </div>

    <div class="verification-status">
        {% if user.is_verified %}
        <div class="status-icon verified">‚úÖ</div>
        <div class="status-content">
            <h3>Verified</h3>
            <p>Your identity has been verified. You now have a verified badge on your profile!</p>
        </div>
        {% elif verification and verification.status == 'pending' %}
        <div class="status-icon pending">‚è≥</div>
        <div class="status-content">
            <h3>Pending Review</h3>
            <p>Your verification is being reviewed. This usually takes 1-2 business days.</p>
        </div>
        {% elif verification and verification.status == 'rejected' %}
        <div class="status-icon rejected">‚ùå</div>
        <div class="status-content">
            <h3>Verification Rejected</h3>
            <p>Your verification was not approved. Please try again with clearer documents.</p>
            {% if verification.rejection_reason %}
            <div class="rejection-reason">{{ verification.rejection_reason }}</div>
            {% endif %}
        </div>
        {% else %}
        <div class="status-icon none">üîê</div>
        <div class="status-content">
            <h3>Not Verified</h3>
            <p>Complete verification to get a verified badge and build trust with clients.</p>
        </div>
        {% endif %}
    </div>

    {% if not user.is_verified and (not verification or verification.status == 'rejected') %}
    <div class="verification-form">
        <div class="info-box">
            <strong>What you need:</strong>
            <ul>
                <li>Malaysian IC (MyKad) - front and back photos</li>
                <li>A selfie holding your IC</li>
                <li>Your legal name as shown on your IC</li>
            </ul>
        </div>

        <form id="verificationForm" enctype="multipart/form-data">
            <div class="form-section-title">Personal Information</div>
            
            <div class="form-group">
                <label class="form-label">IC Number (12 digits) *</label>
                <input type="text" name="ic_number" class="form-input" required placeholder="e.g., 901231105678" maxlength="12" pattern="\d{12}">
            </div>

            <div class="form-group">
                <label class="form-label">Full Name (as shown on IC) *</label>
                <input type="text" name="full_name" class="form-input" required placeholder="e.g., AHMAD BIN ABDULLAH">
            </div>

            <div class="form-section-title" style="margin-top: 32px;">Document Upload</div>

            <div class="form-group">
                <label class="form-label">IC Front Photo *</label>
                <label class="file-upload">
                    <input type="file" name="ic_front" accept="image/*" required>
                    <div class="file-upload-icon">üì∑</div>
                    <div class="file-upload-text"><span>Click to upload</span> or drag and drop</div>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">IC Back Photo *</label>
                <label class="file-upload">
                    <input type="file" name="ic_back" accept="image/*" required>
                    <div class="file-upload-icon">üì∑</div>
                    <div class="file-upload-text"><span>Click to upload</span> or drag and drop</div>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">Selfie with IC <small>(Hold your IC next to your face)</small> *</label>
                <label class="file-upload">
                    <input type="file" name="selfie" accept="image/*" required>
                    <div class="file-upload-icon">ü§≥</div>
                    <div class="file-upload-text"><span>Click to upload</span> or drag and drop</div>
                </label>
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">Submit for Verification</button>
        </form>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.file-upload input').forEach(input => {
    input.addEventListener('change', function() {
        const label = this.closest('.file-upload');
        const text = label.querySelector('.file-upload-text');
        if (this.files.length > 0) {
            text.innerHTML = `<span>Selected:</span> ${this.files[0].name}`;
            label.style.borderColor = 'var(--primary)';
            label.style.background = 'rgba(0, 200, 83, 0.05)';
        }
    });
});

document.getElementById('verificationForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/verification/submit', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Verification submitted successfully! We will review your documents within 1-2 business days.');
            window.location.reload();
        } else {
            alert(data.error || 'Failed to submit verification');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit for Verification';
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit for Verification';
    }
});
</script>
{% endblock %}