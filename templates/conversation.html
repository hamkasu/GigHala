{% extends "base.html" %}

{% block title %}Chat with {{ other_user.get_display_name() }}{% endblock %}

{% block extra_styles %}
<style>
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 32px 24px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
    }
    .chat-header {
        background: var(--bg-white);
        padding: 20px 24px;
        border-radius: var(--radius-lg);
        margin-bottom: 16px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .back-btn {
        color: var(--text-gray);
        text-decoration: none;
        font-size: 24px;
    }
    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 600;
    }
    .chat-user-info h2 {
        margin: 0;
        font-size: 18px;
        color: var(--text-dark);
    }
    .chat-user-info p {
        margin: 2px 0 0;
        font-size: 13px;
        color: var(--text-gray);
    }
    .chat-gig-badge {
        margin-left: auto;
        background: var(--primary-light);
        color: var(--primary);
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
    }
    .chat-gig-badge:hover {
        background: rgba(0, 200, 83, 0.2);
    }
    .messages-area {
        flex: 1;
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .message {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }
    .message.sent {
        align-self: flex-end;
        align-items: flex-end;
    }
    .message.received {
        align-self: flex-start;
        align-items: flex-start;
    }
    .message-bubble {
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
    }
    .message.sent .message-bubble {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .message.received .message-bubble {
        background: var(--bg-light);
        color: var(--text-dark);
        border-bottom-left-radius: 4px;
    }
    .message-time {
        font-size: 11px;
        color: var(--text-gray);
        margin-top: 4px;
    }
    .message-sender {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        padding: 0 2px;
    }
    .message.received .message-sender {
        color: var(--primary);
    }
    .message.sent .message-sender {
        color: var(--text-gray);
    }
    .support-badge {
        display: inline-block;
        background: linear-gradient(135deg, var(--primary) 0%, #00b86a 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        margin-left: 6px;
        letter-spacing: 0.5px;
    }
    .chat-input-area {
        position: relative;
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-top: 16px;
        padding: 16px;
        display: flex;
        gap: 12px;
    }
    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 24px;
        font-size: 14px;
        outline: none;
    }
    .chat-input:focus {
        border-color: var(--primary);
    }
    .send-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
    }
    .send-btn:hover {
        background: var(--primary-dark);
    }
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .empty-messages {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        font-size: 14px;
    }
    .message-error {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: #ff4444;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        max-width: 90%;
        text-align: center;
        z-index: 10;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .chat-container {
            padding: 16px 12px;
            height: calc(100vh - 60px);
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        }

        .chat-header {
            padding: 16px;
            margin-bottom: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .chat-user-info h2 {
            font-size: 16px;
        }

        .chat-user-info p {
            font-size: 12px;
        }

        .chat-gig-badge {
            display: none;
        }

        .messages-area {
            padding: 16px;
            gap: 12px;
        }

        .message {
            max-width: 85%;
        }

        .message-bubble {
            padding: 10px 14px;
            font-size: 14px;
        }

        .message-time {
            font-size: 10px;
        }

        .chat-input-area {
            padding: 12px;
            gap: 8px;
        }

        .chat-input {
            padding: 10px 14px;
            font-size: 15px;
        }

        .send-btn {
            padding: 10px 20px;
            font-size: 13px;
        }

        .back-btn {
            font-size: 20px;
        }
    }

    @media (max-width: 480px) {
        .chat-container {
            padding: 12px 8px;
        }

        .chat-header {
            padding: 12px;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }

        .messages-area {
            padding: 12px;
        }

        .message {
            max-width: 90%;
        }

        .message-bubble {
            padding: 8px 12px;
            font-size: 13px;
        }

        .chat-input-area {
            padding: 10px;
        }

        .send-btn {
            padding: 10px 16px;
            font-size: 12px;
        }
    }

    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
        .send-btn {
            min-height: 44px;
            min-width: 60px;
        }

        .back-btn {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input {
            min-height: 44px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <a href="/messages" class="back-btn">&larr;</a>
        <div class="avatar">{{ other_user.username[0].upper() }}</div>
        <div class="chat-user-info">
            <h2>{{ other_user.get_display_name() }}</h2>
            <p>@{{ other_user.username }}</p>
        </div>
        {% if gig %}
        <a href="/gig/{{ gig.id }}" class="chat-gig-badge">{{ gig.gig_code or 'GIG' }} - {{ gig.title[:25] }}{% if gig.title|length > 25 %}...{% endif %}</a>
        {% endif %}
    </div>

    <div class="messages-area" id="messagesArea">
        {% if messages %}
            {% for msg in messages %}
            <div class="message {% if msg.sender_id == user.id %}sent{% else %}received{% endif %}" data-id="{{ msg.id }}">
                {% if msg.sender_id != user.id %}
                <div class="message-sender">{{ msg.sender.full_name or msg.sender.username }}{% if msg.sender.username == 'support' %}<span class="support-badge">SUPPORT</span>{% endif %}</div>
                {% endif %}
                <div class="message-bubble">{{ msg.content }}</div>
                <span class="message-time">{{ msg.created_at.strftime('%d %b, %H:%M') }}</span>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-messages">
                <p>{{ t('no_messages_yet') }}</p>
            </div>
        {% endif %}
    </div>

    <form class="chat-input-area" id="messageForm">
        <div id="messageError" class="message-error" style="display: none;"></div>
        <input type="text" class="chat-input" id="messageInput" placeholder="{{ t('type_message') }}" autocomplete="off">
        <button type="submit" class="send-btn" id="sendBtn">{{ t('send_message') }}</button>
    </form>
</div>

<script>
const conversationId = {{ conversation.id }};
const userId = {{ user.id }};
let lastMessageId = {% if messages %}{{ messages[-1].id }}{% else %}0{% endif %};

const messagesArea = document.getElementById('messagesArea');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

messagesArea.scrollTop = messagesArea.scrollHeight;

messageForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const content = messageInput.value.trim();
    if (!content) return;

    sendBtn.disabled = true;

    try {
        const response = await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conversation_id: conversationId,
                content: content
            })
        });

        if (response.ok) {
            const data = await response.json();
            appendMessage(data.message, true);
            messageInput.value = '';
            lastMessageId = data.message.id;
            clearError();
        } else {
            const errorData = await response.json();
            showError(errorData.error || 'Failed to send message');
        }
    } catch (error) {
        console.error('Send error:', error);
        showError('Failed to send message');
    }

    sendBtn.disabled = false;
    messageInput.focus();
});

function appendMessage(msg, isSent) {
    const emptyMsg = messagesArea.querySelector('.empty-messages');
    if (emptyMsg) emptyMsg.remove();
    
    const msgEl = document.createElement('div');
    msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
    msgEl.dataset.id = msg.id;
    
    const date = new Date(msg.created_at);
    const timeStr = date.toLocaleDateString('ms-MY', { month: 'short', day: 'numeric' }) + ', ' +
                    date.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', hour12: false });
    
    let senderHtml = '';
    if (!isSent && msg.sender_name) {
        const supportBadge = msg.sender_username === 'support' ? '<span class="support-badge">SUPPORT</span>' : '';
        senderHtml = `<div class="message-sender">${escapeHtml(msg.sender_name)}${supportBadge}</div>`;
    }
    
    msgEl.innerHTML = `
        ${senderHtml}
        <div class="message-bubble">${escapeHtml(msg.content)}</div>
        <span class="message-time">${timeStr}</span>
    `;
    
    messagesArea.appendChild(msgEl);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const errorEl = document.getElementById('messageError');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
        clearError();
    }, 5000); // Auto-hide after 5 seconds
}

function clearError() {
    const errorEl = document.getElementById('messageError');
    errorEl.style.display = 'none';
    errorEl.textContent = '';
}

async function pollMessages() {
    try {
        const response = await fetch(`/api/messages/poll/${conversationId}?last_id=${lastMessageId}`);
        if (response.ok) {
            const data = await response.json();
            for (const msg of data.messages) {
                if (msg.sender_id !== userId && !document.querySelector(`[data-id="${msg.id}"]`)) {
                    appendMessage(msg, false);
                    lastMessageId = Math.max(lastMessageId, msg.id);
                }
            }
        }
    } catch (error) {
        console.error('Poll error:', error);
    }
}

setInterval(pollMessages, 3000);
</script>
{% endblock %}